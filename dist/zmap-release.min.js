var Z={};Z.Util={extend:function(a){var b,c,d,e,f=Array.prototype.slice.call(arguments,1);for(c=0,d=f.length;c<d;c++){e=f[c]||{};for(b in e)e.hasOwnProperty(b)&&(a[b]=e[b])}return a},bind:function(a,b){var c=arguments.length>2?Array.prototype.slice.call(arguments,2):null;return function(){return a.apply(b,c||arguments)}},invokeEach:function(a,b,c){var d,e;if("object"==typeof a){e=Array.prototype.slice.call(arguments,3);for(d in a)b.apply(c,[d,a[d]].concat(e));return!0}return!1},falseFn:function(a){return a&&(a=!1),!1},formatNum:function(a,b){var c=Math.pow(10,b||5);return Math.round(a*c)/c},splitWords:function(a){return Z.Util.stringTrim(a).split(/\s+/)},applyOptions:function(a,b,c,d){d=d||[];for(var e=d?{}:null,f=0;f<d.length;f++)e[d[f]]=1;if(a&&b){var g;if(c)for(g in b)!e||g in e||(a[g]=b[g]);else for(g in a){var h=b[g];void 0===h||!e||g in e||(a[g]=h)}}return a},getParamString:function(a,b,c){var d=[];for(var e in a)d.push(encodeURIComponent(c?e.toUpperCase():e)+"="+encodeURIComponent(a[e]));return(b&&-1!==b.indexOf("?")?"&":"?")+d.join("&")},template:function(a,b){return a.replace(/\{ *([\w_]+) *\}/g,function(a,c){var d=b[c];if(void 0===d)throw new Error("No value provided for variable "+a);return"function"==typeof d&&(d=d(b)),d})},stamp:function(){var a=0,b="_zmap_id";return function(c,d){var e=d?b+"_"+d:b;return c[e]=c[e]||++a,c[e]}}(),arrayClone:function(a){var b=null;if(a instanceof Array){b=[];for(var c=0;c<a.length;c++)b[c]=a[c]}return b},objectClone:function(a,b,c){var d=b||{},c=c||{};for(var e in a)!a.hasOwnProperty(e)||"prototype"===e&&!c.includePrototype||a[e]instanceof Function&&!c.includeFunctions||(d[e]=a[e]);return d},isNull:function(a){return"number"==typeof a?isNaN(a):!a},isZero:function(a){return Z.Util.numberEquals(a,0)},isNumber:function(a){return"number"==typeof a&&!isNaN(a)},numberEquals:function(a,b){return"number"==typeof a&&"number"==typeof b&&Math.abs(a-b)<1e-8},scopeNumber:function(a,b,c){return Z.Util.isNumber(a)||(a=0),Math.min(Math.max(0,a),1)},addToArray:function(a,b,c){!this.isNull(b)&&a instanceof Array&&(c=this.limitIndexToArray(a,c),a.splice(c,0,b))},removeFromArray:function(a,b){if(!this.isNull(b)&&a instanceof Array)for(var c=a.length-1;c>=0;c--)b===a[c]&&a.splice(c,1)},limitIndexToArray:function(a,b){if(a&&void 0!==a.length)return b=void 0===b?a.length:b,b=Math.max(0,Math.min(a.length,b))},getVectorBounds:function(a){if(a=a||[],a.length<=0)return null;for(var b,c,d,e,f,g,h=0;h<a.length;h++)a[h]&&(void 0===b?(b=a[h].x,c=a[h].x,d=a[h].y,e=a[h].y,f=a[h].z,g=a[h].z):(b=Math.min(a[h].x,b),c=Math.max(a[h].x,c),d=Math.min(a[h].y,d),e=Math.max(a[h].y,e),f=Math.min(a[h].z,f),g=Math.max(a[h].z,g)));return Z.GLBounds.create(new Z.Point(b,d,f),new Z.Point(c,e,g))},getPointBounds:function(a){if(a=a||[],a.length<=0)return null;for(var b,c,d,e,f,g,h=0;h<a.length;h++)a[h]&&(void 0===b?(b=a[h].x,c=a[h].x,d=a[h].y,e=a[h].y,f=a[h].z,g=a[h].z):(b=Math.min(a[h].x,b),c=Math.max(a[h].x,c),d=Math.min(a[h].y,d),e=Math.max(a[h].y,e),f=Math.min(a[h].z,f),g=Math.max(a[h].z,g)));return Z.Bounds.create(new Z.Point(b,d,f),new Z.Point(c,e,g))},stringBeginsWith:function(a,b){return"string"==typeof a&&(0!=a.length&&(b=b||" ",a.substring(0,b.length)===b))},stringEndsWith:function(a,b){return"string"==typeof a&&(0!=a.length&&(b=b||" ",a.substring(a.length-b.length)===b))},stringTrim:function(a,b){return"string"!=typeof a?a:0==a.length?a:(b=b||/(^\s+)|(\s+$)/g,a=a.replace(b,""))},isFunction:function(a){return!!a&&"[object Function]"===Object.prototype.toString.call(a)},getConfigValue:function(a,b){if(!a||!b)return null;var c;return Z.Util.isFunction(b)?c=b(a):"string"==typeof(c=b)&&c.indexOf("#{")>=0&&(c=this._extractPropValue(a,c)),c},_extractPropValue:function(a,b){if(void 0===b||null===b)return null;for(var c=b.replace(/\s+/,""),d=/#{([\w\u4e00-\u9fa5]+)}/g,e=c.match(d)||[],f=e.length,g=0;g<f;g++){var h=e[g],i=h.substring(2,h.length-1),j=a[i]||"";c=1===e.length&&h===c.replace(/\s+/,"")?j:c.replace(h,j)}return c},isArray:function(a){return a instanceof Array||a instanceof Float32Array||a instanceof Float64Array||a instanceof Int32Array||a instanceof Int16Array||a instanceof Int8Array||a instanceof Uint32Array||a instanceof Uint16Array||a instanceof Uint8Array}},Z.extend=Z.Util.extend,Z.bind=Z.Util.bind,Z.stamp=Z.Util.stamp,Z.setOptions=Z.Util.setOptions,function(){function a(a){var b,c,d=["webkit","moz","o","ms"];for(b=0;b<d.length&&!c;b++)c=window[d[b]+a];return c}function b(a){var b=+new Date,d=Math.max(0,16-(b-c));return c=b+d,window.setTimeout(a,d)}var c=0,d=window.requestAnimationFrame||a("RequestAnimationFrame")||b,e=window.cancelAnimationFrame||a("CancelAnimationFrame")||a("CancelRequestAnimationFrame")||function(a){window.clearTimeout(a)};Z.Util.requestAnimFrame=function(a,c,e,f){if(a=Z.bind(a,c),!e||d!==b)return d.call(window,a,f);a()},Z.Util.cancelAnimFrame=function(a){a&&e.call(window,a)}}(),Z.Browser=function(){var a="ActiveXObject"in window,b=a&&!document.addEventListener,c=navigator.userAgent.toLowerCase(),d=-1!==c.indexOf("webkit"),e=-1!==c.indexOf("chrome"),f=-1!==c.indexOf("phantom"),g=-1!==c.indexOf("android"),h=-1!==c.search("android [23]"),i=-1!==c.indexOf("gecko"),j=typeof orientation!=void 0+"",k=window.navigator&&window.navigator.msPointerEnabled&&window.navigator.msMaxTouchPoints&&!window.PointerEvent,l=window.PointerEvent&&window.navigator.pointerEnabled&&window.navigator.maxTouchPoints||k,m="devicePixelRatio"in window&&window.devicePixelRatio>1||"matchMedia"in window&&window.matchMedia("(min-resolution:144dpi)")&&window.matchMedia("(min-resolution:144dpi)").matches,n=document.documentElement,o=a&&"transition"in n.style,p="WebKitCSSMatrix"in window&&"m11"in new window.WebKitCSSMatrix&&!h,q="MozPerspective"in n.style,r="OTransition"in n.style,s=!window.L_DISABLE_3D&&(o||p||q||r)&&!f,t=!window.L_NO_TOUCH&&!f&&function(){var a="ontouchstart";if(l||a in n)return!0;var b=document.createElement("div"),c=!1;return!!b.setAttribute&&(b.setAttribute(a,"return;"),"function"==typeof b[a]&&(c=!0),b.removeAttribute(a),b=null,c)}();return{ie:a,ielt9:b,webkit:d,gecko:i&&!d&&!window.opera&&!a,android:g,android23:h,chrome:e,ie3d:o,webkit3d:p,gecko3d:q,opera3d:r,any3d:s,mobile:j,mobileWebkit:j&&d,mobileWebkit3d:j&&p,mobileOpera:j&&window.opera,touch:t,msPointer:k,pointer:l,retina:m}}(),Z.Class=function(){},Z.Class.extend=function(a){var b=function(){this.initialize&&this.initialize.apply(this,arguments),this._initHooks&&this.callInitHooks()},c=function(){};c.prototype=this.prototype;var d=new c;d.constructor=b,b.prototype=d;for(var e in this)this.hasOwnProperty(e)&&"prototype"!==e&&(b[e]=this[e]);a.statics&&(Z.extend(b,a.statics),delete a.statics),a.includes&&(Z.Util.extend.apply(null,[d].concat(a.includes)),delete a.includes),a.options&&d.options&&(a.options=Z.extend({},d.options,a.options)),Z.extend(d,a),d._initHooks=[];var f=this;return b.__super__=f.prototype,d.callInitHooks=function(){if(!this._initHooksCalled){f.prototype.callInitHooks&&f.prototype.callInitHooks.call(this),this._initHooksCalled=!0;for(var a=0,b=d._initHooks.length;a<b;a++)d._initHooks[a].call(this)}},b},Z.Class.include=function(a){Z.extend(this.prototype,a)},Z.Class.mergeOptions=function(a){Z.extend(this.prototype.options,a)},Z.Class.addInitHook=function(a){var b=Array.prototype.slice.call(arguments,1),c="function"==typeof a?a:function(){this[a].apply(this,b)};this.prototype._initHooks=this.prototype._initHooks||[],this.prototype._initHooks.push(c)},Z.DomEvent={addListener:function(a,b,c,d){var e,f,g,h=Z.stamp(c),i="_leaflet_"+b+h;return a[i]?this:(e=function(b){return c.call(d||a,b||Z.DomEvent._getEvent())},Z.Browser.pointer&&0===b.indexOf("touch")?this.addPointerListener(a,b,e,h):(Z.Browser.touch&&"dblclick"===b&&this.addDoubleTapListener&&this.addDoubleTapListener(a,e,h),"addEventListener"in a?"mousewheel"===b?(a.addEventListener("DOMMouseScroll",e,!1),a.addEventListener(b,e,!1)):"mouseenter"===b||"mouseleave"===b?(f=e,g="mouseenter"===b?"mouseover":"mouseout",e=function(b){if(Z.DomEvent._checkMouse(a,b))return f(b)},a.addEventListener(g,e,!1)):"click"===b&&Z.Browser.android?(f=e,e=function(a){return Z.DomEvent._filterClick(a,f)},a.addEventListener(b,e,!1)):a.addEventListener(b,e,!1):"attachEvent"in a&&a.attachEvent("on"+b,e),a[i]=e,this))},removeListener:function(a,b,c){var d=Z.stamp(c),e="_leaflet_"+b+d,f=a[e];return f?(Z.Browser.pointer&&0===b.indexOf("touch")?this.removePointerListener(a,b,d):Z.Browser.touch&&"dblclick"===b&&this.removeDoubleTapListener?this.removeDoubleTapListener(a,d):"removeEventListener"in a?"mousewheel"===b?(a.removeEventListener("DOMMouseScroll",f,!1),a.removeEventListener(b,f,!1)):"mouseenter"===b||"mouseleave"===b?a.removeEventListener("mouseenter"===b?"mouseover":"mouseout",f,!1):a.removeEventListener(b,f,!1):"detachEvent"in a&&a.detachEvent("on"+b,f),a[e]=null,this):this},stopPropagation:function(a){return a.stopPropagation?a.stopPropagation():a.cancelBubble=!0,Z.DomEvent._skipped(a),this},disableScrollPropagation:function(a){var b=Z.DomEvent.stopPropagation;return Z.DomEvent.on(a,"mousewheel",b).on(a,"MozMousePixelScroll",b)},disableClickPropagation:function(a){for(var b=Z.DomEvent.stopPropagation,c=Z.Draggable.START.length-1;c>=0;c--)Z.DomEvent.on(a,Z.Draggable.START[c],b);return Z.DomEvent.on(a,"click",Z.DomEvent._fakeStop).on(a,"dblclick",b)},preventDefault:function(a){return a.preventDefault?a.preventDefault():a.returnValue=!1,this},stop:function(a){return Z.DomEvent.preventDefault(a).stopPropagation(a)},getMousePosition:function(a,b){if(!b)return new Z.Point(a.clientX,a.clientY);var c=b.getBoundingClientRect();return new Z.Point(a.clientX-c.left-b.clientLeft,a.clientY-c.top-b.clientTop)},getWheelDelta:function(a){var b=0;return a.wheelDelta&&(b=a.wheelDelta/120),a.detail&&(b=-a.detail/3),b},_skipEvents:{},_fakeStop:function(a){Z.DomEvent._skipEvents[a.type]=!0},_skipped:function(a){var b=this._skipEvents[a.type];return this._skipEvents[a.type]=!1,b},_checkMouse:function(a,b){var c=b.relatedTarget;if(!c)return!0;try{for(;c&&c!==a;)c=c.parentNode}catch(a){return!1}return c!==a},_getEvent:function(){var a=window.event;if(!a)for(var b=arguments.callee.caller;b&&(!(a=b.arguments[0])||window.Event!==a.constructor);)b=b.caller;return a},_filterClick:function(a,b){var c=a.timeStamp||a.originalEvent.timeStamp,d=Z.DomEvent._lastClick&&c-Z.DomEvent._lastClick;return d&&d>100&&d<500||a.target._simulatedClick&&!a._simulated?void Z.DomEvent.stop(a):(Z.DomEvent._lastClick=c,b(a))}},Z.DomEvent.on=Z.DomEvent.addListener,Z.DomEvent.off=Z.DomEvent.removeListener,Z.DomUtil={get:function(a){return"string"==typeof a?document.getElementById(a):a},getStyle:function(a,b){var c=a.style[b];if(!c&&a.currentStyle&&(c=a.currentStyle[b]),(!c||"auto"===c)&&document.defaultView){var d=document.defaultView.getComputedStyle(a,null);c=d?d[b]:null}return"auto"===c?null:c},getViewportOffset:function(a){var b,c=0,d=0,e=a,f=document.body,g=document.documentElement;do{if(c+=e.offsetTop||0,d+=e.offsetLeft||0,c+=parseInt(Z.DomUtil.getStyle(e,"borderTopWidth"),10)||0,d+=parseInt(Z.DomUtil.getStyle(e,"borderLeftWidth"),10)||0,b=Z.DomUtil.getStyle(e,"position"),e.offsetParent===f&&"absolute"===b)break;if("fixed"===b){c+=f.scrollTop||g.scrollTop||0,d+=f.scrollLeft||g.scrollLeft||0;break}if("relative"===b&&!e.offsetLeft){var h=Z.DomUtil.getStyle(e,"width"),i=Z.DomUtil.getStyle(e,"max-width"),j=e.getBoundingClientRect();"none"===h&&"none"===i||(d+=j.left+e.clientLeft),c+=j.top+(f.scrollTop||g.scrollTop||0);break}e=e.offsetParent}while(e);e=a;do{if(e===f)break;c-=e.scrollTop||0,d-=e.scrollLeft||0,e=e.parentNode}while(e);return new L.Point(d,c)},documentIsLtr:function(){return Z.DomUtil._docIsLtrCached||(Z.DomUtil._docIsLtrCached=!0,Z.DomUtil._docIsLtr="ltr"===Z.DomUtil.getStyle(document.body,"direction")),Z.DomUtil._docIsLtr},create:function(a,b,c){var d=document.createElement(a);return d.className=b,c&&c.appendChild(d),d},hasClass:function(a,b){if(void 0!==a.classList)return a.classList.contains(b);var c=Z.DomUtil._getClass(a);return c.length>0&&new RegExp("(^|\\s)"+b+"(\\s|$)").test(c)},addClass:function(a,b){if(void 0!==a.classList)for(var c=Z.Util.splitWords(b),d=0,e=c.length;d<e;d++)a.classList.add(c[d]);else if(!Z.DomUtil.hasClass(a,b)){var f=Z.DomUtil._getClass(a);Z.DomUtil._setClass(a,(f?f+" ":"")+b)}},removeClass:function(a,b){void 0!==a.classList?a.classList.remove(b):Z.DomUtil._setClass(a,Z.Util.trim((" "+Z.DomUtil._getClass(a)+" ").replace(" "+b+" "," ")))},_setClass:function(a,b){void 0===a.className.baseVal?a.className=b:a.className.baseVal=b},_getClass:function(a){return void 0===a.className.baseVal?a.className:a.className.baseVal},setOpacity:function(a,b){if("opacity"in a.style)a.style.opacity=b;else if("filter"in a.style){var c=!1,d="DXImageTransform.Microsoft.Alpha";try{c=a.filters.item(d)}catch(a){if(1===b)return}b=Math.round(100*b),c?(c.Enabled=100!==b,c.Opacity=b):a.style.filter+=" progid:"+d+"(opacity="+b+")"}},testProp:function(a){for(var b=document.documentElement.style,c=0;c<a.length;c++)if(a[c]in b)return a[c];return!1},getTranslateString:function(a){var b=Z.Browser.webkit3d,c="translate"+(b?"3d":"")+"(",d=(b?",0":"")+")";return c+a.x+"px,"+a.y+"px"+d},getScaleString:function(a,b){return Z.DomUtil.getTranslateString(b.add(b.multiplyBy(-1*a)))+" scale("+a+") "},setPosition:function(a,b,c){a._leaflet_pos=b,!c&&Z.Browser.any3d?a.style[Z.DomUtil.TRANSFORM]=Z.DomUtil.getTranslateString(b):(a.style.left=b.x+"px",a.style.top=b.y+"px")},getPosition:function(a){return a._leaflet_pos},disableTextSelection:function(){if("onselectstart"in document)Z.DomEvent.on(window,"selectstart",Z.DomEvent.preventDefault);else{var a=Z.DomUtil.testProp(["userSelect","WebkitUserSelect","OUserSelect","MozUserSelect","msUserSelect"]);if(a){var b=document.documentElement.style;this._userSelect=b[a],b[a]="none"}}},enableTextSelection:function(){if("onselectstart"in document)Z.DomEvent.off(window,"selectstart",Z.DomEvent.preventDefault);else{var a=Z.DomUtil.testProp(["userSelect","WebkitUserSelect","OUserSelect","MozUserSelect","msUserSelect"]);a&&(document.documentElement.style[a]=this._userSelect,delete this._userSelect)}},disableImageDrag:function(){Z.DomEvent.on(window,"dragstart",Z.DomEvent.preventDefault)},enableImageDrag:function(){Z.DomEvent.off(window,"dragstart",Z.DomEvent.preventDefault)},colorToGRBA:function(a,b){function c(a){return parseInt("0x"+a)}var d=a;if("number"==typeof b&&NaN!==b||(b=1),b=Math.min(1,Math.max(0,b)),"string"==typeof a){if(a.length>=7&&a.indexOf("#")>=0){a=a.substring(a.indexOf("#")+1);var e=(c(a.charAt(0))<<4)+c(a.charAt(1)),f=(c(a.charAt(2))<<4)+c(a.charAt(3)),g=(c(a.charAt(4))<<4)+c(a.charAt(5));d="rgba("+e+","+f+","+g+","+b+")"}else if(a.length>=8&&a.indexOf("0x")>=0){a=a.substring(a.indexOf("0x")+2);var e=(c(a.charAt(0))<<4)+c(a.charAt(1)),f=(c(a.charAt(2))<<4)+c(a.charAt(3)),g=(c(a.charAt(4))<<4)+c(a.charAt(5));d="rgba("+e+","+f+","+g+","+b+")"}}else if("number"==typeof a){var e=a>>16&255,f=a>>8&255,g=255&a;d="rgba("+e+","+f+","+g+","+b+")"}return d},isDom:function(a){return"object"==typeof HTMLElement?a instanceof HTMLElement:a&&"object"==typeof a&&1===a.nodeType&&"string"==typeof a.nodeName},getOffsetPoint:function(a){if(Z.DomUtil.isDom(a)){var b=a.offsetLeft,c=a.offsetTop;if(a.offsetParent){var d=Z.DomUtil.getOffsetPoint(a.offsetParent);b+=d.left,c+=d.top}return{left:b,top:c}}}},Z.DomUtil.TRANSFORM=Z.DomUtil.testProp(["transform","WebkitTransform","OTransform","MozTransform","msTransform"]),Z.DomUtil.TRANSITION=Z.DomUtil.testProp(["webkitTransition","transition","OTransition","MozTransition","msTransition"]),Z.DomUtil.TRANSITION_END="webkitTransition"===Z.DomUtil.TRANSITION||"OTransition"===Z.DomUtil.TRANSITION?Z.DomUtil.TRANSITION+"End":"transitionend";var eventsKey="_leaflet_events";Z.EventManager={addEventListener:function(a,b,c){if("object"==typeof a&&!(a instanceof Array)&&Z.Util.invokeEach(a,this.addEventListener,this,b,c))return this;var d,e,f,g,h,i,j,k=this[eventsKey]=this[eventsKey]||{},l=c&&c!==this&&Z.stamp(c);for("string"==typeof a&&(a=a.indexOf(" ")>=0?Z.Util.splitWords(a):[a]),d=0,e=a.length;d<e;d++)f={action:b,context:c||this},g=a[d],l?(h=g+"_idx",i=h+"_len",j=k[h]=k[h]||{},j[l]||(j[l]=[],k[i]=(k[i]||0)+1),j[l].push(f)):(k[g]=k[g]||[],k[g].push(f));return this},hasEventListeners:function(a){var b=this[eventsKey];return!!b&&(a in b&&b[a].length>0||a+"_idx"in b&&b[a+"_idx_len"]>0)},removeEventListener:function(a,b,c){if(!this[eventsKey])return this;if(!a)return this.clearAllEventListeners();if("object"==typeof a&&!(a instanceof Array)&&Z.Util.invokeEach(a,this.removeEventListener,this,b,c))return this;var d,e,f,g,h,i,j,k,l,m=this[eventsKey],n=c&&c!==this&&Z.stamp(c);for("string"==typeof a&&(a=a.indexOf(" ")>=0?Z.Util.splitWords(a):[a]),d=0,e=a.length;d<e;d++)if(f=a[d],i=f+"_idx",j=i+"_len",k=m[i],b){if(g=n&&k?k[n]:m[f]){for(h=g.length-1;h>=0;h--)g[h].action!==b||c&&g[h].context!==c||(l=g.splice(h,1),l[0].action=Z.Util.falseFn);c&&k&&0===g.length&&(delete k[n],m[j]--)}}else delete m[f],delete m[i],delete m[j];return this},clearAllEventListeners:function(){return delete this[eventsKey],this},fireEvent:function(a,b){if(!this.hasEventListeners(a))return this;var c,d,e,f,g,h=Z.Util.extend({},b,{type:a,target:this}),i=this[eventsKey];if(i[a])for(c=i[a].slice(),d=0,e=c.length;d<e;d++)c[d].action.call(c[d].context,h);f=i[a+"_idx"];for(g in f)if(c=f[g].slice())for(d=0,e=c.length;d<e;d++)c[d].action.call(c[d].context,h);return this},addOneTimeEventListener:function(a,b,c){if(Z.Util.invokeEach(a,this.addOneTimeEventListener,this,b,c))return this;var d=Z.bind(function(){this.removeEventListener(a,b,c).removeEventListener(a,d,c)},this);return this.addEventListener(a,b,c).addEventListener(a,d,c)}},Z.EventManager.on=Z.EventManager.addEventListener,Z.EventManager.off=Z.EventManager.removeEventListener,Z.EventManager.once=Z.EventManager.addOneTimeEventListener,Z.EventManager.fire=Z.EventManager.fireEvent,Z.LeafletUtil={latLngBoundsFromLeaflet:function(a){return Z.LatLngBounds.create(Z.LatLng.create(a.getSouthWest().lat,a.getSouthWest().lng),Z.LatLng.create(a.getNorthEast().lat,a.getNorthEast().lng))},latLngBoundsToLeaflet:function(a){return L.latLngBounds(L.latLng(a.getSouthWest().lat,a.getSouthWest().lng),L.latLng(a.getNorthEast().lat,a.getNorthEast().lng))},latLngToLeaflet:function(a){return L.latLng(a.lat,a.lng)},latLngFromLeaflet:function(a){return new Z.LatLng(a.lat,a.lng)},pointFromLeaflet:function(a){return new Z.Point(a.x,a.y)}},Z.ThreejsUtil={clearObject3D:function(a){for(var b=a.children(),c=0;c<b.length;c++)a.remove(b[c])},vector2GLPoint:function(a){return a=a||{},"number"!=typeof a.x||"number"!=typeof a.y?null:Z.Point.create(a.x,a.y,a.z)}},Z.GeometryUtil={transformPaths:function(a,b){if(!Z.Util.isArray(a))return null;var c=!(a instanceof Array&&a[0]instanceof Array),d=c||!(a[0][0]instanceof Array),e=d||!(a[0][0][0]instanceof Array),f=[];e?d?c||(f=[[a]]):f=[a]:f=a;for(var g,h,i=f.length,j=new Array(i),k=0;k<i;k++){g=f[k].length,j[k]=new Array(g);for(var l=0;l<g;l++){h=f[k][l].length,j[k][l]=new Array(h);for(var m=0;m<h;m++)if(f[k][l][m].length>1){var n=f[k][l][m],o=new Array(3),p=n[0],q=n[1],r=n.length>2?n[2]:void 0,s=b.transform(p,q,r);o[0]=s.x,o[1]=s.y,o[2]=s.z,j[k][l][m]=o}}}return e?d?c?void 0:j[0][0]:j[0]:j},transposePathsAxis:function(a,b,c,d){if(void 0===a||void 0===b||void 0===c||void 0===d)return a;if(!Z.Util.isArray(a))return null;var e=!(a instanceof Array&&a[0]instanceof Array),f=e||!(a[0][0]instanceof Array),g=f||!(a[0][0][0]instanceof Array),h=[];g?f?e||(h=[[a]]):h=[a]:h=a;for(var i,j,k=h.length,l=new Array(k),m=0;m<k;m++){i=h[m].length,l[m]=new Array(i);for(var n=0;n<i;n++){h[m][n];j=h[m][n].length,l[m][n]=new Array(j);for(var o=0;o<j;o++){var p=h[m][n][o];if(p.length>1){var q=new Array(3);q[0]=p[b],q[1]=p[c],q[2]=p.length>2?p[d]:void 0,l[m][n][o]=q}}}}return g?f?e?void 0:l[0][0]:l[0]:l},transformPoint:function(a,b){if(!a)return null;if(Array.isArray(a)){var c=b.transform(a[0],a[1],a[2]);return[c.x,c.y,c.z]}var c=b.transform(a.x,a.y,a.z);return{x:c.x,y:c.y,z:c.z}},getPathBounds:function(a,b){if(Z.Util.isArray(a)){var c=!(a instanceof Array&&a[0]instanceof Array),d=c||!(a[0][0]instanceof Array),e=d||!(a[0][0][0]instanceof Array),f=[];e?d?c||(f=[[a]]):f=[a]:f=a;for(var g,h,i,j,k,l,m,n,o=f.length,p=0;p<o;p++){g=f[p].length;for(var q=0;q<g;q++){h=f[p][q].length;for(var r=0;r<h;r++){var s=f[p][q][r];s.length>1&&(void 0===i?(i=k=s[0],j=l=s[1],m=n=s[2]):(i=Math.min(i,s[0]),k=Math.max(k,s[0]),j=Math.min(j,s[1]),l=Math.max(l,s[1]),m=Math.min(m,s[2]),n=Math.max(n,s[2])))}}}return void 0!==i?b?Z.LatLngBounds.create(Z.LatLng.create(j,i,m),Z.LatLng.create(l,k,n)):Z.LatLngBounds.create(Z.LatLng.create(i,j,m),Z.LatLng.create(k,l,n)):null}return null},convertPathToGeometry:function(a,b,c,d){var e,f=[];if(Z.Util.isArray(a)){var g,h,i,j,k=a.length;for(h=0;h<k;h++)if(a[h]instanceof Array){for(g=a[h].length,e=new THREE.Geometry,i=0;i<g;i++){var l=a[h][i];l instanceof Array&&l.length>1&&(j=d?new THREE.Vector3(l[0],l[1],l[2]):new THREE.Vector3(l[1],l[0],l[2]),b&&(j=c?b.call(c,j):b(j)),j instanceof THREE.Vector3&&e.vertices.push(j))}Z.GeometryUtil.isClockWise(e.vertices)&&e.vertices.reverse(),f.push(e)}}return f},convertPathToShapes:function(a,b,c,d,e,f,g){var h=!(a instanceof Array&&a[0]instanceof Array),i=h||!(a[0][0]instanceof Array),j=i||!(a[0][0][0]instanceof Array),k=[],l=[];e=e||0,f=f||0,j?i?h||(k=[[a]]):k=[a]:k=a;for(var m=0;m<k.length;m++){var n,o,p,q,r,s=[],t=[],u=k[m],v=u.length;for(p=0;p<v;p++){o=u[p].length,n=[];for(q=0;q<o;q++){var w=u[p][q];w.length<=1||(r=g?new THREE.Vector3(w[0]+e,w[1]+f):new THREE.Vector3(w[1]+e,w[0]+f),b&&(r=d?b.call(d,r):b(r)),r instanceof THREE.Vector3&&n.push(r))}if(n.length>2){var x=Z.GeometryUtil.isClockWise(n);0===c?s.length<=0?(x&&n.reverse(),s.push(n)):(x||n.reverse(),t.push(new THREE.Path(n))):(1===c&&n.reverse(),Z.GeometryUtil.isClockWise(n)?t.push(new THREE.Path(n)):s.push(n))}}if(s.length<1)t.length>0&&(console.info("请检查多边形的坐标顺序是否为顺时针"),console.info("bound："+JSON.stringify(s)),console.info("holes："+JSON.stringify(t)));else{for(var y=new THREE.Shape(s[0]),p=0;p<t.length;p++)y.holes.push(t[p]);l.push(y)}}return l},isClockWise:function(a){return Z.GeometryUtil.areaByCoordArray(a)<0},areaByCoordArray:function(a){for(var b=a.length,c=0,d=b-1,e=0;e<b;d=e++)a[d].x&&a[d].y&&a[e].x&&a[e].y?c+=a[d].x*a[e].y-a[e].x*a[d].y:a[d]instanceof Array&&a[d].length>0&&(c+=a[d][1]*a[e][0]-a[e][1]*a[d][0]);return.5*c}},Z.WktParser=function(){},Z.WktParser.wkt2Array=function(a){if(a){a=a.toLowerCase().replace(/\s+/," ");var b=a.match(/\-?[\d\.]+\s\-?[\d\.]+\s\-?[\d\.]+/),c=null;b&&b instanceof Array&&b.length>0?(c=/(\-?[\d\.]+)\s(\-?[\d\.])+\s(\-?[\d\.])+/g,a=a.replace(c,"[$2, $1, $3]")):(c=/(\-?[\d\.]+)\s(\-?[\d\.]+)/g,a=a.replace(c,"[$2, $1]"));var d={};return a.indexOf("multipoint")>=0?d.type="MultiPoint":a.indexOf("point")>=0?d.type="Point":a.indexOf("multipolyline")>=0?d.type="MultiPolyline":a.indexOf("polyline")>=0?d.type="Polyline":a.indexOf("multipolygon")>=0?d.type="MultiPolygon":a.indexOf("polygon")>=0&&(d.type="Polygon"),d.type?d.coords=Z.WktParser._getCoords(a.substring(d.type.length)):d=null,d}},Z.WktParser._getCoords=function(a){return a=a.replace(/\(/g,"["),a=a.replace(/\)/g,"]"),a=Z.Util.stringTrim(a),JSON.parse(a)},Z.Draggable=Z.Class.extend({includes:Z.EventManager,statics:{START:Z.Browser.touch?["touchstart","mousedown"]:["mousedown"],END:{mousedown:"mouseup",touchstart:"touchend",pointerdown:"touchend",MSPointerDown:"touchend"},MOVE:{mousedown:"mousemove",touchstart:"touchmove",pointerdown:"touchmove",MSPointerDown:"touchmove"}},initialize:function(a,b,c){this._element=a,this._dragStartTarget=b||a,this._moveElement=void 0===c||c},enable:function(){if(!this._enabled){for(var a=Z.Draggable.START.length-1;a>=0;a--)Z.DomEvent.on(this._dragStartTarget,Z.Draggable.START[a],this._onDown,this);this._enabled=!0}},disable:function(){if(this._enabled){for(var a=Z.Draggable.START.length-1;a>=0;a--)Z.DomEvent.off(this._dragStartTarget,Z.Draggable.START[a],this._onDown,this);this._enabled=!1,this._moved=!1}},_onDown:function(a){if(this._moved=!1,!a.shiftKey&&(1===a.which||1===a.button||a.touches)&&(Z.DomEvent.stopPropagation(a),!Z.Draggable._disabled&&(Z.DomUtil.disableImageDrag(),Z.DomUtil.disableTextSelection(),!this._moving))){var b=a.touches?a.touches[0]:a;this._startPoint=new Z.Point(b.clientX,b.clientY),this._startPos=this._newPos=this._getElementPosition(this._element),Z.DomEvent.on(document,Z.Draggable.MOVE[a.type],this._onMove,this).on(document,Z.Draggable.END[a.type],this._onUp,this)}},_onMove:function(a){if(a.touches&&a.touches.length>1)return void(this._moved=!0);var b=a.touches&&1===a.touches.length?a.touches[0]:a,c=new Z.Point(b.clientX,b.clientY),d=c.subtract(this._startPoint);(d.x||d.y)&&(Z.Browser.touch&&Math.abs(d.x)+Math.abs(d.y)<3||(Z.DomEvent.preventDefault(a),this._moved||(this.fire("dragstart",{startPoint:c.clone()}),this._moved=!0,this._startPos=this._getElementPosition(this._element).subtract(d),Z.DomUtil.addClass(document.body,"zmap-dragging"),this._lastTarget=a.target||a.srcElement),this._newPos=this._startPos.add(d),this._newPoint=c,this._moving=!0,Z.Util.cancelAnimFrame(this._animRequest),this._animRequest=Z.Util.requestAnimFrame(this._updatePosition,this,!0,this._dragStartTarget)))},_updatePosition:function(){this.fire("predrag"),this._moveElement&&Z.DomUtil.setPosition(this._element,this._newPos),this.fire("drag",{startPoint:this._startPoint.subtract(this._startPos),newPoint:this._newPoint.subtract(this._startPos)})},_onUp:function(a){Z.DomUtil.removeClass(document.body,"zmap-dragging"),this._lastTarget&&(this._lastTarget=null);for(var b in Z.Draggable.MOVE)Z.DomEvent.off(document,Z.Draggable.MOVE[b],this._onMove).off(document,Z.Draggable.END[b],this._onUp);if(Z.DomUtil.enableImageDrag(),Z.DomUtil.enableTextSelection(),this._moved&&this._moving){Z.Util.cancelAnimFrame(this._animRequest);try{this.fire("dragend",{distance:this._newPos.distanceTo(this._startPos),startPoint:this._startPoint.subtract(this._startPos),newPoint:this._newPoint.subtract(this._startPos)})}catch(a){var c=console||{};c.log=c.log||opera.postError,c.log&&c.log(a.message)}}else if(this._startPoint){var d=this._startPoint.subtract(this._startPos);this.fire("nodrag",{distance:0,startPoint:d,newPoint:d,originalUpEvent:a})}this._moving=!1},_getElementPosition:function(a){var b=a.getBoundingClientRect();return new Z.Point(b.left+a.clientLeft,b.top+a.clientTop)}}),Z.RightDraggable=Z.Class.extend({includes:Z.EventManager,statics:{START:Z.Browser.touch?["touchstart","mousedown"]:["mousedown"],END:{mousedown:"mouseup",touchstart:"touchend",pointerdown:"touchend",MSPointerDown:"touchend"},MOVE:{mousedown:"mousemove",touchstart:"touchmove",pointerdown:"touchmove",MSPointerDown:"touchmove"}},initialize:function(a,b,c){this._element=a,this._dragStartTarget=b||a,this._moveElement=void 0===c||c},enable:function(){if(!this._enabled){for(var a=Z.RightDraggable.START.length-1;a>=0;a--)Z.DomEvent.on(this._dragStartTarget,Z.RightDraggable.START[a],this._onDown,this);this._enabled=!0}},disable:function(){if(this._enabled){for(var a=Z.RightDraggable.START.length-1;a>=0;a--)Z.DomEvent.off(this._dragStartTarget,Z.RightDraggable.START[a],this._onDown,this);this._enabled=!1,this._moved=!1}},_onDown:function(a){if(this._moved=!1,!(a.shiftKey||2!==a.which&&2!==a.button)&&(Z.DomEvent.stopPropagation(a),this._enabled&&(Z.DomUtil.disableImageDrag(),Z.DomUtil.disableTextSelection(),!this._moving))){var b=a;this._startPoint=new Z.Point(b.clientX,b.clientY),this._startPos=this._newPos=this._getElementPosition(this._element),Z.DomEvent.on(document,Z.RightDraggable.MOVE[a.type],this._onMove,this).on(document,Z.RightDraggable.END[a.type],this._onUp,this)}},_onMove:function(a){var b=a,c=new Z.Point(b.clientX,b.clientY),d=c.subtract(this._startPoint);(d.x||d.y)&&(Z.DomEvent.preventDefault(a),this._moved||(this.fire("rightdragstart",{startPoint:c.clone()}),this._moved=!0,this._startPos=this._getElementPosition(this._element).subtract(d),this._lastTarget=a.target||a.srcElement),this._newPoint=c,this._moving=!0,this.fire("rightdrag",{startPoint:this._startPoint.subtract(this._startPos),newPoint:this._newPoint.subtract(this._startPos)}))},_onUp:function(a){this._lastTarget&&(this._lastTarget=null);for(var b in Z.RightDraggable.MOVE)Z.DomEvent.off(document,Z.RightDraggable.MOVE[b],this._onMove).off(document,Z.RightDraggable.END[b],this._onUp);if(Z.DomUtil.enableImageDrag(),Z.DomUtil.enableTextSelection(),this._moved&&this._moving){Z.Util.cancelAnimFrame(this._animRequest);try{this.fire("rightdragend",{offset:this._newPoint.subtract(this._startPoint),startPoint:this._startPoint.subtract(this._startPos),newPoint:this._newPoint.subtract(this._startPos)})}catch(a){var c=console||{};c.log=c.log||opera.postError,c.log&&c.log(a.message)}}else if(this._startPoint){var d=this._startPoint.subtract(this._startPos);this.fire("norightdrag",{offset:new Z.Point(0,0,0),startPoint:d,newPoint:d,originalUpEvent:a})}this._moving=!1},_getElementPosition:function(a){var b=Z.DomUtil.getPosition(a);if(!b||NaN===b.x||NaN===b.y){var c=a.offsetLeft,d=a.offsetTop;b=new Z.Point(c,d)}return b}}),Z.ImageTextureManager=function(){var a=[],b=10,c=0,d=function(a,b,d,e,f){var g=new Image;return g._src=b,g.addEventListener("load",function(e){a.image=g,a.needsUpdate=!0,THREE.Cache.add(b,g),c--,d instanceof Function&&d.call(f,a)},!1),g.addEventListener("error",function(b){c--,e instanceof Function&&e.call(f,a)},!1),g};return{createTexture:function(b,c,e,f,g){var h=new THREE.Texture(void 0,c),i=THREE.Cache.get(b);if(void 0!==i)e instanceof Function&&e.call(g,i),h.image=i,h.needsUpdate=!0;else{var j=d(h,b,e,f,g);a.unshift({texture:h,image:j})}return h},loadTextures:function(){for(var d=b-c;d>0&&a.length>0;){var e=a.pop();if(e){d--;var f=(e.texture,e.image);f.src=f._src}}}}}(),Z.ResourceCache=function(){function a(){var a=c(),b=null;return a?(b=a.getSingleInstance("CachedObjects"))||(a.registerSingleInstance("CachedObjects",{}),b=a.getSingleInstance("CachedObjects")):b=d,b}function b(){var a=c();a?a.registerSingleInstance("CachedObjects",{}):d=[]}function c(){var a=null;try{getCurrentMapContext&&(a=getCurrentMapContext())}catch(a){}return a}var d={};return{add:function(b,c){a()[b]=c},get:function(b){return a()[b]},remove:function(b){delete a()[b]},clear:function(){b()}}}(),Z.TileManager=function(){var a=[],b=10,c=0,d=function(a,b,d,e){if(a instanceof Image&&a._src){a._src;return a.addEventListener("load",function(d){c--,b instanceof Function&&b.call(e,a)},!1),a.addEventListener("error",function(b){c--,d instanceof Function&&d.call(e,a)},!1),a}},e=function(a){var b=new XMLHttpRequest,c=b;c.onreadystatechange=function(){4===c.readyState&&200===c.status&&(a.src=window.URL.createObjectURL(this.response))},b.open("get",a._src),c.responseType="blob",c.send(null)};return{pushImageByUrl:function(b,c,e,f){var g=new Image;return g._src=b,d(g,c,e,f),a.unshift(g),g},pushImageObject:function(b,c,e,f){return d(b,c,e,f),a.unshift(b),b},cancelImageLoad:function(a){a&&(a._loadingCanceled=!0)},clear:function(){a=[]},resort:function(b){a.sort(function(a,c){if(a._loadingCanceled||!a._src)return-1;var d=Math.abs(a._tilePoint.x-b.x)+Math.abs(a._tilePoint.y-b.y);return Math.abs(c._tilePoint.x-b.x)+Math.abs(c._tilePoint.y-b.y)-d})},loadImages:function(){for(var d=b-c;d>0&&a.length>0;){var f=a.pop();f&&!f._loadingCanceled&&f._src&&(d--,e(f),c++)}}}}(),Z.RenderMonitor=function(){var a=null,b=!1;return{update:function(){b||(a=new Stats,a.domElement.style.position="absolute",a.domElement.style.top="0px",a.domElement.style.right="0px",document.body.appendChild(a.domElement),b=!0),a.update()}}}(),Z.TaskSchedualer=function(){var a=[],b=30;return{pushTask:function(b){a.unshift(b)},cancelTask:function(b){if(b)for(var c=0;c<a.length;c++)b===a[c]&&a.splice(c,1)},clear:function(){a=[]},runTasks:function(){for(var c=0;c<b&&a.length>0;){var d=new Date,e=a.pop();try{e.run()}catch(a){"Function"==typeof e.error&&e.error()}c+=(new Date).getMilliseconds()-d.getMilliseconds()}}}}(),Z.OBJLoader=function(a){this.manager=void 0!==a?a:THREE.DefaultLoadingManager,this.materials=null,this.regexp={vertex_pattern:/^v\s+([\d|\.|\+|\-|e|E]+)\s+([\d|\.|\+|\-|e|E]+)\s+([\d|\.|\+|\-|e|E]+)/,normal_pattern:/^vn\s+([\d|\.|\+|\-|e|E]+)\s+([\d|\.|\+|\-|e|E]+)\s+([\d|\.|\+|\-|e|E]+)/,uv_pattern:/^vt\s+([\d|\.|\+|\-|e|E]+)\s+([\d|\.|\+|\-|e|E]+)/,face_vertex:/^f\s+(-?\d+)\s+(-?\d+)\s+(-?\d+)(?:\s+(-?\d+))?/,face_vertex_uv:/^f\s+(-?\d+)\/(-?\d+)\s+(-?\d+)\/(-?\d+)\s+(-?\d+)\/(-?\d+)(?:\s+(-?\d+)\/(-?\d+))?/,face_vertex_uv_normal:/^f\s+(-?\d+)\/(-?\d+)\/(-?\d+)\s+(-?\d+)\/(-?\d+)\/(-?\d+)\s+(-?\d+)\/(-?\d+)\/(-?\d+)(?:\s+(-?\d+)\/(-?\d+)\/(-?\d+))?/,face_vertex_normal:/^f\s+(-?\d+)\/\/(-?\d+)\s+(-?\d+)\/\/(-?\d+)\s+(-?\d+)\/\/(-?\d+)(?:\s+(-?\d+)\/\/(-?\d+))?/,object_pattern:/^[og]\s*(.+)?/,smoothing_pattern:/^s\s+(\d+|on|off)/,material_library_pattern:/^mtllib /,material_use_pattern:/^usemtl /}},Z.OBJLoader.prototype={constructor:Z.OBJLoader,load:function(a,b,c,d){var e=this,f=new THREE.XHRLoader(e.manager);f.setPath(this.path),f.load(a,function(a){b(e.parse(a))},c,d)},setPath:function(a){this.path=a},setMaterials:function(a){this.materials=a},_createParserState:function(){var a={objects:[],object:{},vertices:[],normals:[],uvs:[],materialLibraries:[],startObject:function(a,b){if(this.object&&!1===this.object.fromDeclaration)return this.object.name=a,void(this.object.fromDeclaration=!1!==b);this.object&&"function"==typeof this.object._finalize&&this.object._finalize();var c=this.object&&"function"==typeof this.object.currentMaterial?this.object.currentMaterial():void 0;if(this.object={name:a||"",fromDeclaration:!1!==b,geometry:{vertices:[],normals:[],uvs:[]},materials:[],smooth:!0,startMaterial:function(a,b){var c=this._finalize(!1);c&&(c.inherited||c.groupCount<=0)&&this.materials.splice(c.index,1);var d={index:this.materials.length,name:a||"",mtllib:Array.isArray(b)&&b.length>0?b[b.length-1]:"",smooth:void 0!==c?c.smooth:this.smooth,groupStart:void 0!==c?c.groupEnd:0,groupEnd:-1,groupCount:-1,inherited:!1,clone:function(a){return{index:"number"==typeof a?a:this.index,name:this.name,mtllib:this.mtllib,smooth:this.smooth,groupStart:this.groupEnd,groupEnd:-1,groupCount:-1,inherited:!1}}};return this.materials.push(d),d},currentMaterial:function(){if(this.materials.length>0)return this.materials[this.materials.length-1]},_finalize:function(a){var b=this.currentMaterial();return b&&-1===b.groupEnd&&(b.groupEnd=this.geometry.vertices.length/3,b.groupCount=b.groupEnd-b.groupStart,b.inherited=!1),!1!==a&&0===this.materials.length&&this.materials.push({name:"",smooth:this.smooth}),b}},c&&c.name&&"function"==typeof c.clone){var d=c.clone(0);d.inherited=!0,this.object.materials.push(d)}this.objects.push(this.object)},finalize:function(){this.object&&"function"==typeof this.object._finalize&&this.object._finalize()},parseVertexIndex:function(a,b){var c=parseInt(a,10);return 3*(c>=0?c-1:c+b/3)},parseNormalIndex:function(a,b){var c=parseInt(a,10);return 3*(c>=0?c-1:c+b/3)},parseUVIndex:function(a,b){var c=parseInt(a,10);return 2*(c>=0?c-1:c+b/2)},addVertex:function(a,b,c){var d=this.vertices,e=this.object.geometry.vertices;e.push(d[a+0]),e.push(d[a+1]),e.push(d[a+2]),e.push(d[b+0]),e.push(d[b+1]),e.push(d[b+2]),e.push(d[c+0]),e.push(d[c+1]),e.push(d[c+2])},addVertexLine:function(a){var b=this.vertices,c=this.object.geometry.vertices;c.push(b[a+0]),c.push(b[a+1]),c.push(b[a+2])},addNormal:function(a,b,c){var d=this.normals,e=this.object.geometry.normals;e.push(d[a+0]),e.push(d[a+1]),e.push(d[a+2]),e.push(d[b+0]),e.push(d[b+1]),e.push(d[b+2]),e.push(d[c+0]),e.push(d[c+1]),e.push(d[c+2])},addUV:function(a,b,c){var d=this.uvs,e=this.object.geometry.uvs;e.push(d[a+0]),e.push(d[a+1]),e.push(d[b+0]),e.push(d[b+1]),e.push(d[c+0]),e.push(d[c+1])},addUVLine:function(a){var b=this.uvs,c=this.object.geometry.uvs;c.push(b[a+0]),c.push(b[a+1])},addFace:function(a,b,c,d,e,f,g,h,i,j,k,l){var m,n=this.vertices.length,o=this.parseVertexIndex(a,n),p=this.parseVertexIndex(b,n),q=this.parseVertexIndex(c,n);if(void 0===d?this.addVertex(o,p,q):(m=this.parseVertexIndex(d,n),this.addVertex(o,p,m),this.addVertex(p,q,m)),void 0!==e){var r=this.uvs.length;o=this.parseUVIndex(e,r),p=this.parseUVIndex(f,r),q=this.parseUVIndex(g,r),void 0===d?this.addUV(o,p,q):(m=this.parseUVIndex(h,r),this.addUV(o,p,m),this.addUV(p,q,m))}if(void 0!==i){var s=this.normals.length;o=this.parseNormalIndex(i,s),p=i===j?o:this.parseNormalIndex(j,s),q=i===k?o:this.parseNormalIndex(k,s),void 0===d?this.addNormal(o,p,q):(m=this.parseNormalIndex(l,s),this.addNormal(o,p,m),this.addNormal(p,q,m))}},addLineGeometry:function(a,b){this.object.geometry.type="Line";for(var c=this.vertices.length,d=this.uvs.length,e=0,f=a.length;e<f;e++)this.addVertexLine(this.parseVertexIndex(a[e],c));for(var g=0,f=b.length;g<f;g++)this.addUVLine(this.parseUVIndex(b[g],d))}};return a.startObject("",!1),a},parse:function(a){console.time("OBJLoader");var b=this._createParserState();-1!==a.indexOf("\r\n")&&(a=a.replace("\r\n","\n"));for(var c=a.split("\n"),d="",e="",f="",g=[],h="function"==typeof"".trimLeft,i=0,j=c.length;i<j;i++)if(d=c[i],d=h?d.trimLeft():d.trim(),0!==d.length&&"#"!==(e=d.charAt(0)))if("v"===e)if(" "===(f=d.charAt(1))&&null!==(g=this.regexp.vertex_pattern.exec(d)))b.vertices.push(parseFloat(g[1]),parseFloat(g[2]),parseFloat(g[3]));else if("n"===f&&null!==(g=this.regexp.normal_pattern.exec(d)))b.normals.push(parseFloat(g[1]),parseFloat(g[2]),parseFloat(g[3]));else{if("t"!==f||null===(g=this.regexp.uv_pattern.exec(d)))throw new Error("Unexpected vertex/normal/uv line: '"+d+"'");b.uvs.push(parseFloat(g[1]),parseFloat(g[2]))}else if("f"===e)if(null!==(g=this.regexp.face_vertex_uv_normal.exec(d)))b.addFace(g[1],g[4],g[7],g[10],g[2],g[5],g[8],g[11],g[3],g[6],g[9],g[12]);else if(null!==(g=this.regexp.face_vertex_uv.exec(d)))b.addFace(g[1],g[3],g[5],g[7],g[2],g[4],g[6],g[8]);else if(null!==(g=this.regexp.face_vertex_normal.exec(d)))b.addFace(g[1],g[3],g[5],g[7],void 0,void 0,void 0,void 0,g[2],g[4],g[6],g[8]);else{if(null===(g=this.regexp.face_vertex.exec(d)))throw new Error("Unexpected face line: '"+d+"'");b.addFace(g[1],g[2],g[3],g[4])}else if("l"===e){var k=d.substring(1).trim().split(" "),l=[],m=[];if(-1===d.indexOf("/"))l=k;else for(var n=0,o=k.length;n<o;n++){var p=k[n].split("/");""!==p[0]&&l.push(p[0]),""!==p[1]&&m.push(p[1])}b.addLineGeometry(l,m)}else if(null!==(g=this.regexp.object_pattern.exec(d))){var q=g[0].substr(1).trim();b.startObject(q)}else if(this.regexp.material_use_pattern.test(d))b.object.startMaterial(d.substring(7).trim(),b.materialLibraries);else if(this.regexp.material_library_pattern.test(d))b.materialLibraries.push(d.substring(7).trim());else{if(null===(g=this.regexp.smoothing_pattern.exec(d))){if("\0"===d)continue;throw new Error("Unexpected line: '"+d+"'")}var r=g[1].trim().toLowerCase();b.object.smooth="1"===r||"on"===r;var s=b.object.currentMaterial();s&&(s.smooth=b.object.smooth)}return b.finalize(),this.buildMesh(b)},buildMesh:function(a){var b=[];b.materialLibraries=[].concat(a.materialLibraries);for(var c=0,d=a.objects.length;c<d;c++){var e=a.objects[c],f=e.geometry,g=e.materials,h="Line"===f.type;if(0!==f.vertices.length){for(var i={position:f.vertices,normal:f.normals,uv:f.uvs,groups:[]},j=[],k=0,l=g.length;k<l;k++){var m=g[k],n=null;null!==this.materials&&(n=this.materials.materialsInfo[m.name]),j.push({name:m.name,shading:m.smooth,matInfo:n})}if(j.length>1)for(var k=0,l=g.length;k<l;k++){var m=g[k];i.groups.push({start:m.groupStart,count:m.groupCount,materialIndex:k})}b.push({geometry:i,materials:j,name:e.name,isLine:h})}}return console.timeEnd("OBJLoader"),b}},Z.GraphicAnimation=function(){var a=[],b=2;return{animateZValueByStep:function(b,c,d,e,f,g){a.push({graphic:b,step:c,startValue:d,endValue:e,tempValue:d,callback:f,callbackScope:g})},run:function(){for(var c=[],d=0;d<a.length&&d<b;d++){var e=a[d],f=e.graphic,g=e.tempValue,h=e.step,i=e.endValue,j=e.callback,k=e.callbackScope;g+=h,g>=i?(f.scale.set(1,1,i),c.push(d),j&&j.call(k,f)):(e.tempValue=g,f.scale.set(1,1,g))}for(var l=c.length-1;l>=0;l--)a.splice(c[l],1)}}}(),Z.AjaxRequest=function(){function a(a,b,c,d){var e=new XMLHttpRequest;return e.onreadystatechange=function(){4===e.readyState&&b(e)},e.onerror=function(){c(e)},e.open("GET",a),d&&e.setRequestHeader("Content-Type",d),e.send(null),{abort:function(){e.abort()}}}return{getText:function(b,c,d){return a(b,function(a){void 0!==a.responseText&&c.call(d,a.responseText)},function(a){console.warn("ajax request failed"),c.call(d,"")})},getXML:function(b,c,d){return a(b,function(a){void 0!==a.responseXML&&c.call(d,a.responseXML)},function(a){console.warn("ajax request failed"),c.call(d,null)})},getJSON:function(b,c,d,e){return a(b,function(a){if(a.responseText){var e;try{e=JSON.parse(a.responseText)}catch(a){console.warn("Could not parse JSON from "+b+"\n"+a.message)}c.call(d,e),e=null}},function(a){console.warn("ajax request failed"),c.call(d,"")},e)},destroy:function(){}}}(),Z.JSONPRequest=function(){function a(a){var b=document.createElement("script");return b.setAttribute("type","text/javascript"),b.src=a,document.body.appendChild(b),b}function b(a){var b=g[a];b&&document.body.removeChild(b)}function c(b,c,e){var i=f();d(i,h(i,c,e)),g[i]=a(b+"?callback=jsonpCallbackTest")}function d(a,b){Z.JSONPRequest.osmbuildingCallback[a]=b}function e(a){Z.JSONPRequest.osmbuildingCallback[a]&&delete Z.JSONPRequest.osmbuildingCallback[a]}function f(){var a=new Date;return a.getFullYear().toString()+(a.getMonth()+1)+a.getDate()+a.getHours()+a.getMinutes()+a.getSeconds()+i++}var g=null,h=function(a,c,d){return function(f){b(a),e(a),c.call(d,f)}},i=0;return{getJSON:function(a,b,d){return c(a,b,d)},destroy:function(){}}}(),Z.JSONPRequest.osmbuildingCallback={},Z.CompressOBJLoader=function(a,b){this.encoded=a,this.zip=b,this.vertices=[],this.normals=[],this.textures=[],this.material={},this.meshes=[],this.state={}},Z.CompressOBJLoader.prototype={decodeForInt:function(a){return this.encoded?parseInt(a,36):parseInt(a)},decodeForFloatTail:function(a){var b=parseInt(a,36)+"",c="";if(b.length<4){for(var d=0;d<4-b.length;++d)c+="0";c+=b}else c=b;return c},decodeForDecimal:function(a){var b=this;if(!b.encoded)return parseFloat(a);var b=this,c=a,d="";"-"==c[0]&&(d+="-",c=a.substring(1));var e=c.split(".");return d+=b.decodeForInt(e[0]),d+=".",d+=b.decodeForFloatTail(e[1]),parseFloat(d)},decode:function(a){var b=this;return"+"==a[0]?parseFloat(a.substring(1)):a.indexOf(".")>=0?b.decodeForDecimal(a):b.decodeForInt(a)},adapt2Three:function(){var a=this,b=a.meshes,c={};a.state=c,c.objects=[];for(var d=0;d<b.length;++d){var e=b[d],f={};f.name=e.name,f.geometry={},f.materials=[],f.geometry.position=[],f.geometry.normal=[],f.geometry.uv=[],f.geometry.groups=[],c.objects.push(f);for(var g=0,h=0;h<e.groups.length;++h){var i=e.groups[h],j={name:i.material,matInfo:a.material[i.material]};f.materials.push(j),f.geometry.groups.push({count:3*i.face.length,materialIndex:f.materials.length-1,start:g}),g+=3*i.face.length;for(var k=0;k<i.face.length;++k){for(var l=i.face[k],m=0;m<l.v.length;++m){var n=l.v[m];f.geometry.position.push(a.vertices[n].x),f.geometry.position.push(a.vertices[n].y),f.geometry.position.push(a.vertices[n].z)}if(a.normals.length>0)for(var o=0;o<l.n.length;++o){var p=l.n[o];f.geometry.normal.push(a.normals[p].x),f.geometry.normal.push(a.normals[p].y),f.geometry.normal.push(a.normals[p].z)}for(var q=0;q<l.t.length;++q){var r=l.t[q];f.geometry.uv.push(a.textures[r].u),f.geometry.uv.push(a.textures[r].v)}}}}},paseVertex:function(a,b,c){for(var d=this,e=b;e<b+c;++e)for(var f=a[e],g=f.split(";"),h=d.decode(g[0]),i=1;i<g.length;++i)for(var j=g[i],k=j.split(" "),l=d.decode(k[0]),m=1;m<k.length;++m){var n=d.decode(k[m]),o={x:n,y:l,z:h};d.vertices.push(o)}return b+c},paseNormal:function(a,b,c){for(var d=this,e=b;e<b+c;++e)for(var f=a[e],g=f.split(";"),h=d.decode(g[0]),i=1;i<g.length;++i)for(var j=g[i],k=j.split(" "),l=d.decode(k[0]),m=1;m<k.length;++m){var n=d.decode(k[m]),o={x:n,y:l,z:h};d.normals.push(o)}return b+c},paseTexture:function(a,b,c){for(var d=this,e=b;e<b+c;++e)for(var f=a[e],g=f.split(";"),h=d.decode(g[0]),i=1;i<g.length;++i)for(var j=g[i],k=j.split(" "),l=d.decode(k[0]),m=1;m<k.length;++m){var n=d.decode(k[m]),o={u:n,v:l,w:h};d.textures.push(o)}return b+c},paseGroup:function(a,b,c,d){var e=this,f=0,g={};e.meshes.push(g),g.name=c;for(var h=g.groups=[],i=0;i<d;++i){var j=a[b],k=j.split(" ");if("UM"==k[0]){var l=e.decode(k[2]),m=e.decode(k[1]),n=k[3].split("/"),o=e.decode(n[0]),p=e.decode(n[2]),q=e.decode(n[1]),r={};h.push(r),r.material=m,r.face=[],++b,f=b+l;for(var s=b;s<f;++s){var t=a[s];void 0===t&&console.log("");var u=t.split(" ");if(3==u.length){var v={};v.v=[],v.n=[],v.t=[];for(var w=0;w<u.length;++w){var x=u[w],y=x.split("/"),z=e.decode(y[0])+o,A=e.decode(y[1])+q,B=e.decode(y[2])+p;v.v.push(z),v.n.push(A),v.t.push(B)}r.face.push(v)}else if(4==u.length){for(var C=[],D=[],E=[],w=0;w<u.length;++w){var x=u[w],y=x.split("/"),z=e.decode(y[0])+o,A=e.decode(y[1])+q,B=e.decode(y[2])+p;C.push(z),D.push(A),E.push(B)}var F={};F.v=[],F.n=[],F.t=[],F.v.push(C[0]),F.v.push(C[1]),F.v.push(C[3]),F.n.push(D[0]),F.n.push(D[1]),F.n.push(D[3]),F.t.push(E[0]),F.t.push(E[1]),F.t.push(E[3]),r.face.push(F);var G={};G.v=[],G.n=[],G.t=[],G.v.push(C[1]),G.v.push(C[2]),G.v.push(C[3]),G.n.push(D[1]),G.n.push(D[2]),G.n.push(D[3]),G.t.push(E[1]),G.t.push(E[2]),G.t.push(E[3]),r.face.push(G)}}b=f}}return f-1},paseMtl:function(a,b,c,d){for(var e=this,f=[],g=[],h={},i={},j=b+c,k=b+c+d,l=b;l<j;++l){var m=a[l],n=m.split(","),o=n[0].toLowerCase();g.push(o),f.push(parseInt(n[1]));for(var p=2;p<n.length;++p)h.hasOwnProperty(o)||(h[o]=[]),h[o].push(n[p])}for(var q=b+c;q<k;++q){for(var r=a[q],s=r.split(" "),t=q-b-c,u={name:t+""},v=0;v<s.length;++v)if("#"!=s[v]){var w=parseInt(s[v]),x=f[v];if(x>1){u[g[v]]=[];for(var y=0;y<x;++y){var z=w*x+y,A=h[g[v]][z];u[g[v]].push(A)}}else u[g[v]]=h[g[v]][w]}i[t]=u}return e.material=i,k},parse:function(a){var b=this,c="MTL";-1!==a.indexOf("\r\n")&&(a=a.replace(/\r\n/g,"\n"));var d=a.split("\n"),e="",f=0;e=d[f];var g=e.split(" ");if(g[0]==c&&(f=b.paseMtl(d,f+1,parseInt(g[1]),parseInt(g[2]))),e=d[f],"VD"==e&&(f+=1,e=d[f],g=e.split(" "),"V"==g[0]&&(f=b.paseVertex(d,f+1,parseInt(g[1]))),e=d[f],g=e.split(" "),"N"==g[0]&&(f=b.paseNormal(d,f+1,parseInt(g[1]))),e=d[f],g=e.split(" "),"T"==g[0]&&(f=b.paseTexture(d,f+1,parseInt(g[1])))),e=d[f],g=e.split(" "),"VF"==g[0])for(var h=b.decode(g[1]),i=0;i<h;++i)f+=1,e=d[f],g=e.split(" "),"G"==g[0]&&(f=b.paseGroup(d,f+1,g[1],b.decode(g[2])))},noCompressLoad:function(a,b,c,d){var e=(new Date).getTime();void 0===a&&(a=""),void 0!==this.path&&(a=this.path+a);var f=this,g=new XMLHttpRequest;g.open("GET",a,!0),g.addEventListener("load",function(a){var c=a.target.response;if(200===this.status){f.parse(c);f.adapt2Three();b&&b(f);var g=(new Date).getTime();console.log("during:"+(g-e))}else 0===this.status?(console.warn("BaseLoader: HTTP Status 0 received."),b&&b(c)):d&&d(a)},!1),void 0!==c&&g.addEventListener("progress",function(a){c(a)},!1),g.addEventListener("error",function(a){d&&d(a)},!1),void 0!==this.responseType&&(g.responseType=this.responseType),void 0!==this.withCredentials&&(g.withCredentials=this.withCredentials),g.overrideMimeType&&g.overrideMimeType(void 0!==this.mimeType?this.mimeType:"text/plain");for(var h in this.requestHeader)g.setRequestHeader(h,this.requestHeader[h]);return g.send(null),g},load:function(a,b,c,d,e){var f=this;if(!this.zip)return void f.noCompressLoad(a,b,c,d);var g=(new Date).getTime();JSZipUtils.getBinaryContent(a,function(a,c){if(a)throw a;var d=(new Date).getTime();JSZip.loadAsync(c).then(function(a){var c=null;if(e)c=a.file(e);else for(var h in a.files)if(a.files[h]){c=a.files[h];break}if(c)c.async("string").then(function(a){f.parse(a);var c=(f.adapt2Three(),(new Date).getTime());console.log("decompress:"+(c-d)),b&&b(f);var e=(new Date).getTime();console.log("during:"+(e-g))});else{var i=(new Date).getTime();console.log("decompress:"+(i-d)),b&&b(f);var j=(new Date).getTime();console.log("during:"+(j-g))}})})}};var DefaultZMapConfig={center:{x:100,y:30},bounds:{minx:80,miny:20,maxx:130,maxy:50},maxBounds:{minx:-180,miny:-90,maxx:180,maxy:90},crs:"EPSG4326",initZoom:6,minZoom:1,maxZoom:18,selectionMutex:!0,showFrameRate:!1,pyramidId:"TDT",pyramidDefine:null,sceneType:"2D",sceneConfig:{miniMap:!1,miniMapLayer:[{type:"TDTVector",url:"",params:{},minZoom:1,maxZoom:18,label:"天地图矢量底图",bounds:{}}],baseLayer:[],baseOverLayer:[],zoomSlider:"small",scaleControl:!1}},OSMConfig={MATERIAL_COLORS:{brick:"#cc7755",bronze:"#ffeecc",canvas:"#fff8f0",concrete:"#999999",copper:"#a0e0d0",glass:"#e8f8f8",gold:"#ffcc00",plants:"#009933",metal:"#aaaaaa",panel:"#fff8f0",plaster:"#999999",roof_tiles:"#f08060",silver:"#cccccc",slate:"#666666",stone:"#996666",tar_paper:"#333333",wood:"#deb887"},BASE_MATERIALS:{asphalt:"tar_paper",bitumen:"tar_paper",block:"stone",bricks:"brick",glas:"glass",glassfront:"glass",grass:"plants",masonry:"stone",granite:"stone",panels:"panel",paving_stones:"stone",plastered:"plaster",rooftiles:"roof_tiles",roofingfelt:"tar_paper",sandstone:"stone",sheet:"canvas",sheets:"canvas",shingle:"tar_paper",shingles:"tar_paper",slates:"slate",steel:"metal",tar:"tar_paper",tent:"canvas",thatch:"plants",tile:"roof_tiles",tiles:"roof_tiles"}};Z.Globe={},Z.Globe.Layer={layerGroupSize:1e3},Z.Globe.TDTProxy="https://t0.tianditu.gov.cn",Z.Globe.Building={METERS_PER_LEVEL:3,DEFAULT_HEIGHT:10,DEFAULT_ROOF_HEIGHT:3};var ZMapConfig={center:{x:100,y:30},bounds:{minx:80,miny:20,maxx:130,maxy:50},maxBounds:{minx:80,miny:20,maxx:130,maxy:50},crs:"EPSG4326",initZoom:1,minZoom:6,maxZoom:18,selectionMutex:!0,showFrameRate:!1,pyramidId:"OSM",sceneType:"2D",sceneConfig:{miniMap:!1,miniMapLayer:[{type:"TDTVector",url:"",params:{},minZoom:1,maxZoom:18,label:"天地图矢量底图",bounds:{}}],baseLayer:[],baseOverLayer:[],zoomSlider:"small",scaleControl:!1}},mapContextObject=null,getCurrentMapContext=function(){return mapContextObject},ZMapContext=function(){this._singleInstanceConfig={SingleTerrainPlane:new Z.SurfacePlane}};ZMapContext.prototype.registerSingleInstance=function(a,b){void 0!==a&&null!==a&&(this._singleInstanceConfig[a]=b)},ZMapContext.prototype.unregisterSingleInstance=function(a){this._singleInstanceConfig[a]&&delete this._singleInstanceConfig[a]},ZMapContext.prototype.getSingleInstance=function(a){return this._singleInstanceConfig[a]};var ZMapContextManager={};ZMapContextManager.createContext=function(){var a=new ZMapContext;return{execute:function(b,c,d){b instanceof Function&&(mapContextObject=a,c?b.apply(c,d):b(d))}}},Z.Point=function(a,b,c,d){this.x="number"!=typeof a||isNaN(a)?0:d?Math.round(a):a,this.y="number"!=typeof b||isNaN(b)?0:d?Math.round(b):b,this.z="number"!=typeof c||isNaN(c)?0:d?Math.round(c):c,this.type="point",this.tolerance=1e-8},Z.Point.create=function(a,b,c,d){if(a instanceof Z.Point)return a;if(Z.Util.isArray(a))return a.length<2?null:new Z.Point(a[0],a[1],a[2]);if(void 0===a||null===a)return a;if("object"==typeof a&&"x"in a&&"y"in a){var e=isNaN(parseFloat(a.x))?0:parseFloat(a.x),f=isNaN(parseFloat(a.y))?0:parseFloat(a.y);return new Z.Point(e,f,a.z,d)}return new Z.Point(a,b,c,d)},Z.Point.prototype={clone:function(){return new Z.Point(this.x,this.y,this.z)},add:function(a){return this.clone()._add(Z.Point.create(a))},_add:function(a){return this.x+=a.x,this.y+=a.y,this.z+=a.z,this},subtract:function(a){return this.clone()._subtract(Z.Point.create(a))},_subtract:function(a){return this.x-=a.x,this.y-=a.y,this.z-=a.z,this},divideBy:function(a){return this.clone()._divideBy(a)},_divideBy:function(a){return this.x/=a,this.y/=a,this.z/=a,this},multiplyBy:function(a){return this.clone()._multiplyBy(a)},_multiplyBy:function(a){return this.x*=a,this.y*=a,this.z*=a,this},round:function(){return this.clone()._round()},_round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this},floor:function(){return this.clone()._floor()},_floor:function(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this},distanceTo:function(a){a=Z.Point.create(a);var b=a.x-this.x,c=a.y-this.y;return z=a.z-this.z,Math.sqrt(b*b+c*c+z*z)},equals:function(a,b){return a=Z.Point.create(a),b=b||this.tolerance,a&&a.x-this.x<b&&a.y-this.y<b&&a.z-this.z<b},contains:function(a){return a=Z.Point.create(a),Math.abs(a.x)<=Math.abs(this.x)&&Math.abs(a.y)<=Math.abs(this.y)&&Math.abs(a.z)<=Math.abs(this.z)},toString:function(){return"Point("+Z.Util.formatNum(this.x)+", "+Z.Util.formatNum(this.y)+", "+Z.Util.formatNum(this.z)+")"}},Z.LatLng=function(a,b,c,d){if(a=parseFloat(a),b=parseFloat(b),isNaN(a)||isNaN(b))throw new Error("Invalid LatLng object: ("+a+", "+b+")");this.lat=a,this.lng=b,void 0!==c&&(this.alt=parseFloat(c)),this.crs=d||null,this.type="latlng"},Z.LatLng.create=function(a,b,c){if(a instanceof Z.LatLng)return a;if(Z.Util.isArray(a))return"number"==typeof a[0]||"string"==typeof a[0]?new Z.LatLng(a[0],a[1],a[2]):null;if(void 0===a||null===a)return a;if("object"==typeof a&&"lat"in a){var d=new Z.LatLng(a.lat,"lng"in a?a.lng:a.lon);return isNaN(a.alt)||(d.alt=a.alt),d}return void 0===b?null:new Z.LatLng(a,b,c)},Z.extend(Z.LatLng,{DEG_TO_RAD:Math.PI/180,RAD_TO_DEG:180/Math.PI,MAX_MARGIN:1e-9}),Z.LatLng.prototype={clone:function(){return new Z.LatLng(this.lat,this.lng,this.alt,this.crs)},equals:function(a){if(!a)return!1;if(a.crs&&this.crs&&a.crs!==this.crs)return!1;a=Z.LatLng.create(a);var b=Math.max(Math.abs(this.lat-a.lat),Math.abs(this.lng-a.lng));return isNaN(this.alt)||isNaN(a.alt)||(b=Math.max(b,Math.abs(this.alt-a.alt))),b<=Z.LatLng.MAX_MARGIN},add:function(a){return this.clone()._add(Z.LatLng.create(a))},_add:function(a){return this.lat+=a.lat,this.lng+=a.lng,this.alt+=a.alt,this},subtract:function(a){return this.clone()._subtract(Z.LatLng.create(a))},_subtract:function(a){return a&&(this.lat-=a.lat,this.lng-=a.lng,this.alt-=a.alt),this},toString:function(a){return"LatLng("+Z.Util.formatNum(this.lat,a)+", "+Z.Util.formatNum(this.lng,a)+", "+Z.Util.formatNum(this.alt,a)+")"}},Z.Bounds=function(a,b){if(a){for(var c=b?[a,b]:a,d=0,e=c.length;d<e;d++)this.extend(c[d]);this.type="bounds",this.tolerance=1e-8}},Z.Bounds.create=function(a,b){return!a||a instanceof Z.Bounds?a:new Z.Bounds(a,b)},Z.Bounds.prototype={clone:function(){var a=this.min?this.min.clone():null,b=this.max?this.max.clone():null;return new Z.Bounds(a,b)},extend:function(a){return a=Z.Point.create(a),this.min||this.max?(this.min.x=Math.min(a.x,this.min.x),this.max.x=Math.max(a.x,this.max.x),this.min.y=Math.min(a.y,this.min.y),this.max.y=Math.max(a.y,this.max.y),this.min.z=Math.min(a.z,this.min.z),this.max.z=Math.max(a.z,this.max.z)):(this.min=a.clone(),this.max=a.clone()),this},getCenter:function(a){return new Z.Point((this.min.x+this.max.x)/2,(this.min.y+this.max.y)/2,(this.min.z+this.max.z)/2,a)},getBottomLeft:function(){return new Z.Point(this.min.x,this.max.y,this.min.z)},getTopRight:function(){return new Z.Point(this.max.x,this.min.y,this.max.z)},getSize:function(){return this.max.subtract(this.min)},contains:function(a){var b,c;return a="number"==typeof a[0]||a instanceof Z.Point?Z.Point.create(a):Z.Bounds.create(a),a instanceof Z.Bounds?(b=a.min,c=a.max):b=c=a,b.x>=this.min.x&&c.x<=this.max.x&&b.y>=this.min.y&&c.y<=this.max.y&&b.z>=this.min.z&&c.z<=this.max.z},intersects:function(a){a=Z.Bounds.create(a);var b=this.min,c=this.max,d=a.min,e=a.max,f=e.x>=b.x&&d.x<=c.x,g=e.y>=b.y&&d.y<=c.y,h=e.z>=b.z&&d.z<=c.z;return f&&g&&h},isValid:function(){return!(!this.min||!this.max)},equals:function(a,b){if(!(a instanceof Z.Bounds))return!1;var c=!1,d=this.getBottomLeft(),e=this.getTopRight(),f=a.getBottomLeft(),g=a.getTopRight();return d.equals(f,b)&&e.equals(g,b)&&(c=!0),c}},Z.LatLngBounds=function(a,b){if(a){for(var c=b?[a,b]:a,d=0,e=c.length;d<e;d++)this.extend(c[d]);this.type="latlngbounds"}},Z.LatLngBounds.create=function(a,b){return!a||a instanceof Z.LatLngBounds?a:Z.Util.isArray(a)&&a.length>1&&!b?new Z.LatLngBounds(a[0],a[1]):new Z.LatLngBounds(a,b)},Z.LatLngBounds.prototype={clone:function(){return new Z.LatLngBounds(this._southWestLower,this._northEastUpper)},extend:function(a){if(!a)return this;var b=Z.LatLng.create(a);return a=null!==b?b:Z.LatLngBounds.create(a),a instanceof Z.LatLng?this._southWestLower||this._northEastUpper?(this._southWestLower.lat=Math.min(a.lat,this._southWestLower.lat),this._southWestLower.lng=Math.min(a.lng,this._southWestLower.lng),this._northEastUpper.lat=Math.max(a.lat,this._northEastUpper.lat),this._northEastUpper.lng=Math.max(a.lng,this._northEastUpper.lng),isNaN(a.alt)||(this._southWestLower.alt=isNaN(this._southWestLower.alt)?a.alt:Math.min(a.alt,this._southWestLower.alt),this._northEastUpper.alt=isNaN(this._northEastUpper.alt)?a.alt:Math.max(a.alt,this._northEastUpper.alt))):(this._southWestLower=new Z.LatLng(a.lat,a.lng,a.alt),this._northEastUpper=new Z.LatLng(a.lat,a.lng,a.alt)):a instanceof Z.LatLngBounds&&(this.extend(a._southWestLower),this.extend(a._northEastUpper)),this},pad:function(a){var b=this._southWestLower,c=this._northEastUpper,d=Math.abs(b.lat-c.lat)*a,e=Math.abs(b.lng-c.lng)*a,f=this.hasAltValue()?Math.abs(b.alt-c.alt)*a:NaN;return new Z.LatLngBounds(new Z.LatLng(b.lat-d,b.lng-e,isNaN(f)?NaN:b.alt-f),new Z.LatLng(c.lat+d,c.lng+e,isNaN(f)?NaN:c.alt+f))},translate:function(a,b,c){var d=this._southWestLower,e=this._northEastUpper,f=new Z.LatLng(a,b,c);return new Z.LatLngBounds(d.add(f),e.add(f))},getCenter:function(){return new Z.LatLng((this._southWestLower.lat+this._northEastUpper.lat)/2,(this._southWestLower.lng+this._northEastUpper.lng)/2,this.hasAltValue()?(this._southWestLower.alt+this._northEastUpper.alt)/2:NaN)},getSouthWest:function(){return this._southWestLower},getNorthEast:function(){return this._northEastUpper},getNorthWest:function(){return new Z.LatLng(this.getNorth(),this.getWest())},getSouthEast:function(){return new Z.LatLng(this.getSouth(),this.getEast())},getWest:function(){return this._southWestLower.lng},getSouth:function(){return this._southWestLower.lat},getEast:function(){return this._northEastUpper.lng},getNorth:function(){return this._northEastUpper.lat},getTop:function(){return this._northEastUpper.alt},getBottom:function(){return this._southWestLower.alt},contains:function(a){a="number"==typeof a[0]||a instanceof Z.LatLng?Z.LatLng.create(a):Z.LatLngBounds.create(a);var b,c,d=this._southWestLower,e=this._northEastUpper;a instanceof Z.LatLngBounds?(b=a.getSouthWest(),c=a.getNorthEast()):b=c=a;var f=b.lat>=d.lat&&c.lat<=e.lat&&b.lng>=d.lng&&c.lng<=e.lng;return f&&a.hasAltValue()&&this.hasAltValue()&&(f=f&&b.alt>=d.alt&&c.alt<=e.alt),f},intersects:function(a){if("number"==typeof a[0]||a instanceof Z.LatLng){var b=Z.LatLng.create(a);a=Z.LatLngBounds.create(b,b)}else a=Z.LatLngBounds.create(a);var c=this._southWestLower,d=this._northEastUpper,e=a.getSouthWest(),f=a.getNorthEast(),g=f.lat>=c.lat&&e.lat<=d.lat,h=f.lng>=c.lng&&e.lng<=d.lng,i=!0;return a.hasAltValue()&&this.hasAltValue()&&(i=f.alt>=c.alt&&e.alt<=d.alt),g&&h&&i},toBBoxString:function(){var a=[this.getWest(),this.getSouth(),this.getEast(),this.getNorth()];return this.hasAltValue()&&(a.push(this._southWestLower.alt),a.push(this._northEastUpper.alt)),a.join(",")},equals:function(a){return!!a&&(a=Z.LatLngBounds.create(a),this._southWestLower.equals(a.getSouthWest())&&this._northEastUpper.equals(a.getNorthEast()))},isValid:function(){return!(!this._southWestLower||!this._northEastUpper)},hasAltValue:function(){return!isNaN(this._southWestLower.alt)&&!isNaN(this._northEastUpper.alt)}},Z.GLBounds=function(a,b){if(a){for(var c=b?[a,b]:a,d=0,e=c.length;d<e;d++)this.extend(c[d]);this.type="glbounds"}},Z.GLBounds.prototype=Object.create(Z.Bounds.prototype),Z.GLBounds.prototype.constructor=Z.Bounds,Z.GLBounds.prototype.getBottomLeft=function(){return new Z.Point(this.min.x,this.min.y,this.min.z)},Z.GLBounds.prototype.getTopRight=function(){return new Z.Point(this.max.x,this.max.y,this.max.z)},Z.GLBounds.prototype.getWidth=function(){return this.max.x-this.min.x},Z.GLBounds.prototype.getHeight=function(){return this.max.y-this.min.y},Z.GLBounds.prototype.getCenter=function(){return new Z.Point((this.max.x+this.min.x)/2,(this.max.y+this.min.y)/2,(this.max.z+this.min.z)/2)},Z.GLBounds.prototype.getThickness=function(){return this.max.z-this.min.z},Z.GLBounds.prototype.clone=function(){var a=this.min?this.min.clone():null,b=this.max?this.max.clone():null;return new Z.GLBounds(a,b)},Z.GLBounds.create=function(a,b){return!a||a instanceof Z.GLBounds?a:new Z.GLBounds(a,b)},Z.Geometry=Z.Class.extend({initialize:function(a,b,c){this.crs=a||null,this.baseHeight=b||0,this.type="geometry",this.needsUpdate=!0,this._bounds=null,c=c||{},this.lngStart=c.lngStart||!1},getBounds:function(){throw new error("getBounds方法尚未实现")},clone:function(){throw new error("clone方法尚未实现")}}),Z.Polyline=Z.Geometry.extend({initialize:function(a,b,c){Z.Geometry.prototype.initialize.call(this,b,null,c),this.crs=b,this.paths=a,this.type="polyline"},getBounds:function(){return Z.GeometryUtil.getPathBounds(this.paths,this.lngStart)},clone:function(){var a=Z.Util.arrayClone(this.paths);return new Z.Polyline(a,this.crs,{baseHeight:this.baseHeight,lngStart:this.lngStart})}}),Z.Polygon=Z.Geometry.extend({initialize:function(a,b,c){c=c||{},Z.Geometry.prototype.initialize.call(this,b,null,c),this.crs=b,this.rings=a,this.cw=c.cw||!1,this.ignoreCw=c.ignoreCw||!1,this.type="polygon"},getBounds:function(){return Z.GeometryUtil.getPathBounds(this.rings,this.lngStart)},clone:function(){var a=this.rings?Z.Util.arrayClone(this.rings):null;return new Z.Polygon(a,this.crs,{cw:this.cw,ignoreCw:this.ignoreCw,lngStart:this.lngStart})}}),Z.Circle=Z.Geometry.extend({initialize:function(a,b,c,d){Z.Geometry.prototype.initialize.call(this,a),this.crs=a||Z.CRS.EPSG4490,this.center=b,this.radius=c,this.radiusType="meter"===d?"meter":"pixel",this.type="circle",this.baseHeight=this.center?this.center.alt:this.baseHeight},getBounds:function(a){var b=null;if(this.crs&&this.center&&(b=Z.LatLngBounds.create(this.center,this.center),"number"==typeof this.radius)){var c=a.unproject(Z.Point.create(this.radius,this.radius)),d=this.center.subtract(c),e=this.center.add(c);b=Z.LatLngBounds.create(d,e)}return b},clone:function(){var a=this.center?this.center.clone():null;return new Z.Circle(this.crs,a,this.radius,this.radiusType)}}),Z.Sphere=Z.Geometry.extend({initialize:function(a,b,c,d,e,f,g,h,i){Z.Geometry.prototype.initialize.call(this,a),this.crs=a||Z.CRS.EPSG4490,this.center=b,this.radius=c,this.widthSegments=d||360,this.heightSegments=e||180,this.phiStart=f||0,this.phiLength=g||360,this.thetaStart=h||0,this.thetaLength=i||180,this.type="sphere",this.baseHeight=this.center?this.center.alt:this.baseHeight},getBounds:function(a){var b=null;if(this.crs&&this.center&&(b=Z.LatLngBounds.create(this.center,this.center),"number"==typeof this.radius)){var c=a.unproject(Z.Point.create(this.radius,this.radius,this.radius)),d=this.center.subtract(c),e=this.center.add(c);b=Z.LatLngBounds.create(d,e)}return b},clone:function(){var a=this.center?this.center.clone():null;return new Z.Sphere(this.crs,a,this.radius,this.widthSegments,this.heightSegments,this.phiStart,this.phiLength,this.thetaStart,this.thetaLength)}}),Z.Ring=Z.Geometry.extend({initialize:function(a,b,c,d){Z.Geometry.prototype.initialize.call(this,a),this.crs=a||Z.CRS.EPSG4490,this.center=b,this.innerRadius=c,this.outerRadius=d,this.type="ring",this.baseHeight=this.center?this.center.alt:this.baseHeight},getBounds:function(a){if(this.crs&&this.center&&(Z.LatLngBounds.create(this.center,this.center),"number"==typeof this.radius)){var b=a.unproject(Z.LatLng.create(this.outerRadius,this.outerRadius)),c=this.center.subtract(b),d=this.center.add(b);Z.LatLngBounds.create(c,d)}return null},clone:function(){var a=this.center?this.center.clone():null;return new Z.Ring(this.crs,a,this.innerRadius,this.outerRadius)}}),Z.Box=Z.Geometry.extend({initialize:function(a,b,c,d,e,f){f=f||{},Z.Geometry.prototype.initialize.call(this,a,null,f),this.crs=a||Z.CRS.EPSG4490,this.center=b,this.width=c,this.height=d,this.depth=e,this.type="box"},getBounds:function(){throw new Error("方法getBounds未实现")},clone:function(){var a=this.center?this.center.clone():null;return new Z.Box(this.crs,a,this.width,this.height,this.depth)}}),Z.Cylinder=Z.Geometry.extend({initialize:function(a,b,c,d,e,f,g,h,i){Z.Geometry.prototype.initialize.call(this,a),this.crs=a||Z.CRS.EPSG4490,this.bottomCenter=b,this.radiusTop=c,this.radiusBottom=d,this.height=e,this.radiusSegments=f,this.thetaStart=g,this.thetaLength=h,this.openEnded=i,this.type="cylinder"},getBounds:function(){throw new Error("方法getBounds未实现")},clone:function(){var a=this.bottomCenter?this.bottomCenter.clone():null;return new Z.Cylinder(this.crs,a,this.radiusTop,this.radiusBottom,this.height,this.radiusSegments,this.thetaStart,this.thetaLength,this.openEnded)}}),Z.Extrude=Z.Geometry.extend({initialize:function(a,b,c,d,e){e=e||{},Z.Geometry.prototype.initialize.call(this,a,d,e),this.crs=a||Z.CRS.EPSG4490,this.paths=b,this.height=c,this.cw=e.cw||!1,this.ignoreCw=e.ignoreCw||!1,this.type="extrude"},getBounds:function(){if(this.needsUpdate||!this._bounds){var a=Z.GeometryUtil.getPathBounds(this.paths,this.lngStart),b=a.getSouthWest(),c=a.getNorthEast();b.alt=this.baseHeight,c.alt=this.height,this._bounds=Z.LatLngBounds.create(b,c),this.needsUpdate=!1}return this._bounds},clone:function(){var a=Z.Util.arrayClone(this.paths);return new Z.Extrude(this.crs,a,this.height,this.baseHeight,{cw:this.cw,ignoreCw:this.ignoreCw,lngStart:this.lngStart})}}),Z.MultiExtrude=Z.Geometry.extend({initialize:function(a){Z.Geometry.prototype.initialize.call(this),this.extrudes=a||[],this.type="multiextrude"},getBounds:function(){for(var a,b,c,d,e,f,g=0;g<this.extrudes.length;g++){var h=this.extrudes[g].getBounds();void 0===a?(a=h.getWest(),b=h.getEast(),c=h.getSouth(),d=h.getNorth(),e=this.extrudes[g].baseHeight,f=this.extrudes[g].baseHeight+this.extrudes[g].height):(a=Math.min(a,h.getWest()),b=Math.max(b,h.getEast()),c=Math.min(c,h.getSouth()),d=Math.max(d,h.getNorth()),e=Math.min(e,this.extrudes[g].baseHeight),f=Math.max(f,this.extrudes[g].baseHeight+this.extrudes[g].height))}return void 0===a?null:Z.LatLngBounds.create(Z.LatLng.create(c,a,e),Z.LatLng.create(d,b,f))},clone:function(){for(var a=[],b=0;b<this.extrudes;b++)a.push(this.extrudes[b].clone());return new Z.MultiExtrude(a)}}),Z.ModelGeometry=Z.Geometry.extend({initialize:function(a,b,c,d){Z.Geometry.prototype.initialize.call(this,a),this.crs=a||Z.CRS.EPSG4490,this.lngStart=!1!==d,this.modelParams=b||{},this.transformation=c,this.type="modelgeometry"},getBounds:function(){if(this.needsUpdate||!this._bounds){var a,b,c=Z.GeometryUtil.getPathBounds(this._translateArray(this.modelParams?this.modelParams.vertices:[]),!0);c&&(a=c.getSouthWest(),b=c.getNorthEast(),this._bounds=Z.LatLngBounds.create(a,b),this.needsUpdate=!1)}return this._bounds},clone:function(){var a={};return a.vertices=this.modelParams.vertices?Z.Util.arrayClone(this.modelParams.vertices):this.modelParams.vertices,a.uvs=this.modelParams.uvs?Z.Util.arrayClone(this.modelParams.uvs):this.modelParams.uvs,a.faces=this.modelParams.faces?Z.Util.arrayClone(this.modelParams.faces):this.modelParams.faces,new Z.ModelGeometry(this.crs,this.modelParams,this.transformation)},_translateArray:function(a){var b=[];if(Z.Util.isArray(a))for(var c=0,d=0;c<a.length-2;c+=3,d++)if(this.transformation){var e=this.transformation.transform(a[c],a[c+1],a[c+2]);b[d]=[e.x,e.y,e.z]}else b[d]=[a[c],a[c+1],a[c+2]];return b}}),Z.CircleExtrude=Z.Extrude.extend({initialize:function(a,b){this.crs=a.crs||Z.CRS.EPSG4490,this.circle=a,this.height=b,this.type="circleextrude",this.circle&&this.circle.center&&(this.baseHeight=this.circle.center.alt||this.baseHeight)},getBounds:function(){if(this.needsUpdate||!this._bounds){var a=Z.GeometryUtil.getPathBounds(this.paths),b=a.getSouthWest(),c=a.getNorthEast();b.alt=this.baseHeight,c.alt=this.baseHeight+this.height,this._bounds=Z.LatLngBounds.create(b,c),this.needsUpdate=!1}return this._bounds},clone:function(){var a=Z.Util.arrayClone(this.paths);return new Z.Extrude(this.crs,a,this.height,this.baseHeight)}}),Z.Feature=Z.Class.extend({initialize:function(a,b,c){this.props=a||{},this.shape=b},clone:function(){var a={};if(this.props)for(var b in this.props)a[b]=this.props[b];var c=null;this.shape&&(c=this.shape.clone());var d=Z.Util.applyOptions({},this.options,!0);return new Z.Feature(a,c,d)}}),Z.Projection={DEG_TO_RAD:Math.PI/180,RAD_TO_DEG:180/Math.PI},Z.Projection.Simple=Z.extend({},Z.Projection,{project:function(a){return new Z.Point(a.lng,a.lat)},unproject:function(a){return new Z.LatLng(a.y,a.x)}}),Z.Projection.LatLng=Z.extend({},Z.Projection,{Circumference:6378137*Math.PI,project:function(a){var b=Math.cos(a.lat*Math.PI/180)*Z.Projection.LatLng.Circumference*a.lng/180,c=Z.Projection.LatLng.Circumference*a.lat/180;return new Z.Point(b,c)},unproject:function(a){var b=180*a.y/Z.Projection.LatLng.Circumference,c=180*a.x/(Z.Projection.LatLng.Circumference*Math.cos(Math.PI*b/180));return new Z.LatLng(b,c)}}),Z.Projection.SphericalMercator=Z.extend({},Z.Projection,{MAX_LATITUDE:85.0511287798,EarthRadius:6378137,Circumference:6378137*Math.PI,project:function(a){var b=Z.Projection.DEG_TO_RAD,c=Z.Projection.SphericalMercator.MAX_LATITUDE,d=Math.max(Math.min(c,a.lat),-c),e=a.lng*b,f=d*b;return f=Math.log(Math.tan(Math.PI/4+f/2)),new Z.Point(e,f).multiplyBy(Z.Projection.SphericalMercator.EarthRadius)},unproject:function(a){var b=Z.Projection.RAD_TO_DEG,c=a.divideBy(Z.Projection.SphericalMercator.EarthRadius),d=c.x*b,e=(2*Math.atan(Math.exp(c.y))-Math.PI/2)*b;return new Z.LatLng(e,d)}}),Z.Projection.Mercator=Z.extend({},Z.Projection,{MAX_LATITUDE:85.0840591556,R_MINOR:6356752.314245179,R_MAJOR:6378137,Circumference:6378137*Math.PI,project:function(a){var b=Z.Projection.DEG_TO_RAD,c=Z.Projection.Mercator.MAX_LATITUDE,d=Math.max(Math.min(c,a.lat),-c),e=Z.Projection.Mercator.R_MAJOR,f=Z.Projection.Mercator.R_MINOR,g=a.lng*b*e,h=d*b,i=f/e,j=Math.sqrt(1-i*i),k=j*Math.sin(h);k=Math.pow((1-k)/(1+k),.5*j);var l=Math.tan(.5*(.5*Math.PI-h))/k;return h=-e*Math.log(l),new Z.Point(g,h)},unproject:function(a){for(var b,c=Z.Projection.RAD_TO_DEG,d=Z.Projection.Mercator.R_MAJOR,e=Z.Projection.Mercator.R_MINOR,f=a.x*c/d,g=e/d,h=Math.sqrt(1-g*g),i=Math.exp(-a.y/d),j=Math.PI/2-2*Math.atan(i),k=15,l=1e-7,m=k,n=.1;Math.abs(n)>l&&--m>0;)b=h*Math.sin(j),n=Math.PI/2-2*Math.atan(i*Math.pow((1-b)/(1+b),.5*h))-j,j+=n;return new Z.LatLng(j*c,f)}}),Z.PyramidModelFactory=function(){},Z.PyramidModelFactory.create=function(a){a=a||{};var b=a.pyramidId,c=a.pyramidDefine;if(Z.PyramidModel[b])return new Z.PyramidModel[b];if(c&&c.params){var d=null;d="CustomLevel"===c.type?new Z.CustomPyramidGrid(c.params):new Z.FixedMultiplePyramidGrid(c.params);var e=Z.CRS[c.crsId+""]||Z.CRS[DefaultZMapConfig.crs+""]||Z.CRS[MapConfig.crs+""]||Z.CRS.EPSG4326;return c.crs&&(e=(c.crs instanceof Z.CRS?c.crs:null)||e),new Z.PyramidModel(d,e,a.projModel)}return new Z.PyramidModel.TDT},Z.CRS={projection:null,gcs:null,code:"",project:function(a){return this.projection?this.projection.project(a):new Z.Point(a.lng,a.lat)},unproject:function(a){return this.projection?this.projection.unproject(a):new Z.LatLng(a.y,a.x)}},Z.CRS.Simple=Z.extend({},Z.CRS,{code:"Simple",projection:Z.Projection.Simple}),Z.CRS.Geometry=Z.extend({},Z.CRS,{code:"Geometry",projection:Z.Projection.LatLng,EarthRadius:6378137,Circumference:6378137*Math.PI}),Z.CRS.EPSG4490=Z.extend({},Z.CRS.Geometry,{code:"EPSG4490"}),Z.CRS.EPSG4326=Z.extend({},Z.CRS.Geometry,{code:"EPSG4326"}),Z.CRS.EPSG3857=Z.extend({},Z.CRS,{code:"EPSG3857",projection:Z.Projection.SphericalMercator,gcs:Z.CRS.EPSG4326}),Z.CRS.EPSG900913=Z.extend({},Z.CRS,{code:"EPSG900913",projection:Z.Projection.SphericalMercator,gcs:Z.CRS.EPSG4326}),Z.Transformation=function(){this.matrix=new THREE.Matrix4},Z.Transformation.prototype.doTranslation=function(a,b,c){var d=new THREE.Matrix4;d.makeTranslation(a,b,c),this.matrix=d.multiply(this.matrix)},Z.Transformation.prototype.doRotation=function(a,b,c){var d=new THREE.Matrix4,e=new THREE.Matrix4,f=new THREE.Matrix4;d.makeRotationX(a),e.makeRotationY(b),f.makeRotationZ(c),d.multiply(e),d.multiply(f),this.matrix=d.multiply(this.matrix)},Z.Transformation.prototype.doScale=function(a,b,c){var d=new THREE.Matrix4;d.makeScale(a,b,c),this.matrix=d.multiply(this.matrix)},Z.Transformation.prototype.transform=function(a,b,c){var d=new THREE.Vector3(a,b,c);return d.applyMatrix4(this.matrix),new Z.Point(d.x,d.y,d.z)},Z.Transformation.prototype.multiply=function(a){return a&&a instanceof Z.Transformation?(this.matrix.multiply(a.matrix),this):this},Z.Transformation.prototype.getMatrix=function(){return this.matrix},Z.Transformation.prototype.decompose=function(){var a=new THREE.Vector3,b=new THREE.Vector3,c=new THREE.Quaternion;return this.matrix.decompose(a,c,b),{position:a,quaternion:c,scale:b}},Z.Transformation.prototype.clone=function(){var a=new Z.Transformation;return a.matrix=this.matrix.clone(),a},Z.AbstractPyramidGrid=Z.Class.extend({initialize:function(a){a=a||{},this._xFactor=-1===a.xFactor?-1:(a.xFactor,1),this._yFactor=-1===a.yFactor?-1:(a.yFactor,1),this._origin=a.origin?Z.LatLng.create(a.origin):new Z.LatLng(0,0),this._tileSize=a.tileSize?Z.Point.create(a.tileSize):new Z.Point(256,256),this._dpi=a.dpi||96,this._minLevel=void 0,this._maxLevel=void 0,this.resolationTolerance=1e-8},getScale:function(a){},latLngToPixelPoint:function(a,b){if(this._zoomInvalid(b)||!(a instanceof Z.LatLng))return null;var c=(a.lng-this._origin.lng)*this._xFactor,d=(a.lat-this._origin.lat)*this._yFactor;return this._latLngSizeToPixelSize(c,d,b)},pixelPointToLatLng:function(a,b){if(this._zoomInvalid(b)||!(a instanceof Z.Point))return null;var c=this._pixelSizeToLatLngSize(a.x,a.y,b);return c.lat=this._origin.lat+c.lat*this._yFactor,c.lng=this._origin.lng+c.lng*this._xFactor,c},latLngBoundsToPixelBounds:function(a,b){if(this._zoomInvalid(b)||!(a instanceof Z.LatLngBounds))return null;var c=this.latLngToPixelPoint(a.getSouthWest(),b),d=this.latLngToPixelPoint(a.getNorthEast(),b);return new Z.Bounds(c,d)},getTilePoint:function(a,b){var c=this.latLngToPixelPoint(a,b);if(c){var d=Math.floor(c.x/this._tileSize.x),e=Math.floor(c.y/this._tileSize.y);return new Z.Point(d,e,b)}return null},getLatLngBounds:function(a,b){if(this._zoomInvalid(b)||!(a instanceof Z.Point))return null;var c=new Z.Point(a.x*this._tileSize.x,a.y*this._tileSize.y),d=new Z.Point((a.x+1)*this._tileSize.x,(a.y+1)*this._tileSize.y),e=this.pixelPointToLatLng(c,b),f=this.pixelPointToLatLng(d,b);return Z.LatLngBounds.create(e,f)},getTileBounds:function(a,b){var c=this.getTilePoint(a.getSouthWest(),b),d=this.getTilePoint(a.getNorthEast(),b);return c&&d?new Z.Bounds(c,d):null},getTileSize:function(){return this._tileSize.clone()},getOrigin:function(){return this._origin.clone()},getTopLeftPixelPoint:function(a){var b=this._tileSize,c=-1===this._yFactor?a.y:a.y+1,d=1===this._xFactor?a.x:a.x+1;return new Z.Point(b.x*d,b.y*c)},getTopLeftPixelPointOfBounds:function(a){var b=this.getTopLeftTileOfBounds(a);return this.getTopLeftPixelPoint(b)},getTopLeftPixelPointInBounds:function(a,b){var c,d,e=(this._tileSize,this.getTopLeftTileOfBounds(b));c=this.getTopLeftPixelPoint(a),d=this.getTopLeftPixelPoint(e);var f=(c.x-d.x)*this._xFactor,g=(d.y-c.y)*this._yFactor;return new Z.Point(f,g)},getTopLeftTileOfBounds:function(a){var b,c,d=a.min,e=a.max;return b=-1===this._yFactor?d.y:e.y,c=1===this._xFactor?d.x:e.x,new Z.Point(c,b)},fitZoomLevel:function(a,b,c){if(!(a instanceof Z.LatLngBounds))return null;var d=Math.abs((a.getEast()-a.getWest())/b),e=this._getLevelDefine(),f=e[0].resolution,g=1;if(d>f||Math.abs(d-f)<1e-7)return g=this._getResolutionScale(d,f),{scale:e[0].scale,zoomFactor:g,level:e[0].level,outOfScaleBounds:!0};for(var h=1;h<e.length;h++)if(f=e[h].resolution,d>=f||Math.abs(d-f)<1e-7)return g=this._getResolutionScale(d,f),{scale:d-f<e[h-1].resolution-d?e[h].scale:e[h-1].scale,zoomFactor:g,level:d-f<e[h-1].resolution-d?e[h].level:e[h-1].level,outOfScaleBounds:!1};return g=this._getResolutionScale(d,e[e.length-1].resolution),{scale:e[e.length-1].scale,zoomFactor:g,level:e[e.length-1].level,outOfScaleBounds:!0}},getFitableBounds:function(a,b,c,d){var e=this._getLevelDefine(),f=e[b].resolution,g=c*f,h=d*f,i=a.lng-g/2,j=a.lng+g/2,k=a.lat-h/2,l=a.lat+h/2;return Z.LatLngBounds.create(Z.LatLng.create(k,i),Z.LatLng.create(l,j))},scalingLevel:function(a,b){var c=this._getLevelDefine();if(!(a<c[0].level&&a>c[c.length-1].level)){for(var d,e=c[0].scale,f=0,g=1;g<c.length;g++)if(c[g].level===a){e=c[g].scale,f=g;break}if(1===b)d=f;else if(b<1&&b>0){for(var g=f+1;g<c.length;g++){var h=c[g].scale;if(h/e<b){d=g-1;break}}g>=c.length&&(d=c.length-1)}else if(b>1){for(var g=f;g>=0;g--){var h=c[g].scale;if(h/e>=b){d=g;break}}g<0&&(d=0)}return{scale:c[d].scale,level:c[d].level,outOfScaleBounds:!1}}},getLevelRange:function(){return{min:this._getMinLevel(),max:this._getMaxLevel()}},_getLevelDefine:function(){throw error("_getLevelDefine()是抽象方法，请在子类中覆盖")},_getMinLevel:function(){if(void 0===this._minLevel||null===this._minLevel){var a=this._getLevelDefine(),b=void 0;if(a)for(var c=1;c<a.length;c++)b=void 0===b?a[c].level:Math.min(a[c].level,b);this._minLevel=b}return this._minLevel},_getMaxLevel:function(){if(void 0===this._maxLevel||null===this._maxLevel){var a=this._getLevelDefine(),b=void 0;if(a)for(var c=1;c<a.length;c++)b=void 0===b?a[c].level:Math.max(a[c].level,b);this._maxLevel=b}return this._maxLevel},_getResolutionScale:function(a,b){var c=1;return Math.abs(a-b)>this.resolationTolerance&&(c=b/a),c},_zoomInvalid:function(a){throw error("_zoomInvalid(zoom)是抽象方法，请在子类中覆盖")},_latLngSizeToPixelSize:function(a,b,c){throw error("_latLngSizeToPixelSize(latLngWidth, latLngHeight, zoom)是抽象方法，请在子类中覆盖")},_pixelSizeToLatLngSize:function(a,b,c){throw error("_pixelSizeToLatLngSize(pixelWidth, pixelHeight, zoom)是抽象方法，请在子类中覆盖")}}),Z.CustomPyramidGrid=Z.AbstractPyramidGrid.extend({initialize:function(a){if(a=a||{},Z.AbstractPyramidGrid.prototype.initialize.apply(this,arguments),this._levelDefine=a.levelDefine,this._levelMapping=null,this._levelDefine instanceof Array){this._levelDefine.sort(function(a,b){return parseInt(a.level)-parseInt(b.level)}),this._levelMapping={};for(var b=0;b<this._levelDefine.length;b++)this._levelMapping[this._levelDefine[b].level+""]=this._levelDefine[b]}},getScale:function(a){return this._zoomInvalid(a)?NaN:this._levelMapping?this._levelMapping[a+""].scale:void 0},_getLevelDefine:function(){return this._levelDefine},_zoomInvalid:function(a){return!!this._levelMapping&&!this._levelMapping[a+""]},_latLngSizeToPixelSize:function(a,b,c){if(this._levelMapping){var d=this._levelMapping[c+""].resolution,e=Math.floor(a/d),f=Math.floor(b/d);return new Z.Point(e,f)}return null},_pixelSizeToLatLngSize:function(a,b,c){if(this._levelMapping){var d=this._levelMapping[c+""].resolution,e=d*a,f=d*b;return new Z.LatLng(f,e)}return null}}),Z.FixedMultiplePyramidGrid=Z.AbstractPyramidGrid.extend({initialize:function(a){a=a||{},a.origin=a.origin||new Z.LatLng(0,0),Z.AbstractPyramidGrid.prototype.initialize.apply(this,arguments),this.startZoom=isNaN(a.startZoom)?0:parseInt(a.startZoom),this.endZoom=isNaN(a.endZoom)?18:parseInt(a.endZoom),this.multiplier=a.multiplier||2,this.baseZoom=0,this.baseResolution=a.baseResolution||1,this.baseScale=a.baseScale||1},getScale:function(a){return this._zoomInvalid(a)?NaN:this.baseScale/Math.pow(2,a-this.baseZoom)},_getLevelDefine:function(){for(var a=[],b=this.startZoom;b<this.endZoom;b++)a.push({level:b,resolution:this._getResolution(b),scale:this._getScale(b)});return a},_getResolution:function(a){return this.baseResolution/Math.pow(2,a-this.baseZoom)},_getScale:function(a){return this.baseScale/Math.pow(2,a-this.baseZoom)},_zoomInvalid:function(a){return a<this.startZoom&&a>this.endZoom},_latLngSizeToPixelSize:function(a,b,c){var d=this._getResolution(c),e=Math.floor(a/d),f=Math.floor(b/d);return new Z.Point(e,f)},_pixelSizeToLatLngSize:function(a,b,c){var d=this._getResolution(c),e=d*a,f=d*b;return new Z.LatLng(f,e)}}),Z.PyramidModel=Z.Class.extend({initialize:function(a,b,c,d){d=d||{},this.grid=a,this.crs=b||Z.CRS[ZMapConfig.crs]||Z.CRS.EPSG4326,this.projModel=c||new Z.ProjModel},getScale:function(a){var b=this._getMultiple(a,Math.floor(a));return this.grid.getScale(Math.floor(a))/b},getTileSize:function(a){var b=1;if(void 0!==a){var c=this._getNearestGridZoom(a);b=this._getMultiple(a,c)}return this.grid.getTileSize().multiplyBy(b)},getOrigin:function(){var a=this.grid.getOrigin();return this._transformLatLngFromPyramid(a)},latLngToPixelPoint:function(a,b){var c=this._transformLatLng2Pyramid(a),d=this._getNearestGridZoom(b),e=this.grid.latLngToPixelPoint(c,b),f=this._getMultiple(b,d);return e.multiplyBy(f)},pixelPointToLatLng:function(a,b){var c=this._getNearestGridZoom(b),d=this._getMultiple(b,c),e=new Z.Point(a.x*d,a.y*d,a.z*d),f=this.grid.pixelPointToLatLng(e,c);return this._transformLatLngFromPyramid(f)},getTilePoint:function(a,b){var c=this._transformLatLng2Pyramid(a),d=this._getNearestGridZoom(b);return this.grid.getTilePoint(c,d)},getLatLngBounds:function(a,b){var c=this._getNearestGridZoom(b),d=this.grid.getLatLngBounds(a,c);return this._transformLatLngBoundsFromPyramid(d)},getTileBounds:function(a,b){var c=this._transformLatLngBounds2Pyramid(a),d=this._getNearestGridZoom(b);return this.grid.getTileBounds(c,d)},getTopLeftPixelPoint:function(a){return this.grid.getTopLeftPixelPoint(a)},getTopLeftPixelPointOfBounds:function(a){return this.grid.getTopLeftPixelPointOfBounds(a)},getTopLeftPixelPointInBounds:function(a,b){return this.grid.getTopLeftPixelPointInBounds(a,b)},fitZoomLevel:function(a,b,c){var d=this._transformLatLngBounds2Pyramid(a),e=this.grid.fitZoomLevel(d,b,c);return 1===e.zoomFactor?{scale:e.scale,level:e.level,outOfScaleBounds:e.outOfScaleBounds}:this.scalingLevel(e.level,e.zoomFactor)},getFitableBounds:function(a,b,c,d){var e=this._transformLatLng2Pyramid(a),f=this._getNearestGridZoom(b),g=this._getMultiple(b,f),h=this.grid.getFitableBounds(e,f,c/g,d/g);return this._transformLatLngBoundsFromPyramid(h)},scalingLevel:function(a,b){b=void 0===b?1:b;var c,d;if(b<=0||1===b)c=a,d=this.getScale(c);else{d=this.getScale(a)/b;var e=this._getNearestGridZoom(a),f=this.getScale(e),g=this.grid.scalingLevel(e,d/f),h=this.grid.getLevelRange(),i=g.level,j=g.scale;c=d<=j?i===h.max?i:i+this._getSubZoom(i,i+1,d/j):i===h.min?i:i-this._getSubZoom(i,i-1,d/j)}return{level:c,scale:d,outOfScaleBounds:!1}},_getNearestGridZoom:function(a){return Math.floor(a)},_getMultiple:function(a,b){var c,d;return a===b?1:a>b?(c=this.grid.getScale(b),d=this.grid.getScale(Math.ceil(a)),Math.pow(c/d,(a-b)/(Math.ceil(a)-b))):(c=this.grid.getScale(Math.floor(a)),d=this.grid.getScale(b),Math.pow(d/c,(b-a)/(b-Math.floor(a))))},_getSubZoom:function(a,b,c){var d=this.grid.getScale(a),e=this.grid.getScale(b);return Math.log(c)/Math.log(e/d)},_transformLatLng2Pyramid:function(a){return this.projModel.forwardTransform(a)},_transformLatLngFromPyramid:function(a,b){return this.projModel.reverseTransform(a)},_transformLatLngBounds2Pyramid:function(a){var b=a.getSouthWest(),c=a.getNorthEast(),d=this._transformLatLng2Pyramid(b),e=this._transformLatLng2Pyramid(c);return Z.LatLngBounds.create(d,e)},_transformLatLngBoundsFromPyramid:function(a,b){var c=a.getSouthWest(),d=a.getNorthEast(),e=this._transformLatLngFromPyramid(c,b),f=this._transformLatLngFromPyramid(d,b);return Z.LatLngBounds.create(e,f)}}),Z.PyramidModel.TDT=Z.PyramidModel.extend({initialize:function(){var a=Z.CRS.EPSG4326,b=256,c=256,d=new Z.CustomPyramidGrid({xFactor:1,yFactor:-1,tileSize:new Z.Point(b,c),dpi:96,origin:new Z.LatLng(90,-180),levelDefine:[{level:0,resolution:1.40782880508533,scale:591658710.9},{level:1,resolution:.7031250000001188,scale:295497593.0588},{level:2,resolution:.3515625000000594,scale:147748796.5294},{level:3,resolution:.1757812500000297,scale:73874398.2647},{level:4,resolution:.08789062500001485,scale:36937199.13235},{level:5,resolution:.043945312500007425,scale:18468599.566175},{level:6,resolution:.021972656250003712,scale:9234299.7830875},{level:7,resolution:.010986328125001856,scale:4617149.89154375},{level:8,resolution:.005493164062500928,scale:2308574.945771875},{level:9,resolution:.002746582031250464,scale:1154287.4728859374},{level:10,resolution:.001373291015625232,scale:577143.7364429687},{level:11,resolution:.000686645507812616,scale:288571.86822148436},{level:12,resolution:.000343322753906308,scale:144285.93411074218},{level:13,resolution:.000171661376953154,scale:72142.96705537109},{level:14,resolution:85830688476577e-18,scale:36071.483527685545},{level:15,resolution:429153442382885e-19,scale:18035.741763842772},{level:16,resolution:2145767211914425e-20,scale:9017.870881921386},{level:17,resolution:10728836059572125e-21,scale:4508.935440960693},{level:18,resolution:53644180297860626e-22,scale:2254.4677204803465},{level:19,resolution:26822090148930313e-22,scale:1127.2338602401733},{level:20,resolution:13411045074465156e-22,scale:563.6169301200866}]}),e=new Z.ProjModel(Z.CRS.EPSG4490,a);Z.PyramidModel.prototype.initialize.call(this,d,a,e)}}),Z.PyramidModel.OSM=Z.PyramidModel.extend({initialize:function(){var a=Z.CRS.EPSG3857,b=96,c=256,d=256,e=40075016.6855784/c,f=e*b/.0254,g=new Z.FixedMultiplePyramidGrid({xFactor:1,yFactor:-1,tileSize:new Z.Point(c,d),dpi:96,origin:new Z.LatLng(20037508.3427892,-20037508.3427892),multiplier:2,baseZoom:0,baseResolution:e,baseScale:f}),h=new Z.ProjModel(Z.CRS.EPSG4326,a);Z.PyramidModel.prototype.initialize.call(this,g,a,h)}}),Z.PyramidModel.BD=Z.PyramidModel.extend({initialize:function(){var a=Z.CRS.EPSG3857,b=96,c=256,d=256,e=Math.pow(2,18),f=e*b/.0254,g=new Z.FixedMultiplePyramidGrid({xFactor:1,yFactor:1,tileSize:new Z.Point(c,d),dpi:96,origin:new Z.LatLng(0,0),multiplier:2,baseZoom:0,baseResolution:e,baseScale:f}),h=new Z.ProjModel(Z.CRS.EPSG4326,a);Z.PyramidModel.prototype.initialize.call(this,g,a,h)}}),Z.PyramidModel.TDT_UNLIMIT=Z.PyramidModel.extend({initialize:function(){var a=Z.CRS.EPSG4490,b=256,c=256,d=1.4062500000002376,e=590995186.1176,f=new Z.FixedMultiplePyramidGrid({xFactor:1,yFactor:-1,tileSize:new Z.Point(b,c),dpi:96,origin:new Z.LatLng(90,-180),multiplier:2,startZoom:0,endZoom:30,baseZoom:0,baseResolution:d,baseScale:e}),g=new Z.ProjModel(Z.CRS.EPSG4326,a);Z.PyramidModel.prototype.initialize.call(this,f,a,g)}}),Z.ProjModel=Z.Class.extend({initialize:function(a,b){this.fromCRS=a||Z.CRS.EPSG4326,this.toCRS=b||Z.CRS.EPSG4326},project:function(a){if(this._isSameCRS())return this.fromCRS.project(a);var b=this.fromCRS.gcs,c=this.toCRS.gcs;if(b||c){if(b&&!c){if(b.code!==this.toCRS.code){var d=this.fromCRS.unproject(new Z.Point(a.lng,a.lat));return a=this._transformGCS(d,b,this.toCRS),this.toCRS.project(a)}return new Z.Point(a.lng,a.lat)}if(!b&&c)return this.fromCRS.code!==c.code&&(a=this._transformGCS(d,this.fromCRS,c)),this.toCRS.project(a);var d=this.fromCRS.unproject(new Z.Point(a.lng,a.lat)),e=d;return b.code!==c.code&&(e=this._transformGCS(d,b,c)),this.toCRS.project(e)}return this.fromCRS.code!==this.toCRS.code&&(a=this._transformGCS(a,this.fromCRS,this.toCRS)),this.toCRS.project(a)},unproject:function(a){if(this._isSameCRS())return this.fromCRS.unproject(a);var b=this.fromCRS.gcs,c=this.toCRS.gcs;if(b||c){if(b&&!c){if(b.code!==this.toCRS.code){var d=this.toCRS.unproject(a),e=this._transformGCS(d,this.toCRS,b),f=this.fromCRS.project(e);return new Z.LatLng(f.y,f.x)}return new Z.LatLng(a.y,a.x)}if(!b&&c){var g=this.toCRS.unproject(a);return this.fromCRS.code!==c.code&&(g=this._transformGCS(e,c,this.fromCRS)),g}var d=this.toCRS.unproject(new Z.Point(latlng.lng,latlng.lat)),e=d;b.code!==c.code&&(e=this._transformGCS(d,c,b));var f=this.fromCRS.project(e);return new Z.LatLng(f.y,f.x)}var g=this.toCRS.unproject(a);return this.fromCRS.code!==this.toCRS.code&&(g=this._transformGCS(g,this.toCRS,this.fromCRS)),g},forwardTransform:function(a){if(this._isSameCRS())return a;if(this.toCRS.gcs&&this.toCRS.gcs.code===this.fromCRS.code){var b=this.toCRS.project(a);return new Z.LatLng(b.y,b.x)}return a},reverseTransform:function(a){if(this._isSameCRS())return a;if(this.toCRS.gcs&&this.toCRS.gcs.code===this.fromCRS.code){return this.toCRS.unproject(new Z.Point(a.lng,a.lat))}return a},_isSameCRS:function(){return this.fromCRS&&this.toCRS&&this.fromCRS.code===this.toCRS.code},_transformGCS:function(a,b,c){return a}}),Z.IGraphicLayerRender=Z.Class.extend({includes:Z.EventManager,onAdd:function(a){},onRemove:function(a){},show:function(){},hide:function(){},setOpacity:function(a){},getZIndex:function(){},setZIndex:function(a){},refresh:function(a){},addGraphic:function(a,b){},removeGraphic:function(a,b){},clear:function(){}}),Z.IGraphicRender=Z.Class.extend({includes:Z.EventManager,initialize:function(){},onAdd:function(a){throw new Error("方法onAdd未实现")},onRemove:function(a){throw new Error("方法onRemove未实现")},updateGeometry:function(a){},updateSymbol:function(a){}}),Z.ILayer=Z.Class.extend({includes:Z.EventManager,onAdd:function(a){},onRemove:function(a){},show:function(){},hide:function(){},setOpacity:function(a){},setZIndex:function(a){},setZoomRange:function(a,b){},getContainerPane:function(){},refresh:function(){}}),Z.IScene=Z.Class.extend({includes:Z.EventManager,getBounds:function(){return null},getPixelSceneRatio:function(){return null},setZoom:function(a){},getZoom:function(){},getScale:function(a){},getSize:function(){},panTo:function(a,b){},latLngToScreenPoint:function(a){return null},screenPointToLatLng:function(a){},addLayer:function(a){},removeLayer:function(a){},openPopup:function(a){},closePopup:function(a){},addControl:function(a){},removeControl:function(a){},refresh:function(){},setSunLight:function(a){},setAmbientLight:function(a){},rotateByEuler:function(a){},resetRotate:function(){},getRotateByRad:function(){},getContentBounds:function(){}}),Z.ITileRender=Z.Class.extend({includes:Z.EventManager,onAdd:function(a){},onRemove:function(a){},show:function(){},hide:function(){},setOpacity:function(a){},setZIndex:function(a){},refresh:function(a){}}),Z.AbstractIcon=Z.Class.extend({includes:Z.EventManager,initialize:function(a){this.options={width:"auto",height:"auto",anchor:"bottomLeft",offset:[0,0]},Z.Util.applyOptions(this.options,a,!1),this._parentNode=null,this._mapScene=null,this._container=null,this._latlng=null,this._content=null,this._containerBottom=0,this._containerLeft=0,this._lastMouseOverPosition=null,this._contentUpdated=!1},onAdd:function(a){if(this._mapScene=a,this._parentNode=this._getParentNode(a),this._container||(this._container=this._initLayout(),this._applyMouseEvents("on")),!this._container)return void console.info("marker对象对应的DOM对象未成功创建，请检查_initLayout（）方法是否返回了正确的值");this._parentNode.appendChild(this._container);for(var b=this._getEvents(),c=0;c<b.length;c++)b[c].target.on(b[c].event,b[c].func,this);this._initContent(),this.update(),this.fire("add")},onRemove:function(a){if(this._parentNode){this._parentNode.removeChild(this._container),Z.Util.falseFn(this._container.offsetWidth);for(var b=this._getEvents(),c=0;c<b.length;c++)b[c].target.off(b[c].event,b[c].func,this);this._mapScene=null,this.fire("remove")}},getLatLng:function(){return this._latlng},setLatLng:function(a){return this._latlng=Z.LatLng.create(a),this._mapScene&&this._updatePosition(),this},setContent:function(a,b,c){},getSize:function(){var a=0,b=0;return this._container&&(a=this._container.offsetWidth,b=this._container.offsetHeight),{width:a,height:b}},update:function(){this._container.style.visibility="hidden",this._mapScene&&this._latlng&&(this._updateContent(),this._updateLayout(),this._updatePosition(),this._container.style.visibility="",console.info("do update()"))},show:function(){this._container&&(this._container.style.visibility="")},hide:function(){this._container&&(this._container.style.visibility="hidden")},_getParentNode:function(a){return a._viewFrame.labelPane.root},_initLayout:function(){var a=document.createElement("div");return a.style.position="absolute",a},_initContent:function(){this._updateContent(),this._updateLayout()},_getEvents:function(){for(var a=(this._mapScene,[]),b=this._getPopupEvents()||[],c=0;c<b.length;c++)a.push(b[c]);return a},_getPopupEvents:function(){return[]},_updateContent:function(){this.setContent(this._container,this.options.width,this.options.height)},_updateLayout:function(){this._containerWidth=this._container.offsetWidth,this._containerHeight=this._container.offsetHeight},_updatePosition:function(){if(this._mapScene&&this._latlng){var a=this._mapScene.latLngToScreenPoint(this._latlng),b=Z.Point.create(this.options.offset),c=this._getPositionOffset(this._containerWidth,this._containerHeight)||{x:0,y:0};c.x="number"!=typeof c.x||isNaN(c.x)?0:c.x,c.y="number"!=typeof c.y||isNaN(c.y)?0:c.y,this._containerTop=-b.y+a.y-c.y,this._containerLeft=b.x+a.x+c.x,this._container.style.top=this._containerTop+"px",this._container.style.left=this._containerLeft+"px"}},_getPositionOffset:function(a,b){var c=this.options.anchor||"bottomLeft",d=this._getOffsetRatio(c);return{x:-a*d.xRatio,y:b*d.yRatio}},_getOffsetRatio:function(a){var b=0,c=1;return"bottomLeft"===a?(b=0,c=1):"bottomCenter"===a?(b=.5,c=1):"bottomRight"===a?(b=1,c=1):"centerLeft"===a?(b=0,c=.5):"centerCenter"===a?(b=.5,c=.5):"centerRight"===a?(b=1,c=.5):"topLeft"===a?(b=0,c=0):"topCenter"===a?(b=.5,c=0):"topRight"===a&&(b=1,c=0),{xRatio:b,yRatio:c}},_applyMouseEvents:function(a){if(Z.DomEvent){a=a||"on";var b,c,d=["dblclick","click","mousedown","mouseup","mouseover","mouseout","mouseenter","mouseleave","mousemove","contextmenu"];for(b=0,c=d.length;b<c;b++)Z.DomEvent[a](this._container,d[b],this._fireMouseEvent,this)}},_fireMouseEvent:function(a){var b=a.type;if(b="mouseenter"===b?"mouseover":"mouseleave"===b?"mouseout":b,"contextmenu"===b&&Z.DomEvent.preventDefault(a),("mouseout"===b||"mouseover"===b)&&!Z.DomEvent._checkMouse(this._container,a))return void Z.DomEvent.stopPropagation(a);var c=new Z.Point(a.clientX,a.clientY);if("mouseover"===b){var d=this._lastMouseOverPosition;if(d&&this._contentUpdated){if(c.x-d.x<1&&c.y-d.y<1)return void Z.DomEvent.stopPropagation(a);this._contentUpdated=!1}this._lastMouseOverPosition=c}else this._lastMouseOverPosition=null;if("resize"===b)this.fire(b);else{var e=Z.DomEvent.getMousePosition(a,this._container);e?this.fire(b,{containerPoint:e,originalEvent:a}):this.fire(b)}Z.DomEvent.stopPropagation(a)},_outOfContainer:function(a,b){return a.x<0||a.y<0||a.x>b.clientWidth||a.y>b.clientHeight}}),Z.AbstractPopup=Z.Class.extend({includes:Z.EventManager,options:{minWidth:50,maxWidth:300,minHeight:50,maxHeight:250,hideNullContent:!0,autoPan:!0,stopPropagation:!0,offset:[0,0],autoPanPadding:[5,5],keepInView:!1,className:""},initialize:function(a){Z.Util.applyOptions(this.options,a,!1),this._isOpen=!1,this._parentNode=null,this._mapScene=null,this._container=null,this._latlng=null,this._content=null,this._containerBottom=0,this._containerLeft=0,this._contentUpdated=!0},onAdd:function(a){if(this._mapScene=a,this._parentNode=this._getParentNode(a),this._container||(this._container=this._initLayout()),!this._container)return void console.info("popup对象对应的DOM对象未成功创建，请检查_initLayout（）方法是否返回了正确的值");this._parentNode.appendChild(this._container);for(var b=this._getEvents(),c=0;c<b.length;c++)b[c].target.on(b[c].event,b[c].func,this);this.update(),this._close(),this._applyMouseEvents("on"),this.fire("add"),a.fire("popupadd",{popup:this})},onRemove:function(a){if(this._parentNode){this._parentNode.removeChild(this._container),Z.Util.falseFn(this._container.offsetWidth);for(var b=this._getEvents(),c=0;c<b.length;c++)b[c].target.off(b[c].event,b[c].func,this);this._mapScene=null,this._applyMouseEvents("off"),this.fire("remove"),a.fire("popupremove",{popup:this})}},getLatLng:function(){return this._latlng},setLatLng:function(a){return this._latlng=Z.LatLng.create(a),this._mapScene&&this._isOpen&&this._updatePosition(),this},getContent:function(){return this._content},setContent:function(a){if(a!==this._content)return this._content=a,this._contentUpdated=!0,this._isOpen&&this.update(),this},getSize:function(){var a=0,b=0;return this._container&&(a=this._container.offsetWidth,b=this._container.offsetHeight),{width:a,height:b}},update:function(){this._container.style.visibility="hidden",this._mapScene&&this._latlng&&(!this._isOpen&&this.options.hideNullContent||(this._contentUpdated&&(this._updateContent(),this._updateLayout(),this._contentUpdated=!1),this._updatePosition(),this._container.style.visibility=""))},open:function(){if(this._mapScene&&this._latlng&&this._container){if(this.options.hideNullContent&&(Z.Util.isNull(this._content)||this._content.length<=0))return void(this.isOpened()&&this.close());this._isOpen=!0,this.update(),this.fire("open"),this._mapScene.fire("popupopen",{popup:this})}},close:function(){this._mapScene&&this._latlng&&this._container&&(this._isOpen=!1,this._close(),this.fire("close"),this._mapScene.fire("popupclose",{popup:this}))},isOpened:function(){return this._isOpen},isUpdated:function(){return this._contentUpdated},_close:function(){this._container.style.visibility="hidden"},_getEvents:function(){var a=this._mapScene,b=[{target:a,event:"viewreset",func:this._updatePosition},{target:a,event:"zoomlevelschange",func:this._updatePosition}];("closeOnClick"in this.options?this.options.closeOnClick:this._mapScene.options.closePopupOnClick)&&b.push({target:a,event:"preclick",func:this.close}),this.options.keepInView&&b.push({target:a,event:"moveend",func:this._adjustPan});for(var c=this._getPopupEvents()||[],d=0;d<c.length;d++)b.push(c[d]);return b},_getParentNode:function(a){return a._viewFrame.popupPane.root},_getPopupEvents:function(){},_initLayout:function(){throw new error("_initLayout是抽象方法， 请在子类中覆写， 不可直接调用")},_updateContent:function(){var a=this._content||"";this._fillContent(a),this.fire("contentupdate")},_fillContent:function(a){throw new error("_fillContent是抽象方法， 请在子类中覆写， 不可直接调用")},_updateLayout:function(){this._updatePopupLayout(this._container),this._containerWidth=this._container.offsetWidth,this._containerHeight=this._container.offsetHeight},_updatePopupLayout:function(a){throw new error("_updatePopupLayout是抽象方法， 请在子类中覆写， 不可直接调用")},_updatePosition:function(){if(this._mapScene&&this._latlng){var a=this._mapScene.latLngToScreenPoint(this._latlng),b=Z.Point.create(this.options.offset),c=this._getPositionOffset(this._containerWidth,this._containerHeight)||{x:0,y:0};c.x="number"!=typeof c.x||isNaN(c.x)?0:c.x,c.y="number"!=typeof c.y||isNaN(c.y)?0:c.y,this._containerBottom=b.y-a.y-c.y,this._containerLeft=a.x+c.x,this._container.style.bottom=this._containerBottom+"px",this._container.style.left=this._containerLeft+"px"}},_getPositionOffset:function(a,b){throw new error("_getPositionOffset是抽象方法， 请在子类中覆写， 不可直接调用")},_applyMouseEvents:function(a){if(Z.DomEvent){a=a||"on";var b,c,d=["dblclick","click","mousedown","mouseup","mouseover","mouseout","mouseenter","mouseleave","mousemove","contextmenu"];for(b=0,c=d.length;b<c;b++)Z.DomEvent[a](this._container,d[b],this._fireMouseEvent,this)}},_fireMouseEvent:function(a){var b=a.type;if(b="mouseenter"===b?"mouseover":"mouseleave"===b?"mouseout":b,"contextmenu"===b&&Z.DomEvent.preventDefault(a),"resize"===b)this.fire(b);else{var c=Z.DomEvent.getMousePosition(a,this._container);c?this.fire(b,{containerPoint:c,originalEvent:a}):this.fire(b)}this.options.stopPropagation&&Z.DomEvent.stopPropagation(a)}}),Z.Popup=Z.AbstractPopup.extend({initialize:function(a,b){Z.AbstractPopup.prototype.initialize.apply(this,arguments),Z.Util.applyOptions(this.options,{width:150,height:200,closeButton:!0},!0),Z.Util.applyOptions(this.options,a,!1),this._source=b,this._isOpen=!1,this._title=null,this._titleUpdated=!0},update:function(){Z.AbstractPopup.prototype.update.apply(this,arguments)},setTitle:function(a){(a=Z.Util.stringTrim((a||"")+""))!==this._title&&(this._title=a,this._titleUpdated=!0)},getTitle:function(){return this._title},isUpdated:function(){return this._contentUpdated||this._titleUpdated},_getParentNode:function(a){return a._viewFrame.popupPane.root},_initLayout:function(){var a,b="zmap-popup",c=b+" "+this.options.className,d=Z.DomUtil.create("div",c);this.options.closeButton&&(a=this._closeButton=Z.DomUtil.create("a",b+"-close-button",d),a.href="#close",a.innerHTML="&#215;",Z.DomEvent.on(a,"click",this._onCloseButtonClick,this));var e=this._wrapper=Z.DomUtil.create("div",b+"-content-wrapper",d);return this._titleNode=Z.DomUtil.create("div",b+"-title",e),this._contentNode=Z.DomUtil.create("div",b+"-content",e),this._tipContainer=Z.DomUtil.create("div",b+"-tip-container",d),this._tip=Z.DomUtil.create("div",b+"-tip",this._tipContainer),d},_updatePopupLayout:function(a){var b=this._contentNode,c=b.style;c.width="",c.whiteSpace="nowrap";var d=b.offsetWidth;c.width;d=Math.min(d,this.options.maxWidth),d=Math.max(d,this.options.minWidth),c.width=d+"px",c.whiteSpace="",c.height="";var e=Math.max(b.offsetHeight,this.options.minHeight),f=this.options.maxHeight,g="zmap-popup-scrolled";f&&e>f?(c.height=f+"px",Z.DomUtil.addClass(b,g)):Z.DomUtil.removeClass(b,g)},_fillContent:function(a){if(this._title?(this._titleNode.innerHTML=this._title+"<hr/>",this._titleNode.style.display="block"):this._titleNode.style.display="none","string"==typeof a)this._contentNode.innerHTML=a;else{for(;this._contentNode.hasChildNodes();)this._contentNode.removeChild(this._contentNode.firstChild);this._contentNode.appendChild(a)}},_getPositionOffset:function(a,b){return{x:-Math.round(a/2),y:0}},_getPopupEvents:function(){},_onCloseButtonClick:function(a){this.close(),Z.DomEvent.stop(a)},_adjustPan:function(){if(this.options.autoPan){var a=this._mapScene,b=this._containerHeight,c=this._containerWidth,d=new Z.Point(this._containerLeft,-b-this._containerBottom),e=d,f=Z.Point.create(this.options.autoPanPadding),g=Z.Point.create(this.options.autoPanPaddingTopLeft||f),h=Z.Point.create(this.options.autoPanPaddingBottomRight||f),i=map.getSize(),j=0,k=0;e.x+c+h.x>i.x&&(j=e.x+c-i.x+h.x),e.x-j-g.x<0&&(j=e.x-g.x),e.y+b+h.y>i.y&&(k=e.y+b-i.y+h.y),e.y-k-g.y<0&&(k=e.y-g.y),(j||k)&&a.fire("autopanstart").panByPixel(j,k)}}}),Z.AbstractInfoTemplate=Z.Class.extend({initialize:function(){},getTitle:function(){},getContent:function(){}}),Z.SimpleInfoTemplate=Z.AbstractInfoTemplate.extend({initialize:function(a){Z.AbstractInfoTemplate.prototype.initialize.call(this,a),this._content=null,this._title=null,this.options={showTitle:!0},Z.Util.applyOptions(this.options,a)},getTitle:function(){return this._title},getContent:function(a){return this._content},setTitle:function(a){this._title=a},setContent:function(a){this._content=a}}),Z.PropertyInfoTemplate=Z.SimpleInfoTemplate.extend({initialize:function(a,b){Z.SimpleInfoTemplate.prototype.initialize.call(this,b),this._props=a,this._propConfig={},this.options=Z.Util.applyOptions(this.options,{propertyMapping:[]},!0),Z.Util.applyOptions(this.options,b),this._configProps()},getContent:function(a){return this._propsToHtml(this._props)},_configProps:function(){var a=this.options.propertyMapping;if(a&&a.length>0)for(var b=0;b<a.length;b++)this._propConfig[a[b].name]=a[b];else for(var c in this._props)this._propConfig[c]={name:c,title:c}},_propsToHtml:function(a){a=a||{};var b="",c="";this.getTitle();for(var d in a)this._showProp(d)&&(c.length>0&&(c+="<br/>"),c+="<label>"+this._getPropLabel(d)+": </label><label>"+this._getPropValue(d,a[d])+"</label>");return b+=c},_showProp:function(a){return!!this._propConfig[a]},_getPropLabel:function(a){var b=this._propConfig[a];return b&&b.title?b.title:a},_getPropValue:function(a,b){var c=this._propConfig[a];return c&&c.func?c.func(a,b):b}}),Z.Tip=Z.AbstractPopup.extend({initialize:function(a,b){this.options={minWidth:50,maxWidth:300,hideNullContent:!0,autoPan:!1,stopPropagation:!1,offset:[0,0],autoPanPadding:[5,5],keepInView:!1,className:"",zoomAnimation:!0},this._symbol=null,Z.Util.applyOptions(this.options,b,!1),Z.AbstractPopup.prototype.initialize.call(this,this.options),this._target=a},updateSymbol:function(a){a&&(a===this._symbol||a.equals(this._symbol)||(this._setStyle(this._wrapper,a),this._symbol=a))},_setStyle:function(a,b){var c=b||new Z.TextSymbol,d=a.style;if(d.fontSize=c.font.size+"em",d.fontFamily=c.font.family,d.fontWeight=c.font.weight,d.fontStyle=c.font.style,d.color=c.color,c.fill){var e=c.fillSymbol,f=Z.DomUtil.colorToGRBA(e.bgColor,e.opacity);d.backgroundColor=f}if(c.border){var g=c.borderSymbol,h=Z.DomUtil.colorToGRBA(g.color,g.opacity);d.borderWidth=g.width+"px",d.borderStyle=g.style,d.borderColor=h}else d.borderWidth="0px"},_getParentNode:function(a){return a._viewFrame.tipPane.root},_initLayout:function(){var a="zmap-popup",b=a+" "+this.options.className,c=Z.DomUtil.create("div",b),d=this._wrapper=Z.DomUtil.create("div",a+"-content-wrapper",c);return this._contentNode=Z.DomUtil.create("div",a+"-content",d),this._tipContainer=Z.DomUtil.create("div",a+"-tip-container",c),this._tip=Z.DomUtil.create("div",a+"-tip",this._tipContainer),c},_updatePopupLayout:function(a){var b=this._contentNode,c=b.style;c.width="",c.whiteSpace="nowrap";var d=b.offsetWidth;d=Math.min(d,this.options.maxWidth),d=Math.max(d,this.options.minWidth),c.width=d+1+"px",c.whiteSpace="",c.height="";var e=b.offsetHeight,f=this.options.maxHeight,g="zmap-popup-scrolled";f&&e>f?(c.height=f+"px",Z.DomUtil.addClass(b,g)):Z.DomUtil.removeClass(b,g)},_fillContent:function(a){if("string"==typeof a)this._contentNode.innerHTML=a;else{for(;this._contentNode.hasChildNodes();)this._contentNode.removeChild(this._contentNode.firstChild);this._contentNode.appendChild(a)}},_getPositionOffset:function(a,b){return{x:-Math.round(a/2),y:0}}}),Z.Label=Z.AbstractPopup.extend({options:{minWidth:50,maxWidth:300,hideNullContent:!0,symbol:null,autoPan:!1,offset:[0,0],autoPanPadding:[5,5],keepInView:!1,className:"",zoomAnimation:!0},initialize:function(a,b){Z.Util.applyOptions(this.options,b,!1),Z.AbstractPopup.prototype.initialize.call(this,this.options),this._target=a},_getParentNode:function(a){return a._viewFrame.labelPane.root},_initLayout:function(){var a="zmap-popup",b=a+" "+this.options.className,c=Z.DomUtil.create("div",b),d=this._wrapper=Z.DomUtil.create("div","",c);return this._contentNode=Z.DomUtil.create("div","",d),this._setStyle(c),c},_setStyle:function(){var a=this.options.symbol||new Z.TextSymbol;if(this._wrapper.style.fontSize=a.font.size+"em",this._wrapper.style.fontFamily=a.font.family,this._wrapper.style.fontWeight=a.font.weight,this._wrapper.style.fontStyle=a.font.style,this._wrapper.style.color=a.color,a.fill){var b=a.fillSymbol;this._wrapper.style.backgroundColor=Z.DomUtil.colorToGRBA(b.bgColor,b.opacity)}if(a.border){var c=a.borderSymbol;this._wrapper.style.borderWidth=c.width,this._wrapper.style.borderStyle=c.style,this._wrapper.style.borderColor=Z.DomUtil.colorToGRBA(c.color,c.opacity)}},_updatePopupLayout:function(a){var b=this._contentNode,c=b.style;c.width="",c.whiteSpace="nowrap";var d=b.offsetWidth;d=Math.min(d,this.options.maxWidth),d=Math.max(d,this.options.minWidth),c.width=d+1+"px",c.whiteSpace="",c.height="";var e=b.offsetHeight,f=this.options.maxHeight,g="zmap-popup-scrolled";f&&e>f?(c.height=f+"px",Z.DomUtil.addClass(b,g)):Z.DomUtil.removeClass(b,g)},_fillContent:function(a){if("string"==typeof a)this._contentNode.innerHTML=a;else{for(;this._contentNode.hasChildNodes();)this._contentNode.removeChild(this._contentNode.firstChild);this._contentNode.appendChild(a)}},_getPositionOffset:function(a,b){return{x:-Math.round(a/2),y:0}},_getPopupEvents:function(){return[]}}),Z.SingleTip=function(){var a,b;return{getInstance:function(c){var d=null,e=null;try{getCurrentMapContext&&(d=getCurrentMapContext())}catch(a){}if(d){if(!(e=d.getSingleInstance("SingleTip"))){var f=new Z.Tip;f.onAdd(c),b=c,d.registerSingleInstance("SingleTip",f)}e=d.getSingleInstance("SingleTip")}else a||(a=new Z.Tip,a.onAdd(c),b=c),e=a;return c&&c!==b&&(e.onRemove(b),e.onAdd(c),b=c),e}}}(),Z.SinglePopup=function(){var a,b;return{getInstance:function(c,d){var e=null,f=null;try{getCurrentMapContext&&(e=getCurrentMapContext())}catch(a){}if(e){if(!(f=e.getSingleInstance("SinglePopup"))){var g=new Z.Popup(d);g.onAdd(c),b=c,e.registerSingleInstance("SinglePopup",g)}f=e.getSingleInstance("SinglePopup")}else a||(a=new Z.Popup(d),a.onAdd(c),b=c),f=a;return c&&c!==b&&(f.onRemove(b),f.onAdd(c),b=c),f}}}(),Z.PictureIcon=Z.AbstractIcon.extend({initialize:function(a,b){Z.AbstractIcon.prototype.initialize.call(this,b),this._pictureUrl=a,this._imageObj=null},setContent:function(a,b,c){this._imageObj||(this._imageObj=new Image,this._imageObj.src=this._pictureUrl,a.appendChild(this._imageObj)),this._setNodeSize(this._imageObj,b,c)},setPicture:function(a){this._pictureUrl=a,this.update()},_setNodeSize:function(a,b,c){"number"!=typeof b||isNaN(b)||a.width===b||(a.width=b),"number"!=typeof c||isNaN(c)||a.height===c||(a.height=c)}}),Z.TextIcon=Z.AbstractIcon.extend({initialize:function(a,b,c){Z.AbstractIcon.prototype.initialize.call(this,c),this._text=a,this._symbol=b,this._wrapperNode=null,this._contentNode=null,this._tipContainer=null,this._tip=null},setContent:function(a,b,c){this._contentNode||this._createContentNode(a,this._symbol),this._setStyle(this._wrapperNode,this._symbol),this._fillContent(this._text),this._setNodeSize(this._wrapperNode,b,c)},setText:function(a){this._text=a,this.update(),this._contentUpdated=!0},updateSymbol:function(a){a&&(this._setStyle(this._wrapperNode,a),this._symbol=a)},_createContentNode:function(a,b){var c=this._wrapperNode=Z.DomUtil.create("div","",a);return this._contentNode=Z.DomUtil.create("div","",c),this._createAnchorNode(a),b.anchor?this._showAnchorNode():this._hideAnchorNode(),a},_createAnchorNode:function(a){this._tipContainer=Z.DomUtil.create("div","zmap-title-tip-container",a),this._tip=Z.DomUtil.create("div","zmap-title-tip",this._tipContainer)},_showAnchorNode:function(){this._showNode(this._tipContainer)},_hideAnchorNode:function(){this._hideNode(this._tipContainer)},_showNode:function(a){a.style.display="block"},_hideNode:function(a){a.style.display="none"},_setStyle:function(a,b){var c=b||new Z.TextSymbol,d=a.style;if(d.fontSize=c.font.size+"em",d.fontFamily=c.font.family,d.fontWeight=c.font.weight,d.fontStyle=c.font.style,d.color=c.color,c.fill){var e=c.fillSymbol,f=Z.DomUtil.colorToGRBA(e.bgColor,e.opacity);d.backgroundColor=f}if(c.border){var g=c.borderSymbol,h=Z.DomUtil.colorToGRBA(g.color,g.opacity);d.borderWidth=g.width+"px",d.borderStyle=g.style,d.borderColor=h}else d.borderWidth="0px";this._setAnchorStyle(c)},_setAnchorStyle:function(a){var b=a;if(this._hideAnchorNode(),b.fill){var c=b.fillSymbol,d=Z.DomUtil.colorToGRBA(c.bgColor,c.opacity);this._tip.style.backgroundColor=d}if(b.border){var e=b.borderSymbol,f=Z.DomUtil.colorToGRBA(e.color,e.opacity);this._tip.style.borderWidth=e.width,this._tip.style.borderStyle=e.style,this._tip.style.borderColor=f}else this._tip.style.borderWidth="0px";a.anchor&&this._showAnchorNode()},_fillContent:function(a){if("string"==typeof a)this._contentNode.innerHTML=a;else{for(;this._contentNode.hasChildNodes();)this._contentNode.removeChild(this._contentNode.firstChild);this._contentNode.appendChild(a)}},_setNodeSize:function(a,b,c){"number"!=typeof b||isNaN(b)||a.width===b||(a.width=b),"number"!=typeof c||isNaN(c)||a.height===c||(a.height=c)}}),Z.Symbol=Z.Class.extend({initialize:function(a){a=a||{},this.opacity="number"==typeof a.opacity?a.opacity:1},equals:function(a){var b=!1;return a instanceof Z.Symbol&&(b=!0,this.opacity!==a.opacity&&(b=!1)),b},clone:function(a){return new Z.Symbol({opacity:this.opacity})}}),Z.MarkerSymbol=Z.Symbol.extend({initialize:function(a){Z.Symbol.prototype.initialize.call(this,a),a=a||{},this.width=a.width,this.height=a.height,this.anchor=a.anchor||"bottomCenter",this.offset=a.offset},equals:function(a){var b=!1;if(a instanceof Z.MarkerSymbol){var c=this.offset||new Z.Point(0,0);this.width===a.width&&this.height===a.height&&c.equals(a.offset)&&(b=!0),b&&(b=Z.Symbol.prototype.equals.call(this,a))}return b},clone:function(){var a=new Z.MarkerSymbol,b=Z.Symbol.prototype.clone.apply(this,[{opacity:this.opacity}]);return Z.Util.objectClone(b,a),a.width=this.width,a.height=this.height,a.offset=this.offset,a.anchor=this.anchor,a}}),Z.FontStyle={Normal:"normal",Italic:"italic"},Z.FontWeight={Normal:"normal",Bold:"bold"},Z.FontFamily={Helvetiker:"helvetiker",Optimer:"optimer",Gentilis:"gentilis",DroidSans:"droid sans",DroidSerif:"droid serif"},Z.Font=function(a){a=a||{},this.family=a.family||Z.FontFamily.Helvetiker,this.size=a.size||"1em",this.style=a.style||Z.FontStyle.Normal,this.weight=a.weight||Z.FontWeight.Normal},Z.Font.prototype.equals=function(a){return a instanceof Z.Font&&(this.family===a.family&&this.size===a.size&&this.style===a.style&&this.weight===a.weight)},Z.Font.prototype.clone=function(){var a=new Z.Font;return a.family=this.family,a.size=this.size,a.style=this.style,a.weight=this.weight,a},Z.SimpleMarkerType={Circle:1,Square:2,Triangle:3,Sphere:4,Cube:5},Z.PolylineStyleType={Dash:"dashed",Solid:"solid",Null:""},Z.FillStyleType={Solid:0,Null:1},Z.PictureMarkerSymbol=Z.MarkerSymbol.extend({initialize:function(a){a=a||{},Z.MarkerSymbol.prototype.initialize.call(this,a),this.url=a.url},equals:function(a){var b=!1;return a instanceof Z.PictureMarkerSymbol&&(this.url===a.url&&(b=!0),b&&(b=Z.MarkerSymbol.prototype.equals.call(this,a))),b},clone:function(){var a=new Z.PictureMarkerSymbol,b=Z.MarkerSymbol.prototype.clone.apply(this,[{opacity:this.opacity,width:this.width,height:this.height,offset:this.offset}]);return Z.Util.objectClone(b,a),a.url=this.url,a}}),Z.SimpleMarkerSymbol=Z.MarkerSymbol.extend({initialize:function(a){a=a||{},Z.MarkerSymbol.prototype.initialize.apply(this,a),this.type=a.type||Z.SimpleMarkerType.Square,this.borderColor=a.borderColor,this.borderWidth=a.borderWidth,this.fill=a.fill,this.fillColor=a.fillColor},equals:function(a){var b=!1;return a instanceof Z.SimpleMarkerSymbol&&(this.type===a.type&&this.borderColor===a.borderColor&&this.borderWidth===a.borderWidth&&this.fill===a.fill&&this.fillColor===a.fillColor&&(b=!0),b&&(b=Z.MarkerSymbol.prototype.equals.call(this,a))),b},clone:function(){var a=new Z.SimpleMarkerSymbol,b=Z.MarkerSymbol.prototype.clone.apply(this,[{opacity:this.opacity,width:this.width,height:this.height,offset:this.offset}]);return Z.Util.objectClone(b,a),a.type=this.type,a.borderColor=this.borderColor,a.borderWidth=this.borderWidth,a.fill=this.fill,a.fillColor=this.fillColor,a}}),Z.TextSymbol=Z.MarkerSymbol.extend({initialize:function(a){a=a||{},Z.MarkerSymbol.prototype.initialize.call(this,a),this.text=a.text,this.font=a.font?new Z.Font(a.font):new Z.Font,this.color=a.color||"#222222",this.fill="boolean"!=typeof a.fill||a.fill,this.fillSymbol=a.fillSymbol instanceof Z.FillSymbol?a.fillSymbol:new Z.SimpleFillSymbol(a.fillSymbol),this.border="boolean"!=typeof a.border||a.border,this.borderSymbol=a.borderSymbol instanceof Z.PolylineSymbol?a.borderSymbol:new Z.PolylineSymbol(a.borderSymbol),this.anchor=a.anchor||!1},equals:function(a){var b=!1;return a instanceof Z.TextSymbol&&(this.text===a.text&&this.font.equals(a.font)&&this.color===a.color&&this.fill===a.fill&&this.fillSymbol.equals(a.fillSymbol)&&this.border===a.border&&this.borderSymbol.equals(a.borderSymbol)&&(b=!0),b&&(b=Z.MarkerSymbol.prototype.equals.call(this,a))),b},clone:function(){var a=new Z.TextSymbol,b=Z.MarkerSymbol.prototype.clone.apply(this,[{opacity:this.opacity,width:this.width,height:this.height,offset:this.offset}]);return Z.Util.objectClone(b,a),a.text=this.text,a.font=this.font.clone(),a.color=this.color,a.fill=this.fill,a.fillSymbol=this.fillSymbol.clone(),a.border=this.border,a.borderSymbol=this.borderSymbol.clone(),a}}),Z.PolylineSymbol=Z.Symbol.extend({initialize:function(a){Z.Symbol.prototype.initialize.call(this,a),a=a||{},this.color=a.color||"#555500",this.width=a.width||1,this.style=a.style||Z.PolylineStyleType.Solid,this.dashSize=a.dashSize||10,this.gapSize=a.gapSize||5,this.only2d=a.only2d||!0},equals:function(a){var b=!1;return a instanceof Z.PolylineSymbol&&(this.color===a.color&&this.width===a.width&&this.style===a.style&&this.only2d===a.only2d&&(b=!0),b&&(b=Z.Symbol.prototype.equals.call(this,a))),b},clone:function(){var a=new Z.PolylineSymbol;return a.opacity=this.opacity,a.color=this.color,a.width=this.width,a.style=this.style,a.only2d=this.only2d,a}}),Z.FillSymbol=Z.Symbol.extend({initialize:function(a){Z.Symbol.prototype.initialize.call(this,a),a=a||{},this.bgColor=a.bgColor||"#ffffff"},equals:function(a){var b=!1;return a instanceof Z.FillSymbol&&(this.bgColor===a.bgColor&&(b=!0),b&&(b=Z.Symbol.prototype.equals.call(this,a))),b},clone:function(){var a=new Z.FillSymbol;return a.opacity=this.opacity,a.bgColor=this.bgColor,a}}),Z.SimpleFillSymbol=Z.FillSymbol.extend({initialize:function(a){a=a||{},Z.FillSymbol.prototype.initialize.call(this,a),this.color=a.color||"#ffffff",this.style=a.style||Z.FillStyleType.Solid},equals:function(a){var b=!1;return a instanceof Z.SimpleFillSymbol&&(this.color===a.color&&this.style===a.style&&(b=!0),b&&(b=Z.FillSymbol.prototype.equals.call(this,a))),b},clone:function(){var a=new Z.SimpleFillSymbol;return a.opacity=this.opacity,a.bgColor=this.bgColor,a.color=this.color,a.style=this.style,a}}),Z.PictureFillSymbol=Z.FillSymbol.extend({initialize:function(a){a=a||{},Z.FillSymbol.prototype.initialize.call(this,a),this.url=a.url},equals:function(a){var b=!1;return a instanceof Z.PictureFillSymbol&&(this.url===a.url&&(b=!0),b&&(b=Z.FillSymbol.prototype.equals.call(this,a))),b},clone:function(){return symbol=new Z.PictureFillSymbol,symbol.opacity=this.opacity,symbol.bgColor=this.bgColor,symbol.url=this.url,symbol}}),Z.PolygonSymbol=Z.Symbol.extend({initialize:function(a){a=a||{},Z.Symbol.prototype.initialize.call(this,a),this.polylineSymbol=a.polylineSymbol||new Z.PolylineSymbol,this.polylineSymbol.opacity="number"==typeof this.polylineSymbol.opacity?this.polylineSymbol.opacity:this.opacity,this.fillSymbol=a.fillSymbol||new Z.SimpleFillSymbol,this.fillSymbol.opacity="number"==typeof this.fillSymbol.opacity?this.fillSymbol.opacity:this.opacity,this.hidePolyline="boolean"==typeof a.hidePolyline&&a.hidePolyline,this.hideFill="boolean"==typeof a.hideFill&&a.hideFill},equals:function(a){var b=!1;return a instanceof Z.PolygonSymbol&&(this.polylineSymbol.equals(a.polylineSymbol)&&this.fillSymbol.equals(a.fillSymbol)&&this.hidePolyline===a.hidePolyline&&this.hideFill===a.hideFill&&(b=!0),b&&(b=Z.Symbol.prototype.equals.call(this,a))),b},clone:function(){var a=new Z.PolygonSymbol;return a.opacity=this.opacity,a.polylineSymbol=this.polylineSymbol.clone(),a.fillSymbol=this.fillSymbol.clone(),a.hidePolyline=this.hidePolyline,a.hideFill=this.hideFill,a}}),Z.ExtrudeSymbol=Z.Symbol.extend({initialize:function(a){Z.Symbol.prototype.initialize.call(this,a),a=a||{},this.topColor=a.topColor||"#aaaaaa",this.topImageUrl=a.topImageUrl,this.wallColor=a.wallColor||"#aaaaaa",this.wallImageUrl=a.wallImageUrl,this.wire=a.wire||!1,this.wireSymbol=a.wireSymbol||new Z.PolylineSymbol,this.side="FrontSide"},equals:function(a){var b=!1;return a instanceof Z.ExtrudeSymbol&&(this.topColor===a.topColor&&this.topImageUrl===a.topImageUrl&&this.wallColor===a.wallColor&&this.wallImageUrl===a.wallImageUrl&&this.wire===a.wire&&this.wireSymbol.equals(a.wireSymbol)&&this.side===a.side&&(b=!0),b&&(b=Z.Symbol.prototype.equals.call(this,a))),b},clone:function(){var a=new Z.ExtrudeSymbol;return a.opacity=this.opacity,a.topColor=this.topColor,a.topImageUrl=this.topImageUrl,a.wallColor=this.wallColor,a.wallImageUrl=this.wallImageUrl,a.wire=this.wire,a.wireSymbol=this.wireSymbol,a}}),Z.CircleSymbol=Z.Symbol.extend({initialize:function(a){Z.Symbol.prototype.initialize.call(this,a),this.borderSymbol=a.borderSymbol||new Z.PolylineSymbol,this.borderSymbol.opacity="number"==typeof this.borderSymbol.opacity?this.borderSymbol.opacity:this.opacity,this.fillSymbol=a.fillSymbol||new Z.SimpleFillSymbol,this.fillSymbol.opacity="number"==typeof this.fillSymbol.opacity?this.fillSymbol.opacity:this.opacity,this.hidePolyline="boolean"==typeof a.hideBorder&&a.hideBorder,this.hideFill="boolean"==typeof a.hideFill&&a.hideFill,this.segments="number"==typeof a.segments?a.segments:360},equals:function(a){var b=!1;return a instanceof Z.CircleSymbol&&(b=Z.Symbol.prototype.equals.call(this,a))&&(this.borderSymbol.equals(a.borderSymbol)&&this.fillSymbol.equals(a.fillSymbol)&&this.hidePolyline===a.hidePolyline&&this.hideFill===a.hideFill&&this.segments===a.segments||(b=!1)),b},clone:function(){var a=new Z.CircleSymbol;return a.opacity=this.opacity,a.borderSymbol=this.borderSymbol.clone(),a.fillSymbol=this.fillSymbol.clone(),a.hideBorder=this.hideBorder,a.hideFill=this.hideFill,a.segments=this.segments,a}}),Z.RingSymbol=Z.CircleSymbol.extend({initialize:function(a){Z.CircleSymbol.prototype.initialize.call(this,a)},clone:function(){return Z.CircleSymbol.prototype.clone.call(this)}}),Z.ModelSymbol=Z.Symbol.extend({initialize:function(a){Z.Symbol.prototype.initialize.call(this,a),this.ka=a.ka,this.kd=a.kd,this.ks=a.ks,this.ke=a.ke,this.sharpness=a.sharpness,this.illum=a.illum,this.ni=a.ni,this.d=a.d,this.map_ka=a.map_ka,this.map_kd=a.map_kd,this.map_ks=a.map_ks,this.map_bump=a.map_bump||a.bump,this.refl=a.refl,this.map_ka_wrap=a.map_ka_wrap||THREE.RepeatWrapping,this.map_kd_wrap=a.map_kd_wrap||THREE.RepeatWrapping,this.map_ks_wrap=a.map_ks_wrap||THREE.RepeatWrapping,this.map_bump_wrap=a.map_bump_wrap||THREE.RepeatWrapping,this.isLine=a.isLine||!1,this.name=a.name||"",this.path=a.path||""},equals:function(a){var b=!1;return a instanceof Z.ModelSymbol&&(b=Z.Symbol.prototype.equals.call(this,a))&&(this.ka===a.ka&&this.kd===a.kd&&this.ks===a.ks&&this.ke===a.ke&&this.sharpness===a.sharpness&&this.illum===a.illum&&this.ni===a.ni&&this.d===a.d&&this.refl===a.refl&&this.isLine===a.isLine||(b=!1)),b},clone:function(){return new Z.ModelSymbol(this)}}),Z.GroupSymbol=Z.Class.extend({initialize:function(a,b){this.groups=a||[],this.symbols=b||[]},clone:function(){return new Z.GroupSymbol(this.groups,this.symbols)}}),Z.Graphic=Z.Class.extend({includes:Z.EventManager,initialize:function(a,b,c){this.options={enableTitle:!1,enableIcon:!1,tip:"",tipSymbol:null,title:"",titleSymbol:new Z.TextSymbol,titleMouseoverSymbol:null,titleSelectSymbol:null,iconSymbol:null,iconMouseoverSymbol:null,iconSelectSymbol:null,markerSymbol:null,markerMouseoverSymbol:null,markerSelctSymbol:null,infoTemplate:null,mouseoverSymbol:null,selectSymbol:null},Z.Util.applyOptions(this.options,c,!0),this.feature=a,this.symbol=b||this._getDefaultSymbol(a),this.eventCapturable=!0,this.eventFirable=!0,this._layer=null,this._container=null,this._titleElement=null,this._scene=null,this._mainElementRoot=null,this._mainElement=null,this._iconElement=null,this._infoTemplate=this.options.infoTemplate,this._added=!1,this._show=!0,this._titleShowing=!1,this._tipShowing=!1,this._iconShowing=!1,this._infoWindowShowing=!1,this._titleContent=null,this._titleSymbol=null,this._titleMouseoverSymbol=null,this._titleSelectSymbol=null,this._tipContent=null,this._tipSymbol=null,this._currentSymbol=this.symbol,this._currentTitleSymbol=null,this.needsUpdate=!0},updateFeature:function(a){a instanceof Z.Feature&&(this.feature=a,this._updateFeature(a),this.refresh(),this.needsUpdate=!0,this.fire("featureupdated"))},updateSymbol:function(a){a&&(this.symbol=a,this._updateSymbol(a),this._currentSymbol=a,this.needsUpdate=!0,this.fire("symbolupdated"))},updateTitleSymbol:function(a,b,c){this._titleSymbol=a,this._titleMouseoverSymbol=b,this._titleSelectSymbol=c,this._updateTitleSymbol(a),this._currentTitleSymbol=a,this.needsUpdate=!0},getTitleSymbol:function(){return{titleSymbol:this._titleSymbol,mouseoverSymbol:this._titleMouseoverSymbol,selectSymbol:this._titleSelectSymbol}},updateTitleContent:function(a){this._titleContent=a},getTitleContent:function(){return this._titleContent},resetTitleContent:function(){this._titleContent=null},updateTipSymbol:function(a){this._tipSymbol=a},getTipSymbol:function(){return this._getTipSymbol()},updateTipContent:function(a){this._tipContent=a},getTipContent:function(){return this._tipContent},resetTipContent:function(){this._tipContent=null},onAdd:function(a,b,c){if(!(this.feature instanceof Z.Feature&&(this.symbol instanceof Z.Symbol||this.symbol instanceof Z.GroupSymbol)))return void console.info("feature或者symbol属性不合法");this._layer&&this._layer!==a&&this.onRemove(this._layer),this._mainElement||(this._mainElement=new Z.GraphicElement(this.feature,this.symbol)),this._mainElement.ownerGraphic!==this&&(this._mainElement.ownerGraphic=this),this.feature.shape.crs||(this.feature.shape.crs=c.options.crs),!this._mainElementRoot&&b&&(this._mainElementRoot=b.newInstance(),b.addChild(this._mainElementRoot)),this._mainElement.onAdd(a,this._mainElementRoot,c),this._layer=a,this._container=b,this._scene=c,this.options.enableTitle&&this._titleShowing&&this.showTitle(),this.options.enableIcon&&this._iconShowing&&this.showIcon(),this._added=!0,this._show?this._doShow():this._doHide(),this.needsUpdate=!0,this.fire("added")},onRemove:function(a){this._mainElement&&(this._mainElement.onRemove(a),this._mainElement.ownerGraphic=null),this._titleElement&&(this._titleElement.onRemove(a),this._titleElement=null),this._mainElementRoot&&this._container&&(this._container.removeChild(this._mainElementRoot),this._mainElementRoot=null),this._infoWindowShowing&&this.hideInfoWindow(),this._layer=null,this._container=null,this._scene=null,this._added=!1,this.needsUpdate=!0,this.fire("removed")},dispose:function(){this._added&&this.onRemove(this._layer),this._mainElement&&(this._mainElement.dispose(),this._mainElement=null),this._titleElement&&(this._titleElement=null),this.fire("disposed")},refresh:function(){if(this._show){if(this._mainElement&&this._mainElement.refresh(),this._titleElement&&this.options.enableTitle&&this._titleShowing){this.showTitle();var a=this._getTitlePos();this._titleElement.setLatLng(a)}if(this._iconElement&&this.options.enableIcon&&this._iconShowing){this.showIcon();var b=this._getTitlePos();this._iconElement.setLatLng(b)}}},showTitle:function(a){if(this._show){var b=a||Z.Util.stringTrim(this._getTitleText());if(b&&this._layer){var c=this._getTitleGraphic();c.setText(b),c.show()}}this._titleShowing=!0},hideTitle:function(){this._show&&this._titleElement&&this._layer&&this._titleElement.hide(),this._titleShowing=!1},showIcon:function(){if(this._iconShowing=!0,this._show){if(!this._layer)return;this._getIconElement().show()}},hideIcon:function(){if(this._iconShowing=!1,this._show){if(!this._layer||!this._iconElement)return;this._getIconElement().hide()}},showInfoWindow:function(a){if(this._infoWindowShowing=!0,this._show){if(!this._layer)return;var b=this._getInfoTemplate(),c=b.getContent?b.getContent():null,d=b.getTitle?b.getTitle():null,e=this._getTitlePos();this._layer._scene.openPopup(d,c,e,a)}},hideInfoWindow:function(){if(this._infoWindowShowing=!1,this._show){if(!this._layer)return;this._layer._scene.closePopup()}},showTip:function(){if((!this._titleShowing||this._titleIsNull())&&(this._tipShowing=!0,this._show)){if(!this._layer)return;var a=this._getTipText()||"",b=this._getTipSymbol();if(a&&a.replace(/\s+/,"")){var c=Z.SingleTip.getInstance(this._layer._scene);c.updateSymbol(b);var d=this._getTitlePos();c.setLatLng(d),c.setContent(a),c.open()}}},hideTip:function(){if(this._tipShowing=!1,this._show){if(!this._layer)return;Z.SingleTip.getInstance(this._layer._scene).close()}},show:function(a){this._show&&!a||(this._doShow(),this._show=!0,this.needsUpdate=!0,this.fire("show"))},hide:function(a){(this._show||a)&&(this._doHide(),this._show=!1,this.needsUpdate=!0,this.fire("hide"))},isShowing:function(){return this._show},isTitleShowing:function(){return this._titleShowing},isAdded:function(){return this._added},enableTitle:function(){this.options.enableTitle=!0,this.showTitle()},disableTitle:function(){this.options.enableTitle=!1,this.hideTitle()},enableIcon:function(){this.options.enableIcon=!0,this.showIcon()},disableIcon:function(){this.options.enableIcon=!1,this.hideIcon()},doMouseOver:function(){var a=this.options.mouseoverSymbol;if(a&&(this._updateSymbol(a),this.needsUpdate=!0,this.fire("symbolupdated")),this._titleShowing){var b=this._titleMouseoverSymbol||this.options.titleMouseoverSymbol;this._updateTitleSymbol(b)}},doMouseOut:function(){(this._titleMouseoverSymbol||this.options.mouseoverSymbol)&&(this._updateSymbol(this._currentSymbol),this.needsUpdate=!0,this.fire("symbolupdated")),this._titleShowing&&this._updateTitleSymbol(this._currentTitleSymbol)},doSelect:function(){var a=this.options.selectSymbol;if(a&&(this._updateSymbol(a),this._currentSymbol=a,this.needsUpdate=!0,this.fire("symbolupdated")),this._titleShowing){var b=this._titleSelectSymbol||this.options.titleSelectSymbol;this._updateTitleSymbol(b),this._currentTitleSymbol=b}},doUnselect:function(){if(this.options.selectSymbol&&(this._updateSymbol(this.symbol),this._currentSymbol=this.symbol,this.needsUpdate=!0,this.fire("symbolupdated")),this._titleShowing){var a=this._getTitleSymbol();this._updateTitleSymbol(a),this._currentTitleSymbol=a}},resetSymbol:function(){if(this._currentSymbol!==this.symbol&&(this._updateSymbol(this.symbol),this._currentSymbol=this.symbol,this.needsUpdate=!0,this.fire("symbolupdated"),this._titleShowing)){var a=this._getTitleSymbol();this._updateTitleSymbol(a),this._currentTitleSymbol=a}},setInfoTemplate:function(a){this._infoTemplate=a},getInfoTemplate:function(){return this._infoTemplate},clone:function(){var a,b=this.feature.clone(),c=this.symbol.clone(),d=this.options;a={enableTitle:d.enableTitle,enableIcon:d.enableIcon,tip:d.tip,title:d.title,titleSymbol:d.titleSymbol?d.titleSymbol.clone():null,iconSymbol:d.iconSymbol?d.iconSymbol.clone():null,markerSymbol:d.markerSymbol?d.markerSymbol.clone():null,infoTemplate:d.infoTemplate?d.infoTemplate.clone():null,mouseoverSymbol:d.mouseoverSymbol?d.mouseoverSymbol.clone():null,selectSymbol:d.selectSymbol?d.selectSymbol.clone():null};var e=new Z.Graphic(b,c,a);return e.eventCapturable=this.eventCapturable,e.eventFirable=this.eventFirable,e._show=this._show,e._titleShowing=this._titleShowing,e._tipShowing=this._tipShowing,e._iconShowing=this._iconShowing,e._infoWindowShowing=this._infoWindowShowing,e._titleContent=this._titleContent,e._titleSymbol=this._titleSymbol,e},_getDefaultSymbol:function(a){},_updateFeature:function(a){this._mainElement&&this._mainElement.updateFeature(a)},_updateSymbol:function(a){this._mainElement&&this._mainElement.updateSymbol(a)},_updateTitleSymbol:function(a){this._titleElement&&this._titleElement.updateSymbol(a)},_getTipText:function(){var a=this._tipContent||Z.Util.getConfigValue(this.feature.props,this.options.tip);return a?a+"":""},_getTitleText:function(){var a=this._titleContent||Z.Util.getConfigValue(this.feature.props,this.options.title);return Z.DomUtil.isDom(a)?a:a?a+"":""},_getTitleGraphic:function(){if(this._titleElement)return this._titleElement;var a=this._getTitleSymbol();this._currentTitleSymbol!==a&&(this._currentTitleSymbol=a),this._titleElement=new Z.TextIcon("",a,{width:"auto",height:"auto",anchor:"bottomCenter",offset:[0,0]}),this._applyTitleEvents("on"),this._titleElement.onAdd(this._layer._scene);var b=this._getTitlePos();this._titleElement.setLatLng(b);var c=this._getTitleText();return this._titleElement.setText(c),this._titleElement},_applyTitleEvents:function(a){if(Z.DomEvent){a=a||"on";var b,c,d=["click","mouseover","mouseout"];for(b=0,c=d.length;b<c;b++)Z.DomEvent[a](this._titleElement,d[b],this._reactTitleEvent,this)}},_reactTitleEvent:function(a){a.type;this._layer&&this._layer.delegateGraphicEvent(this,a)},_getTitlePos:function(){var a,b=this.feature.shape;if(b instanceof Z.LatLng)a=b.clone();else{var c=b.getBounds();a=c.getCenter(),a.alt=c.getNorthEast().alt}return a},_getTitleSymbol:function(){if(this._titleSymbol)return this._titleSymbol;var a=this.options||{};return a.titleSymbol?a.titleSymbol.clone():new Z.TextSymbol},_getInfoTemplate:function(){if(!this._infoTemplate){var a=this.options.infoTemplate;if(!a){var b=this.feature?this.feature.props||{}:{};a=new Z.PropertyInfoTemplate(b),a.setTitle(this._getTitleText())}this._infoTemplate=a}return this._infoTemplate},_getIconElement:function(){if(this._iconElement)return this._iconElement;var a=this._getIconSymbol(),b=a.offset,c=b?[b.x,b.y]:[0,0];a instanceof Z.PictureMarkerSymbol&&(this._iconElement=new Z.PictureIcon(a.url,{offset:c,anchor:a.anchor,width:a.width,height:a.height})),this._iconElement.onAdd(this._layer._scene);var d=this._getTitlePos();return this._iconElement.setLatLng(d),this._iconElement},_getIconSymbol:function(){var a=this.options||{};return a.iconSymbol?a.iconSymbol.clone():new Z.PictureMarkerSymbol},_getTipSymbol:function(){return this._tipSymbol||(this._tipSymbol=this.options.tipSymbol||new Z.TextSymbol({border:!1})),this._tipSymbol},_doShow:function(){this._mainElementRoot&&this._mainElementRoot.show(),this.options.enableTitle&&this._titleShowing&&this.showTitle(),this.options.enableIcon&&this._iconShowing&&this.showIcon()},_doHide:function(){this._mainElementRoot&&this._mainElementRoot.hide(),this.hideTitle(),this.hideInfoWindow(),this.hideIcon(),this.hideTip()},_titleIsNull:function(){var a=this._getTitleText(),b=Z.Util.stringTrim();if(a){if("string"==typeof a){var b=Z.Util.stringTrim(a);return!(b&&b.length>0)}return!1}return!0}}),Z.GraphicElement=Z.Class.extend({includes:Z.EventManager,initialize:function(a,b,c){this.feature=a,this.symbol=b,this.options=c||{},this.ownerGraphic=null,this._layer=null,this._render=null,this._added=!1},updateFeature:function(a){a instanceof Z.Feature&&(this.feature=a,this._render&&this._added&&this._render.updateGeometry(a.shape))},updateSymbol:function(a){a&&(this.symbol=a,this._render&&this._added&&this._render.updateSymbol(a))},onAdd:function(a,b,c){var d=this._getGraphicRender(a,c);d&&(this._added||(this._render&&this._render.onRemove(a),this._render=d,this._render.onAdd(a,b,c)),this._layer=a,this._added=!0)},onRemove:function(a){this._render&&this._render.onRemove(a),this._layer=null,this._added=!1},dispose:function(){this._added&&this.onRemove(this._layer),this._render&&(this._render.dispose(),this._render=null)},refresh:function(){this._render&&this._render.refresh()},_getGraphicRender:function(a,b){return this._render?a!==this._layer&&this._layer?(this.onRemove(a),this._createGraphicRender(a,b)):this._render:this._createGraphicRender(a,b)},_createGraphicRender:function(a,b){return Z.GraphicRenderFactory.getGraphicRender(a,this,b)}}),Z.GraphicGridIndex=function(a,b,c){this._center=a||new L.point(0,0,0),this._gridWidth=b||100,this._gridHeight=c||100,this._graphicIndex={},this._indexCubeArray=[],this._graphicToIndexMap={}},Z.GraphicGridIndex.prototype.addGraphic=function(a){var b=this._cloneGraphic(a);this._addOneGraphic(b)},Z.GraphicGridIndex.prototype.addGraphics=function(a){if(a=a instanceof Array?a:[a],!(a.length<=0))for(var b=0;b<a.length;b++){var c=this._cloneGraphic(a[b]);this._addOneGraphic(c)}},Z.GraphicGridIndex.prototype.updateGridCubes=function(a){for(var b in this._graphicIndex)if(this._graphicIndex[b].needsUpdate||a){var c=b.split(",");this._updateGridCube(parseInt(c[1]),parseInt(c[0])),this._graphicIndex[b].needsUpdate=!1}},Z.GraphicGridIndex.prototype.deleteGraphic=function(a){for(var b=(a._rawGraphic||a).id,c=this._graphicToIndexMap[b],d=c.minGrid,e=c.maxGrid,f=d.row;f<=e.row;f++)for(var g=d.col;g<=e.col;g++){var h=g+","+f,i=this._graphicIndex[h].objects;if(this._graphicIndex[h]){for(var j=0;j<i.length;j++)if(i[j]._rawGraphic===a){i.splice(j,1);break}this._graphicIndex[h].needsUpdate=!0}}delete this._graphicToIndexMap[b]},Z.GraphicGridIndex.prototype.updateGraphic=function(a){this.deleteGraphic(a),this.addGraphic(a)},Z.GraphicGridIndex.prototype.updateMatrixWorld=function(a){for(var b in this._graphicIndex)if(this._graphicIndex[b]){var c=this._graphicIndex[b].cube;c&&(c.updateMatrix(),c.matrixWorld.multiplyMatrices(a,c.matrix)),this._graphicIndex[b].matrixWorldNeedsUpdate=!0,this._graphicIndex[b].matrixWorld=a}},Z.GraphicGridIndex.prototype.clear=function(){for(var a in this._graphicIndex){var b=this._graphicIndex[a],c=b.cube;c&&(c.dispose(),b.cube=null),b.objects=[]}this._graphicIndex={},this._indexCubeArray=[],this._graphicToIndexMap={}},Z.GraphicGridIndex.prototype.dispose=function(){this.clear()},Z.GraphicGridIndex.prototype.getIntersectMeshes=function(a){var b=this._getIntersectCube(a);return b?this._getIntersectMeshes(a,b):[]},Z.GraphicGridIndex.prototype._cloneGraphic=function(a){var b=a.clone();return b._rawGraphic=a,b.geometry=this._recomputeVertices(a),b},Z.GraphicGridIndex.prototype._recomputeVertices=function(a){var b=a._z_posOffset||{},c=1e-8,d=a.geometry;if(b.x>c||b.y>c||b.z>c){d=d.clone();for(var e=d.vertices,f=0;f<e.length;f++)e[f]=e[f].add(b)}return d},Z.GraphicGridIndex.prototype._addOneGraphic=function(a){var b=this._getGraphicBbox(a),c=this._getGridNum(b.min),d=this._getGridNum(b.max),e=(a._rawGraphic||a).id;this._graphicToIndexMap[e]={minGrid:c,maxGrid:d};for(var f=c.col;f<=d.col;f++)for(var g=c.row;g<=d.row;g++){var h=f+","+g;this._graphicIndex[h]||(this._graphicIndex[h]={cube:null,objects:[],matrixWorldNeedsUpdate:!1,matrixWorld:null,needsUpdate:!1}),this._graphicIndex[h].objects.push(a),this._graphicIndex[h].needsUpdate=!0}},Z.GraphicGridIndex.prototype._updateIntersectGridCube=function(a){for(var b=this._getGraphicBbox(a),c=this._getGridNum(b.min),d=this._getGridNum(b.max),e=c.col;e<=d.col;e++)for(var f=c.row;f<=d.row;f++)this._updateGridCube(f,e)},Z.GraphicGridIndex.prototype._getIntersectCube=function(a){var b=a.intersectObjects(this._indexCubeArray);if(b.length>0){for(var c={},d=0;d<b.length;d++)b[d].object.indexKey&&(c[b[d].object.indexKey]=1);return c}return null},Z.GraphicGridIndex.prototype._getIntersectMeshes=function(a,b){b=b||{};var c=[];for(var d in b)if(d&&this._graphicIndex[d]){this._graphicIndex[d].matrixWorldNeedsUpdate&&this._updateIndexMatrixWorld(this._graphicIndex[d]);for(var e=this._graphicIndex[d].objects,f=0;f<e.length;f++)c.push(e[f])}if(c.length>0){for(var g=a.intersectObjects(c),h=0;h<g.length;h++){var i=g[h].object._rawGraphic||g[h].object;g[h].object=i}return g}return[]},Z.GraphicGridIndex.prototype._updateIndexMatrixWorld=function(a){for(var b=a.objects,c=a.matrixWorld,d=0;d<b.length;d++){var e=b[d];e.matrixWorld.multiplyMatrices(c,e.matrix)}a.matrixWorldNeedsUpdate=!1,a.matrixWorld=null},Z.GraphicGridIndex.prototype._getGraphicBbox=function(a){a=a instanceof Array?a:[a];var b,c,d,e,f,g;if(1===a.length){var h=a[0].geometry;return h.boundingBox||h.computeBoundingBox(),h.boundingBox}for(var i=0;i<a.length;i++){var h=a[i].geometry;h.boundingBox||h.computeBoundingBox();var j=h.boundingBox;void 0===b?(b=j.min.x,c=j.min.y,d=j.min.z,e=j.max.x,f=j.max.y,g=j.max.z):(b=Math.min(b,j.min.x),c=Math.min(c,j.min.y),d=Math.min(d,j.min.z),e=Math.max(e,j.max.x),f=Math.max(f,j.max.y),g=Math.max(g,j.max.z))}return{min:new THREE.Vector3(b,c,d),max:new THREE.Vector3(e,f,g)}},Z.GraphicGridIndex.prototype._getGridNum=function(a){var b=Math.ceil(Math.abs(a.x)/this._gridWidth),c=Math.ceil(Math.abs(a.y)/this._gridHeight);return{col:a.x>0?b:-b,row:a.y>0?c:-c}},Z.GraphicGridIndex.prototype._createGridCube=function(a,b,c){var d=Math.abs(c.max.z-c.min.z),e=new THREE.BoxGeometry(this._gridWidth,this._gridHeight,d),f=new THREE.MeshBasicMaterial,g=new Z.Mesh(e,f),h=b>=0?this._gridWidth*(b-1)+this._gridWidth/2:this._gridWidth*(b+1)-this._gridWidth/2,i=a>=0?this._gridHeight*(a-1)+this._gridHeight/2:this._gridHeight*(a+1)-this._gridHeight/2,j=(c.min.z+c.max.z)/2;return g.position.set(h,i,j),g},Z.GraphicGridIndex.prototype._updateGridCube=function(a,b){var c=b+","+a,d=this._graphicIndex[c].cube;if(d){for(var e=0;e<this._indexCubeArray.length;e++)if(d===this._indexCubeArray[e]){this._indexCubeArray.splice(e,1);break}d.dispose()}var f=this._recomputeGridCube(a,b,this._graphicIndex[c].objects);f.indexKey=c,this._graphicIndex[c].cube=f,this._indexCubeArray.push(f)},Z.GraphicGridIndex.prototype._recomputeGridCube=function(a,b,c){var d=this._getGraphicBbox(c);return this._createGridCube(a,b,d)},Z.GraphicTileLoader=function(a){this._compositeGraphics={},this._graphics={},this._context=a,this._loadMethodRuning=!1},Z.GraphicTileLoader.prototype.setContext=function(a){this._context=a},Z.GraphicTileLoader.prototype.addGraphics=function(a){if(a)for(var b=a instanceof Array?a:[a],c=0;c<b.length;c++){var d=Z.Util.stamp(b[c],"graphic");b[c]instanceof Z.Graphic?this._graphics[d]=b[c]:this._compositeGraphics[d]=b[c]}},Z.GraphicTileLoader.prototype.loadGraphicsBySceneBounds=function(a){if(this._context){var b,c,d,e=a.getBottomLeft(),f=a.getTopRight();return b=this._context.layer.layerScenePointToLatLng(e),c=this._context.layer.layerScenePointToLatLng(f),d=new Z.LatLngBounds(b,c),this.loadGraphicsByLatLngBounds(d)}},Z.GraphicTileLoader.prototype.loadGraphicsByLatLngBounds=function(a){if(this._loadMethodRuning)return[];this._loadMethodRuning=!0;var b=[];for(var c in this._compositeGraphics){var d=this._compositeGraphics[c];if(!d.isAdded()){var e=d.feature.shape.getBounds();a.intersects(e)&&d.onAdd(this._context.layer,this._context.container,this._context.scene)}}for(var c in this._graphics){var d=this._graphics[c];if(!d.isAdded()){var e=d.feature.shape.getBounds();a.intersects(e)&&d.onAdd(this._context.layer,this._context.container,this._context.scene)}if(d instanceof Z.Graphic)for(var f=this._checkMeshes([d]),g=0;g<f.length;g++)b.push(f[g])}return this._loadMethodRuning=!1,b},Z.GraphicTileLoader.prototype._checkMeshes=function(a){for(var b=[],c=0;c<a.length;c++)if(a[c]instanceof Z.Graphic)for(var d=this._getMeshes(a[c]._mainElement._render._renderedObject),e=0;e<d.length;e++)b.push(d[e]);return b},Z.GraphicTileLoader.prototype._getMeshes=function(a){var b=[];if(a instanceof THREE.Mesh||a instanceof THREE.Line)b.push(a);else if(a&&a.children&&a.children.length>0)for(var c=0;c<a.children.length;c++)for(var d=this._getMeshes(a.children[c]),e=0;e<d.length;e++)b.push(d[e]);return b},Z.GraphicTileManager=function(a,b,c){this._center=a||new Z.Point(0,0,0),this._gridWidth=b||100,this._gridHeight=c||100,this._graphicTiles={},this._graphicToIndexMap={},this._visibleTileBounds=null,this.tileLoader=null,this._visibleGraphics={},this.root=new THREE.Object3D},Z.GraphicTileManager.prototype.addGraphics=function(a){if(a=a instanceof Array?a:[a],!(a.length<=0))for(var b=0;b<a.length;b++){var c=this._cloneGraphic(a[b]);this._addOneGraphic(c)}},Z.GraphicTileManager.prototype.deleteGraphics=function(a){if(a=a instanceof Array?a:[a],!(a.length<=0))for(var b=0;b<a.length;b++)this._deleteOneGraphic(a[b])},Z.GraphicTileManager.prototype._deleteOneGraphic=function(a){for(var b=(a._rawGraphic||a).id,c=this._graphicToIndexMap[b],d=c.minGrid,e=c.maxGrid,f=d.row;f<=e.row;f++)for(var g=d.col;g<=e.col;g++)if(0!==f&&0!==g){var h=this._getTile(g,f);if(h)for(var i=h.objects,j=0;j<i.length;j++)if(i[j]._rawGraphic===a){i.splice(j,1),h.needsUpdate=!0;break}}delete this._graphicToIndexMap[b],delete this._visibleGraphics[b]},Z.GraphicTileManager.prototype.updateGraphic=function(a){this.deleteGraphic(a),this.addGraphic(a)},Z.GraphicTileManager.prototype.updateMatrixWorld=function(a){for(var b in this._graphicTiles){var c=this._getTileByKey(b);c&&(c.matrixWorldNeedsUpdate=!0,c.matrixWorld=a)}},Z.GraphicTileManager.prototype._cloneGraphic=function(a){var b=a.clone();return b._rawGraphic=a,b.geometry=this._recomputeVertices(a),b},Z.GraphicTileManager.prototype._recomputeVertices=function(a){var b=a._z_posOffset||{},c=1e-8,d=a.geometry;if(b.x>c||b.y>c||b.z>c){d=d.clone();for(var e=d.vertices,f=0;f<e.length;f++)e[f]=e[f].add(b)}return d},Z.GraphicTileManager.prototype._addOneGraphic=function(a){var b=this._getGraphicBbox(a),c=this._getGridNum(b.min),d=this._getGridNum(b.max),e=(a._rawGraphic||a).id;this._graphicToIndexMap[e]={minGrid:c,maxGrid:d};for(var f=c.col;f<=d.col;f++)for(var g=c.row;g<=d.row;g++)if(0!==f&&0!==g){var h=this._getTile(g,f);h.objects.push(a),h.needsUpdate=!0}},Z.GraphicTileManager.prototype.refreshVisibleTiles=function(){if(this._visibleTileBounds)for(var a=this._visibleTileBounds.getBottomLeft(),b=this._visibleTileBounds.getTopRight(),c=a.x;c<=b.x;c++)for(var d=a.y;d<=b.y;d++)if(0!==c&&0!==d){var e=this._getTile(d,c);e&&this._updateTile(e)}},Z.GraphicTileManager.prototype._getGraphicBbox=function(a){a=a instanceof Array?a:[a];var b,c,d,e,f,g;if(1===a.length){var h=a[0].geometry;return h.boundingBox||h.computeBoundingBox(),h.boundingBox}for(var i=0;i<a.length;i++){var h=a[i].geometry;h.boundingBox||h.computeBoundingBox();var j=h.boundingBox;void 0===b?(b=j.min.x,c=j.min.y,d=j.min.z,e=j.max.x,f=j.max.y,g=j.max.z):(b=Math.min(b,j.min.x),c=Math.min(c,j.min.y),d=Math.min(d,j.min.z),e=Math.max(e,j.max.x),f=Math.max(f,j.max.y),g=Math.max(g,j.max.z))}return{min:new THREE.Vector3(b,c,d),max:new THREE.Vector3(e,f,g)}},Z.GraphicTileManager.prototype._getTile=function(a,b){var c=b+","+a;return this._getTileByKey(c)},Z.GraphicTileManager.prototype.updateVisibleBBox=function(a){var b=this._getTileBounds(a),c=this._getTilesForUpdate(b);this._loadTiles(c.newTiles),this._updateTiles(c.updateTiles),this._removeTiles(c.invisibleTiles),this._visibleTileBounds=b},Z.GraphicTileManager.prototype._getTileBounds=function(a){if(!a)return null;var b=this._getGridNum(a.min),c=this._getGridNum(a.max);return Z.GLBounds.create(Z.Point.create(b.col,b.row),Z.Point.create(c.col,c.row))},Z.GraphicTileManager.prototype._getGridNum=function(a){var b=Math.ceil(Math.abs(a.x)/this._gridWidth),c=Math.ceil(Math.abs(a.y)/this._gridHeight);return{col:a.x>0?b:-b,row:a.y>0?c:-c}},Z.GraphicTileManager.prototype._getTilesForUpdate=function(a){a=a||this._visibleTileBounds;var b=[],c=[],d=[],e={};if(this._visibleTileBounds)for(var f=this._visibleTileBounds.getBottomLeft(),g=this._visibleTileBounds.getTopRight(),h=f.x;h<=g.x;h++)for(var i=f.y;i<=g.y;i++)if(0!==h&&0!==i){var j=this._getTileKey(i,h);e[j]=1}var k=a.getBottomLeft(),l=a.getTopRight();for(h=k.x;h<=l.x;h++)for(i=k.y;i<=l.y;i++)if(0!==h&&0!==i){var m=this._getTileKey(i,h);e[m]?e[m]=2:d.push(m)}for(m in e)1===e[m]?b.push(m):2===e[m]&&c.push(m);return{newTiles:d,updateTiles:c,invisibleTiles:b}},Z.GraphicTileManager.prototype._getTileKey=function(a,b){return b+","+a},Z.GraphicTileManager.prototype._loadTiles=function(a){for(var b=0;b<a.length;b++){var c=this._loadOneTile(a[b]);this._updateOneTile(c),Z.GraphicAnimation.animateZValueByStep(c.tileGraphic.root,.05,0,1)}},Z.GraphicTileManager.prototype._parseTileKey=function(a){var b=(a||"").split(",");return{col:parseInt(b[0]),row:parseInt(b[1])}},Z.GraphicTileManager.prototype._getTileByKey=function(a){return"string"!=typeof a||a.length<=0?null:this._graphicTiles[a]?(this._graphicTiles[a].key!==a&&(this._graphicTiles[a].key=a),this._graphicTiles[a]):null},Z.GraphicTileManager.prototype._loadOneTile=function(a){var b=this._getTileByKey(a)||this._createTile(a),c=this._loadTileMeshes(a);return b.objects=c,b.needsUpdate=!0,b},Z.GraphicTileManager.prototype._createTile=function(a){var b={objects:[],tileGraphic:null,tempTileGraphic:null,matrixWorldNeedsUpdate:!1,matrixWorld:null,needsUpdate:!1,loaded:!1};return this._graphicTiles[a]=b,b},Z.GraphicTileManager.prototype._loadTileMeshes=function(a){var b,c,d,e,f=this._parseTileKey(a);b=f.col>0?this._gridWidth*(f.col-1):this._gridWidth*f.col,d=b+this._gridWidth,c=f.row>0?this._gridHeight*(f.row-1):this._gridHeight*f.row,e=c+this._gridHeight;var g=new Z.GLBounds(new Z.Point(b,c),new Z.Point(d,e));return this.tileLoader.loadGraphicsBySceneBounds(g)},Z.GraphicTileManager.prototype._updateOneTile=function(a){a&&a.needsUpdate&&(a.tileGraphic&&this.root.remove(a.tileGraphic.root),this._updateTileGraphic(a),a.tileGraphic&&this.root.add(a.tileGraphic.root))},Z.GraphicTileManager.prototype._updateTileGraphic=function(a){a.tileGraphic||(a.tileGraphic=new Z.MergedMesh3D1);for(var b=[],c=0;c<a.objects.length;c++){var d=a.objects[c],e=(d._rawGraphic||d).id,f=this._visibleGraphics[e];f||(this._visibleGraphics[e]={addedTile:null,owners:[]},f=this._visibleGraphics[e]),f.addedTile||(b.push(d),f.addedTile=a,f.owners.push(a))}for(var g=[],h=0;h<b.length;h++)a.tileGraphic.hasMesh(b[h])||g.push(b[h]);a.tileGraphic.addMeshes(g)},Z.GraphicTileManager.prototype._updateTiles=function(a){for(var b=0;b<a.length;b++){var c=this._loadOneTile(a[b]);this._updateOneTile(c)}},Z.GraphicTileManager.prototype._removeTiles=function(a){for(var b={},c=0;c<a.length;c++){var d=this._getTileByKey(a[c]);d.tileGraphic&&this.root.remove(d.tileGraphic.root);for(var e=0;e<d.objects;e++){var f=d.objects[e],g=this._removeObjectFromOneTile(f,d),h=(f._rawGraphic||f).id;b[h]||(b[h]=g)}}for(var i in b)this._updateTile(b[i])},Z.GraphicTileManager.prototype._removeObjectFromOneTile=function(a,b){for(var c=a,d=(c._rawGraphic||c).id,e=this._visibleGraphics[d].owners||[],f=null,g=e.length-1;g>0;g--)e[g]===b&&(e.splice(g,1),this._visibleGraphics[d].addedTile===b&&(this._visibleGraphics[d].addedTile=null));if(!this._visibleGraphics[d].addedTile)if(e.length<=0)this._visibleGraphics[d]=null,delete this._visibleGraphics[d];else{var h=e[0];h.needsUpdate=!0,f=h}return f},Z.MergedLine=function(){this.root=new THREE.Object3D,this._linesDataBuffer={}},Z.MergedLine.prototype.addMesh=function(a){a&&this._addOneLine(a)},Z.MergedLine.prototype.addMeshes=function(a){if(a=a instanceof Array?a:[a],!(a.length<=0))for(var b=0;b<a.length;b++)this._addOneLine(a[b])},Z.MergedLine.prototype.deleteMesh=function(a){a&&this._deleteOneLine(a)},Z.MergedLine.prototype.updateMesh=function(a){this.deleteMesh(a),this.addMesh(a)},Z.MergedLine.prototype.clear=function(){for(var a in this._linesDataBuffer){var b=this._linesDataBuffer[a];this.root.remove(b.mergedLine),b.mergedLine.dispose(),b.mergedLine=null,b.linesArray=[],b.linesMap={},delete this._linesDataBuffer[a]}},Z.MergedLine.prototype.dispose=function(){this.clear(),this.root.parent&&this.root.parent.remove(this.root),this.root=null},Z.MergedLine.prototype._addOneLine=function(a){var b=a.material.id;this._linesDataBuffer[b]||(this._linesDataBuffer[b]={material:a.material,linesArray:[],linesMap:[],vertices:[],mergedLine:null});var c=this._linesDataBuffer[b],d=c.linesArray.length;c.linesArray[d]=a;var e=a.userData.graphicId||a.id;c.linesMap[e]={index:d,mesh:a},c.mergedLine&&this.root.remove(c.mergedLine),this._mergeLines(a,c),this.root.add(c.mergedLine)},Z.MergedLine.prototype._mergeLines=function(a,b){this._addLineToBuffer(a,b),b.mergedLine=this._createLineFromDataBuffer(b),this._createIndexBuffer(b.mergedLine,a)},Z.MergedLine.prototype._addLineToBuffer=function(a,b){var c=this._recomputeVertices(a),d=c.vertices;b.vertices=b.vertices.concat(d)},Z.MergedLine.prototype._recomputeVertices=function(a){var b=a._z_posOffset,c=1e-8,d=a.geometry;if(b.x>c||b.y>c||b.z>c){d=d.clone();for(var e=d.vertices,f=0;f<e.length;f++)e[f]=e[f].add(b)}return d},Z.MergedLine.prototype._createLineFromDataBuffer=function(a){if(a.vertices.length>0){var b=new THREE.Geometry;b.vertices=a.vertices;return new Z.THREELine(b,a.material)}return null},Z.MergedLine.prototype._createIndexBuffer=function(a,b){b.buildingIndexesBuffer=a?{verticesMin:a.geometry.vertices.length-b.geometry.vertices.length,verticesMax:Math.max(a.geometry.vertices.length-1,0)}:{verticesMin:0,verticesMax:Math.max(b.geometry.vertices.length-1,0)}},Z.MergedLine.prototype._deleteOneLine=function(a){var b=a.material.id,c=this._linesDataBuffer[b],d=a.userData.graphicId||a.id;if(c&&c.linesMap[d]){var e=c.linesMap[d],f=e.mesh,g=e.index+1;this._deleteLineFromBuffer(f,g,c),this.root.remove(c.mergedLine),this._bufferIsNull(c)||(c.mergedLine=this._createLineFromDataBuffer(c),this.root.add(c.mergedLine));var h=this._getMeshesForOffset(g,c);this._offsetMeshesIndex(h,-1,c),c.linesArray.splice(e.index,1),delete c.linesMap[d],this._bufferIsNull(c)&&delete this._linesDataBuffer[b]}},Z.MergedLine.prototype._deleteLineFromBuffer=function(a,b,c){var d=this._getMeshOffsetForDelete(a);if(0!==d.verticesOffset){var e=c.vertices,f=this._getIndexBuffer(a),g=this._getMeshesForOffset(b,c);this._offsetMeshesFromBuffer(g,d.verticesOffset,d.facesOffset,d.uvsOffset),e.splice(f.verticesMin,f.verticesMax-f.verticesMin+1)}},Z.MergedLine.prototype._getMeshOffsetForDelete=function(a){var b=a,c=b.buildingIndexesBuffer;return{verticesOffset:-(c.verticesMax-c.verticesMin+1)}},Z.MergedLine.prototype._getIndexBuffer=function(a){return a.buildingIndexesBuffer},Z.MergedLine.prototype._getMeshesForOffset=function(a,b){for(var c=b.linesArray.length-1,d=[],e=a;e<=c;e++)d.push(b.linesArray[e]);return d},Z.MergedLine.prototype._offsetMeshesIndex=function(a,b,c){for(var d=0;d<a.length;d++){var e=a[d],f=e.userData.graphicId||e.id;c.linesMap[f].index+=b}},Z.MergedLine.prototype._offsetMeshesFromBuffer=function(a,b,c,d){this._offsetIndexBuffer(a,b,c,d)},Z.MergedLine.prototype._offsetIndexBuffer=function(a,b,c,d){for(var e=0;e<a.length;e++){var f=a[e],g=f.buildingIndexesBuffer;g.verticesMin+=b,g.verticesMax+=b}},Z.MergedLine.prototype._bufferIsNull=function(a){return!(a.vertices.length>0)},Z.MergedMesh3D=function(){this._mergedGraphic=null,this._meshesArray=[],this._meshesMap={},this._graphicGrid=new Z.GraphicGrid(50,50)},Z.MergedMesh3D.prototype.addMesh=function(a){a&&(this._addOneMesh(a),this._graphicGrid.addGraphic(a))},Z.MergedMesh3D.prototype.addMeshes=function(a){if(a=a instanceof Array?a:[a],!(a.length<=0)){for(var b=0;b<a.length;b++)this._addOneMesh(a[b]);this._graphicGrid.addGraphics(a)}},Z.MergedMesh3D.prototype.deleteMesh=function(a){if(a){var b=a.userData.graphicId||a.id;if(this._meshesMap[b]){var c=this._meshesMap[b],d=c.mesh,e=d.buildingIndexesBuffer,f=-(e.verticesMax-e.verticesMin+1),g=-(e.facesMax-e.facesMin+1),h=-(e.uvsMax-e.uvsMin+1);if(0!==f||0!==g||0!==h){var i=c.index+1;this._offsetMeshs(i,-1,f,g,h),this._deleteFromGeometry(d),this._meshesArray.splice(c.index,1),delete this._meshesMap[b],this._graphicGrid.deleteGraphic(d)}}}},Z.MergedMesh3D.prototype.reorderFacesByMaterial=function(){this._mergedGraphic&&this._mergedGraphic.geometry.faces.sort(function(a,b){return a.materialIndex-b.materialIndex})},Z.MergedMesh3D.prototype.updateRasterIndex=function(){var a=this._mergedGraphic?this._mergedGraphic.parent:null;a&&(a.updateMatrix(),a.updateMatrixWorld(),this._graphicGrid.updateMatrixWorld(a.matrixWorld))},Z.MergedMesh3D.prototype._addOneMesh=function(a){var b=this._meshesArray.length;this._meshesArray[b]=a;var c=a.userData.graphicId||a.id;this._meshesMap[c]={index:b,mesh:a},this._mergedGraphic?this._mergeMeshes(this._mergedGraphic,a):(this._createMesh(a),this._mergedGraphic.raycastIndex=this._graphicGrid)},Z.MergedMesh3D.prototype._deleteFromGeometry=function(a){var b=this._mergedGraphic.geometry.vertices,c=this._mergedGraphic.geometry.faces,d=this._mergedGraphic.geometry.faceVertexUvs[0],e=this._getIndexBuffer(a);b.splice(e.verticesMin,e.verticesMax-e.verticesMin+1),c.splice(e.facesMin,e.facesMax-e.facesMin+1),d.splice(e.uvsMin,e.uvsMax-e.uvsMin+1),this._mergedGraphic.geometry.verticesNeedUpdate=!0,this._mergedGraphic.geometry.uvsNeedUpdate=!0,this._mergedGraphic.geometry.elementsNeedUpdate=!0,this._mergedGraphic.geometry.groupsNeedUpdate=!0};Z.MergedMesh3D.prototype.updateMesh=function(a){var b=a.userData.graphicId||a.id;if(!this._meshesMap[b])return void this.addMesh(a);this.deleteMesh(a),this.addMesh(a)},Z.MergedMesh3D.prototype.clear=function(){this._mergedGraphic=null,this._buildingsArray=[],this._buildingsMap={},this._graphicGrid.clear()},Z.MergedMesh3D.prototype._createMesh=function(a){var b=this._recomputeVertices(a),c=a.material.clone(),d=new Z.Mesh(b,c),e=b.faces,f=e.length>0?e.length-1:0;return this._attacthOwnerObject(d,0,f,a),this._mergedGraphic=d,this._createIndexBuffer(this._mergedGraphic,a),d},Z.MergedMesh3D.prototype._recomputeVertices=function(a){var b=a._z_posOffset,c=1e-8,d=a.geometry;if(b.x>c||b.y>c||b.z>c){d=d.clone();for(var e=d.vertices,f=0;f<e.length;f++)e[f]=e[f].add(b)}return d},Z.MergedMesh3D.prototype._mergeMeshes=function(a,b){var c=a.material,d=b.material,e=this._recomputeVertices(b),f=e.faces,g=!1;if(c instanceof THREE.MultiMaterial&&d instanceof THREE.MultiMaterial){for(var h=0;h<d.materials.length;h++)if(d.materials[h]!==c.materials[h]){g=!0;break}if(g)for(var i=this._getMaterialMapping(a,b),j=0,k=f.length;j<k;j++){var l=void 0!==f[j].rawMaterialIndex?f[j].rawMaterialIndex:f[j].materialIndex;f[j].rawMaterialIndex=l,f[j].materialIndex=i[l]}}if(a.geometry.merge(e),g)for(var j=0,k=f.length;j<k;j++)void 0!==f[j].rawMaterialIndex&&(f[j].materialIndex=f[j].rawMaterialIndex,f[j].rawMaterialIndex=void 0);var m=a.geometry.faces,n=m.length-f.length,o=m.length-1;this._attacthOwnerObject(a,n,o,b),this._createIndexBuffer(a,b)},Z.MergedMesh3D.prototype._getMaterialMapping=function(a,b){for(var c=a.material,d=b.material,e=[],f=0;f<d.materials.length;f++){for(var g=0;g<c.materials.length;g++)if(d.materials[f]==c.materials[g]){e[f]=g;break}g>=c.materials.length&&(c.materials.push(d.materials[f]),e[f]=c.materials.length-1)}return e},Z.MergedMesh3D.prototype._createIndexBuffer=function(a,b){b.buildingIndexesBuffer=a?{verticesMin:a.geometry.vertices.length-b.geometry.vertices.length,verticesMax:a.geometry.vertices.length-1,facesMin:a.geometry.faces.length-b.geometry.faces.length,facesMax:a.geometry.faces.length-1,uvsMin:a.geometry.faceVertexUvs[0].length-b.geometry.faceVertexUvs[0].length,uvsMax:a.geometry.faceVertexUvs[0].length-1}:{verticesMin:0,verticesMax:b.geometry.vertices.length-1,facesMin:0,facesMax:b.geometry.faces.length-1,uvsMin:0,uvsMax:b.geometry.faceVertexUvs[0].length-1}},Z.MergedMesh3D.prototype._getIndexBuffer=function(a){return a.buildingIndexesBuffer},Z.MergedMesh3D.prototype._attacthOwnerObject=function(a,b,c,d){var e=a.geometry.faces;if(e.length>0)for(var f=b;f<=c;f++)e[f].ownerMesh=d},Z.MergedMesh3D.prototype._offsetMeshs=function(a,b,c,d,e){if(!(a>=this._meshesArray.length))for(var f=this._meshesArray.length-1,g=this._mergedGraphic.geometry.faces,h=a;h<=f;h++){for(var i=this._meshesArray[h],j=i.buildingIndexesBuffer,k=j.facesMin,l=j.facesMax,m=k;m<=l;m++){var n=g[m];n.a+=c,n.b+=c,n.c+=c}j.verticesMin+=c,j.verticesMax+=c,j.facesMin+=d,j.facesMax+=d,j.uvsMin+=e,j.uvsMax+=e;var o=i.userData.graphicId||i.id;this._meshesMap[o].index+=b}},Z.MergedMesh3D1=function(){this.root=new Z.Object3D;var a=this;this.root.setPropertyListener("children",{preGet:function(b,c){a._mergedMeshNeedsUpdate&&(a._mergedGraphic&&b.remove(a._mergedGraphic),a._mergedGraphic=a._createMeshFromDataBuffer(a._dataBuffer),b.add(a._mergedGraphic),a._mergedMeshNeedsUpdate=!1,a._graphicGrid&&a._graphicGrid.updateGridCubes())}}),this._reset(),this._mergedMeshNeedsUpdate=!1,this._mergedLine=new Z.MergedLine,this.root.add(this._mergedLine.root),this._graphicGrid=new Z.GraphicGridIndex(50,50)},Z.MergedMesh3D1.prototype._reset=function(){if(this._meshesArray=[],this._meshesMap={},this._dataBuffer){for(var a=this._dataBuffer.faces,b=a.length,c=0;c<b;c++)a[c].ownerMesh=null,a[c]=null;this._dataBuffer.vertices=[],this._dataBuffer.faces=[],this._dataBuffer.uvs=[],this._dataBuffer.materials=[]}else this._dataBuffer={vertices:[],faces:[],uvs:[],materials:[]};this._linesDataBuffer={}},Z.MergedMesh3D1.prototype.addMesh=function(a){a&&(a instanceof THREE.Mesh?this._addMeshes([a]):a instanceof THREE.Line&&this._mergedLine&&this._mergedLine.addMeshes([a]),this._graphicGrid&&this._graphicGrid.addGraphic(a))},Z.MergedMesh3D1.prototype.addMeshes=function(a){if(a=a instanceof Array?a:[a],!(a.length<=0)){for(var b=[],c=[],d=0;d<a.length;d++)a[d]instanceof THREE.Mesh?b.push(a[d]):a[d]instanceof THREE.Line&&c.push(a[d]);this._addMeshes(b),this._mergedLine&&this._mergedLine.addMeshes(c),this._graphicGrid&&this._graphicGrid.addGraphics(a)}},Z.MergedMesh3D1.prototype.deleteMesh=function(a){a&&(a instanceof THREE.Mesh?this._deleteOneMesh(a):a instanceof THREE.Line&&this._mergedLine&&this._mergedLine.deleteMesh(a))},Z.MergedMesh3D1.prototype._deleteOneMesh=function(a){var b=a.userData.graphicId||a.id;if(this._meshesMap[b]){var c=this._meshesMap[b],d=c.mesh,e=c.index+1;this._deleteMeshFromBuffer(d,e),this._mergedMeshNeedsUpdate=!0;var f=this._getMeshesForOffset(e);this._offsetMeshesIndex(f,-1),this._meshesArray.splice(c.index,1),delete this._meshesMap[b],this._graphicGrid&&this._graphicGrid.deleteGraphic(d)}},Z.MergedMesh3D1.prototype._getMeshOffsetForDelete=function(a){var b=a,c=b.buildingIndexesBuffer;return{verticesOffset:-(c.verticesMax-c.verticesMin+1),facesOffset:-(c.facesMax-c.facesMin+1),uvsOffset:-(c.uvsMax-c.uvsMin+1)}},Z.MergedMesh3D1.prototype.reorderFacesByMaterial=function(a){var b=a||this._mergedGraphic;if(b){b.geometry.faces.sort(function(a,b){return a.materialIndex-b.materialIndex})}},Z.MergedMesh3D1.prototype.hasMesh=function(a){var b=a.userData.graphicId||a.id,c=this._meshesMap[b];return!(!c||c.mesh!==a)},Z.MergedMesh3D1.prototype.updateRasterIndex=function(){var a=this.root?this.root.parent:null;a&&(a.updateMatrix(),a.updateMatrixWorld(),this._graphicGrid&&this._graphicGrid.updateMatrixWorld(a.matrixWorld))},Z.MergedMesh3D1.prototype._addMeshes=function(a){for(var b=0;b<a.length;b++)this.hasMesh(a[b])||this._addOneMesh(a[b])},Z.MergedMesh3D1.prototype._updateMergedMesh=function(){this._mergedGraphic&&this.root.remove(this._mergedGraphic),this._mergedGraphic=this._createMeshFromDataBuffer(this._dataBuffer),this.root.add(this._mergedGraphic)},Z.MergedMesh3D1.prototype._addOneMesh=function(a){var b=this._meshesArray.length;this._meshesArray[b]=a;var c=a.userData.graphicId||a.id;this._meshesMap[c]={index:b,mesh:a},this._mergeMeshes(a),this._mergedMeshNeedsUpdate=!0},Z.MergedMesh3D1.prototype._deleteMeshFromBuffer=function(a,b){var c=this._getMeshOffsetForDelete(a);if(0!==c.verticesOffset||0!==c.facesOffset||0!==c.uvsOffset){var d=this._dataBuffer.vertices,e=this._dataBuffer.faces,f=this._dataBuffer.uvs,g=this._getIndexBuffer(a),h=this._getMeshesForOffset(b);this._offsetMeshesFromBuffer(h,c.verticesOffset,c.facesOffset,c.uvsOffset),d.splice(g.verticesMin,g.verticesMax-g.verticesMin+1),e.splice(g.facesMin,g.facesMax-g.facesMin+1),f.splice(g.uvsMin,g.uvsMax-g.uvsMin+1)}},Z.MergedMesh3D1.prototype.updateMesh=function(a){var b=a.userData.graphicId||a.id;this._meshesMap[b]&&this.deleteMesh(a),this.addMesh(a)},Z.MergedMesh3D1.prototype.clear=function(){this._reset(),this._mergedLine&&this._mergedLine.clear(),this._graphicGrid&&this._graphicGrid.clear(),this._mergedMeshNeedsUpdate=!0},Z.MergedMesh3D1.prototype.dispose=function(){this.clear(),this._mergedGraphic&&(this.root.remove(this._mergedGraphic),this._mergedGraphic.dispose()),this._mergedLine&&this._mergedLine.dispose(),this._graphicGrid&&this._graphicGrid.dispose(),this._mergedGraphic=null,this._mergedLine=null,this._graphicGrid=null,this.root.parent&&this.root.parent.remove(this.root),this.root=null},Z.MergedMesh3D1.prototype._recomputeVertices=function(a){var b=a._z_posOffset||{},c=1e-8,d=a.geometry;if(b.x>c||b.y>c||b.z>c){d=d.clone();for(var e=d.vertices,f=0;f<e.length;f++)e[f]=e[f].add(b)}return d},Z.MergedMesh3D1.prototype._addMeshToBuffer=function(a){var b=this._recomputeVertices(a),c=b;b instanceof THREE.BufferGeometry&&(c=new THREE.Geometry,c.fromBufferGeometry(b));for(var d=c.vertices,e=[],f=c.faceVertexUvs[0],g=this._dataBuffer,h=g.vertices.length,i=g.materials,j=a.material instanceof THREE.MultiMaterial?a.material.materials:a.material instanceof Array?a.material:[a.material],k=this._mergeMaterial(i,j),l=2e3,m=c.faces.length,n=Math.ceil(m/l),o=0;o<n;o++){var p=l*o,q=Math.min(m,p+l)-1;this._copyFaces(e,c.faces,p,q,h,k,a)}for(var r=0;r<d.length;r++)g.vertices.push(d[r]);for(r=0;r<e.length;r++)g.faces.push(e[r]);for(r=0;r<f.length;r++)g.uvs.push(f[r])},Z.MergedMesh3D1.prototype._copyFaces=function(a,b,c,d,e,f,g){for(var h=c;h<=d;h++){var i=b[h].clone();e&&(i.a+=e,i.b+=e,i.c+=e),f&&(i.materialIndex=f[i.materialIndex||0]||0),i.ownerMesh=g||b[h].ownerMesh,a.push(i)}},Z.MergedMesh3D1.prototype._createMeshFromDataBuffer=function(a){var b=new THREE.Geometry,c=[];b.vertices=a.vertices,b.faceVertexUvs[0]=a.uvs;for(var d=0,e=a.faces.length;d<e;d++){var f=a.faces[d];c.push(f)}b.faces=c;var g=new Z.Mesh(b,a.materials);return this._graphicGrid&&(g.raycastIndex=this._graphicGrid),this.reorderFacesByMaterial(g),g},Z.MergedMesh3D1.prototype._mergeMeshes=function(a){this._addMeshToBuffer(a),this._createIndexBuffer(this._dataBuffer,a)},Z.MergedMesh3D1.prototype._mergeMaterial=function(a,b){for(var c=[],d=0;d<b.length;d++){for(var e=0;e<a.length;e++)if(b[d]==a[e]){c[d]=e;break}e>=a.length&&(a.push(b[d]),c[d]=a.length-1)}return c},Z.MergedMesh3D1.prototype._createIndexBuffer=function(a,b){var c=b.geometry;c instanceof THREE.BufferGeometry&&(c=new THREE.Geometry,c.fromBufferGeometry(b.geometry)),b.buildingIndexesBuffer=a?{verticesMin:a.vertices.length-c.vertices.length,verticesMax:Math.max(a.vertices.length-1,0),facesMin:a.faces.length-c.faces.length,facesMax:Math.max(a.faces.length-1,0),uvsMin:a.uvs.length-c.faceVertexUvs[0].length,uvsMax:Math.max(a.uvs.length-1,0)}:{verticesMin:0,verticesMax:Math.max(c.vertices.length-1,0),facesMin:0,facesMax:Math.max(c.faces.length-1,0),uvsMin:0,uvsMax:Math.max(c.faceVertexUvs[0].length-1,0)}},Z.MergedMesh3D1.prototype._getIndexBuffer=function(a){return a.buildingIndexesBuffer},Z.MergedMesh3D1.prototype._getMeshesForOffset=function(a){for(var b=this._meshesArray.length-1,c=[],d=a;d<=b;d++)c.push(this._meshesArray[d]);return c},Z.MergedMesh3D1.prototype._offsetMeshesIndex=function(a,b){for(var c=0;c<a.length;c++){var d=a[c],e=d.userData.graphicId||d.id;this._meshesMap[e].index+=b}},Z.MergedMesh3D1.prototype._offsetMeshesFromBuffer=function(a,b,c,d){this._offsetFaces(a,b,c,d),this._offsetIndexBuffer(a,b,c,d)},Z.MergedMesh3D1.prototype._offsetFaces=function(a,b,c,d){for(var e=this._dataBuffer.faces,f=0;f<a.length;f++)for(var g=a[f],h=g.buildingIndexesBuffer,i=h.facesMin,j=h.facesMax,k=i;k<=j;k++){var l=e[k];l.a+=b,l.b+=b,l.c+=b}},Z.MergedMesh3D1.prototype._offsetIndexBuffer=function(a,b,c,d){for(var e=0;e<a.length;e++){var f=a[e],g=f.buildingIndexesBuffer;g.verticesMin+=b,g.verticesMax+=b,g.facesMin+=c,g.facesMax+=c,g.uvsMin+=d,g.uvsMax+=d}},Z.Mesh=function(a,b){THREE.Mesh.apply(this,arguments),this.raycastIndex=null},Z.Mesh.prototype=Object.create(THREE.Mesh.prototype),Z.Mesh.prototype.constructor=Z.Mesh,Z.Mesh.prototype.raycast=function(a,b){if(!this.raycastIndex)return THREE.Mesh.prototype.raycast.apply(this,arguments);for(var c=this.raycastIndex.getIntersectMeshes(a),d=0;d<c.length;d++)b.push(c[d])},Z.Mesh.prototype.dispose=function(){if(this.material){var a=[this.material];this.material instanceof THREE.MultiMaterial?a=this.material.materials:this.material instanceof Array&&(a=this.material);for(var b=0;b<a.length;b++){var c=a[b];c&&(c.map&&c.map.dispose(),c.aoMap&&c.aoMap.dispose(),c.specularMap&&c.specularMap.dispose(),c.alphaMap&&c.alphaMap.dispose(),c.envMap&&c.envMap.dispose(),c.dispose())}}this.geometry&&this.geometry.dispose()},Z.OSMBuildingBuilder=function(){function a(a){var c=new Z.ExtrudeSymbol;return c.topColor=a.roofColor||a.color||b(a.material)||c.topColor,c.wallColor=a.wallColor||a.color||b(a.material)||c.wallColor,c}function b(a){return a?"string"!=typeof a?null:(a=a.toLowerCase(),"#"===a[0]?a:OSMConfig.MATERIAL_COLORS[OSMConfig.BASE_MATERIALS[a]||a]||null):null}function c(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=16*Math.random()|0;return("x"==a?b:3&b|8).toString(16)})}return{buildGraphic:function(b,d){if(!b)return null;if(!b.geometry)return null;var e=b.geometry.type;if("Polygon"!==e&&"MultiPolygon"!==e)return null;var f=b.properties,g=b.geometry.coordinates,h=f.height||(f.levels?f.levels*Z.Globe.Building.METERS_PER_LEVEL:Z.Globe.Building.DEFAULT_HEIGHT),i=f.minHeight||(f.minLevel?f.minLevel*Z.Globe.Building.METERS_PER_LEVEL:0);if(!Array.isArray(g))return null;var j,k=c(),l=new Z.Extrude(null,g,h,i,{lngStart:!0,ignoreCw:!0}),m=new Z.Feature(f,l),n=a(f);return j=new Z.Graphic(m,n),j.id=k,j}}}(),Z.Object3D=function(a,b){this._propertyListener={};for(var c=new THREE.Object3D,d=Object.getOwnPropertyNames(c),e=0;e<d.length;e++)"Function"!=typeof c[d[e]]&&this._applyProperty(d[e],c,this._propertyListener[d[e]]);this._innerObject=c},Z.Object3D.prototype=Object.create(THREE.Object3D.prototype),Z.Object3D.prototype.constructor=Z.Object3D,Z.Object3D.prototype.getPropertyListener=function(a){return this._propertyListener[a]},Z.Object3D.prototype.setPropertyListener=function(a,b){this._propertyListener[a]=b},Z.Object3D.prototype.removePropertyListener=function(a,b){this._propertyListener[a]=null,delete this._propertyListener[a]},Z.Object3D.prototype._applyProperty=function(a,b){var c=this;Object.defineProperty(this,a,{get:function(){var d=c._propertyListener[a]||{};d.preGet&&d.preGet(b,a);var e=b[a];return d.afterGet&&(e=d.afterGet(b,a,e)),e},set:function(d){var e=c._propertyListener[a]||{},f=d;e.preSet&&(f=e.preSet(b,a,f)),b[a]=f,e.afterSet&&e.afterSet(b,a,f)}})},Z.ObjectOwnerMapping=Z.Class.extend({initialize:function(){this._mapping={}},registerObjects:function(a,b){for(var c=0;c<b.length;c++){var d=b[c],e=(d._rawGraphic||d).id;this._registerOneObject(a,e)}},getUnregisteredObjects:function(a){for(var b=[],c=0;c<a.length;c++){var d=a[c],e=(d._rawGraphic||d).id,f=this._mapping[e],g=!1;f&&f.addedOwner&&(g=!0),g||b.push(d)}return b},getOwnersForUpdate:function(a){for(var b={},c=0;c<a.length;c++){var d=a[c],e=(d._rawGraphic||d).id,f=this._mapping[e].owners||[];if(!this._mapping[e].addedOwner&&f.length>0){var g=f[0];b[e]=g}}return b},unregisterObjects:function(a,b){for(var c=[],d=[],e=0;e<b.length;e++){var f=b[e];this._removeObjectFromOneOwner(f,a)?c.push(f):d.push(f)}var g=this.getOwnersForUpdate(d),h=[];for(var i in g)h.push(g[i]);return{removed:c,remained:d,owneresNeedsUpdate:h}},exist:function(a){var b=!1;if(!a)return b;var c=a.id;if(!c)return b;var d=this._mapping[c];return d&&(d.addedOwner||!d.addedOwner&&d.owners.length>0)&&(b=!0),b},_registerOneObject:function(a,b){var c=this._mapping[b];if(c||(this._mapping[b]={addedOwner:null,owners:[]},c=this._mapping[b]),c.addedOwner){for(var d=c.owners,e=!1,f=0;f<d.length;f++)if(d[f]===a){e=!0;break}e||c.owners.push(a)}else c.addedOwner=a,c.owners.push(a)},_removeObjectFromOneOwner:function(a,b){var c=a,d=(c._rawGraphic||c).id,e=[],f=!0;if(!this._mapping[d])return f;e=this._mapping[d].owners||[];for(var g=e.length-1;g>=0;g--)e[g]===b&&(e.splice(g,1),this._mapping[d].addedOwner===b&&(this._mapping[d].addedOwner=null));return this._mapping[d].addedOwner||(e.length<=0?(this._mapping[d]=null,delete this._mapping[d]):f=!1),f}}),Z.THREELine=function(a,b){THREE.Line.apply(this,arguments),this.raycastIndex=null},Z.THREELine.prototype=Object.create(THREE.Line.prototype),Z.THREELine.prototype.constructor=Z.THREELine,Z.THREELine.prototype.raycast=function(a,b){if(!this.raycastIndex)return THREE.Line.prototype.raycast.apply(this,arguments);for(var c=this.raycastIndex.getIntersectMeshes(a),d=0;d<c.length;d++)b.push(c[d])},Z.THREELine.prototype.dispose=function(){if(this.material){var a=[this.material];this.material instanceof THREE.MultiMaterial&&(a=this.material.materials);for(var b=0;b<a.length;b++)a[b].dispose()}this.geometry&&this.geometry.dispose()},Z.VectorTile=Z.Class.extend({includes:Z.EventManager,initialize:function(a,b,c,d,e){this.root=new THREE.Object3D,this.row=a,this.col=b,this.zoom=c,this.objects=d||[],this.graphicObjects=e||[],this.tileGraphic=null,this.matrixWorldNeedsUpdate=!1,this.matrixWorld=null,this.needsUpdate=!1,this.loaded=!1,this.tileLoader=null,this.context=null},load:function(a,b){var c=this;this.tileLoader.loadVectorTile(this.zoom,this.row,this.col,function(d){d=d||{},d.features=d.features||[];for(var e=[],f=Array.isArray(d.features)?d.features:[d.features],g=0;g<f.length;g++){var h=f[g],i=Z.OSMBuildingBuilder.buildGraphic(h);("Function"!=typeof a||a(i))&&e.push(i)}c.graphicObjects=e,c._renderGraphics(e),b(c)})},_updateTileContent:function(a){this.needsUpdate&&(this.tileGraphic&&this.root.remove(this.tileGraphic.root),this._addMeshes(a),this.tileGraphic&&this.root.add(this.tileGraphic.root),this.needsUpdate=!1)},updateTileContentByGraphic:function(a){var b=this._getGraphicMeshes(a);this._updateTileContent(b)},updateTilePos:function(){this.tileGraphic&&this.tileGraphic.updateRasterIndex()},disposeByGraphic:function(a,b){if(a){a=Array.isArray(a)?a:[a],this.objects=[],this.graphicObjects=[],this.tileGraphic&&(this.root.remove(this.tileGraphic.root),this.tileGraphic.dispose(),this.tileGraphic=null);for(var c=this.tileLoader._context,d=0;d<a.length;d++){var e=a[d];e.onRemove(c.layer),e.dispose()}b&&b(this,a)}},_renderGraphics:function(a){for(var b=this.tileLoader._context,c=[],d=0;d<a.length;d++){var e=a[d];e.onAdd(b.layer,b.container,b.scene);for(var f=this._getMeshes(e._mainElement._render._renderedObject),g=0;g<f.length;g++)c.push(f[g])}this.objects=c,this.needsUpdate=!0},_getGraphicMeshes:function(a){for(var b=[],c=Array.isArray(a)?a:[a],d=0;d<c.length;d++)for(var a=c[d],e=this._getMeshes(a._mainElement._render._renderedObject),f=0;f<e.length;f++)b.push(e[f]);return b},_getMeshes:function(a){var b=[];if(a instanceof THREE.Mesh||a instanceof THREE.Line)b.push(a);else if(a&&a.children&&a.children.length>0)for(var c=0;c<a.children.length;c++)for(var d=this._getMeshes(a.children[c]),e=0;e<d.length;e++)b.push(d[e]);return b},_addMeshes:function(a){this.tileGraphic||(this.tileGraphic=new Z.MergedMesh3D1);for(var b=[],c=0;c<a.length;c++)this.tileGraphic.hasMesh(a[c])||b.push(a[c]);this.tileGraphic.addMeshes(b)}}),Z.VectorTileLoader=function(a,b){this._compositeGraphics={},this._graphics={},this._urls=a||[],this._urls instanceof Array||(this._urls=[this._urls]),this._context=b,this._loadMethodRuning=!1},Z.VectorTileLoader.prototype.setContext=function(a){this._context=a},Z.VectorTileLoader.prototype.loadVectorTile=function(a,b,c,d,e){if(this._context){var f=this._getTileUrl(a,b,c);Z.AjaxRequest.getJSON(f,d,e)}},Z.VectorTileLoader.prototype.loadGraphicsByLatLngBounds=function(a){if(this._loadMethodRuning)return[];this._loadMethodRuning=!0;var b=[];for(var c in this._compositeGraphics){var d=this._compositeGraphics[c];if(!d.isAdded()){var e=d.feature.shape.getBounds();a.intersects(e)&&d.onAdd(this._context.layer,this._context.container,this._context.scene)}}for(var c in this._graphics){var d=this._graphics[c];if(!d.isAdded()){var e=d.feature.shape.getBounds();a.intersects(e)&&d.onAdd(this._context.layer,this._context.container,this._context.scene)}if(d instanceof Z.Graphic)for(var f=this._checkMeshes([d]),g=0;g<f.length;g++)b.push(f[g])}return this._loadMethodRuning=!1,b},Z.VectorTileLoader.prototype._checkMeshes=function(a){for(var b=[],c=0;c<a.length;c++)if(a[c]instanceof Z.Graphic)for(var d=this._getMeshes(a[c]._mainElement._render._renderedObject),e=0;e<d.length;e++)b.push(d[e]);return b},Z.VectorTileLoader.prototype._getMeshes=function(a){var b=[];if(a instanceof THREE.Mesh||a instanceof THREE.Line)b.push(a);else if(a&&a.children&&a.children.length>0)for(var c=0;c<a.children.length;c++)for(var d=this._getMeshes(a.children[c]),e=0;e<d.length;e++)b.push(d[e]);return b},Z.VectorTileLoader.prototype._getTileUrl=function(a,b,c){if(this._context&&!(this._urls.length<=0)){for(var d=this._urls.length,e=(b+c)%d,f=this._urls[e];!f&&e<d-1;)f=this._urls[++e];if(!f)return null;var g=null;return f.indexOf("{level}")>0||f.indexOf("{col}")>0||f.indexOf("{row}")>0?(g=f.replace("{level}",a),g=g.replace("{col}",c),g=g.replace("{row}",b)):g=f+"/"+a+"/"+c+"/"+b+".json",g}},Z.VectorTileManager=Z.Class.extend({includes:Z.EventManager,initialize:function(a,b,c){this._graphicTiles={},this._visibleTileBounds=null,this.tileLoader=null,this._pyramidModel=a||new Z.PyramidModel,this._currentZoom=1,this._levelMapping=b||[],this.root=new THREE.Object3D,this._ooMapping=new Z.ObjectOwnerMapping},updateVisibleBBox:function(a,b){var c=this._getTileBounds(a,b);if(c){this._currentZoom=c.min.z;var d=this._getTilesForUpdate(c);this._loadTiles(d.newTiles),this._updateTiles(d.updateTiles),this._removeTiles(d.invisibleTiles),this._visibleTileBounds=c}},_getTileBounds:function(a,b){if(!a||!b)return null;for(var c=this._pyramidModel.fitZoomLevel(a,b.x,b.y),d=c.level,e=0;e<this._levelMapping.length;e++){var f=this._levelMapping[e],g=f.start,h=f.end,i=f.toLevel;if(d>=g&&d<=h){d=i;break}}return this._pyramidModel.getTileBounds(a,d)},_getTilesForUpdate:function(a){a=a||this._visibleTileBounds;var b=[],c=[],d=[],e={};if(this._visibleTileBounds)for(var f=this._visibleTileBounds.getBottomLeft(),g=this._visibleTileBounds.getTopRight(),h=f.x;h<=g.x;h++)for(var i=f.y;i>=g.y;i--)if(0!==h&&0!==i){var j=this._getTileKey(i,h);e[j]=1}var k=a.getBottomLeft(),l=a.getTopRight();for(h=k.x;h<=l.x;h++)for(i=k.y;i>=l.y;i--)if(0!==h&&0!==i){var m=this._getTileKey(i,h);e[m]?e[m]=2:d.push(m)}for(m in e)1===e[m]?b.push(m):2===e[m]&&c.push(m);return{newTiles:d,updateTiles:c,invisibleTiles:b}},_getTileKey:function(a,b){return b+","+a},_loadTiles:function(a){for(var b=0;b<a.length;b++){var c=this,d=a[b];(this._getTileByKey(d)||this._createTile(d)).load(function(a){return!c._ooMapping.exist(a)},function(a){c._updateOneTile(a),c.fire("tileload",{row:a.row,col:a.col,zoom:a.zoom,graphics:a.graphicObjects})})}},_parseTileKey:function(a){var b=(a||"").split(",");return{col:parseInt(b[0]),row:parseInt(b[1])}},_getTileByKey:function(a){return"string"!=typeof a||a.length<=0?null:this._graphicTiles[a]?(this._graphicTiles[a].key!==a&&(this._graphicTiles[a].key=a),this._graphicTiles[a]):null},_createTile:function(a){var b=this._parseTileKey(a),c=new Z.VectorTile(b.row,b.col,this._currentZoom);return c.tileLoader=this.tileLoader,this.root.add(c.root),this._graphicTiles[a]=c,c},_updateOneTile:function(a){if(a){if(a.needsUpdate){var b=this._ooMapping.getUnregisteredObjects(a.graphicObjects);a.updateTileContentByGraphic(b),this._ooMapping.registerObjects(a,a.graphicObjects)}a.updateTilePos()}},_updateTiles:function(a){for(var b=0;b<a.length;b++){var c=this._getTileByKey(a[b]),d=c.needsUpdate;this._updateOneTile(c),d&&this.fire("tileupdate",{row:c.row,col:c.col})}},_removeTiles:function(a){for(var b=this,c=0;c<a.length;c++){var d=this._getTileByKey(a[c]);this.root.remove(d.root);var e=this._ooMapping.unregisterObjects(d,d.graphicObjects);this._switchOwnerTile(e.owneresNeedsUpdate),d.disposeByGraphic(e.removed,function(a,c){var d=b._getTileKey(a.row,a.col);delete b._graphicTiles[d],b.fire("tileremove",{row:a.row,col:a.col,graphics:c})})}},_switchOwnerTile:function(a){for(var b=0;b<a.length;b++){var c=a[b];c.needsUpdate=!0,this._updateOneTile(c)}}}),Z.GraphicRenderFactory={getGraphicRender:function(a,b,c){if(!(b instanceof Z.GraphicElement&&c instanceof Z.IScene))return null;var d=b.feature?b.feature.shape:null;if(!d)return null;if(c instanceof Z.Scene2D)return this._getGraphicRender2D(a,b,d);if(c instanceof Z.Scene3D)return this._getGraphicRender3D(a,b,d);throw new Error("不支持的scene类型："+c.constructor)},_getGraphicRender2D:function(a,b,c){return c instanceof Z.Polyline?new Z.PolylineRender2D(b):c instanceof Z.Polygon?new Z.PolygonRender2D(b):c instanceof Z.LatLng&&b.symbol instanceof Z.PictureMarkerSymbol?new Z.PictureMarkerRender2D(b):c instanceof Z.LatLng&&b.symbol instanceof Z.TextSymbol?new Z.TextMarkerRender2D(b):c instanceof Z.Circle?new Z.CircleMarkerRender2D(b):(console.info("不支持的Geometry类型:"+c.constructor),null)},_getGraphicRender3D:function(a,b,c){return a instanceof Z.TerrainGraphicLayer?new Z.GraphicRenderTerrain(b):c instanceof Z.Polyline?new Z.PolylineRender3D(b):c instanceof Z.Polygon?new Z.PolygonRender3D(b):c instanceof Z.LatLng&&b.symbol instanceof Z.PictureMarkerSymbol?new Z.PictureMarkerRender3D(b):c instanceof Z.LatLng&&b.symbol instanceof Z.TextSymbol?new Z.CanvasTextRender3D(b):c instanceof Z.CircleExtrude?new Z.CircleExtrudeRender3D(b):c instanceof Z.Extrude||c instanceof Z.MultiExtrude?new Z.ExtrudeRender3D(b):c instanceof Z.Circle?new Z.CircleMarkerRender3D(b):c instanceof Z.Ring?new Z.RingMarkerRender3D(b):c instanceof Z.ModelGeometry?new Z.ModelRender3D(b):c instanceof Z.Sphere?new Z.SphereRender3D(b):(console.info("不支持的Geometry类型:"+c.constructor),null)}},Z.SpriteContainer=Z.Class.extend({includes:Z.EventManager,initialize:function(a,b){if(!(a instanceof THREE.Object3D||a instanceof THREE.Geometry))throw new Error("缺少sprite参数");this.sprite=a;var c=a.position.clone();this.sprite.position.set(0,0,0),this._container=new THREE.Object3D,this._container.add(this.sprite),this._container.position.set(c.x,c.y,c.z),this.setOffset(b)},setPosition:function(a,b,c){this._container.position.set(a,b,c)},setOffset:function(a){a instanceof Z.Point&&this.sprite.position.set(a.x,a.y,a.z)},resetScale:function(){this.sprite.scale.set(1,1,1)},setScale:function(a){a instanceof Z.Point&&this.sprite.scale.set(a.x||1,a.y||1,a.z||1)},getSpriteBounds:function(){return this.sprite.geometry.computeBoundingBox(),this.sprite.geometry.boundingBox},onAdd:function(a){this._scene=a,this.refresh()},refresh:function(){if(this._scene){var a=this._scene.getRotateByRad();this._container.setRotationFromQuaternion(new THREE.Quaternion(a.x,a.y,a.z,a.w))}},getThreeObject:function(){return this._container}}),Z.ComposeGraphic=Z.Graphic.extend({initialize:function(a,b,c){Z.Graphic.prototype.initialize.apply(this,arguments),this._members=[],this._membersShowing=!1,this._selfShowing=!0,this._membersRoot=null,this._graphicRoot=null,this._parent=null},onAdd:function(a,b,c){!this._graphicRoot&&b&&(this._graphicRoot=b.newInstance(),b.addChild(this._graphicRoot)),Z.Graphic.prototype.onAdd.apply(this,[a,this._graphicRoot,c]),!this._membersRoot&&this._mainElementRoot&&(this._membersRoot=this._mainElementRoot.newInstance(),this._graphicRoot&&this._graphicRoot.addChild(this._membersRoot))},onRemove:function(a){this.clearMembers(),Z.Graphic.prototype.onRemove.apply(this,arguments)},updateFeature:function(a){Z.Graphic.prototype.updateFeature.apply(this,arguments)},updateSymbol:function(a){Z.Graphic.prototype.updateSymbol.apply(this,arguments)},show:function(){this._selfShowing?this._showSelf():this._hideSelf(),this._membersShowing?this._showMembers():this._hideMembers()},hide:function(){this.disableSelf(),this.disableMembers()},enableMembers:function(){this._membersShowing||(this._showMembers(),this._membersShowing=!0)},disableMembers:function(){this._membersShowing&&(this._hideMembers(),this._membersShowing=!1)},enableSelf:function(){this._selfShowing||(this._showSelf(),this._selfShowing=!0)},disableSelf:function(){this._selfShowing&&(this._hideSelf(),this._selfShowing=!1)},addMember:function(a){if(a)for(var b=a instanceof Array?a:[a],c=0;c<b.length;c++)b[c]instanceof Z.Graphic&&(this._members.push(b[c]),b[c]._parent=this,this._membersShowing&&this._addOneGraphic(b[c]))},removeMember:function(a){if(a)for(var b=a instanceof Array?a:[a],c=0;c<b.length;c++)for(var d=this._members.length-1;d>=0;d--)this._removeOneMember(this._members[d],d)},clearMembers:function(){for(var a=this._members.length-1;a>=0;a--)this._removeOneMember(this._members[a],a)},getAllMembers:function(){return this._members},_hideSelf:function(){Z.Graphic.prototype.hide.apply(this)},_showSelf:function(){Z.Graphic.prototype.show.apply(this)},_hideMembers:function(){for(var a=0;a<this._members.length;a++)this._removeOneGraphic(this._members[a])},_showMembers:function(){for(var a=0;a<this._members.length;a++)this._addOneGraphic(this._members[a]),this._members[a].show()},_removeOneMember:function(a,b){a instanceof Z.Graphic&&(this._membersShowing&&this._removeOneGraphic(this._members[i]),a._parent=null,this._members.splice(b,1))},_addOneGraphic:function(a){this._layer.addGraphic(a),a._container!==this._membersRoot&&(a._graphicRoot?(a._container.removeChild(a._graphicRoot),this._membersRoot.addChild(a._graphicRoot)):(a._container.removeChild(a._mainElementRoot),this._membersRoot.addChild(a._mainElementRoot)),a._container=this._membersRoot)},_removeOneGraphic:function(a){this._layer.removeGraphic(a)}}),Z.ComposeGraphic1=Z.Class.extend({includes:Z.EventManager,initialize:function(a,b,c){this._container=null,this._layer=null,this._self=new Z.Graphic(a,b,c),this._members=[],this._membersShowing=!1,this._selfShowing=!0,this._membersRoot=null,this._graphicRoot=null,this._parent=null,this._show=!0,this._added=!1,this._baseHeight=0,this._feature=a,this._graphicEvents=["symbolupdated","featureupdated","show","hide"],this._mouseEvents=["dblclick","click","mousedown","mouseup","mouseover","mouseout","mousemove","contextmenu","select","unselect"];var d=this;Object.defineProperty(this,"baseHeight",{get:function(){return d._baseHeight},set:function(a){isNaN(a)||(d._baseHeight=a,d.updateFeature(d.feature))}}),Object.defineProperty(this,"options",{get:function(){return d._self.options},set:function(a){d._self.options=a}}),Object.defineProperty(this,"feature",{get:function(){return d._feature},set:function(a){a instanceof Z.Feature&&(d._feature=a,d.updateFeature(a))}}),Object.defineProperty(this,"symbol",{get:function(){return d._self.symbol},set:function(a){d._self.symbol=a}}),Object.defineProperty(this,"eventCapturable",{get:function(){return d._self.eventCapturable},set:function(a){d._self.eventCapturable=a}}),Object.defineProperty(this,"eventFirable",{get:function(){return d._self.eventFirable},set:function(a){d._self.eventFirable=a}})},onAdd:function(a,b,c){!this._graphicRoot&&b&&(this._graphicRoot=b.newInstance(),b.addChild(this._graphicRoot),this._membersRoot=b.newInstance(),this._graphicRoot.addChild(this._membersRoot)),this._layer=a;var d=this._getGraphicFeature(this.feature);this._self.updateFeature(d),this._addOneGraphic(this._self,this._graphicRoot),this._container=b,this._added=!0,this._applyEvents("on")},onRemove:function(a){this.clearMembers(),this._removeOneGraphic(this._self),this._graphicRoot.removeChild(this._membersRoot),this._container.removeChild(this._graphicRoot),this._membersRoot=null,this._graphicRoot=null,this._layer=null,this._container=null,this._added=!1,this._applyEvents("off")},updateFeature:function(a){if(this._self){var b=this._getGraphicFeature(this.feature);this._self.updateFeature(b)}for(var c=0;c<this._members.length;c++)this._members[c].updateFeature(this._members[c].feature)},updateSymbol:function(a){this._self&&this._self.updateSymbol(a);for(var b=0;b<this._members.length;b++)this._members[b].updateSymbol(this._members[b].symbol)},dispose:function(){this._self&&this._self.dispose()},refresh:function(){this._self&&this._self.refresh();for(var a=0;a<this._members.length;a++)this._members[a].refresh()},showTitle:function(){this._self&&this._self.showTitle()},hideTitle:function(){this._self&&this._self.hideTitle()},showMarker:function(){this._self&&this._self.showMarker()},hideMarker:function(){this._self&&this._self.hideMarker()},showInfoWindow:function(){this._self&&this._self.showInfoWindow()},hideInfoWindow:function(){this._self&&this._self.hideInfoWindow()},showTip:function(){this._self&&this._self.showTip()},hideTip:function(){this._self&&this._self.hideTip()},show:function(){this._selfShowing||this._membersShowing||(this._selfShowing=!0),this._selfShowing?this._showSelf():this._hideSelf(),this._membersShowing?this._showMembers():this._hideMembers()},hide:function(){this.disableSelf(),this.disableMembers()},isShowing:function(){return this._selfShowing||this._membersShowing},isAdded:function(){return this._added},enableTitle:function(){this._self&&this._self.enableTitle()},disableTitle:function(){this._self&&this._self.disableTitle()},doMouseOver:function(){this._self&&this._self.doMouseOver()},doMouseOut:function(){this._self&&this._self.doMouseOut()},doSelect:function(){this._self&&this._self.doSelect()},doUnselect:function(){this._self&&this._self.doUnselect()},enableMembers:function(){this._membersShowing||(this._showMembers(),this._membersShowing=!0)},disableMembers:function(){this._membersShowing&&(this._hideMembers(),this._membersShowing=!1)},enableSelf:function(){this._selfShowing||(this._showSelf(),this._selfShowing=!0)},disableSelf:function(){this._selfShowing&&(this._hideSelf(),this._selfShowing=!1)},addMember:function(a){if(a)for(var b=a instanceof Array?a:[a],c=0;c<b.length;c++)this._addOneMember(b[c])},removeMember:function(a){if(a)for(var b=a instanceof Array?a:[a],c=0;c<b.length;c++)for(var d=this._members.length-1;d>=0;d--)this._removeOneMember(this._members[d],d)},clearMembers:function(){for(var a=this._members.length-1;a>=0;a--)this._removeOneMember(this._members[a],a)},getAllMembers:function(){return this._members},getWorldBaseHeight:function(){var a=this.baseHeight||0;return this._parent&&this._parent.baseHeight&&(a+=this._parent.baseHeight||0),a},_getGraphicFeature:function(a){var b=this.getWorldBaseHeight(),c=a.clone();return c.shape.baseHeight+=b,c},_hideSelf:function(){this._self&&this._layer&&this._layer.hasGraphic(this._self)&&this._removeOneGraphic(this._self)},_showSelf:function(){this._self&&this._layer&&!this._layer.hasGraphic(this._self)&&this._addOneGraphic(this._self,this._graphicRoot)},_hideMembers:function(){for(var a=0;a<this._members.length;a++)this._hideOneMember(this._members[a])},_showMembers:function(){for(var a=0;a<this._members.length;a++)this._showOneMember(this._members[a])},_addOneMember:function(a){a instanceof Z.ComposeGraphic1?(this._members.push(a),a._parent=this,this._membersShowing&&(this._addOneGraphic(a,this._membersRoot),this._applyObjectEvents("on",a,this._mouseEvents))):console.info("只允许添加Z.ComposeGraphic1类型的对象")},_removeOneMember:function(a,b){(a instanceof Z.Graphic||a instanceof Z.ComposeGraphic1)&&(this._membersShowing&&(this._removeOneGraphic(a),this._applyObjectEvents("off",a,this._mouseEvents)),a._parent=null,this._members.splice(b,1))},_showOneMember:function(a){this._layer.hasGraphic(a)||this._addOneGraphic(a,this._membersRoot),a.show()},_hideOneMember:function(a){this._layer.hasGraphic(a)&&this._removeOneGraphic(a)},_addOneGraphic:function(a,b){a._container!==b&&(a.on("added",function(){a instanceof Z.ComposeGraphic1?(a._container.removeChild(a._graphicRoot),b.addChild(a._graphicRoot)):(a._container.removeChild(a._mainElementRoot),b.addChild(a._mainElementRoot)),a._container=b}),this._layer.addGraphic(a))},_removeOneGraphic:function(a){this._layer.removeGraphic(a)},_getTitlePos:function(){var a=this._self._getTitlePos();return a.alt=this.getWorldBaseHeight()+this.feature.shape.height,a},_applyEvents:function(a){this._applyObjectEvents(a,this._self,this._graphicEvents),this._applyObjectEvents(a,this._self,this._mouseEvents),this._applyObjectEvents(a,this._members,this._mouseEvents)},_applyObjectEvents:function(a,b,c){for(var d=b instanceof Array?b:[b],e=0,f=c.length;e<f;e++)for(var g=0,h=d.length;g<h;g++)d[g][a](c[e],this._fireEvents,this)},_fireEvents:function(a){var b=a.type,c={};for(var d in a)"prototype"!==d&&(c[d]="object"===d?this:a[d]);this.fire(b,c)}}),Z.StyleBuilder3D=function(){},Z.StyleBuilder3D.createRenderStyle=function(a,b,c,d){a=a||{};var e=null,f=a.opacity,g={transparent:!1};if(f<1&&(g.transparent=!0,g.opacity=f),c&&THREE[c]&&(g.side=THREE[c]),a instanceof Z.FillSymbol){if(a instanceof Z.PictureFillSymbol){var h=a.bgColor||16777215;g.color=h,"string"==typeof a.url&&a.url.length>0&&(g.map=this._loadTexture(a.url,null,d))}else{var i=a.color||a.bgColor||16777215;g.color=i}e="lambert"===b?new THREE.MeshLambertMaterial(g):"phong"===b?new THREE.MeshPhongMaterial(g):new THREE.MeshBasicMaterial(g),a instanceof Z.PictureFillSymbol||!d||"function"!=typeof d||d()}else if(a instanceof Z.PolylineSymbol){var j=a.color||16777215,k=a.width||1;g.color=j,g.linewidth=k,a.style===Z.PolylineStyleType.Dash?(a.dashSize&&(g.dashSize=a.dashSize),a.gapSize&&(g.gapSize=a.gapSize),e=new THREE.LineDashedMaterial(g)):e=new THREE.LineBasicMaterial(g),d&&"function"==typeof d&&d()}else a instanceof Z.ModelSymbol&&(e=this._createByModelSymbol(a,b,d));return e},Z.StyleBuilder3D._createByModelSymbol=function(a,b,c){var d={transparent:!1,texParams:{}};for(var e in a){var f=a[e];if(null!==f&&void 0!==f&&""!==f)switch(e.toLowerCase()){case"kd":d.color=(new THREE.Color).fromArray(f);break;case"ks":d.specular=(new THREE.Color).fromArray(f);break;case"map_kd":if(d.map)break;var g=this._getTextureParams(f,d);d.texParams.map=this._prepareTexture(this._resolveURL(a.path,g.url),g.scale,g.offset,a.map_kd_wrap,a.map_kd_wrap);break;case"map_ks":if(d.specularMap)break;d.texParams.specularMap=this._prepareTexture(this._resolveURL(a.path,f),null,null,a.map_ks_wrap,a.map_ks_wrap);break;case"ns":d.shininess=parseFloat(f);break;case"d":f<1&&(d.opacity=f,d.transparent=!0);break;case"Tr":f>0&&(d.opacity=1-f,d.transparent=!0);break;case"map_bump":case"bump":if(d.bumpMap)break;d.texParams.bumpMap=this._prepareTexture(this._resolveURL(a.path,f),g.scale,g.offset,a.map_bump_wrap,a.map_bump_wrap)}}var h;if(h="lambert"===b?new THREE.MeshLambertMaterial(d):"phong"===b?new THREE.MeshPhongMaterial(d):new THREE.MeshBasicMaterial(d),a.isLine){var i=new THREE.LineBasicMaterial;i.copy(h),h=i}for(var j in d.texParams){var k=d.texParams[j];Z.TileManager.pushImageByUrl(k.url,function(a){var b=new THREE.Texture,d=k.url.search(/\.(jpg|jpeg)$/)>0||0===k.url.search(/^data\:image\/jpeg/);b.format=d?THREE.RGBFormat:THREE.RGBAFormat,b.image=a,b.needsUpdate=!0,k.onLoad(b),h[j]=b,h.needsUpdate=!0,c&&"function"==typeof c&&c()})}return h},Z.StyleBuilder3D.createDefaultRenderStyle=function(a,b,c,d){var e=null;return a=(a+"").toLowerCase(),"fillsymbol"===a||"simplefillsymbol"===a?e=Z.StyleBuilder3D.createRenderStyle(new Z.SimpleFillSymbol(b),c,void 0,d):"picturefillsymbol"===a?e=Z.StyleBuilder3D.createRenderStyle(new Z.PictureFillSymbol(b),c,void 0,d):"linesymbol"===a&&(e=Z.StyleBuilder3D.createRenderStyle(new Z.PolylineSymbol(b),c,void 0,d)),e},Z.StyleBuilder3D._resolveURL=function(a,b){return"string"!=typeof b||""===b?"":/^https?:\/\//i.test(b)?b:a+b},Z.StyleBuilder3D._getTextureParams=function(a,b){var c,d={scale:new THREE.Vector2(1,1),offset:new THREE.Vector2(0,0)},e=a.split(/\s+/);return c=e.indexOf("-bm"),c>=0&&(b.bumpScale=parseFloat(e[c+1]),e.splice(c,2)),c=e.indexOf("-s"),c>=0&&(d.scale.set(parseFloat(e[c+1]),parseFloat(e[c+2])),e.splice(c,4)),c=e.indexOf("-o"),c>=0&&(d.offset.set(parseFloat(e[c+1]),parseFloat(e[c+2])),e.splice(c,4)),d.url=e.join(" ").trim(),d},Z.StyleBuilder3D._prepareTexture=function(a,b,c,d,e){return{url:a,onLoad:function(a){isNaN(b)||a.repeat.copy(b),isNaN(c)||a.offset.copy(c),a.wrapS=d,a.wrapT=e}}},Z.StyleBuilder3D._loadTexture=function(a,b,c,d,e){var f,g=THREE.Loader.Handlers.get(a),h=void 0!==this.manager?this.manager:THREE.DefaultLoadingManager;return null===g&&(g=new THREE.TextureLoader(h)),g.setCrossOrigin&&g.setCrossOrigin(this.crossOrigin),f=g.load(a,c,d,e),void 0!==b&&(f.mapping=b),f},Z.Style3DFlyweight=function(){var a=null;return{getInstance:function(){var b=null,c=null;try{getCurrentMapContext&&(b=getCurrentMapContext())}catch(a){}return b?(c=b.getSingleInstance("Style3DFlyweight"),c||b.registerSingleInstance("Style3DFlyweight",{symbolsBuffer:{},defaultRenderType:"basic",styleBuilder:Z.StyleBuilder3D}),c=b.getSingleInstance("Style3DFlyweight")):(a||(a={symbolsBuffer:{},defaultRenderType:"basic",styleBuilder:Z.StyleBuilder3D}),c=a),c},getStyle:function(a,b,c,d){if(!(a instanceof Z.Symbol))return null;var e=Z.Style3DFlyweight.getInstance();b=b||e.defaultRenderType,e.symbolsBuffer[b]||(e.symbolsBuffer[b]=[]);for(var f=e.symbolsBuffer[b],g=null,h=f.length,i=0;i<h;i++){var j=f[i],k=j.symbol;if(j.side===c&&k.equals(a)){g=j.style;break}}return g||(g=e.styleBuilder.createRenderStyle(a,b,c,d),f.push({style:g,side:c,symbol:a.clone()})),g}}}(),Z.MaterialCache=function(){var a=null;return{getInstance:function(){var b=null,c=null;try{getCurrentMapContext&&(b=getCurrentMapContext())}catch(a){}return b?(c=b.getSingleInstance("MaterialCache"),c||b.registerSingleInstance("MaterialCache",{symbolsBuffer:{}}),c=b.getSingleInstance("MaterialCache")):(a||(a={symbolsBuffer:{}}),c=a),c},getMaterial:function(a){return Z.MaterialCache.getInstance().symbolsBuffer[a]},putMaterial:function(a,b){Z.MaterialCache.getInstance().symbolsBuffer[a]=b},removeMaterial:function(a){delete Z.MaterialCache.getInstance().symbolsBuffer[a]},clear:function(){Z.MaterialCache.getInstance().symbolsBuffer={}}}}(),Z.CanvasTexture=Z.Class.extend({initialize:function(a){this._element=null,this._context=null,this.needsUpdate=!1,this.options={padding:0,width:100,height:100,autoWidth:!0,autoHeight:!0,fill:!0,fillSymbol:new Z.SimpleFillSymbol,border:!0,borderSymbol:new Z.PolylineSymbol,opacity:1},this.options=Z.Util.applyOptions(this.options,a,!1)},draw:function(a,b){var c=this._getContext();this.drawContent(c,a,b)},drawContent:function(a,b,c){},clear:function(){if(this._context){var a=this._element.width,b=this._element.height;this._context.clearRect(0,0,a,b)}},dispose:function(){this._context=null,this._element=null},getElement:function(){return this._element},getSize:function(){if(this._element){var a=this._element.width,b=this._element.height;return new Z.Point(a,b)}return new Z.Point(0,0)},_getContext:function(){return this._element||(this._element=this._createCanvasElement()),this._context||(this._context=this._element.getContext("2d")),this._context.globalAlpha!==this.options.opacity&&(this._context.globalAlpha,this.options.opacity),this._context},_createCanvasElement:function(){var a=document.createElement("canvas"),b=this.options.padding;return a.style.padding=b+"px",a},_getStyle:function(a,b){var c=a;if("string"==typeof a){if(a.length>=7&&a.indexOf("#")>=0){a=a.substring(a.indexOf("#")+1);var d=(this._hex2Int(a.charAt(0))<<4)+this._hex2Int(a.charAt(1)),e=(this._hex2Int(a.charAt(2))<<4)+this._hex2Int(a.charAt(3)),f=(this._hex2Int(a.charAt(4))<<4)+this._hex2Int(a.charAt(5));c="rgba("+d+","+e+","+f+","+b+")"}else if(a.length>=8&&a.indexOf("0x")>=0){a=a.substring(a.indexOf("0x")+2);var d=(this._hex2Int(a.charAt(0))<<4)+this._hex2Int(a.charAt(1)),e=(this._hex2Int(a.charAt(2))<<4)+this._hex2Int(a.charAt(3)),f=(this._hex2Int(a.charAt(4))<<4)+this._hex2Int(a.charAt(5));c="rgba("+d+","+e+","+f+","+b+")"}}else if("number"==typeof a){var d=a>>16&255,e=a>>8&255,f=255&a;c="rgba("+d+","+e+","+f+","+b+")"}return c},_hex2Int:function(a){return parseInt("0x"+a)},px2num:function(a){return"string"==typeof a&&a.indexOf("px")>=0?parseInt(a.substring(0,a.length-2)):NaN}}),Z.TextCanvasTexture=Z.CanvasTexture.extend({initialize:function(a){Z.CanvasTexture.prototype.initialize.call(this,a)},drawContent:function(a,b,c){c=c||{};var d=c.textSymbol||new Z.TextSymbol;this._setCanvasFont(a,d),this._setCanvasSize(this._element,a,b),this._setCanvasFont(a,d),this._fillBackground(this._element,a,d),this._fillText(this._element,a,b)},_setCanvasFont:function(a,b){var c=b.font.family,d=b.font.weight,e=b.font.style,f=(b.font.size+"").toLowerCase();f.indexOf("px")<0&&f.indexOf("em")<0&&(f+="px"),a.font=e+" "+d+" "+f+" "+c,a.fillStyle=b.color},_calculateCanvasSize:function(a,b,c){var d=b.measureText(c),e=this.options.padding,f=d.width+2*e;return d=b.measureText("中"),{width:f,height:1.5*d.width+2*e}},_setCanvasSize:function(a,b,c){if(this.options.autoWidth||this.options.autoHeight){var d=this._calculateCanvasSize(a,b,c);a.width=this.options.autoWidth?d.width:this.options.width,a.height=this.options.autoHeight?d.height:this.options.height}else a.width=this.options.width,a.height=this.options.height},_fillBackground:function(a,b,c){if(c.fillSymbol||c.borderSymbol){if(c.fill){var d=b.fillStyle;b.fillStyle=this._getStyle(c.fillSymbol.color,c.fillSymbol.opacity),b.fillRect(0,0,a.width,a.height),b.fillStyle=d}if(c.border){var e=b.strokeStyle;b.lineWidth=c.borderWidth,b.strokeStyle=this._getStyle(c.borderSymbol.color,c.borderSymbol.opacity),b.strokeRect(0,0,a.width,a.height),b.strokeStyle=e}}},_fillText:function(a,b,c){var d=(this.options.padding,this._getTextPosition(a));b.fillText(c,d.x,d.y)},_getTextPosition:function(a){var b=this.options.padding,c=a.height-2*b;return{x:b,y:a.height-b-1*c/3}}}),Z.PolylineCanvasTexture=Z.CanvasTexture.extend({initialize:function(a){Z.CanvasTexture.prototype.initialize.call(this,a)},drawContent:function(a,b,c){var d=this._getBounds(b);this._setCanvasSize(this._element,a,d,c.pixelSceneRatio),this._fillBackground(this._element,a,this.options),this._setDrawStyle(a,c.polylineSymbol),this._fillPolyline(this._element,a,b,d)},_getBounds:function(a){for(var b,c,d=0;d<a.length;d++)b?(b.x=Math.min(b.x,a[d].x),b.y=Math.min(b.y,a[d].y),b.z=Math.min(b.z,a[d].z),c.x=Math.max(c.x,a[d].x),c.y=Math.max(c.y,a[d].y),c.z=Math.max(c.z,a[d].z)):(b=a[d].clone(),c=a[d].clone());return{min:b,max:c}},_calculateCanvasSize:function(a,b,c,d){return{width:(c.max.x-c.min.x)*d.x,height:(c.max.y-c.min.y)*d.y}},_setCanvasSize:function(a,b,c,d){if(this.options.autoWidth||this.options.autoHeight){var e=this._calculateCanvasSize(a,b,c,d);a.width=this.options.autoWidth?e.width:this.options.width,a.height=this.options.autoHeight?e.height:this.options.height}else a.width=this.options.width,a.height=this.options.height},_fillBackground:function(a,b,c){if(c.fillSymbol||c.borderSymbol){if(c.fill){var d=b.fillStyle;b.fillStyle=this._getStyle(c.fillSymbol.color,c.fillSymbol.opacity),b.fillRect(0,0,a.width,a.height),b.fillStyle=d}if(c.border){var e=b.strokeStyle;b.lineWidth=c.borderWidth,b.strokeStyle=this._getStyle(c.borderSymbol.color,c.borderSymbol.opacity),b.strokeRect(0,0,a.width,a.height),b.strokeStyle=e}}},_setDrawStyle:function(a,b){a.strokeStyle=this._getStyle(b.color,b.opacity),a.lineWidth=b.width},_fillPolyline:function(a,b,c,d){var e,f,g=d.min,h=d.max,i=h.x-g.x,j=h.y-g.y,k=a.width,l=a.height;if(!(c.length<2)){b.beginPath();for(var m=0;m<c.length;m++)e=k*(c[m].x-g.x)/i,f=l*(h.y-c[m].y)/j,0==m?b.moveTo(e,f):b.lineTo(e,f);b.stroke()}}}),Z.TileCanvasTexture=Z.CanvasTexture.extend({initialize:function(a){Z.CanvasTexture.prototype.initialize.call(this,a),this._tileWidth=256,this._tileHeight=256,this._getContext()},setTextureSize:function(a,b){"number"!=typeof a||isNaN(a)||(this._element.width=a),"number"!=typeof b||isNaN(b)||(this._element.height=b)},setTileSize:function(a,b){"number"!=typeof a||isNaN(a)||"number"!=typeof b||isNaN(b)||(this._tileWidth=a,this._tileHeight=b)},drawContent:function(a,b,c){this._fillBackground(this._element,a,this.options),this._fillTile(this._element,a,b)},_fillBackground:function(a,b,c){if(c.fillSymbol||c.borderSymbol){if(c.fill){var d=b.fillStyle;b.fillStyle=this._getStyle(c.fillSymbol.bgColor,c.fillSymbol.opacity),b.fillRect(0,0,a.width,a.height),b.fillStyle=d}if(c.border){var e=b.strokeStyle;b.lineWidth=c.borderWidth,b.strokeStyle=this._getStyle(c.borderSymbol.color,c.borderSymbol.opacity),b.strokeRect(0,0,a.width,a.height),b.strokeStyle=e}}},_fillTile:function(a,b,c){if(!(c.length<0))for(var d=0;d<c.length;d++){var e=c[d].image,f=c[d].point;b.drawImage(e,0,0,e.width,e.height,f.x*this._tileWidth,f.y*this._tileHeight,this._tileWidth,this._tileHeight)}}}),Z.CommonCanvasTexture=Z.CanvasTexture.extend({initialize:function(a){Z.CanvasTexture.prototype.initialize.call(this,a),this._getContext(),this._tileAnchor=new Z.Point(0,0),this._latLngBounds=null,this._widthScale=1,this._heightScale=1,this._textureWidth=0,this._textureHeight=0},setTextureSize:function(a,b){if("number"==typeof a&&!isNaN(a)){this._textureWidth=a;var c=this._nearestPowerOfTwo(a);c!==a?(this._widthScale=c/a,a=c):this._widthScale=1,this._element.width=a,this._element.style.width=a+"px"}if("number"==typeof b&&!isNaN(b)){this._textureHeight=b;var d=this._nearestPowerOfTwo(b);d!==b?(this._heightScale=d/b,b=d):this._heightScale=1,this._element.height=b,this._element.style.height=b+"px"}this.needsUpdate=!0},getSize:function(){return this._element?new Z.Point(this._textureWidth,this._textureHeight):new Z.Point(0,0)},setTileAnchor:function(a,b){this._tileAnchor.x=a,this._tileAnchor.y=b,this.needsUpdate=!0},setLatLngBounds:function(a){this._latLngBounds=a,this.needsUpdate=!0},drawContent:function(a,b,c){if(b instanceof Array){b.sort(function(a,b){return a?b?!a.index&&0!==a.index||!b.index&&0!==b.index?-1:a.index-b.index:1:-1});for(var d=0;d<b.length;d++)this._drawOneItem(a,b[d])}},getPixelData:function(a,b){this.getSize();if(a>=0&&a<this._textureWidth&&b>=0&&b<this._textureHeight&&this._context){a*=this._widthScale,b*=this._heightScale;var c=this._context.getImageData(a,b,1,1);return c.data.length>=4?c.data:null}return null},_drawOneItem:function(a,b){b.objects instanceof Array&&("graphic"===b.type?this._drawGraphics(a,b.objects,b.options):"image"===b.type&&this._drawImages(a,b.objects,b.options))},_drawGraphics:function(a,b,c){for(var d=this._latLngBounds.getSouthWest(),e=this._latLngBounds.getNorthEast(),f=this._textureWidth/(e.lng-d.lng),g=this._textureHeight/(e.lat-d.lat),h=this._getVisibleGraphics(b),i=h.length,j=0;j<i;j++){var k=h[j],l=k.type;"polyline"===l?this._drawPolyline(a,k.object,k.symbol,f,g):"polygon"===l&&this._drawPolygon(a,k.object,k.symbol,f,g)}},_drawPolyline:function(a,b,c,d,e){var f=this._normalizePolylineVertices(b.paths);if(f){var g=this;this._setDrawStyle(a,c,null,function(){g._doPolylineDrawing(a,f,d,e)})}},_normalizePolylineVertices:function(a){var b,c=!(a instanceof Array),d=c||!(a[0]instanceof Array),e=d||!(a[0][0]instanceof Array);return e?d||(b=[a]):b=a,b},_doPolylineDrawing:function(a,b,c,d){for(var e=this._latLngBounds.getSouthWest(),f=this._latLngBounds.getNorthEast(),g=0;g<b.length;g++)if(!(b[g].length<2)){a.beginPath();for(var h=0;h<b[g].length;h++){var i=c*(b[g][h][1]-e.lng),j=d*(f.lat-b[g][h][0]);0==h?a.moveTo(i,j):a.lineTo(i,j)}a.stroke()}},_drawPolygon:function(a,b,c,d,e){if(!c.hidePolyline||!c.hideFill){var f=this._normalizePolygonVertices(b.rings);if(f){var g=this;this._setDrawStyle(a,c.polylineSymbol,c.fillSymbol,function(){g._doPolygonDrawing(a,f,c,d,e)})}}},_normalizePolygonVertices:function(a){var b,c=!(a instanceof Array),d=c||!(a[0]instanceof Array),e=d||!(a[0][0]instanceof Array),f=e||!(a[0][0][0]instanceof Array);return f?e?d||(b=[[a]]):b=[a]:b=a,b},_setDrawStyle:function(a,b,c,d){if(b||c){var e=this,f=arguments;if(b&&(a.strokeStyle=this._getStyle(b.color,b.opacity),a.lineWidth=b.width),c)if(c.url){var g=THREE.Cache.get(c.url);if(!g)return g=new Image,g.onload=function(){THREE.Cache.add(c.url,g),e._setDrawStyle(f),e.needsUpdate=!0},void(g.src=c.url);g.style.opacity=c.opacity,a.fillStyle=a.createPattern(g,"repeat")}else a.fillStyle=this._getStyle(c.color||c.bgColor,c.opacity);d&&d.call(e)}},_getStyle:function(a,b){var c=a;if("string"==typeof a){if(a.length>=7&&a.indexOf("#")>=0){a=a.substring(a.indexOf("#")+1);var d=(this._hex2Int(a.charAt(0))<<4)+this._hex2Int(a.charAt(1)),e=(this._hex2Int(a.charAt(2))<<4)+this._hex2Int(a.charAt(3)),f=(this._hex2Int(a.charAt(4))<<4)+this._hex2Int(a.charAt(5));c="rgba("+d+","+e+","+f+","+b+")"}else if(a.length>=8&&a.indexOf("0x")>=0){a=a.substring(a.indexOf("0x")+2);var d=(this._hex2Int(a.charAt(0))<<4)+this._hex2Int(a.charAt(1)),e=(this._hex2Int(a.charAt(2))<<4)+this._hex2Int(a.charAt(3)),f=(this._hex2Int(a.charAt(4))<<4)+this._hex2Int(a.charAt(5));c="rgba("+d+","+e+","+f+","+b+")"}}else if("number"==typeof a){var d=a>>16&255,e=a>>8&255,f=255&a;c="rgba("+d+","+e+","+f+","+b+")"}return c},_doPolygonDrawing:function(a,b,c,d,e){for(var f=this._latLngBounds.getSouthWest(),g=this._latLngBounds.getNorthEast(),h=b.length,i=0;i<h;i++){a.beginPath();for(var j=b[i].length,k=0;k<j;k++)if(!(b[i][k].length<3))for(var l=b[i][k].length,m=0;m<l;m++){var n=d*(b[i][k][m][1]-f.lng),o=e*(g.lat-b[i][k][m][0]);0==m?a.moveTo(n,o):a.lineTo(n,o)}c.hideFill||a.fill(),c.hidePolyline||a.stroke()}},_getVisibleGraphics:function(a){for(var b=this._latLngBounds.getSouthWest(),c=this._latLngBounds.getNorthEast(),d=a.length,e=[],f=0;f<d;f++){var g=a[f],h=g.type,i=[];if("polyline"===h?i=g.object.paths:"polygon"===h&&(i=g.object.rings),!(i.length<=0)){this._graphicIsVisible(b,c,i)&&e.push(g)}}return e},_graphicIsVisible:function(a,b,c){var d=Z.GeometryUtil.getPathBounds(c),e=d.getSouthWest(),f=d.getNorthEast();return!(e.lat>b.lat||e.lng>b.lng||f.lat<a.lat||f.lng<a.lng)},_drawImages:function(a,b,c){if(!(b.length<=0)){c=c||{};var d=0,e=0;c.topLeft&&(d=c.topLeft.x-this._tileAnchor.x,e=c.topLeft.y-this._tileAnchor.y);var f=null;if(c.tileBounds)f=c.tileBounds;else{for(var g=[],h=0;h<b.length;h++)g.push(b[h].point);f=Z.Util.getPointBounds(g)}for(var h=0;h<b.length;h++){var i=b[h].image,j=b[h].point,k=c.width||i.width,l=c.height||i.height,m=this._getTileTopLeftPos(d,e,j,f,c.pyramidModel);try{var n=m.x*this._widthScale,o=m.y*this._heightScale,p=k*this._widthScale,q=l*this._heightScale;a.drawImage(i,0,0,i.width,i.height,n,o,p,q)}catch(a){console.error(a.message)}}}},_getTileTopLeftPos:function(a,b,c,d,e){var f=e.getTopLeftPixelPointInBounds(c,d);return new Z.Point(f.x+a,f.y+b)},_fillBackground:function(a,b,c){if(c.fillSymbol||c.borderSymbol){if(c.fill){var d=b.fillStyle;b.fillStyle=this._getStyle(c.fillSymbol.bgColor,c.fillSymbol.opacity),b.fillRect(0,0,a.width,a.height),b.fillStyle=d}if(c.border){var e=b.strokeStyle;b.lineWidth=c.borderWidth,b.strokeStyle=this._getStyle(c.borderSymbol.color,c.borderSymbol.opacity),b.strokeRect(0,0,a.width,a.height),b.strokeStyle=e}}},_nearestPowerOfTwo:function(a){return a}}),Z.AggragatedSurfaceTexture=Z.CommonCanvasTexture.extend({initialize:function(a){var b=Z.Util.applyOptions({padding:0,autoWidth:!1,autoHeight:!1,fill:!1,border:!1},a,!1);Z.CommonCanvasTexture.prototype.initialize.apply(this,b),this._layers={}},addSurfaceLayer:function(a,b,c,d,e){a&&b&&(d="number"==typeof d?d||0:0,this._layers[a]={type:b,objects:c,index:d,options:e},this.needsUpdate=!0)},removeSurfaceLayer:function(a){a&&(this._layers[a]&&delete this._layers[a],this.needsUpdate=!0)},updateLayerIndex:function(a,b){a&&!isNaN(b)&&this._layers[a]&&(this._layers[a].index=b,this.needsUpdate=!0)},updateLayerContent:function(a,b,c){a&&(b||c)&&this._layers[a]&&(b&&(this._layers[a].objects=b),c&&(this._layers[a].options=c),this.needsUpdate=!0)},draw:function(){var a=[];for(var b in this._layers)a.push(this._layers[b]);Z.CommonCanvasTexture.prototype.draw.call(this,a)}}),Z.HotAreaTexture=Z.AggragatedSurfaceTexture.extend({initialize:function(){var a={fill:!0,fillSymbol:new Z.SimpleFillSymbol({color:"#000000"})};Z.AggragatedSurfaceTexture.prototype.initialize.call(this,a),this._lineBuffer=1,this._layerColors={},this._layerMapping={},this._maxLayerCount=Math.pow(2,8),this._maxGraphicCount=Math.pow(2,16)-1},addSurfaceLayer:function(a,b,c,d,e){if(a){Z.AggragatedSurfaceTexture.prototype.addSurfaceLayer.apply(this,arguments);var f=this._getLayerColor();this._layerColors[a]=f,this._layerMapping[f+""]={}}},removeSurfaceLayer:function(a){if(a){Z.AggragatedSurfaceTexture.prototype.removeSurfaceLayer.apply(this,arguments);var b=this._layerColors[a];delete this._layerColors[a],delete this._layerMapping[b+""]}},updateLayerContent:function(a,b,c){a&&(b||c)&&this._layers[a]&&(this._updateLayerContent(a,b),this._updateLayerOptions(a,c),this.needsUpdate=!0)},draw:function(){var a=[];for(var b in this._layers)a.push(this._layers[b]);Z.CommonCanvasTexture.prototype.draw.call(this,a)},getGraphic:function(a,b){var c=this._latLngBounds,d=this.getSize(),e=Math.ceil(d.x*(b.lng-c.getWest())/(c.getEast()-c.getWest())),f=Math.ceil(d.y*(c.getNorth()-b.lat)/(c.getNorth()-c.getSouth()));return this._getGraphicByPixel(a,e,f)},_getLayerColor:function(){for(var a=0;a<this._maxLayerCount;a++){var b=!1;for(var c in this._layerColors)if(this._layerColors[c]===a){b=!0;break}if(!b)return a}a>=this._maxLayerCount&&console.error("图层数量超过了允许的最大值："+this._maxLayerCount)},_updateLayerContent:function(a,b){if(a&&b){for(var c=this._layerColors[a]<<16,d=this._layerMapping[this._layerColors[a]+""],e=b.length,f=new Array(e),g=0;g<e;g++){var h=b[g],i={object:h.object,symbol:h.symbol.clone(),type:h.type,graphic:h.graphic},j=this._getGraphicColor(c,g);this._setGraphicSymbol(i,j),d&&(d[j+""]=i),f[g]=i}this._layers[a].objects=f}},_setGraphicSymbol:function(a,b){var c=a.type,d=a.symbol;"polyline"===c?(d.width+=this._lineBuffer,d.color=b,d.opacity=1):"polygon"===c&&(d.polylineSymbol.color=b,d.polylineSymbol.opacity=1,d.fillSymbol=new Z.SimpleFillSymbol({opacity:1,color:b,bgColor:b}))},_getGraphicColor:function(a,b){b+1>=this._maxGraphicCount&&console.error("图层中要素数量超过了允许的最大值："+this._maxGraphicCount);var c=a+b+1;return"rgba("+(c>>16&255)+","+(c>>8&255)+","+(255&c)+",1)"},_updateLayerOptions:function(a,b){b&&(this._layers[a].options=b)},_getGraphicByPixel:function(a,b,c){var d=this.getPixelData(b,c);if(!d)return null;if(255!==d[3])return null;var e=d[0];d[1],d[2];if(a&&e!==this._layerColors[a])return null;var f=this._layerMapping[e];if(f){var g="rgba("+d[0]+","+d[1]+","+d[2]+",1)";return f[g]?f[g].graphic:null}return null}}),Z.GraphicRender3D=Z.IGraphicRender.extend({initialize:function(a){this._graphic=a,this._renderedObject=null,this._container=null,this._baseIndex=null,this._layerIndex=null,this._layer=null,this._scene=null,this._added=!1},onAdd:function(a,b,c){this._renderedObject&&this._container&&this._container.remove(this._renderedObject),this._container=b?b.root:this._container,this._baseIndex=a.getContainerPane().index,this._layerIndex=a.getZIndex(),this._layer=a,this._scene=c,this._renderedObject?this._updateGraphic():(this._renderedObject=this.getRenderedObject(this._baseIndex,this._layerIndex),this._renderedObject&&(this._renderedObject.castShadow=!0),this._renderedObject&&this._container&&(this._container.add(this._renderedObject),this._renderedObject.updateMatrixWorld(!0))),this._added=!0},onRemove:function(a){this._renderedObject&&this._container&&this._container.remove(this._renderedObject),this._detachGraphic(this._renderedObject),this._container=null,this._layer=null,this._scene=null,this._added=!1},getRenderedObject:function(a,b){var c=this._graphic;if(c){var d=this.buildGeometry(c.feature.shape),e=this.buildMaterial(c.symbol),f=this.buildGraphicObject(d,e);return f&&this._attachGraphic(f),f}return null},buildGeometry:function(a,b){},buildMaterial:function(a){},buildGraphicObject:function(a,b){return new THREE.Mesh(a,b)},updateGeometry:function(a,b){if(this._renderedObject){var c=this.buildGeometry(a,b);c instanceof Array&&1===c.length?c.length<=0?this._renderedObject.geometry=new THREE.Geometry:1===c.length?this._renderedObject.geometry=c[0]:this._updateGraphic():this._renderedObject.geometry=c}},updateSymbol:function(a){this._updateGraphic()},dispose:function(){this._added&&this.onRemove(this._layer),this._disposeRenderedObject(this._renderedObject),this._renderedObject=null,this._graphic=null},refresh:function(){},_enableZIndex:function(a){Z.ZIndexManager.enableZIndex(a)},_attachGraphic:function(a){if(a)if(a.children.length>0)for(var b=0;b<a.children.length;b++)this._attachGraphic(a.children[b]);else a._disableMouseEvent||(a._graphicObj=this._graphic.ownerGraphic,a.userData.graphicId=Z.Util.stamp(a._graphicObj,"graphic"))},_detachGraphic:function(a){if(a)if(a.children.length>0)for(var b=0;b<a.children.length;b++)this._detachGraphic(a.children[b]);else a._graphicObj&&(a._graphicObj=null,delete a._graphicObj),a.userData.graphicId&&delete a.userData.graphicId},_latLngPointToScene:function(a){var b;b=a instanceof Z.LatLng?a:new Z.LatLng(a.y,a.x,a.z);var c=this._layer.latLngToLayerScenePoint(b);return new THREE.Vector3(c.x,c.y,c.z)},_updateGraphic:function(){if(this._renderedObject){var a=this.getRenderedObject(this._baseIndex,this._layerIndex);this._container&&this._container.remove(this._renderedObject);var b=this._renderedObject;this._renderedObject=a,this._container&&(this._container.add(this._renderedObject),this._renderedObject.updateMatrixWorld(!0)),this._disposeRenderedObject(b)}},_disposeRenderedObject:function(a){if(a){for(var b=a.children.length,c=0;c<b;c++)this._disposeRenderedObject(a.children[c]);a.geometry&&a.geometry.dispose(),a.material&&this._disposeMaterial(a.material)}},_disposeMaterial:function(a){if(a)for(var b=a instanceof Array?a:[a],c=0;c<b.length;c++){var d=b[c];if(d.materials)for(var e=d.materials.length,f=0;f<e;f++)this._disposeMaterial(d.materials[f]);else d.map&&d.map.dispose(),d.alphaMap&&d.alphaMap.dispose(),d.aoMap&&d.aoMap.dispose(),d.emissiveMap&&d.emissiveMap.dispose(),d.lightMap&&d.lightMap.dispose(),d.specularMap&&d.specularMap.dispose(),d.dispose&&d.dispose()}}}),Z.PolylineRender3D=Z.GraphicRender3D.extend({initialize:function(a){Z.GraphicRender3D.prototype.initialize.apply(this,arguments)},buildGeometry:function(a){var b,c=a?a.paths:null,d=!!a&&a.lngStart;return c&&(b=Z.GeometryUtil.convertPathToGeometry(c,this._latLngPointToScene,this,d)),b},buildMaterial:function(a){return a instanceof Z.PolylineSymbol?Z.StyleBuilder3D.createRenderStyle(a):Z.StyleBuilder3D.createRenderStyle("linesymbol")},buildGraphicObject:function(a,b){if(a instanceof Array){for(var c=new THREE.Object3D,d=0;d<a.length;d++)c.add(new THREE.Line(a[d],b));return c}return new THREE.Line(a,b)},updateGeometry:function(a,b){if(this._renderedObject){var c=this.getRenderedObject(this._baseIndex,this._layerIndex);this._container&&this._container.remove(this._renderedObject),this._renderedObject=c,this._container&&this._container.add(this._renderedObject)}}}),Z.PolygonRender3D=Z.GraphicRender3D.extend({initialize:function(a){Z.GraphicRender3D.prototype.initialize.apply(this,arguments),this._uvScale,this._textureForLoad=[],this._textureLoaded=[]},onAdd:function(a,b,c,d,e){Z.GraphicRender3D.prototype.onAdd.apply(this,arguments)},onRemove:function(a,b,c,d,e){Z.GraphicRender3D.prototype.onRemove.apply(this,arguments),this._uvScale=void 0},buildGeometry:function(a){var b,c=a?a.rings:null,d=!!a&&a.lngStart,e=(a.baseHeight,a.ignoreCw?0:a.cw?1:-1);c&&(b=Z.GeometryUtil.convertPathToShapes(c,this._latLngPointToScene,e,this,0,0,d));for(var f=[],g=0;g<b.length;g++){var h=new THREE.ShapeGeometry(b);this._uvScale&&this._textureForLoad.length>0&&(this._updateUV(h,this._uvScale),h.uvsNeedUpdate=!0),f.push(h)}return f},buildMaterial:function(a){return a=a||{},this._uvScale=void 0,[null,a.hideFill?null:this._getFillMaterial(a.fillSymbol)]},buildGraphicObject:function(a,b){for(var c=[],d=a instanceof Array?a:[a],e=0;e<d.length;e++){var f=null;if(this._loadTexture(d[e]),b instanceof Array){for(var g=[],h=0;h<b.length;h++)b[h]&&g.push(b[h]);g.length>1?f=new THREE.SceneUtils.createMultiMaterialObject(d[e],g):1===g.length&&(f=new THREE.Mesh(d[e],g[0]))}else f=new THREE.Mesh(d[e],b);c.push(f)}if(c.length<=0)return new THREE.Object3D;if(1===c.length)return c[0];for(var i=new THREE.Object3D,j=0;j<c.length;j++)i.add(c[j]);return i},getRenderedObject:function(a,b){return this._uvScale=void 0,this._textureForLoad=[],Z.GraphicRender3D.prototype.getRenderedObject.apply(this,arguments)},_getFrameMaterial:function(a){return a instanceof Z.PolylineSymbol?Z.StyleBuilder3D.createRenderStyle(a):Z.StyleBuilder3D.createDefaultRenderStyle("linesymbol")},_getFillMaterial:function(a){var b,a=a||{};return a instanceof Z.PictureFillSymbol?(b=Z.StyleBuilder3D.createRenderStyle(a),b.side=THREE.DoubleSide,this._textureForLoad.push({material:b,url:a.url})):b=a?Z.StyleBuilder3D.createRenderStyle(a):Z.StyleBuilder3D.createDefaultRenderStyle("fillsymbol"),b},_getUVScale:function(a){var b=1,c=1;if(a){var d=a.image,e=d.width,f=d.height,g=this._scene.getPixelSceneRatio();b=e/g.x,c=f/g.y}return Z.Point.create(b,c)},_updateUV:function(a,b){a instanceof THREE.Geometry&&this._updateGeometryUV(a,b)},_updateGeometryUV:function(a,b){var c=a.faceVertexUvs;a.computeBoundingBox();for(var d=a.boundingBox,e=0;e<c.length;e++)for(var f=0;f<c[e].length;f++)for(var g=0;g<c[e][f].length;g++)c[e][f][g].x=(c[e][f][g].x-d.min.x)/b.x,c[e][f][g].y=(c[e][f][g].y-d.min.y)/b.y},_loadTexture:function(a){if(this._textureForLoad.length>0)for(var b=this,c=0;c<this._textureForLoad.length;c++){var d=this._textureForLoad[c].url,e=this._textureForLoad[c].material,f=THREE.ImageUtils.loadTexture(d,{},function(c){if(!b._uvScale){var d=b._getUVScale(c);b._uvScale=d}b._updateUV(a,b._uvScale),a.uvsNeedUpdate=!0,b._scene.refresh()},function(){b._scene.refresh()});f.wrapS=THREE.RepeatWrapping,f.wrapT=THREE.RepeatWrapping,f.minFilter=THREE.LinearFilter,e.map=f}}}),Z.PictureMarkerRender3D=Z.GraphicRender3D.extend({initialize:function(a){Z.GraphicRender3D.prototype.initialize.apply(this,arguments),this._spriteContainer=null},buildGeometry:function(a,b){return a instanceof Z.LatLng?this._latLngPointToScene(new THREE.Vector3(a.lng,a.lat,a.alt)):null},buildMaterial:function(a){var b=this;return a instanceof Z.PictureMarkerSymbol?Z.StyleBuilder3D.createRenderStyle(new Z.PictureFillSymbol({url:a.url}),void 0,void 0,function(){b._scene.refresh()}):Z.StyleBuilder3D.createDefaultRenderStyle("picturefillsymbol",void 0,function(){b._scene.refresh()})},buildGraphicObject:function(a,b){if(a&&b){var c=this._createPictureObject(b),d=new Z.SpriteContainer(c);return d.setPosition(a.x,a.y,a.z),this._applyOffset(d),this._updateSpriteSize(d,this._graphic.symbol),d.onAdd(this._scene),this._spriteContainer=d,d.getThreeObject()}},refresh:function(){Z.GraphicRender3D.prototype.refresh.apply(this,arguments),this._spriteContainer.refresh()},updateGeometry:function(a,b){var c=this.buildGeometry(a,b);this._spriteContainer.setPosition(c.x,c.y,c.z)},_applyOffset:function(a){var b=this._graphic.symbol,c=this._pixelOffsetToScene(b.offset),d=this._getAnchorOffset(a,b.anchor);a.setOffset(new Z.Point(c.x+d.x,c.y+d.y,c.z+d.z))},_getAnchorOffset:function(a,b){var c=0,d=0;"bottomLeft"===b?(c=.5,d=.5):"bottomCenter"===b?(c=0,d=.5):"bottomRight"===b?(c=-.5,d=.5):"centerLeft"===b?(c=.5,d=0):"centerCenter"===b?(c=0,d=0):"centerRight"===b?(c=-.5,d=0):"topLeft"===b?(c=.5,d=-.5):"topCenter"===b?(c=0,d=-.5):"topRight"===b&&(c=-.5,d=-.5);var e=a.getSpriteBounds();return{x:c*Math.abs(e.max.x-e.min.x),y:d*Math.abs(e.max.y-e.min.y),z:0}},_pixelOffsetToScene:function(a){var b=a||Z.Point.create(0,0,0),c=this._scene.getPixelSceneRatio();return{x:b.x/c.x||0,y:b.y/c.y||0,z:b.z/c.z||0}},_updateSpriteSize:function(a,b){var c=this._scene.getPixelSceneRatio(),d=b.width||1,e=b.height||1,f=d/c.x,g=e/c.y;a.setScale(new Z.Point(f,g,1))},_createPictureObject:function(a){var b=new THREE.PlaneGeometry(1,1),c=a||Z.StyleBuilder3D.createDefaultRenderStyle("picturefillsymbol"),d=new THREE.Mesh(b,c);return d.castShadow=!0,d}}),Z.CircleMarkerRender3D=Z.GraphicRender3D.extend({initialize:function(a){Z.GraphicRender3D.prototype.initialize.apply(this,arguments)},buildGeometry:function(a,b){return a=a.center,a instanceof Z.LatLng?this._latLngPointToScene(new THREE.Vector3(a.lng,a.lat,a.alt)):null},buildMaterial:function(a){var b=this;return a instanceof Z.CircleSymbol?Z.StyleBuilder3D.createRenderStyle(a.fillSymbol,void 0,void 0,function(){b._scene.refresh()}):Z.StyleBuilder3D.createDefaultRenderStyle("fillsymbol",void 0,function(){b._scene.refresh()})},buildGraphicObject:function(a,b){if(a&&b){var c=this._createCircleObject(b);return c.position.set(a.x,a.y,a.z),c}},updateGeometry:function(a,b){var c=this.buildGeometry(a,b);this._renderedObject.position.set(c.x,c.y,c.z);var d=this._createCircleGeometry();this._renderedObject.geometry=d},_createCircleObject:function(a){var b=this._createCircleGeometry(),c=a||Z.StyleBuilder3D.createRenderStyle("simplefillsymbol");return new THREE.Mesh(b,c)},_createCircleGeometry:function(){var a=this._graphic.feature.shape,b=this._graphic.symbol.segments,c=this._layer.getSceneHeight(a.radius);return"pixel"===a.radiusType&&(c=a.radius/this._scene.getPixelSceneRatio().x),new THREE.CircleGeometry(c,b)}}),Z.ExtrudeRender3D=Z.GraphicRender3D.extend({initialize:function(a){Z.GraphicRender3D.prototype.initialize.apply(this,arguments)},buildGeometry:function(a){var b=a.ignoreCw?0:a.cw?1:-1;if(a instanceof Z.Extrude)return this._buildOneGeometry(a,b);if(a instanceof Z.MultiExtrude){for(var c=[],d=0;d<a.extrudes.length;d++)c.push(this._buildOneGeometry(a.extrudes[d],b));return this._mergeGeometrys(c)}},buildMaterial:function(a){var b,c;return a instanceof Z.ExtrudeSymbol?(b=Z.Style3DFlyweight.getStyle(new Z.SimpleFillSymbol({color:a.topColor,opacity:a.opacity}),"lambert",a.side),a.topImageUrl&&(b=this._appendTexture(b,a.topImageUrl)),c=Z.Style3DFlyweight.getStyle(new Z.SimpleFillSymbol({color:a.wallColor,opacity:a.opacity}),"lambert",a.side),a.wallImageUrl&&(c=this._appendTexture(c,a.wallImageUrl))):(b=Z.Style3DFlyweight.getStyle(new Z.SimpleFillSymbol,"lambert",a.side),c=b),[b,c]},buildGraphicObject:function(a,b){if(!a||!b)return null;for(var c=[],d=a instanceof Array?a:[a],e=0;e<d.length;e++){var f=new Z.Mesh(d[e],b);f.castShadow=!0,c.push(f)}var g=new THREE.Object3D;if(c.length>=1){for(var h=0;h<c.length;h++)g.add(c[h]);if(this._graphic.symbol.wire)for(var i=this._buildWire(c),j=0;j<i.length;j++)i[j]._disableMouseEvent=!0,g.add(i[j])}return g},updateGeometry:function(a,b){this.updateSymbol(this._graphic.symbol)},_buildOneGeometry:function(a,b){var c,d=a?a.paths:null,e=!!a&&a.lngStart,f=a.baseHeight,g=a.height-a.baseHeight;if(d){c=Z.GeometryUtil.convertPathToShapes(d,this._latLngPointToScene,b,this,0,0,e)}for(var h=[],i=this._layer.getSceneHeight(f),j=this._layer.getSceneHeight(g),k={depth:j,bevelEnabled:!1,material:0,extrudeMaterial:1},l=c.length,m=0;m<l;m++){for(var n=new THREE.ExtrudeGeometry(c[m],k),f=c[m].length>0?c[m][0].z:0,o=n.vertices,p=n.vertices.length,q=0;q<p;q++)o[q].z+=i;h.push(n)}return this._mergeGeometrys(h)},_mergeGeometrys:function(a){if(a.length<=0)return null;if(1===a.length)return a[0];for(var b=a[0],c=1;c<a.length;c++)b.merge(a[c]);return b},_appendTexture:function(a,b){if(!("string"!=typeof b||b.length<=0)){var c=this,d=THREE.ImageUtils.loadTexture(b,{},function(a){c._scene.refresh()},function(){c._scene.refresh()}),e=a.clone();return e.map=d,e}},_enableZIndex:function(a){},_getTitlePos:function(){var a=Z.GraphicRender3D.prototype._getTitlePos.apply(this,arguments);return a.alt=this._layer.getSceneHeight(this._graphic.feature.shape.height)+1e-5,a},_buildWire:function(a){for(var b=[],c=0;c<a.length;c++)a[c]instanceof THREE.Mesh&&b.push(new THREE.Line(a[c].geometry.clone(),this._getWireMaterial()));return b},_getWireMaterial:function(){var a=this._graphic.symbol.wireSymbol,b={color:a.color,linewidth:a.width,transparent:!0};return a.style===Z.PolylineStyleType.Dash?new THREE.LineDashedMaterial(b):new THREE.LineBasicMaterial(b)}}),Z.ExtrudeTextRender3D=Z.GraphicRender3D.extend({initialize:function(a){Z.GraphicRender3D.prototype.initialize.apply(this,arguments),this._spriteContainer=null},buildGeometry:function(a,b){return a instanceof Z.LatLng?this._latLngPointToScene(new THREE.Vector3(a.lng,a.lat,a.alt)):null},buildMaterial:function(a){return a instanceof Z.TextSymbol?new THREE.MeshFaceMaterial([Z.StyleBuilder3D.createRenderStyle(new Z.SimpleFillSymbol({color:a.color})),Z.StyleBuilder3D.createRenderStyle(new Z.SimpleFillSymbol({color:a.color}))]):new THREE.MeshFaceMaterial([Z.StyleMaker3D.createRenderStyle("simplefillsymbol"),Z.StyleMaker3D.createRenderStyle("simplefillsymbol")])},buildGraphicObject:function(a,b){if(a&&b){var c=this._createExtrudeText(b),d=new Z.SpriteContainer(c);return d.onAdd(this._scene),d.setPosition(a.x,a.y,a.z),this._applyOffset(d,c.geometry),this._spriteContainer=d,d.getThreeObject()}},refresh:function(){Z.GraphicRender3D.prototype.refresh.apply(this,arguments),this._spriteContainer.refresh()},updateGeometry:function(a,b){var c=this.buildGeometry(a,b);this._spriteContainer.setPosition(c.x,c.y,c.z)},_createExtrudeText:function(a){var b=this._createTextGeometry();return new THREE.Mesh(b,a)},_createTextGeometry:function(){var a=this._graphic.symbol.text,b=this._graphic.symbol.font.size,c=new THREE.TextGeometry(a,{size:b,height:.01,curveSegments:3,font:this._graphic.symbol.font.family,weight:this._graphic.symbol.font.weight,style:this._graphic.symbol.font.style,bevelEnabled:!1,material:0,extrudeMaterial:1});return c.computeBoundingBox(),c.computeVertexNormals(),c},_applyOffset:function(a,b){var c=.5*(b.boundingBox.max.x-b.boundingBox.min.x);a.setOffset(new Z.Point(0,c,0))}}),Z.RingMarkerRender3D=Z.GraphicRender3D.extend({initialize:function(a){Z.GraphicRender3D.prototype.initialize.apply(this,arguments)},buildGeometry:function(a,b){return a=a.center,a instanceof Z.LatLng?this._latLngPointToScene(new THREE.Vector3(a.lng,a.lat,a.alt)):null},buildMaterial:function(a){var b=this;return a instanceof Z.RingSymbol?Z.StyleBuilder3D.createRenderStyle(a.fillSymbol,void 0,void 0,function(){b._scene.refresh()}):Z.StyleBuilder3D.createDefaultRenderStyle("simplefillsymbol",void 0,function(){b._scene.refresh()})},buildGraphicObject:function(a,b){if(a&&b){var c=this._createRingObject(b);return c.position.set(a.x,a.y,a.z),c}},updateGeometry:function(a,b){var c=this.buildGeometry(a,b);this._renderedObject.position.set(c.x,c.y,c.z);var d=this._createRingGeometry();this._renderedObject.geometry=d},_createRingObject:function(a){var b=this._createRingGeometry(),c=a||Z.StyleBuilder3D.createDefaultRenderStyle("simplefillsymbol");return new THREE.Mesh(b,c)},_createRingGeometry:function(){var a=this._graphic.feature.shape,b=this._graphic.symbol.segments,c=this._layer.getSceneHeight(a.innerRadius),d=this._layer.getSceneHeight(a.outerRadius);return new THREE.RingGeometry(c,d,b)}}),Z.CanvasTextRender3D=Z.GraphicRender3D.extend({initialize:function(a){Z.GraphicRender3D.prototype.initialize.apply(this,arguments),this._spriteContainer=null,this._markerSize=null,this._canvasTexture=null},buildGeometry:function(a,b){return a instanceof Z.LatLng?this._latLngPointToScene(new THREE.Vector3(a.lng,a.lat,a.alt)):null},buildMaterial:function(a){return Z.StyleBuilder3D.createDefaultRenderStyle("fillsymbol",{color:"#ffffff"})},buildGraphicObject:function(a,b){if(a&&b){var c=this._createCanvasText(b),d=new Z.SpriteContainer(c);return d.onAdd(this._scene),d.setPosition(a.x,a.y,a.z),this._applyOffset(d),this._spriteContainer=d,d.getThreeObject()}},refresh:function(){Z.GraphicRender3D.prototype.refresh.apply(this,arguments),this._spriteContainer.refresh()},updateGeometry:function(a,b){var c=this.buildGeometry(a,b);this._spriteContainer.setPosition(c.x,c.y,c.z)},onRemove:function(a){Z.GraphicRender3D.prototype.onRemove.apply(this,arguments),this._markerSize=null},_createCanvasText:function(a){this._createCanvas();var b=this._canvasTexture.getElement(),c=new THREE.Texture(b);c.minFilter=THREE.LinearFilter,c.needsUpdate=!0,a.map=c;var d=this._getGeometrySize(b),e=new THREE.PlaneBufferGeometry(d.x,d.y);return this._markerSize=d,new THREE.Mesh(e,a)},_createCanvas:function(){this._canvasTexture||(this._canvasTexture=new Z.TextCanvasTexture({padding:5,autoWidth:!0,autoHeight:!0,opacity:1})),this._canvasTexture.clear(),this._canvasTexture.draw(this._graphic.symbol.text,{textSymbol:this._graphic.symbol})},_getGeometrySize:function(a){var b=this._scene.getPixelSceneRatio(),c=a.width/b.x,d=a.height/b.y;return new Z.Point(c,d)},_applyOffset:function(a){var b=.5*this._markerSize.y;a.setOffset(new Z.Point(0,b,0))}}),Z.ModelRender3D=Z.GraphicRender3D.extend({buildGeometry:function(a,b){var c=a?a.modelParams:null,d=a.lngStart;if(c){var e=new THREE.BufferGeometry,f=null;if(a.transformation){f=new Array(c.vertices.length);for(var g=0;g<c.vertices.length;g+=3){var h=c.vertices[g],i=c.vertices[g+1],j=c.vertices[g+2];!1===d&&(j=c.vertices[g+1],i=c.vertices[g+2]);var k=a.transformation.transform(h,i,j),l=this._latLngPointToScene(new THREE.Vector3(k.x,k.y,0)),m=this._layer.getSceneHeight(k.z);f[g]=l.x,f[g+1]=l.y,f[g+2]=m}}else if(!1===d){f=new Array(c.vertices.length);for(var g=0;g<c.vertices.length;g+=3){var h=c.vertices[g],j=c.vertices[g+1],i=c.vertices[g+2];f[g]=h,f[g+1]=i,f[g+2]=j}}e.addAttribute("position",new THREE.BufferAttribute(new Float32Array(f||c.vertices),3)),c.faces&&(c.faces.length>65535?e.setIndex(new THREE.BufferAttribute(new Uint32Array(c.faces),1)):e.setIndex(new THREE.BufferAttribute(new Uint16Array(c.faces),1))),c.normals&&c.normals.length>0?e.addAttribute("normal",new THREE.BufferAttribute(new Float32Array(c.normals),3)):e.computeFaceNormals(),c.uvs&&c.uvs.length>0&&e.addAttribute("uv",new THREE.BufferAttribute(new Float32Array(c.uvs),2));var n=this._graphic.symbol.groups;if(n)for(var o=0;o<n.length;o++)e.addGroup(n[o].start,n[o].count,n[o].symbolIndex);e.verticesNeedUpdate=!0,e.computeBoundingSphere(),e.computeBoundingBox()}return e},buildMaterial:function(a){var b=null;if(a instanceof Z.GroupSymbol){for(var c=a.symbols,d=[],e=0;e<c.length;e++)d.push(this._getFillMaterial(c[e]));b=1===d.length?d[0]:d.length>1?new THREE.MultiMaterial(d):this._getFillMaterial(a)}else b=this._getFillMaterial(a);return b},buildGraphicObject:function(a,b){for(var c=[],d=a instanceof Array?a:[a],e=this._graphic.feature.shape.isLine,f=0;f<d.length;f++){var g=null;if(b instanceof Array){for(var h=[],i=0;i<b.length;i++)b[i]&&h.push(b[i]);if(h.length>1){g=new THREE.Group;for(var i=0,j=h.length;i<j;i++)g=this._createThreeObject(d[f],h[i],e)}else 1===h.length&&(g=this._createThreeObject(d[f],h[0],e))}else g=this._createThreeObject(d[f],b,e);c.push(g)}if(c.length<=0)return new THREE.Object3D;if(1===c.length)return c[0];for(var k=new THREE.Object3D,l=0;l<c.length;l++)k.add(c[l]);return k},_getFillMaterial:function(a){var b=a.name;if(Z.MaterialCache.getMaterial(b))return Z.MaterialCache.getMaterial(b);var c,d=this,a=a||{};return a instanceof Z.PictureFillSymbol?(c=Z.Style3DFlyweight.getStyle(a,"lambert",a.side,function(){d._scene.refresh()}),c.side=THREE.DoubleSide):c=a?Z.Style3DFlyweight.getStyle(a,"lambert",a.side):Z.StyleBuilder3D.createDefaultRenderStyle("fillsymbol"),Z.MaterialCache.putMaterial(b,c),c},_createThreeObject:function(a,b,c){return c?new THREE.Line(a,b):new THREE.Mesh(a,b)}}),Z.SphereRender3D=Z.GraphicRender3D.extend({buildGeometry:function(a,b){var c=null,d=a?a.center:null,e=a?a.radius:null;if(d)var f=this._layer.getSceneHeight(e||0),c=new THREE.SphereGeometry(f);return c},buildMaterial:function(a){return this._getFillMaterial(a)},buildGraphicObject:function(a,b){for(var c=[],d=a instanceof Array?a:[a],e=this._graphic.feature.shape.center,f=this._latLngPointToScene(new THREE.Vector3(e.lng,e.lat,0)),g=this._layer.getSceneHeight(e.alt||0),h=0;h<d.length;h++){var i=null;if(b instanceof Array){for(var j=[],k=0;k<b.length;k++)b[k]&&j.push(b[k]);j.length>1?i=new THREE.SceneUtils.createMultiMaterialObject(d[h],j):1===j.length&&(i=new THREE.Mesh(d[h],j[0]))}else i=new THREE.Mesh(d[h],b);i.position.set(f.x,f.y,g),c.push(i)}if(c.length<=0)return new THREE.Object3D;if(1===c.length)return c[0];for(var l=new THREE.Object3D,m=0;m<c.length;m++)l.add(c[m]);return l},updateGeometry:function(){this._updateGraphic()},_getFillMaterial:function(a){var b,a=a||{};return a instanceof Z.PictureFillSymbol?(b=Z.StyleBuilder3D.createRenderStyle(a,"lambert"),b.side=THREE.DoubleSide):b=a?Z.StyleBuilder3D.createRenderStyle(a,"lambert"):Z.StyleBuilder3D.createDefaultRenderStyle("fillsymbol"),b}}),Z.CircleExtrudeRender3D=Z.ExtrudeRender3D.extend({_buildOneGeometry:function(a,b){var c,d,e=this._latLngPointToScene(a.circle.center),f=this._layer.getSceneHeight(a.circle.radius);c=new THREE.Shape,c.absellipse(e.x,e.y,f,f,0,2*Math.PI),d=[c];for(var g=[],h=this._layer.getSceneHeight(this._graphic.feature.shape.height),i={amount:h,bevelEnabled:!1,material:0,extrudeMaterial:1},j=0;j<d.length;j++){var k=new THREE.ExtrudeGeometry(d[j],i);d[j].length>0&&d[j][0].z;g.push(k)}return this._mergeGeometrys(g)}}),Z.GraphicRender2D=Z.IGraphicRender.extend({initialize:function(a){this._graphic=a,this._renderedObject=null,this._added=!1},onAdd:function(a,b,c){this._container=b,this._baseIndex=a.getContainerPane().index,this._layerIndex=a.getZIndex(),this._renderedObject||(this._renderedObject=this.getRenderedObject(this._baseIndex,this._layerIndex)),this._renderedObject&&(b.addLayer(this._renderedObject),this._applyEvents("on")),this._added=!0},onRemove:function(a){this._renderedObject&&this._container&&this._container.removeLayer(this._renderedObject),this._applyEvents("off"),this._renderedObject=null,this._container=null,this._added=!1},getRenderedObject:function(a,b){var c=this.buildGraphicObject(a,b);return c.graphic=this._graphic.ownerGraphic,c},buildGraphicObject:function(){},updateGeometry:function(a){},updateSymbol:function(a){},dispose:function(){this._added&&this.onRemove()},refresh:function(){},_applyEvents:function(a){var b,c,d=this,a=a||"on",e=["dblclick","click","mousedown","mouseup","mouseover","mouseout","mousemove","contextmenu"];for(b=0,c=e.length;b<c;b++)this._renderedObject[a](e[b],d._onMouseEvent,d)},_onMouseEvent:function(a){this._renderedObject&&this._renderedObject.graphic&&this._renderedObject.graphic.fire&&this._renderedObject.graphic.fire(a.type,{latlng:Z.LeafletUtil.latLngFromLeaflet(a.latlng),scenePoint:Z.LeafletUtil.pointFromLeaflet(a.layerPoint),containerPoint:Z.LeafletUtil.pointFromLeaflet(a.containerPoint),originalEvent:a.originalEvent,object:this._renderedObject.graphic})}}),Z.PolylineRender2D=Z.GraphicRender2D.extend({initialize:function(a){Z.GraphicRender2D.prototype.initialize.apply(this,arguments)},buildGraphicObject:function(a,b){var c=this._getLeafletOptions(this._graphic.symbol),d=this._getLeafletGeometry(this._graphic.feature.shape);return d.length>1?L.multiPolyline(d,c):L.polyline(d,c)},updateGeometry:function(a){this._renderedObject&&this._renderedObject.setLatLngs(this._getLeafletGeometry(a))},updateSymbol:function(a){this._renderedObject&&this._renderedObject.setStyle(this._getLeafletOptions(a))},_getLeafletGeometry:function(a){var b,c,d,e=[];return a&&(b=a.paths,c=!(b instanceof Array&&b[0]instanceof Array),d=c||!(b[0][0]instanceof Array),d?c||(e=[b]):e=b),e},_getLeafletOptions:function(a){return{stroke:!0,color:a.color||"#03f",weight:a.width||5,opacity:a.opacity||.5,fill:!1,dashArray:a.style===Z.PolylineStyleType.Solid?null:"2,2",lineCap:null,lineJoin:null,clickable:!0}}}),Z.PolygonRender2D=Z.GraphicRender2D.extend({initialize:function(a){Z.GraphicRender2D.prototype.initialize.apply(this,arguments)},buildGraphicObject:function(a,b){for(var c=this._getLeafletOptions(this._graphic.symbol),d=this._getLeafletGeometry(this._graphic.feature.shape),e=[],f=0;f<d.length;f++)if(e[f]=[],!(d[f].paths.length<=0)){e[f].push(d[f].paths[0]);for(var g=0;g<d[f].holes.length;g++)e[f].push(d[f].holes[g])}return e.length>1?L.multiPolygon(e,c):L.polygon(e[0],c)},updateGeometry:function(a){this._renderedObject&&this._renderedObject.setLatLngs(this._getLeafletGeometry(a))},updateSymbol:function(a){this._renderedObject&&this._renderedObject.setStyle(this._getLeafletOptions(a))},_getLeafletGeometry:function(a){var b,c,d,e,f,g=[];if(a){b=a.rings,c=!(b instanceof Array&&b[0]instanceof Array),d=c||!(b[0][0]instanceof Array),e=d||!(b[0][0][0]instanceof Array),f=[],e?d?c||(f=[[b]]):f=[b]:f=b;for(var h=0;h<f.length;h++){for(var i={paths:[],holes:[]},j=0;j<f[h].length;j++)Z.GeometryUtil.isClockWise(f[h][j])?i.holes.push(f[h][j]):i.paths.push(f[h][j]);g.push(i)}}return g},_getLeafletOptions:function(a){return{stroke:!a.hidePolyline,color:a.polylineSymbol.color||"#0033ff",weight:a.polylineSymbol.width||5,opacity:a.polylineSymbol.opacity||.5,fill:!a.hideFill,fillColor:a.fillSymbol.color||"#002244",fillOpacity:a.fillSymbol.opacity||.5,dashArray:a.polylineSymbol.style===Z.PolylineStyleType.Solid?null:"2,2",lineCap:null,lineJoin:null,clickable:!0}}}),Z.PictureMarkerRender2D=Z.GraphicRender2D.extend({initialize:function(a){Z.GraphicRender2D.prototype.initialize.apply(this,arguments)},buildGraphicObject:function(a,b){var c=this._getLeafletOptions(this._graphic.symbol),d=this._getLeafletGeometry(this._graphic.feature.shape);return L.marker(d,c)},updateGeometry:function(a){this._renderedObject&&this._renderedObject.setLatLng(this._getLeafletGeometry(a))},updateSymbol:function(a){if(this._renderedObject){a.opacity!==this._renderedObject.options.opacity&&this._renderedObject.setOpacity(a.opacity);var b=this._getIconOptions(a);this._renderedObject.setIcon(L.icon(b))}},_getLeafletGeometry:function(a){var b;return a instanceof Z.LatLng?b=L.latLng(a.lat,a.lng,a.alt):a instanceof Array&&(a.length>=3?b=L.latLng([a[1],a[0],a[2]]):a.length>=2&&(b=L.latLng([a[1],a[0]]))),b},_getLeafletOptions:function(a){var b=this._getIconOptions(a);return{opacity:a.opacity||1,icon:L.icon(b),clickable:!0,keyboard:!1}},_getIconOptions:function(a){var b={iconUrl:a.url};return"number"==typeof a.width&&"number"==typeof a.height&&(b.iconSize=L.point(a.width,a.height)),a.offset&&b.iconSize&&(b.iconAnchor=L.point(b.iconSize.x/2-a.offset.x,a.offset.y+b.iconSize.y/2)),b}}),Z.CircleMarkerRender2D=Z.GraphicRender2D.extend({initialize:function(a){Z.GraphicRender2D.prototype.initialize.apply(this,arguments)},buildGraphicObject:function(a,b){var c=this._getLeafletOptions(this._graphic.symbol),d=this._getRadius(this._graphic.feature.shape),e=this._getLeafletGeometry(this._graphic.feature.shape);return"meter"===this._graphic.feature.shape.radiusType?L.circle(e,d,c):(c.radius=d,L.circleMarker(e,c))},updateGeometry:function(a){this._renderedObject&&this._renderedObject.setLatLng(this._getLeafletGeometry(a))},_getLeafletGeometry:function(a){var b,c=a.center;return c instanceof Z.LatLng?b=L.latLng(c.lat,c.lng,c.alt):c instanceof Array&&(c.length>=3?b=L.latLng([c[1],c[0],c[2]]):c.length>=2&&(b=L.latLng([c[1],c[0]]))),b},_getRadius:function(a){return a.radius||100},_getLeafletOptions:function(a){return{stroke:!a.hidePolyline,color:a.borderSymbol.color||"#0033ff",weight:a.borderSymbol.width||5,opacity:a.borderSymbol.opacity||.5,fill:!a.hideFill,fillColor:a.fillSymbol.color||"#002244",fillOpacity:a.fillSymbol.opacity||.5,dashArray:a.borderSymbol.style===Z.PolylineStyleType.Solid?null:"2,2",lineCap:null,lineJoin:null,clickable:!0}}}),Z.TextMarkerRender2D=Z.GraphicRender2D.extend({initialize:function(a){Z.GraphicRender2D.prototype.initialize.apply(this,arguments)},buildGraphicObject:function(a,b){var c=this._getLeafletOptions(this._graphic.symbol),d=this._getLeafletGeometry(this._graphic.feature.shape),e=L.marker(d,c);return e.on("add",function(){var a,b=e.options.icon;a=b.getSize(),b.setAnchor(L.point(a.x/2,a.y))}),e},updateGeometry:function(a){this._renderedObject&&this._renderedObject.setLatLng(this._getLeafletGeometry(a))},updateSymbol:function(a){if(this._renderedObject){a.opacity!==this._renderedObject.options.opacity&&this._renderedObject.setOpacity(a.opacity);var b=this._getIconOptions(a);this._renderedObject.setIcon(L.icon(b))}},_getLeafletGeometry:function(a){var b;return a instanceof Z.LatLng?b=L.latLng(a.lat,a.lng,a.alt):a instanceof Array&&(a.length>=3?b=L.latLng([a[1],a[0],a[2]]):a.length>=2&&(b=L.latLng([a[1],a[0]]))),b},_getLeafletOptions:function(a){var b=this._getIconOptions(a);return{opacity:a.opacity||1,icon:new L.TextIcon(b),clickable:!0,keyboard:!1}},_getIconOptions:function(a){var b={font:{family:a.font.family,size:a.font.size,style:a.font.style,weight:a.font.weight},color:a.color,fill:a.fill,fillSymbol:{opacity:a.fillSymbol.opacity,bgColor:a.fillSymbol.bgColor},border:a.border,borderSymbol:{opacity:a.borderSymbol.opacity,color:a.borderSymbol.color,width:a.borderSymbol.width,style:this._getCssStyle(a.borderSymbol.style)},iconOpacity:a.opacity};return"number"==typeof a.width&&"number"==typeof a.height&&(b.iconSize=L.point(a.width,a.height)),a.offset&&b.iconSize&&(b.iconAnchor=L.point(b.iconSize.x/2-a.offset.x,a.offset.y+b.iconSize.y/2)),b.text=a.text,b},_getCssStyle:function(a){return a===Z.PolylineStyleType.Dash?"dashed":"solid"}}),Z.GraphicRenderTerrain=Z.IGraphicRender.extend({initialize:function(a){},onAdd:function(a,b,c){},onRemove:function(a){},refresh:function(){}}),Z.AbstractBuilding=Z.ComposeGraphic1.extend({initialize:function(a,b,c){if(a=a||{},!(a.shape instanceof Z.Extrude))throw error("几何类型应为Z.Extrude");Z.ComposeGraphic1.prototype.initialize.apply(this,arguments),this._parts={},this._basePlane=null,this._curPartIds=[],this._partsLoaded=!1,this.partsLoader=null,this.id="",this.name="",this.desc=""},loadParts:function(){if(!this._partsLoaded&&this.partsLoader){var a=this;this.partsLoader.load(function(b){for(var c=a._buildParts(a,b,a.options.partsOptions),d=0;d<c.length;d++)a.addMember(c[d]),a._parts[c[d]._id]=c[d];a._partsLoaded=!0})}},getAllParts:function(){var a=[];for(var b in this._parts)a.push(this._parts[b]);return a},getParts:function(a){a instanceof Array||(a=[a]);for(var b=[],c=0;c<a.length;c++){var d=this._parts[a[c]];d&&b.push(d)}return b},getCurParts:function(){return this.getParts(this._curPartIds)},getCurPartIds:function(){for(var a=[],b=0;b<this._curPartIds.length;b++)a.push(this._curPartIds[b]);return a},showParts:function(a,b){if(a){a instanceof Array||(a=[a]),this.loadParts(),this._curPartIds=[];for(var c=0;c<a.length;c++)this._curPartIds.push(a[c]);this._showParts(this._curPartIds,b)}},showAllParts:function(a){this.loadParts(),this._curPartIds=[];for(var b in this._parts)this._curPartIds.push(b);this._showParts(this._curPartIds,a)},showSelf:function(){this.disableMembers(),this.enableSelf(),this._curPartIds=[]},showStructure:function(){this._showBasePlane()},hideStructure:function(){this._hideBasePlane()},onAdd:function(a,b,c){Z.ComposeGraphic1.prototype.onAdd.apply(this,arguments)},updateFeature:function(a){Z.ComposeGraphic1.prototype.updateFeature.apply(this,arguments)},updateSymbol:function(a){Z.ComposeGraphic1.prototype.updateSymbol.apply(this,arguments)},_showParts:function(a,b){this.disableSelf(),this.enableMembers();var c=this.getParts(a)||[];for(var d in this._parts)this._parts[d].hide();for(var e=0;e<c.length;e++)this._showOnePart(c[e],b)},_showOnePart:function(a,b){b=b||{},b.showInner?a.showAllParts():a.showSelf()},_buildParts:function(a,b,c){throw error("_buildParts(loader)是抽象方法，请在子类中覆盖")},_createBasePlane:function(){var a=new Z.Polygon(this.feature.shape.paths),b=new Z.Feature({},a),c=new Z.ComposeGraphic1(b,new Z.PolygonSymbol);return c.eventCapturable=!0,c.eventFirable=!1,c},_showBasePlane:function(){this._basePlane||(this._basePlane=this._createBasePlane(),this.addMember(this._basePlane)),this._basePlane.show()},_hideBasePlane:function(){this._basePlane&&this._basePlane.hide()}}),Z.AbstractBuildingLoader=Z.Class.extend({initialize:function(){},load:function(a,b){throw error("load为抽象方法，请在子类中覆盖")}}),Z.BuildingBuilder=function(){return{buildBuilding:function(a,b){return this._buildGraphics(null,a,b,function(a,b,c){return new Z.Building(a,b,c)})},buildFloor:function(a,b,c){c.floorIndex&&(c.id=c.floorIndex);var d=this._buildGraphics(a,b,c,function(a,b,c){return new Z.Floor(a,b,c)});d.sort(function(a,b){return parseInt(a._id)-parseInt(b._id)});for(var e=0,f=void 0,g=0;g<d.length;g++){if(!(parseInt(d[g].feature.props[c.id])<0)){void 0===f&&(f=g);var h=parseFloat(this._getHeight(d[g].feature.props,c.height));d[g].baseHeight=e,e+=h}}e=0;for(var g=f-1;g>=0;g--)h=parseFloat(this._getHeight(d[g].feature.props,c.height)),e-=h,d[g].baseHeight=e;return d},buildCell:function(a,b,c){return this._buildGraphics(a,b,c,function(a,b,c){return new Z.Cell(a,b,c)})},_buildGraphics:function(a,b,c,d){if(!b||!c||!d)return null;b=b instanceof Array?b:[b];for(var e=[],f=0;f<b.length;f++){var g=this._getProps(b[f],c),h=this._buildOneGraphic(a,g,c,d);h&&(h.partsLoader=this._buildingLoader(b[f],c),e.push(h))}return e},_getProps:function(a,b){return b.props?this._getOptionsValue(a,b.props):a},_buildOneGraphic:function(a,b,c,d){if(!b||!c||!d)return null;var e=this._getShape(b,c.shape),f=this._getHeight(b,c.height),g=this._getHeight(b,c.baseHeight),h=this._getGraphicOptions(b,c);if(!e&&a&&(e=a.feature.shape.paths),!e)return null;var i,j=new Z.Extrude(null,e,f,g,h),k=new Z.Feature(b,j,h),l=this._getSymbol(b,c);if((i=d(k,l,h))&&!(i instanceof Z.AbstractBuilding))throw error("_getGraphicObjet(feature, symbol, graphicOptions)方法的返回结果应继承自Z.AbstractBuilding类");return i._id=this._getOptionsValue(b,c.id)||(new Date).getMilliseconds()+""+1e6*Math.random(),i.id=i._id,i.name=h.titleText||i.id||i.name,i.desc=this._getOptionsValue(b,c.desc)||i.desc,i},_getShape:function(a,b){var c=this._getOptionsValue(a,b),d=Z.WktParser.wkt2Array(c),e=[];return d?("MultiPolygon"===d.type?e=d.coords:"Polygon"===d.type&&(e=[d.coords]),e):null},_getHeight:function(a,b){var c=0;return b=b||"",c=this._getOptionsValue(a,b),"number"==typeof c?c:"string"==typeof c?parseFloat(c):0},_getGraphicOptions:function(a,b){var c={};if(a&&b){var d=this._getOptionsValue(a,b.title),e=this._getOptionsValue(a,b.desc),f=this._getOptionsValue(a,b.titleSymbol),g=this._getOptionsValue(a,b.iconSymbol);c={title:d?d+"":"",tip:e?e+"":"",titleSymbol:f,iconSymbol:g},c.enableTitle=!!d,b.iconSymbol&&(c.iconSymbol=b.iconSymbol,c.enableIcon=!0)}var h=Z.Util.applyOptions({},b,!0);return Z.Util.applyOptions(h,c,!0)},_getOptionsValue:function(a,b){return Z.Util.getConfigValue(a,b)},_getSymbol:function(a,b){var c=b.symbol||new Z.ExtrudeSymbol;return c.topColor=this._getOptionsValue(a,b.topColor)||c.topColor,c.wallColor=this._getOptionsValue(a,b.wallColor)||c.wallColor,c.opacity=this._getOptionsValue(a,b.opacity)||c.opacity,c.wire=this._getOptionsValue(a,b.wire)||!1,c},_buildingLoader:function(a,b){var a=a||{},b=b||{};return b.partsLoader?b.partsLoader:new Z.JsonBuildingLoader(this._getOptionsValue(a,b.partsData))}}}(),Z.FloorModel={Surface:"Surface",Cells:"Cells"},Z.JsonBuildingLoader=Z.AbstractBuildingLoader.extend({initialize:function(a,b){this.json=a||"",this.root=b},load:function(callback,recursive){if(callback instanceof Function){var data=this.json;"string"==typeof data&&data.length>0&&(data=JSON?JSON.parse(data):eval("("+data+")")),this.root&&data[this.root]&&(data=data[this.root]),data instanceof Array||(data=[data]),callback(data)}}}),Z.NSDModelBuilder=function(){return{colorSetting:{Arch_Element_Floor:4605255,Arch_Element_Wall:15919834,Arch_Element_RectStair:10326151,Arch_Element_HandRail:10067356,Arch_Element_LineStair:4281685,Arch_Element_Slab:4281685,Arch_Element_Column:13748151,Arch_Element_Opening:13878950,Arch_Space_RoomSpace:16770244},opacitySetting:{Arch_Element_Opening:.6},types:{Arch_Element_Floor:"地板",Arch_Element_Wall:"墙",Arch_Element_RectStair:"双跑楼梯",Arch_Element_HandRail:"扶手",Arch_Element_LineStair:"直线梯段",Arch_Element_Slab:"平台",Arch_Element_Column:"柱",Arch_Element_Opening:"开启物",Arch_Space_RoomSpace:"房间"},symbolSetting:{select:{color:16711680,opacity:1},mouseover:{color:16776960,opacity:1}},titleProp:"图元名",parse:function(a,b){if(!a)return null;var c=a;"string"==typeof a&&(c=this.text2dom(a));var d=c.documentElement,e=this.parseNode(d);e.entities={},e.relations=[];for(var f=c.getElementsByTagName("ArchEntity"),g=0;g<f.length;g++){var h=this.parseEntity(f[g],b);e.entities[h.ID]=h}for(var i=c.getElementsByTagName("ArchRelation"),g=0;g<i.length;g++)e.relations.push(this.parseRelation(i[g]));return e},text2dom:function(a){var b=null;if(document.all)b=new ActiveXObject("Microsoft.XMLDOM"),b.async="false",b.loadXML(a);else if(DOMParser){var c=new DOMParser;b=c.parseFromString(a,"text/xml")}return b},getAttributeValue:function(a,b){for(var c=0;c<a.attributes.length;c++){if(a.attributes[c].nodeName==b){return a.attributes[c].nodeValue}}return""},getNodeName:function(a){return a.nodeName},parseNode:function(a){if(!a)return null;var b=a.nodeType;if(2===b||3===b)return a.nodeValue;if(1===b){for(var c={},d=a.childNodes,e=a.attributes,f=0;f<e.length;f++)if(e[f]){var g=this.getNodeName(e[f]),h=e[f].nodeValue;this.createObjectProperty(c,g,h)}for(f=0;f<d.length;f++)d[f]&&1===d[f].nodeType&&(g=this.getNodeName(d[f]),h=d[f].textContent,"ArchEntitys"!=g&&"ArcRelations"!=g&&("Version"!=g&&"Data"!=g&&"DataSource"!=g&&"TopSpace"!=g||this.createObjectProperty(c,g,h)));return c}return null},createObjectProperty:function(a,b,c){b&&(a[b]=c)},parseEntity:function(a,b){if(!a)return null;var c,d=this.getAttributeValue(a,"ID"),e=this.getAttributeValue(a,"Type"),f={};if(a.childNodes.length>0)for(var g=0;g<a.childNodes.length;g++){var h=a.childNodes[g];if(1===h.nodeType){var i=this.getNodeName(h),j=h.childNodes;if("ArchGeometries"===i){for(var k=0;k<j.length;k++)if(1===j[k].nodeType){var l=this.getAttributeValue(j[k],"GeoType");"stl3D"===l&&(c=this.parseStl3DNode(j[k],e),c.feature.shape.transformation=b)}}else if("ArchProperties"===i)for(var k=0;k<j.length;k++)if(1===j[k].nodeType){var m=j[k].nodeName;if("ArchProperty"===m){var n=this.getAttributeValue(j[k],"Name"),o=j[k].textContent;"高度"===n||"楼层高度"===n?n="height":"向下联通"===n?n="crossdown":"楼层位置"===n&&(n="floorIndex"),f[n]=o}}}}return c&&(c.feature.props=f),{ID:d,Type:e,Properties:f,ArchGeometry2D:null,ArchGeometry3D:c}},parseStl3DNode:function(a,b){var c=a.textContent;if(c&&c.length>0){for(var d=c.split("\n"),e=!0,f=[],g=[],h=-1,i=0;i<d.length;i++){var j=d[i].toLowerCase().replace(/\s+/," ");if(j=j.replace(/(^\s*)|(\s*$)/g,""),0!==j.length)if(e&&d[i]&&d[i].indexOf("end_header")>=0)e=!1;else if(!(e||d[i].indexOf("---")>=0)){var k=j.split(" ");3===k.length?(-1===h?h=0:1===h&&(h=2),0===h&&f.splice(f.length,0,parseFloat(k[0]),parseFloat(k[1]),parseFloat(k[2]))):4===k.length&&(0===h&&(h=1),1===h&&g.splice(g.length,0,parseFloat(k[1]),parseFloat(k[2]),parseFloat(k[3])))}}var l=new Z.ModelGeometry(null,{vertices:f,faces:g}),m=this.getElementColor(b),n=this.getElementOpacity(b),o=new Z.SimpleFillSymbol({color:m,opacity:n}),p=new Z.SimpleFillSymbol(this.symbolSetting.select),q=new Z.SimpleFillSymbol(this.symbolSetting.mouseover);return new Z.Graphic(new Z.Feature({},l),o,{selectSymbol:p,mouseoverSymbol:q,title:"#{"+this.titleProp+"}"})}return null},getElementColor:function(a){return this.colorSetting[a]||11184640},getElementOpacity:function(a){return this.opacitySetting[a]||1},parseRelation:function(a){return{ID:this.getAttributeValue(a,"ID"),Type:this.getAttributeValue(a,"Type"),EntityFirst:this.getAttributeValue(a,"EntityFirst"),EntitySecond:this.getAttributeValue(a,"EntitySecond")}},buildObjectRelation:function(a,b){for(var c={},d={},e=0;e<b.length;e++){var f=b[e].EntityFirst,g=b[e].EntitySecond;"Arch_Relation_Aggregation"===b[e].Type&&(c[f]||(c[f]={entity:a[f],parent:null,children:[]}),c[g]||(c[g]={entity:a[g],parent:null,children:[]}),c[g].children.push(c[f]),d[f]&&delete d[f],d[g]||(d[g]=c[g]))}var h=[];for(var i in d)h.push(d[i]);return h},findFloors:function(a){var b={},c={};for(var d in a){var e=a[d];if("Arch_Space_FloorSpace"===e.Type){var f=e.Properties.floorIndex,g=e.Properties.StoreyIndex;b[f]={entity:e,elements:[]},c[g]=f}}for(d in a)e=a[d],"Arch_Space_FloorSpace"!==e.Type&&(g=e.Properties.StoreyIndex)&&(f=c[g])&&b[f]&&b[f].elements.push(e);return b}}}(),Z.PropertyBuildingLoader=Z.AbstractBuildingLoader.extend({initialize:function(a,b){this.data=a||{},this.prop=b},load:function(a){if(a instanceof Function){a(this.data[this.prop])}}}),Z.Building=Z.AbstractBuilding.extend({initialize:function(a,b,c){Z.AbstractBuilding.prototype.initialize.apply(this,arguments),this.options=Z.Util.applyOptions(this.options,{floorIndexProp:c.floorIndexProp||"index"},!0)},showSurface:function(a){this.showSelf(),this.hideStructure(),this.eventCapturable=!0,this.eventFirable=!0,this.fire("showBuildingSurface")},showFloor:function(a){this.showParts(a,{showInner:!0});for(var b=this.getFloors(a),c=0;c<b.length;c++)b[c].showAllCells();this.hideStructure(),this.eventCapturable=!1,this.fire("showFloors",{floorsIndex:a})},showAllFloors:function(a){this.showAllParts(),this.hideStructure(),this.eventCapturable=!1,this.fire("showAllFloors");for(var b=this.getAllFloors(),c=0;c<b.length;c++)a===Z.FloorModel.Cells?b[c].showAllCells():b[c].showSurface()},showCell:function(a,b){},getAllFloors:function(){return this.getAllParts()},getFloors:function(a){return this.getParts(a)},getCurFloors:function(){return this.getCurParts()},getCurFloorsIndex:function(){return this.getCurPartIds()},_buildParts:function(a,b,c){return Z.BuildingBuilder.buildFloor(a,b,c)}}),Z.Floor=Z.AbstractBuilding.extend({initialize:function(a,b,c){Z.AbstractBuilding.prototype.initialize.apply(this,arguments)},showSurface:function(a){this.showSelf(),this.hideStructure(),this.eventCapturable=!0,this.eventFirable=!0,this.fire("showFloorSurface")},showCells:function(a,b){this.showParts(a,b);for(var c=this.getCells(a),d=0;d<c.length;d++)c[d].showSurface();this.showStructure(),this.eventCapturable=!1,this.fire("showCells",{cellId:a})},showAllCells:function(){this.showAllParts();for(var a=this.getAllCells(),b=0;b<a.length;b++)a[b].showSurface();this.showStructure(),this.eventCapturable=!1,this.fire("showFloorCells")},getAllCells:function(){return this.getAllParts()},getCells:function(a){return this.getParts(a)},_buildParts:function(a,b,c){return Z.BuildingBuilder.buildCell(a,b,c)}}),Z.Cell=Z.AbstractBuilding.extend({initialize:function(a,b,c){Z.AbstractBuilding.prototype.initialize.apply(this,arguments)},showSurface:function(a){this.showSelf(),this.hideStructure()},_buildParts:function(a,b,c){return Z.BuildingBuilder.buildCell(a,b,c)}}),Z.Building.load=function(){},Z.ZIndexManager=function(){},Z.ZIndexManager.enableZIndex=function(a){if(a)if(a instanceof Array)for(var b=0;b<a.length;b++)Z.ZIndexManager.enableZIndex(a[b]);else a.polygonOffset=!0},Z.ZIndexManager.setZIndex=function(a,b,c){if(a=a||{},a.children)if(a.children.length>0)for(var d=0;d<a.children.length;d++)Z.ZIndexManager.setZIndex(a.children[d],b,c);else Z.ZIndexManager._setBaseIndex(a,c),Z.ZIndexManager._setZIndex(a,b,c)},Z.ZIndexManager._setBaseIndex=function(a,b){a=a||{};var c=a.material;if(c){var d=1-b,e=1-b;c.polygonOffsetFactor=d,c.polygonOffsetUnits=e}},Z.ZIndexManager._setZIndex=function(a,b,c){a.renderOrder=c*Z.Globe.Layer.layerGroupSize+b},Z.TileLayer=Z.ILayer.extend({initialize:function(a,b){this.options={minZoom:1,maxZoom:20,zoomOffset:0,extent:Z.LatLngBounds.create(Z.LatLng.create(-90,-180),Z.LatLng.create(90,180)),zIndex:1,opacity:1,errorTileUrl:"",attribution:"",crs:"",params:{},pyramidId:"OSM",pyramidDefine:{type:"FixedMultiple",crsId:"EPSG3857",params:{}}},a=a||[],a instanceof Array||(a=[a+""]),this._urls=a,this._scene=null,this._render=null,this._containerPane=null,this._visible=!0,this._pyramidModel=null,b=b||{},this.options=Z.Util.applyOptions(this.options,b,!1,["tileInfo"]),this.options.tileInfo=Z.Util.applyOptions(this.options.tileInfo,b.tileInfo,!1)},onAdd:function(a,b,c,d){this.fire("loading");var e=this.getTileRender(a,this._urls,this.options);this._render&&this._render.onRemove(this._scene),this._render=e,this._scene=a,this._containerPane=c;var f=this._render.onAdd(this._scene,b,c,d);return this.fire("load"),f},getTileRender:function(a,b,c){var d;if(!this._pyramidModel){this._pyramidModel=this._initPyramidModel(c);var e=a.getCRS(),f=this._pyramidModel.crs||e;this._pyramidModel.projModel=new Z.ProjModel(e,f)}return c.pyramidModel=this._pyramidModel,a instanceof Z.Scene2D?d=this.getTileRender2D(b,c):a instanceof Z.Scene3D&&(d=this.getTileRender3D(b,c)),d},getTileRender2D:function(a,b){return new Z.TileRender2D(a,b)},getTileRender3D:function(a,b){return new Z.TileAggregatedRender3D(a,b)},onRemove:function(a){this._render&&(this._render.onRemove(this._scene),this._render=null)},show:function(){this._render.show()},hide:function(){this._render.hide()},setOpacity:function(a){this.options.opacity=a,this._render.setOpacity(a)},setZIndex:function(a){this.options.zIndex=a,this._render.setZIndex(a)},getContainerPane:function(){return this._containerPane},setZoomRange:function(a,b){this.options.minZoom="number"==typeof a?a:this.options.minZoom,this.options.maxZoom="number"==typeof b?b:this.options.maxZoom,this.refresh()},refresh:function(){this._render.refresh(this.options)},_initPyramidModel:function(a){var b={pyramidId:a.pyramidId,pyramidDefine:a.pyramidDefine};return Z.PyramidModelFactory.create(b)}}),Z.TemplateTileLayer=Z.TileLayer.extend({getTileRender2D:function(a,b){throw error("不支持的方法")},getTileRender3D:function(a,b){return new Z.TemplateTileRender3D(a,b)}}),Z.WMTSTileLayer=Z.TileLayer.extend({getTileRender2D:function(a,b){return new Z.WMTSTileRender2D(a,b)},getTileRender3D:function(a,b){return new Z.WMTSTileRender3D(a,b)}}),Z.AbstractTDTLayer=Z.WMTSTileLayer.extend({initialize:function(a,b){b=b||{};var c={layer:"",style:"default",format:"tiles",tilematrixSet:""};Z.Util.applyOptions(c,b,!0),b.params=c,b.pyramidId="TDT",Z.WMTSTileLayer.prototype.initialize.call(this,a,b)},getTileRender2D:function(a,b){throw Error("不支持的操作")},getTileRender3D:function(a,b){return new Z.TDTTileRender3D(a,b)}}),Z.TDTVectorLayer=Z.AbstractTDTLayer.extend({initialize:function(a){var b=[(Z.Globe.TDTProxy||"")+"/vec_c/wmts"],c={layer:"vec",style:"default",format:"tiles",tilematrixSet:"c"};a&&(c.token=a),Z.AbstractTDTLayer.prototype.initialize.call(this,b,c)}}),Z.TDTVectorAnnoLayer=Z.AbstractTDTLayer.extend({initialize:function(a){var b=[(Z.Globe.TDTProxy||"")+"/cva_c/wmts"],c={layer:"cva",style:"default",format:"tiles",tilematrixSet:"c"};a&&(c.token=a),Z.AbstractTDTLayer.prototype.initialize.call(this,b,c)}}),Z.TDTRasterLayer=Z.AbstractTDTLayer.extend({initialize:function(a){var b=[(Z.Globe.TDTProxy||"")+"/img_c/wmts"],c={layer:"img",style:"default",format:"tiles",tilematrixSet:"c"};a&&(c.token=a),Z.AbstractTDTLayer.prototype.initialize.call(this,b,c)}}),Z.TDTRasterAnnoLayer=Z.AbstractTDTLayer.extend({initialize:function(a){var b=[(Z.Globe.TDTProxy||"")+"/cia_c/wmts"],c={layer:"cia",style:"default",format:"tiles",tilematrixSet:"c"};a&&(c.token=a),Z.AbstractTDTLayer.prototype.initialize.call(this,b,c)}}),Z.BDTileLayer=Z.TileLayer.extend({initialize:function(a,b){a=["http://localhost:8080/onlinelabel/"],b=b||{},b.pyramidId="BD",Z.TileLayer.prototype.initialize.call(this,a,b)},getTileRender2D:function(a,b){throw Error("不支持的操作")},getTileRender3D:function(a,b){return new Z.BDTileRender3D(a,b)}}),Z.OSMTileLayer=Z.TileLayer.extend({initialize:function(a,b){a=["https://tile.openstreetmap.org"],b=b||{},b.pyramidId="OSM",Z.TileLayer.prototype.initialize.call(this,a,b)},getTileRender2D:function(a,b){throw Error("不支持的操作")},getTileRender3D:function(a,b){return new Z.OSMTileRender3D(a,b)}}),Z.TileRender2D=Z.ITileRender.extend({initialize:function(a,b){this._leafletLayer=this.getTileLayer(a,b),this._scene=null},getTileLayer:function(a,b){var c=this._getLeafletOptions(b);return new L.TileLayer(a[0],c)},onAdd:function(a,b,c,d){this._scene=a,a._leafletMap.addLayer(this._leafletLayer)},onRemove:function(a){this._scene=void 0,a._leafletMap.removeLayer(this._leafletLayer)},show:function(){this._leafletLayer.getContainer().style.display="block"},hide:function(){this._leafletLayer.getContainer().style.display="none"},setOpacity:function(a){this._leafletLayer.setOpacity(a)},setZIndex:function(a){this._leafletLayer.setZIndex(a)},refresh:function(a){var b=this._getLeafletOptions(a);for(var c in b)void 0!==b[c]&&(this._leafletLayer[c]=b[c])},_getLeafletOptions:function(a){return{minZoom:void 0!==a.minZoom?a.minZoom:1,maxZoom:void 0!==a.maxZoom?a.maxZoom:20,zoomOffset:void 0!==a.zoomOffset?a.zoomOffset:void 0,tileSize:void 0!==a.tileSize?a.tileSize:void 0,opacity:void 0!==a.opacity?a.opacity:void 0,zIndex:void 0!==a.zIndex?a.zIndex:void 0,bounds:void 0!==a.extent?Z.LeafletUtil.latLngBoundsToLeaflet(a.extent):void 0,errorTileUrl:void 0!==a.errorTileUrl?a.errorTileUrl:void 0,attribution:void 0!==a.attribution?a.attribution:void 0}}}),Z.WMTSTileRender2D=Z.TileRender2D.extend({initialize:function(a,b){Z.TileRender2D.prototype.initialize.apply(this,arguments)},getTileLayer:function(a,b){var c=this._getLeafletOptions(b);return new L.TileLayer.WMTS(a,c)},_getLeafletOptions:function(a){return{minZoom:void 0!==a.minZoom?a.minZoom:1,maxZoom:void 0!==a.maxZoom?a.maxZoom:20,zoomOffset:void 0!==a.zoomOffset?a.zoomOffset:void 0,tileSize:void 0!==a.tileSize?a.tileSize:void 0,opacity:void 0!==a.opacity?a.opacity:void 0,zIndex:void 0!==a.zIndex?a.zIndex:void 0,bounds:void 0!==a.extent?Z.LeafletUtil.latLngBoundsToLeaflet(a.extent):void 0,errorTileUrl:void 0!==a.errorTileUrl?a.errorTileUrl:void 0,attribution:void 0!==a.attribution?a.attribution:void 0,layer:void 0!==a.params.layer?a.params.layer:"0",style:void 0!==a.params.style?a.params.style:"default",tilematrixSet:void 0!==a.params.tilematrixSet?a.params.tilematrixSet:"",format:void 0!==a.tileInfo.format?a.tileInfo.format:"image/jpeg"}}}),Z.TDTVectorTileRender2D=Z.TileRender2D.extend({initialize:function(a,b){Z.TileRender2D.prototype.initialize.apply(this,arguments)},getTileLayer:function(a,b){return new L.TileLayer.TDT.Vector}}),Z.TDTVectorAnnoTileRender2D=Z.TileRender2D.extend({initialize:function(a,b){Z.TileRender2D.prototype.initialize.apply(this,arguments)},getTileLayer:function(a,b){return new L.TileLayer.TDT.VectorAnno}}),Z.TDTRasterTileRender2D=Z.TileRender2D.extend({initialize:function(a,b){Z.TileRender2D.prototype.initialize.apply(this,arguments)},getTileLayer:function(a,b){return new L.TileLayer.TDT.Raster}}),Z.TDTRasterAnnoTileRender2D=Z.TileRender2D.extend({initialize:function(a,b){Z.TileRender2D.prototype.initialize.apply(this,arguments)},getTileLayer:function(a,b){return new L.TileLayer.TDT.RasterAnno}}),Z.TileAggregatedRender3D=Z.ITileRender.extend({initialize:function(a,b){this._scene=null,this._tiles={},this._options={},this._renderTileSize=null,this._containerPane=null,this._tileImages=[],this._dragStartPoint=null,this._zIndex=0,this._urls=a instanceof Array?a:"string"==typeof a?[a]:[],this._options=Z.Util.applyOptions(this._options,b,!0),this._tileRoot=new Z.SceneThreePaneItem,this._pyramidModel=this._options.pyramidModel,this._renderId=Z.Util.stamp(this,"layerRender"),this._scaleTolerance=1e-6},getTileUrl:function(a,b,c){return this._urls[(b+c)%this._urls.length]+"/"+a+"/"+b+"/"+c},onAdd:function(a,b,c,d){if(a instanceof Z.Scene3D&&c instanceof Z.SceneThreePaneItem){var e=b;return"number"!=typeof e&&(e=c.getMaxChildIndex()+1),this._scene=a,this._tileRoot.index=e,c.addChild(this._tileRoot,e),this._containerPane=c,Z.SingleTerrainPlane.getInstance().addSurfaceLayer(this._renderId,"image"),this._addEvents(),this._reset(),this._update(),this.setZIndex(e),this._scene.refresh(),e}},onRemove:function(a){this._reset(),this._removeEvents(),this._containerPane&&(this._containerPane.removeChild(this._tileRoot),this._containerPane=null),Z.SingleTerrainPlane.getInstance().removeSurfaceLayer(this._renderId),this._scene.refresh(),this._scene=void 0},show:function(){Z.SingleTerrainPlane.getInstance().addSurfaceLayer(this._renderId,"image")},hide:function(){Z.SingleTerrainPlane.getInstance().removeSurfaceLayer(this._renderId)},setOpacity:function(a){},setZIndex:function(a){"number"==typeof a&&this._containerPane&&(this._zIndex=a,Z.SingleTerrainPlane.getInstance().updateLayerIndex(this._renderId,a))},refresh:function(a){},_addEvents:function(){var a=this;this._scene.on("viewreset",a._onViewReset,a),this._scene.on("zoomlevelschange",a._onZoomChange,a)},_removeEvents:function(){var a=this;this._scene.off("viewreset",a._onViewReset,a),this._scene.off("zoomlevelschange",a._onZoomChange,a)},_onViewReset:function(a){this._update(),this.setZIndex(this._zIndex),this._scene.refresh()},_onZoomChange:function(a){this._reset(),this._update(),this.setZIndex(this._zIndex),this._scene.refresh()},_disposeTiles:function(){for(var a in this._tiles)this._removeTile(a);this._tiles={}},_reset:function(a){for(var b in this._tiles)this.fire("tileunload",{tile:this._tiles[b]});this._disposeTiles(),this._renderTileSize=null,this._containerPane.removeChild(this._tileRoot),this._tileRoot.resetRoot(),this._containerPane.addChild(this._tileRoot)},_update:function(){if(this._scene&&this._pyramidModel){var a=this._scene.getContentBounds(),b=this._scene.getBounds(),c=this._scene.getSize(),d=this._pyramidModel.fitZoomLevel(b,c.x,c.y),e=null;d.outOfScaleBounds||(e=this._pyramidModel.getTileBounds(a,d.level)),this._updateTiles(e,d.level)}},_updateTiles:function(a,b){this._updateTilesPos(a,b),this._addNewTiles(a,b),this._removeInvisibleTiles(a)},_updateTilesPos:function(a,b){this._tileImages=[];for(var c in this._tiles){var d=this._tiles[c],e=c.split(":"),f=parseInt(e[0],10),g=parseInt(e[1],10);a&&f>=a.min.x&&f<=a.max.x&&g>=a.min.y&&g<=a.max.y&&d._loaded?this._tileImages.push({image:d,point:new Z.Point(f,g)}):this._removeTile(c)}this._drawTileTexture(a,b)},_drawTileTexture:function(a,b){var c=this._getTextureOptions(a,b);Z.SingleTerrainPlane.getInstance().updateLayerContent(this._renderId,this._tileImages,c)},_getTextureOptions:function(a,b){var c=this._pyramidModel.getTileSize();return a?{width:c.x,height:c.y,zoom:b,tileZoom:void 0===a.min.z?b:a.min.z,tileBounds:a,pyramidModel:this._pyramidModel}:null},_addNewTiles:function(a,b){if(a){var c,d,e,f=[],g=void 0===a.min.z?b:a.min.z;for(c=a.min.y;c<=a.max.y;c++)for(d=a.min.x;d<=a.max.x;d++)e=new Z.Point(d,c,g),this._tileShouldBeLoaded(e)&&f.push(e);var h=f.length;if(0!==h){for(f.sort(function(a,b){return b.y-a.y}),d=0;d<h;d++)this._addTile(f[d],a);var i=new Z.Point((a.min.x+a.max.x)/2,a.max.y);Z.TileManager.resort(i)}}},_tileShouldBeLoaded:function(a){if(a.x+":"+a.y in this._tiles)return!1;var b=this._pyramidModel.getTileBounds(this._scene.options.maxBounds,this._scene.getZoom());return!(a.x<b.min.x||a.x>b.max.x||a.y<b.min.y||a.y>b.max.y)},_getRenderTileSize:function(a){var b=this._pyramidModel.getLatLngBounds(a,a.z),c=this._scene._latLngToGLPoint(b.getSouthWest()),d=this._scene._latLngToGLPoint(b.getNorthEast());return new Z.Point(Math.abs(c.x-d.x),Math.abs(c.y-d.y))},_addTile:function(a,b){var c=this._getTile();this._tiles[a.x+":"+a.y]=c,c._tilePoint=a,this._loadTile(c,a,b)},_loadTile:function(a,b,c){var d=this,e=(b.z,function(c){a._loaded=!0,d._tileImages.push({image:a,point:b}),d._drawTileTexture()}),f=function(a){},g=this._options.zoomOffset?b.z+this._options.zoomOffset:b.z,h=this.getTileUrl(g,b.y,b.x);a._src=h,Z.TileManager.pushImageObject(a,e,f,d)},_getTile:function(){var a=new Image,b=this._pyramidModel.getTileSize();return a.width=b.x,a.height=b.y,a},_removeInvisibleTiles:function(a){var b,c,d,e;for(e in this._tiles)b=e.split(":"),c=parseInt(b[0],10),d=parseInt(b[1],10),(c<a.min.x||c>a.max.x||d<a.min.y||d>a.max.y)&&this._removeTile(e)},_removeTile:function(a){var b=this._tiles[a];b&&(this.fire("tileunload",{tile:b,url:b._tileUrl}),Z.TileManager.cancelImageLoad(b)),delete this._tiles[a]}}),Z.TileRender3D=Z.ITileRender.extend({initialize:function(a,b){this._scene=null,this._tiles={},this._options={},this._renderTileSize=null,this._containerPane=null,this._tileMaterial=null,this._pyramidModel=null,this._dragStartPoint=null,this._zIndex=0;var c=typeof a;this._urls="array"===c?a:"string"===c?[a]:[],this._options=Z.Util.applyOptions(this._options,b,!0),this._tileRoot=new Z.SceneThreePaneItem,this._initPyramidModel(this._options),this._initTileMaterial()},getTileUrl:function(a,b,c){return this._urls[(b+c)%this._urls.length]+"/"+a+"/"+b+"/"+c},onAdd:function(a,b,c){if(a instanceof Z.Scene3D&&c instanceof Z.SceneThreePaneItem){var d=b;return"number"!=typeof d&&(d=c.getMaxChildIndex()+1),this._scene=a,this._tileRoot.index=d,c.addChild(this._tileRoot,d),this._containerPane=c,this._addEvents(),this._reset(),this._update(),this.setZIndex(d),this._scene.refresh(),d}},onRemove:function(a){this._reset(),this._removeEvents(),this._containerPane&&(this._containerPane.removeChild(this._tileRoot),this._containerPane=null),this._scene.refresh(),this._scene=void 0},show:function(){this._tileRoot.show()},hide:function(){this._tileRoot.hide()},setOpacity:function(a){if("number"==typeof a){a=Math.min(1,Math.max(a,0)),this._tileMaterial.opacity=a;for(var b in this._tiles)this._tiles[b].material.opacity=a}},setZIndex:function(a){"number"==typeof a&&this._containerPane&&(this._zIndex=a,this._containerPane.setChildIndex(this._tileRoot,a),this._setTileZIndex(a,this._containerPane.index))},_setTileZIndex:function(a,b){for(var c in this._tiles)Z.ZIndexManager.setZIndex(this._tiles[c],a,b)},refresh:function(a){},_initPyramidModel:function(a){var b={origin:a.tileInfo.origin,tileSize:Z.Point.create(a.tileInfo.tileWidth,a.tileInfo.tileHeight),levelDefine:a.tileInfo.levelDefine};this._pyramidModel=new Z.PyramidModel(b)},_initTileMaterial:function(){var a=new THREE.MeshBasicMaterial({transparent:!0,opacity:1,fog:!0});Z.ZIndexManager.enableZIndex(a),this._tileMaterial=a},_addEvents:function(){var a=this;this._scene.on("viewreset",a._onViewReset,a),this._scene.on("zoomlevelschange",a._onZoomChange,a),this._scene.on("dragstart",a._onDragStart,a),this._scene.on("drag",this._onDrag,a),this._scene.on("dragend",a._onDragEnd,a)},_removeEvents:function(){var a=this;this._scene.off("viewreset",a._onViewReset,a),this._scene.off("zoomlevelschange",a._onZoomChange,a),this._scene.off("dragstart",a._onDragStart,a),this._scene.off("drag",this._onDrag,a),this._scene.off("dragend",a._onDragEnd,a)},_onViewReset:function(a){this._update(),this.setZIndex(this._zIndex),this._scene.refresh()},_onZoomChange:function(a){this._reset(),this._update(),this.setZIndex(this._zIndex),this._scene.refresh()},_onDragStart:function(a){this._dragStartPoint=this._tileRoot.root.position.clone()},_onDrag:function(a){this._scene.refresh()},_onDragEnd:function(a){var b=this._scene;b.screenPointToScenePoint(a.startPoint),b.screenPointToScenePoint(a.newPoint);this._tileRoot.root.position.x=this._dragStartPoint.x,this._tileRoot.root.position.y=this._dragStartPoint.y,this._tileRoot.root.position.z=this._dragStartPoint.z,this._dragStartPoint=null},_disposeTiles:function(){for(var a in this._tiles)try{this._tiles[a].material&&(this._tiles[a].material.map&&this._tiles[a].material.map.dispose(),this._tiles[a].material.dispose())}catch(a){}this._tiles={}},_reset:function(a){for(var b in this._tiles)this.fire("tileunload",{tile:this._tiles[b]});this._disposeTiles(),this._renderTileSize=null,this._containerPane.removeChild(this._tileRoot),this._tileRoot.resetRoot(),this._containerPane.addChild(this._tileRoot),this._initTileMaterial()},_update:function(){if(this._scene&&this._pyramidModel){var a=this._scene.getContentBounds(),b=this._scene.getBounds(),c=this._scene.getSize(),d=(this._scene.getScale(),this._pyramidModel.fitZoomLevel(b,c.x,c.y)),e=this._pyramidModel.getTileBounds(a,d.level);this._updateTiles(e,d.level)}},_updateTiles:function(a,b){this._updateTilesPos();var c,d,e,f=[];for(c=a.min.y;c<=a.max.y;c++)for(d=a.min.x;d<=a.max.x;d++)e=new Z.Point(d,c,b),this._tileShouldBeLoaded(e)&&f.push(e);var g=f.length;if(0!==g){f.sort(function(a,b){return b.y-a.y}),this._renderTileSize||(this._renderTileSize=this._getRenderTileSize(f[0]));var h=this._tileRoot.root;for(d=0;d<g;d++)this._addTile(f[d],h);this._removeInvisibleTiles(a)}},_updateTilesPos:function(){var a,b,c=null;for(a in this._tiles){if(b=this._tiles[a],!c){var d,e,f,g,h=a.split(":");d=parseInt(h[0],10),e=parseInt(h[1],10),f=this._getTilePos(new Z.Point(d,e)),g=new Z.Point(b.position.x,b.position.y,b.position.z),c=f.subtract(g)}b.position.x+=c.x,b.position.y+=c.y,b.position.z+=c.z}},_tileShouldBeLoaded:function(a){if(a.x+":"+a.y in this._tiles)return!1;var b=this._pyramidModel.getTileBounds(this._scene.options.maxBounds,this._scene.getZoom());return!(a.x<b.min.x||a.x>b.max.x||a.y<b.min.y||a.y>b.max.y)},_getRenderTileSize:function(a){var b=this._pyramidModel.getLatLngBounds(a,this._scene.getZoom()),c=this._scene._latLngToGLPoint(b.getSouthWest()),d=this._scene._latLngToGLPoint(b.getNorthEast());return new Z.Point(Math.abs(c.x-d.x),Math.abs(c.y-d.y))},_addTile:function(a,b){var c=this._getTilePos(a),d=this._getTile();this._setTilePos(d,c),this._tiles[a.x+":"+a.y]=d,this._loadTile(d,a),d.parent!==b&&b.add(d)},_getTilePos:function(a){var b=this._pyramidModel.getLatLngBounds(a,this._scene.getZoom()),c=b.getCenter();return this._scene._latLngToGLPoint(c)},_getTile:function(){var a=new THREE.PlaneBufferGeometry(this._renderTileSize.x,this._renderTileSize.y,1,1),b=new THREE.Mesh(a,this._tileMaterial.clone());return b.receiveShadow=!0,Z.ZIndexManager.setZIndex(b,this._zIndex,this._containerPane.index),b},_setTilePos:function(a,b){a.position.x=b.x,a.position.y=b.y,a.position.z=b.z},_loadTile:function(a,b){var c=this._options.zoomOffset?b.z+this._options.zoomOffset:b.z,d=this.getTileUrl(c,b.y,b.x),e=this,f=function(){e._scene.refresh()},g=function(){e._removeTile(b.x+":"+b.y),a.material.map=Z.ImageTextureManager.createTexture(e._options.errorTileUrl,{},function(){e._scene.refresh()})},h=Z.ImageTextureManager.createTexture(d,{},f,g,e);h.premultiplyAlpha=!1,h.anisotropy=this._scene.getMaxAnisotropy(),a.material.map=h,a._tileUrl=d,this.fire("tileloadstart",{tile:a,url:d})},_removeInvisibleTiles:function(a){var b,c,d,e,f=[];for(e in this._tiles)b=e.split(":"),c=parseInt(b[0],10),d=parseInt(b[1],10),(c<a.min.x||c>a.max.x||d<a.min.y||d>a.max.y)&&f.push(e);for(e in f)this._removeTile(f[e])},_removeTile:function(a){var b=this._tiles[a];b&&(this.fire("tileunload",{tile:b,url:b._tileUrl}),this._tileRoot.root.remove(b),b.material&&(b.material.texture&&b.material.texture.dispose(),b.material.dispose())),delete this._tiles[a]}}),Z.WMTSTileRender3D=Z.TileAggregatedRender3D.extend({getTileUrl:function(a,b,c){var d=this._urls[(b+c)%this._urls.length],e=this._getWMTSGetTileParams(a,b,c);return d+Z.Util.getParamString(e)},_getWMTSGetTileParams:function(a,b,c){var d={service:"WMTS",request:"GetTile",version:"1.0.0",layer:"",style:"default",tilematrixSet:"",format:"image/jpeg"};return Z.Util.applyOptions(d,this._options.params,!1),d.tileMatrix=a,d.tileRow=b,d.tileCol=c,d.format=d.format||this._options.tileInfo.format,d}}),Z.TDTTileRender3D=Z.WMTSTileRender3D.extend({getTileUrl:function(a,b,c){var d=Z.WMTSTileRender3D.prototype.getTileUrl.apply(this,arguments);return this._options.params.token&&(d+="&tk="+this._options.params.token),d}}),Z.TemplateTileRender3D=Z.TileAggregatedRender3D.extend({getTileUrl:function(a,b,c){var d=this._urls[(b+c)%this._urls.length];return d=d.replace("{level}",this._getLevelExpress(a)),d=d.replace("{row}",this._getRowExpress(b)),d=d.replace("{col}",this._getColExpress(c))},_getLevelExpress:function(a){var b=a+"";return 1===b.length?"L0"+b:"L"+b},_getRowExpress:function(a){var b=a.toString(16)+"";if(b.length>8)return"R"+b;for(var c=8-b.length,d=0;d<c;d++)b="0"+b;return"R"+b},_getColExpress:function(a){var b=a.toString(16)+"";if(b.length>8)return"C"+b;for(var c=8-b.length,d=0;d<c;d++)b="0"+b;return"C"+b}}),Z.BDTileRender3D=Z.TileAggregatedRender3D.extend({getTileUrl:function(a,b,c){var d=this._urls[(b+c)%this._urls.length];return b=b>=0?b:"M"+Math.abs(b),c=c>=0?c:"M"+Math.abs(c),d+"?qt=tile&x="+c+"&y="+b+"&z="+a+"&styles=pl&scalear=1&p=0"}}),Z.OSMTileRender3D=Z.TileAggregatedRender3D.extend({getTileUrl:function(a,b,c){return this._urls[(b+c)%this._urls.length]+"/"+a+"/"+c+"/"+b+".png"}}),Z.GraphicLayer=Z.ILayer.extend({initialize:function(a){this.options={idProp:"",nameProp:"",opacity:1,zIndex:0,minZoom:null,maxZoom:null,enableInfoWindow:!1,infoWindowOptions:null,enableTip:!1,enableTitle:!1,enableIcon:!1},this._graphics={},this._scene=null,this._render=null,this._containerPane=null,this._visible=!0,a=a||{},this.options=Z.Util.applyOptions(this.options,a,!1);var b=this;Object.defineProperties(this,{needsUpdate:{get:function(){var a=b._graphics,c=null;for(var d in a)if(c=a[d],c.needsUpdate)return!0;return!1}}})},onAdd:function(a,b,c,d){this.fire("loading"),this._render&&this._render.onRemove(this._scene);var e=this._getGraphicLayerRender(a,this.options);this._render=e,this._scene=a,this._containerPane=c;var f=this._render.onAdd(this,this._scene,b,c,d);for(var g in this._graphics)this._graphics[g]&&this._render.addGraphic(this,this._graphics[g]);return this._scene.refresh(),this._applyEvents("on"),this.fire("load"),f},onRemove:function(a){this._render.onRemove(this._scene),this._scene=null,this._render=null,this._applyEvents("off")},show:function(){this._render.show()},hide:function(){this._render.hide()},setOpacity:function(a){this.options.opacity=a,this._render.setOpacity(a)},setZIndex:function(a){this.options.zIndex=a,this._render.setZIndex(a)},getZIndex:function(){return this._render.getZIndex()},getContainerPane:function(){return this._containerPane},setZoomRange:function(a,b){this.options.minZoom="number"==typeof a?a:this.options.minZoom,this.options.maxZoom="number"==typeof b?b:this.options.maxZoom,this.refresh()},refresh:function(){this._render.refresh(this.options)},resetUpdateState:function(){var a=this._graphics,b=null;for(var c in a)b=a[c],b.needsUpdate&&(b.needsUpdate=!1)},addGraphic:function(a){var b=a instanceof Array?a:[a];this._addGraphics(b),this._scene&&this._scene.refresh()},addGraphics:function(a){a=a instanceof Array?a:[a],this._addGraphics(a),this._scene&&this._scene.refresh()},getGraphics:function(){var a=[];for(var b in this._graphics)a.push(this._graphics[b]);return a},hasGraphic:function(a){if(!a)return!1;var b=Z.Util.stamp(a,"graphic");return!!this._graphics[b]},removeGraphic:function(a){var b=a instanceof Array?a:[a];this._removeGraphics(b),this._scene&&this._scene.refresh()},removeGraphics:function(a){a=a instanceof Array?a:[a],this._removeGraphics(a),this._scene&&this._scene.refresh()},clear:function(){var a=[];for(var b in this._graphics)a.push(this._graphics[b]);this.removeGraphics(a),this.fire("graphicsclear")},latLngToLayerScenePoint:function(a){return this._render?this._render.latLngToLayerScenePoint(a):null},layerScenePointToLatLng:function(a){return this._render?this._render.layerScenePointToLatLng(a):null},getLayerSceneBounds:function(){var a,b,c=this._scene.getContentBounds(),d=c.getSouthWest(),e=c.getNorthEast();return a=this.latLngToLayerScenePoint(d),b=this.latLngToLayerScenePoint(e),Z.GLBounds.create(a,b)},getSceneHeight:function(a){return this._render?this._render.getSceneHeight(a):null},delegateGraphicEvent:function(a,b){this._render&&this._render.delegateGraphicEvent(a,event)},_getGraphicLayerRender:function(a,b){var c;return a instanceof Z.Scene2D?c=this._getGraphicLayerRender2D(b):a instanceof Z.Scene3D&&(c=this._getGraphicLayerRender3D(b)),c},_getGraphicLayerRender2D:function(a){return new Z.GraphicLayerRender2D(a)},_getGraphicLayerRender3D:function(a){return new Z.GraphicLayerRender3D(a)},_applyEvents:function(a){if(Z.DomEvent&&this._render){a=a||"on",this._applyLayerEvents(a);for(var b=this.getGraphics(),c=0;c<b.length;c++)this._applyGraphicEvents(b[c],a)}},_applyLayerEvents:function(a){var b,c,d=["click","dblclick","mousedown","mouseup","mouseover","mouseout","mousemove","contextmenu"];for(b=0,c=d.length;b<c;b++)this._render[a](d[b],this._fireLayerEvent,this);this.options.enableInfoWindow&&this._enableInfoWindowEvent(a),this.options.enableTip&&this._enableTipEvent(a)},_fireLayerEvent:function(a){this.fire(a.type,a)},_applyGraphicEvents:function(a,b){var c=["click","dblclick","mousedown","mouseup","mouseover","mouseout","mousemove","contextmenu","select","unselect"];a[b](c,this._fireGraphicEvent,this);var d=["select","unselect","mouseover","mouseout"];a[b](d,this._enableGraphicAutoReact,this)},_fireGraphicEvent:function(a){this.fire("graphic"+a.type,{latlng:a.latlng,scenePoint:a.scenePoint,containerPoint:a.containerPoint,originalEvent:a.originalEvent,objects:a.object?[a.object]:[]})},_enableGraphicAutoReact:function(a){var b=a.type,c=a.object;c&&("select"===b?c.doSelect():"unselect"===b?c.doUnselect():"mouseover"===b?c.doMouseOver():"mouseout"===b&&c.doMouseOut())},_addGraphics:function(a){var b=this._checkGraphics(a),c=b.length;if(0!==c){for(var d=0;d<c;d++){var e=b[d];this.options.enableTitle&&e.enableTitle(),this.options.enableIcon&&e.enableIcon()}this._render&&this._render.addGraphics(this,b);for(var d=0;d<c;d++){var e=b[d],f=Z.Util.stamp(e,"graphic");this._graphics[f]=e,this._applyGraphicEvents(e,"on"),this.fire("graphicadd",{graphic:e})}}},_removeGraphics:function(a){var b=this._checkGraphics(a,"exist"),c=b.length;if(0!==c){this._render&&this._render.removeGraphics(this,b);for(var d=0;d<c;d++){var e=b[d],f=Z.Util.stamp(e,"graphic");delete this._graphics[f],this._applyGraphicEvents(e,"off"),this.fire("graphicremove",{graphic:e})}}},_checkGraphics:function(a,b){for(var c=[],d=a.length,b=b||"new",e=0;e<d;e++){var f=a[e];if(f instanceof Z.Graphic||f instanceof Z.ComposeGraphic1){var g=Z.Util.stamp(f,"graphic");this._graphics[g]||"new"!==b?this._graphics[g]&&"exist"===b&&c.push(f):c.push(f)}}return c},_enableInfoWindowEvent:function(a){this[a]("graphicclick",this._showGraphicInfoWindow,this)},_showGraphicInfoWindow:function(a){var b=a.objects;b&&b.length>0&&b[0].showInfoWindow(this.options.infoWindowOptions)},_enableTipEvent:function(a){this[a]("graphicmouseover",this._showGraphicTip,this),this[a]("graphicmouseout",this._hideGraphicTip,this)},_showGraphicTip:function(a){var b=a.objects;b&&b.length>0&&b[0].showTip()},_hideGraphicTip:function(a){var b=a.objects;b&&b.length>0&&b[0].hideTip()}}),Z.BuildingLayer=Z.GraphicLayer.extend({buildingOptions:{root:"",props:"",id:"#{id}",title:"#{name}",titleSymbol:null,icon:null,iconSymbol:null,desc:"#{id}",shape:"#{SHAPE}",cw:!1,height:0,baseHeight:0,selectSymbol:null,mouseoverSymbol:null,partsData:null,partsOptions:{props:"",id:"#{id}",title:"#{name}",titleSymbol:null,icon:null,iconSymbol:null,desc:"#{id}",shape:"#{SHAPE}",cw:!1,floorIndex:"#{id}",height:0,selectSymbol:null,mouseoverSymbol:null,partsData:null,partsOptions:{props:"",id:"#{id}",title:"#{name}",titleSymbol:null,icon:null,iconSymbol:null,desc:"#{id}",height:0,shape:"#{SHAPE}",cw:!1,selectSymbol:null,mouseoverSymbol:null,wire:!1,opacity:1,topColor:"#000fff",wallColor:"#ffaa33"},wire:!0,opacity:1,topColor:"#0f00ff",wallColor:"#00aa33"},wire:!0,opacity:1,topColor:"#000fff",wallColor:"#ffaa33"},initialize:function(a){a=a||{},Z.GraphicLayer.prototype.initialize.call(this,a),this.buildingOptions=Z.Util.applyOptions(this.buildingOptions,a,!1)},loadBuildingsByWKT:function(a,b,c){b=b||{},b.partsOptions=b.partsOptions||{},this.buildingOptions=Z.Util.applyOptions(this.buildingOptions,b,!1,["partsOptions"]),this.buildingOptions.partsOptions=Z.Util.applyOptions(this.buildingOptions.partsOptions,b.partsOptions,!1,["partsOptions"]),this.buildingOptions.partsOptions.partsOptions=Z.Util.applyOptions(this.buildingOptions.partsOptions.partsOptions,b.partsOptions.partsOptions,!1),this.options=Z.Util.applyOptions(this.options,b,!1);var d=a.length,e=[];console.info("objLength:"+d);var f=this;new Z.JsonBuildingLoader(a,this.buildingOptions.root).load(function(a){for(var b=Z.BuildingBuilder.buildBuilding(a,f.buildingOptions),c=0;c<b.length;c++)e.push(b[c])},c),this.addGraphics(e)},_fireGraphicEvent:function(a){Z.GraphicLayer.prototype._fireGraphicEvent.apply(this,arguments);var b=a.object,c=a.type;b instanceof Z.Building?c="building"+c:b instanceof Z.Floor?c="floor"+c:b instanceof Z.Cell&&(c="cell"+c),this.fire(c,{latlng:a.latlng,scenePoint:a.scenePoint,containerPoint:a.containerPoint,originalEvent:a.originalEvent,objects:a.object?[a.object]:[]})},_getGraphicLayerRender3D:function(a){return new Z.GraphicLayerMergedRender3D(a)}}),Z.TerrainGraphicLayer=Z.GraphicLayer.extend({initialize:function(a){Z.GraphicLayer.prototype.initialize.apply(this,arguments)},_getGraphicLayerRender3D:function(a){return new Z.GraphicLayerRenderTerrain(a)}}),Z.NSDModelLayer=Z.GraphicLayer.extend({initialize:function(a){a=a||{},Z.GraphicLayer.prototype.initialize.call(this,a),this._model=null,this._floors=null},showModel:function(a,b){function c(a){var b=document.getElementById("loadingTag"),c=document.getElementById("loadingStatus");if(b||(b=document.createElement("div"),b.id="loadingTag",document.body.appendChild(b)),c||(c=document.createElement("span"),c.id="loadingStatus",b.appendChild(c)),"none"===b.style.display){var d=window.innerWidth,e=window.innerHeight;b.style.left=(d-250)/2+"px",b.style.top=(e-20)/2+"px",b.style.display="block"}c.innerHTML=a}var d=this,e=function(a){a.lengthComputable&&c("正在加载")},f=function(a){c("建筑模型加载出错， 请检查网络")};(new THREE.XHRLoader).load(a,function(a){var c=Z.NSDModelBuilder.parse(a,b),e={},f=Z.NSDModelBuilder.findFloors(c.entities);for(var g in c.entities)e[c.entities[g].Type]||(e[c.entities[g].Type]="1");d._model=c,d._floors=f,d.fire("modelLoaded")},e,f)},getFloorIndexes:function(){var a=[];for(var b in this._floors)a.push(b);return a},getComponentTypes:function(){return Z.NSDModelBuilder.types},showFloors:function(a,b){if(a instanceof Array){for(var c={},d=[],e=0;e<b.length;e++)c[b[e]]=!0;for(var f=0;f<a.length;f++){var g=a[f]+"",h=this._floors[g];if(h)for(var i=h.elements,j=0;j<i.length;j++)c[i[j].Type]&&d.push(i[j].ArchGeometry3D)}for(var k={},l=[],m=[],j=0;j<d.length;j++){k[Z.Util.stamp(d[j],"graphic")]=!0,this.hasGraphic(d[j])||l.push(d[j])}for(var n in this._graphics)k[n]||m.push(this._graphics[n]);this.addGraphics(l),this.removeGraphics(m)}}}),Z.ThreeDMaxModelLayer=Z.GraphicLayer.extend({initialize:function(a){a=a||{},Z.GraphicLayer.prototype.initialize.call(this,a),this._components={},this._shells=[],this._floors={},this._shellConfig={"外壳1":!0,"外壳2":!0},this._floorConfig={"-1":{_1f:!0,"_1F物品":!0},1:{"1f":!0,"1F物品":!0,"1楼楼梯7":!0,"1楼指示牌":!0,"地面":!0},2:{"2f":!0,"2F物品":!0,"2楼楼梯":!0,"2楼指示牌":!0,"2楼楼板":!0},3:{"3f01":!0,"3F物品":!0,"3楼楼梯":!0,"3层楼板":!0}}},showModel:function(a,b){function c(a){var b=document.getElementById("loadingTag"),c=document.getElementById("loadingStatus");if(b||(b=document.createElement("div"),b.id="loadingTag",document.body.appendChild(b)),c||(c=document.createElement("span"),c.id="loadingStatus",b.appendChild(c)),"none"===b.style.display){var d=window.innerWidth,e=window.innerHeight;b.style.left=(d-250)/2+"px",b.style.top=(e-20)/2+"px",b.style.display="block"}c.innerHTML=a}var d=this,e=function(a){},f=function(a){c("建筑模型加载出错， 请检查网络")};THREE.Loader.Handlers.add(/\.dds$/i,new THREE.DDSLoader),a.lastIndexOf("/")===a.length-1&&(a=a.substring(0,a.length-1));var g=a.lastIndexOf("/"),h="",i="";g<0?h=a:0===g?h=a.substring(g+1):g>0&&g<a.length-1&&(h=a.substring(g+1),i=a.substring(0,g+1));var j=new THREE.MTLLoader;j.setPath(i),j.load(h+".mtl",function(a){function c(c){for(var e=c.length,f={},g=e-1;g>=0;g--){for(var h,j,k=c[g].geometry,l=c[g].materials,m=c[g].isLine,n=k.normal,o=k.position,p=k.uv,q=k.face,r=k.groups,s=l,t=[],u=[],v=0;v<s.length;v++){var w=s[v].name;if(f[w])t[v]=f[w];else{if(a.materialsInfo[w]){var x=a.materialsInfo[w];t[v]=new Z.ModelSymbol(x),t[v].path=i}else t[v]=new Z.ModelSymbol({name:w});t[v].isLine=m,f[w]=t[v]}}for(v=0;v<r.length;v++)u[v]={start:r[v].start,count:r[v].count,symbolIndex:r[v].materialIndex};h=new Z.GroupSymbol(u,t);var y={normals:n||null,uvs:p||null,vertices:o||null,faces:q||null,isLine:m};j=new Z.ModelGeometry(null,y,b);var z=c[g].name,A={title:"#{name}",tip:"#{name}",enableTitle:!0},B=new Z.Graphic(new Z.Feature({name:z},j),h,A);if(d._components[z]=B,d._shellConfig[z])d._shells.push({ArchGeometry3D:B,Type:z});else for(var C in d._floorConfig)d._floorConfig[C][z]&&(d._floors[C]||(d._floors[C]=[]),d._floors[C].push({ArchGeometry3D:B,Type:z}))}d.fire("modelLoaded")}var g=new Z.OBJLoader;g.setMaterials(a),g.setPath(i),g.load(h+".obj",c,e,f)})},getFloorIndexes:function(){var a=[];for(var b in this._floors)a.push(b);for(var c in this._shellConfig)if(c){a.push("外壳");break}return a},getComponentTypes:function(a){var b=[];for(var c in this._components)b.push(c);return b},showFloors:function(a,b){if(a instanceof Array){for(var c={},d=[],e=0;e<b.length;e++)c[b[e]]=!0;for(var f=0;f<a.length;f++){var g=a[f]+"",h=this._floors[g];if(!h){if("外壳"!==g)continue;h=this._shells}for(var i=h,j=0;j<i.length;j++)c[i[j].Type]&&d.push(i[j].ArchGeometry3D)}for(var k={},l=[],m=[],j=0;j<d.length;j++){k[Z.Util.stamp(d[j],"graphic")]=!0,this.hasGraphic(d[j])||l.push(d[j])}for(var n in this._graphics)k[n]||m.push(this._graphics[n]);this.addGraphics(l),this.removeGraphics(m)}},showComponents:function(a){if(a instanceof Array){for(var b=[],c=0;c<a.length;c++)b.push(this._components[a[c]]);for(var d={},e=[],f=[],g=0;g<b.length;g++){d[Z.Util.stamp(b[g],"graphic")]=!0,this.hasGraphic(b[g])||e.push(b[g])}for(var h in this._graphics)d[h]||f.push(this._graphics[h]);this.addGraphics(e),this.removeGraphics(f)}},showAllComponents:function(){var a=[];for(var b in this._components)a.push(this._components[b]);this.addGraphics(a)},_getGraphicLayerRender3D:function(a){return new Z.GraphicLayerRender3D(a)}}),Z.TiledGraphicLayer=Z.ILayer.extend({initialize:function(a,b){this.options={idProp:"",nameProp:"",opacity:1,zIndex:0,minZoom:null,maxZoom:null,enableInfoWindow:!1,infoWindowOptions:null,enableTip:!1,enableTitle:!1,enableIcon:!1,levelMapping:[]},this.needsUpdate=!1,this._urls=a||[],this._graphics={},this._scene=null,this._render=null,this._containerPane=null,this._visible=!0,this._pyramidModel=null,b=b||{},this.options=Z.Util.applyOptions(this.options,b,!1)},onAdd:function(a,b,c,d){this.fire("loading"),this._render&&this._render.onRemove(this._scene);var e=this._getGraphicLayerRender(a,this._urls,this.options);this._render=e,this._scene=a,this._containerPane=c;var f=this._render.onAdd(this,this._scene,b,c,d);return this._scene.refresh(),this.needsUpdate=!0,this._applyEvents("on"),this.fire("load"),f},onRemove:function(a){this._render.onRemove(this._scene),this._removeGraphics(this._graphics),this._scene=null,this._render=null,this.needsUpdate=!0,this._applyEvents("off")},show:function(){this._render.show(),this.needsUpdate=!0},hide:function(){this._render.hide(),this.needsUpdate=!0},setOpacity:function(a){this.options.opacity=a,this._render.setOpacity(a),this.needsUpdate=!0},setZIndex:function(a){this.options.zIndex=a,this._render.setZIndex(a),this.needsUpdate=!0},getZIndex:function(){return this._render.getZIndex()},getContainerPane:function(){return this._containerPane},setZoomRange:function(a,b){this.options.minZoom="number"==typeof a?a:this.options.minZoom,this.options.maxZoom="number"==typeof b?b:this.options.maxZoom,this.refresh()},refresh:function(){this._render.refresh(this.options),this.needsUpdate=!0},resetUpdateState:function(){this.needsUpdate=!1},getGraphics:function(){var a=[];for(var b in this._graphics)a.push(this._graphics[b]);return a},hasGraphic:function(a){if(!a)return!1;var b=Z.Util.stamp(a,"graphic");return!!this._graphics[b]},latLngToLayerScenePoint:function(a){return this._render?this._render.latLngToLayerScenePoint(a):null},layerScenePointToLatLng:function(a){return this._render?this._render.layerScenePointToLatLng(a):null},getLayerSceneBounds:function(){var a,b,c=this._scene.getContentBounds(),d=c.getSouthWest(),e=c.getNorthEast();return a=this.latLngToLayerScenePoint(d),b=this.latLngToLayerScenePoint(e),Z.GLBounds.create(a,b)},getSceneHeight:function(a){return this._render?this._render.getSceneHeight(a):null},_getGraphicLayerRender:function(a,b,c){var d;return this._pyramidModel||(this._pyramidModel=this._initPyramidModel(c)),c.pyramidModel=this._pyramidModel,a instanceof Z.Scene2D?d=this._getGraphicLayerRender2D(b,c):a instanceof Z.Scene3D&&(d=this._getGraphicLayerRender3D(b,c)),d},_getGraphicLayerRender2D:function(a,b){return new Z.GraphicLayerRender2D(b)},_getGraphicLayerRender3D:function(a,b){return new Z.VectorTileRender3D(a,b)},_applyEvents:function(a){if(Z.DomEvent&&this._render){a=a||"on",this._applyLayerEvents(a);var b=this.getGraphics();for(j=0;j<b.length;j++)this._applyGraphicEvents(b[j],a);this._applyTileEvents(a)}},_applyLayerEvents:function(a){var b,c,d=["click","dblclick","mousedown","mouseup","mouseover","mouseout","mousemove","contextmenu"];for(b=0,c=d.length;b<c;b++)this._render[a](d[b],this._fireLayerEvent,this);this.options.enableInfoWindow&&this._enableInfoWindowEvent(a),this.options.enableTip&&this._enableTipEvent(a)},_fireLayerEvent:function(a){this.fire(a.type,a)},_applyGraphicEvents:function(a,b){for(var c=["click","dblclick","mousedown","mouseup","mouseover","mouseout","mousemove","contextmenu","select","unselect"],d=0,e=c.length;d<e;d++)a[b](c[d],this._fireGraphicEvent,this);for(var f=["select","unselect","mouseover","mouseout"],g=0,e=f.length;g<e;g++)a[b](f[g],this._enableGraphicAutoReact,this)},_fireGraphicEvent:function(a){this.fire("graphic"+a.type,{latlng:a.latlng,scenePoint:a.scenePoint,containerPoint:a.containerPoint,originalEvent:a.originalEvent,objects:a.object?[a.object]:[]})},_enableGraphicAutoReact:function(a){var b=a.type,c=a.object;c&&("select"===b?c.doSelect():"unselect"===b?c.doUnselect():"mouseover"===b?c.doMouseOver():"mouseout"===b&&c.doMouseOut())},_enableInfoWindowEvent:function(a){this[a]("graphicclick",this._showGraphicInfoWindow,this)},_showGraphicInfoWindow:function(a){var b=a.objects;b&&b.length>0&&b[0].showInfoWindow(this.options.infoWindowOptions)},_enableTipEvent:function(a){this[a]("graphicmouseover",this._showGraphicTip,this),this[a]("graphicmouseout",this._hideGraphicTip,this)},_showGraphicTip:function(a){var b=a.objects;b&&b.length>0&&b[0].showTip()},_hideGraphicTip:function(a){var b=a.objects;b&&b.length>0&&b[0].hideTip()},_applyTileEvents:function(a){this._render[a]("tileload",this._onTileLoad,this),this._render[a]("tileupdate",this._onTileUpdate,this),this._render[a]("tileremove",this._onTileRemove,this)},_onTileLoad:function(a){this.needsUpdate=!0;var b=a.graphics;this._addGraphics(b)},_onTileUpdate:function(a){this.needsUpdate=!0},_onTileRemove:function(a){this.needsUpdate=!0;var b=a.graphics;this._removeGraphics(b)},_addGraphics:function(a){var b=this._checkGraphics(a),c=b.length;if(0!==c){for(var d=0;d<c;d++){var e=b[d];this.options.enableTitle&&e.enableTitle(),this.options.enableIcon&&e.enableIcon()}for(var d=0;d<c;d++){var e=b[d],f=Z.Util.stamp(e,"graphic");this._graphics[f]=e,this._applyGraphicEvents(e,"on"),this.fire("graphicadd",{graphic:e})}}},_removeGraphics:function(a){var b=this._checkGraphics(a,"exist"),c=b.length;if(0!==c)for(var d=0;d<c;d++){var e=b[d],f=Z.Util.stamp(e,"graphic");delete this._graphics[f],this._applyGraphicEvents(e,"off"),this.fire("graphicremove",{graphic:e})}},_checkGraphics:function(a,b){for(var c=[],d=a.length,b=b||"new",e=0;e<d;e++){var f=a[e];if(f instanceof Z.Graphic||f instanceof Z.ComposeGraphic1){var g=Z.Util.stamp(f,"graphic");this._graphics[g]||"new"!==b?this._graphics[g]&&"exist"===b&&c.push(f):c.push(f)}}return c},_initPyramidModel:function(a){return new Z.PyramidModel.OSM}}),Z.GraphicLayerRender2D=Z.IGraphicLayerRender.extend({initialize:function(a){this._leafletLayer=this._getGraphicLayer(a),this._scene=null,this._containerPane=null},onAdd:function(a,b,c,d,e){this._scene=b,this._containerPane=d,b._leafletMap.addLayer(this._leafletLayer),this._applyEvents("on")},onRemove:function(a){this._scene=null,this._containerPane=null,a._leafletMap.removeLayer(this._leafletLayer),this._applyEvents("off")},show:function(){throw new Error("show方法尚未实现")},hide:function(){throw new Error("hide方法尚未实现")},setOpacity:function(a){throw new Error("setOpacity方法尚未实现")},getZIndex:function(){return 0},setZIndex:function(a){},refresh:function(a){throw new Error("refresh方法尚未实现")},addGraphic:function(a,b){(b instanceof Z.Graphic||b instanceof Z.MultiGraphic)&&b.onAdd(a,this._leafletLayer,this._scene)},removeGraphic:function(a,b){(b instanceof Z.Graphic||b instanceof Z.MultiGraphic)&&b.onRemove(a,this._leafletLayer,this._scene)},addGraphics:function(a,b){if(b=b||[],!(b.length<=0))for(var c=0;c<b.length;c++){var d=b[c];(d instanceof Z.Graphic||d instanceof Z.MultiGraphic)&&d.onAdd(a,this._leafletLayer,this._scene)}},removeGraphics:function(a,b){if(b=b||[],!(b.length<=0))for(var c=0;c<b.length;c++){var d=b[c];(d instanceof Z.Graphic||d instanceof Z.MultiGraphic)&&d.onRemove(a,this._leafletLayer,this._scene)}},clear:function(){this._leafletLayer&&this._leafletLayer.clearLayers()},on:function(a,b,c){this._leafletLayer&&this._leafletLayer.on(a,b,c)},off:function(a,b,c){this._leafletLayer&&this._leafletLayer.off(a,b,c)},_getGraphicLayer:function(a){return new L.FeatureGroup},_applyEvents:function(a){var a=a||"on";this._applyLayerEvents(a)},_applyLayerEvents:function(a){for(var b=this,c=["dblclick","click","mousedown","mouseup","mouseover","mouseout","mousemove","contextmenu"],d=0,e=c.length;d<e;d++)this._leafletLayer[a](c[d],b._onLayerEvent,b)},_onLayerEvent:function(a){this.fire(a.type,{latlng:Z.LeafletUtil.latLngFromLeaflet(a.latlng),scenePoint:Z.LeafletUtil.pointFromLeaflet(a.layerPoint),containerPoint:Z.LeafletUtil.pointFromLeaflet(a.containerPoint),originalEvent:a.originalEvent,objects:[]})}}),Z.GraphicLayerRender3D=Z.IGraphicLayerRender.extend({initialize:function(a,b){this.options={},this.options=Z.Util.applyOptions(this.options,b,!1),this._graphicRoot=new Z.SceneThreePaneItem,this._containerPane=null,this._anchor={latLng1:null,latLng2:null,scenePoint1:null,scenePoint2:null},this._zIndex,this._graphicLayer,this._scene,this._intersectedObjects={}},onAdd:function(a,b,c,d,e){if(b instanceof Z.Scene3D&&d){this._graphicLayer=a;var f=c;return"number"!=typeof f&&(f=e?e.getMaxChildIndex()+1:d.getMaxChildIndex()+1),this._scene=b,d instanceof Z.SceneThreePaneItem&&(this._containerPane=d,this.setZIndex(f)),this._initAnchor(),this._addEvents(),f}},onRemove:function(a){this._removeEvents(),this._containerPane&&(this._containerPane.removeChild(this._graphicRoot),this._containerPane=null),this._scene=void 0},show:function(){this._graphicRoot.show()},hide:function(){this._graphicRoot.hide()},setOpacity:function(a){if("number"==typeof a){a=Math.min(1,Math.max(a,0));for(var b=this._graphicRoot.root.children,c=0;c<b.length;c++)b[c].material&&(b[c].material.opacity=a)}},setZIndex:function(a){"number"==typeof a&&(this._zIndex=a,this._containerPane.setChildIndex(this._graphicRoot,a))},getZIndex:function(){return this._zIndex},refresh:function(a){throw new Error("refresh方法尚未实现")},addGraphic:function(a,b){var c=b instanceof Array?b:b?[b]:[];this.addGraphics(a,c)},removeGraphic:function(a,b){var c=b instanceof Array?b:b?[b]:[];this.removeGraphics(a,c)},addGraphics:function(a,b){var c=b instanceof Array?b:b?[b]:[];if(!(c.length<=0))for(var d=0;d<c.length;d++){var e=c[d];(e instanceof Z.Graphic||e instanceof Z.ComposeGraphic1)&&e.onAdd(a,this._graphicRoot,this._scene)}},removeGraphics:function(a,b){var c=b instanceof Array?b:b?[b]:[];if(!(c.length<=0))for(var d=0;d<c.length;d++){var e=c[d];(e instanceof Z.Graphic||e instanceof Z.ComposeGraphic1)&&e.onRemove(a,this._graphicRoot,this._scene)}},clear:function(){this._containerPane.removeChild(this._graphicRoot),this._graphicRoot.resetRoot(),this._containerPane.addChild(this._graphicRoot)},latLngToLayerScenePoint:function(a){var b=this._anchor.scenePoint1,c=this._anchor.scenePoint2,d=this._anchor.latLng1,e=this._anchor.latLng2,f=(c.y-b.y)/(e.lat-d.lat),g=(c.x-b.x)/(e.lng-d.lng),h=(a.lng-d.lng)*g,i=(a.lat-d.lat)*f,j=Z.Util.isNull(a.alt)?NaN:Z.Util.isNull(d.alt)?a.alt:a.alt-d.alt,k=this.getSceneHeight(j);return new Z.Point(h,i,k)},getSceneHeight:function(a){return(a=a||0)*(this._anchor.sceneHeight/this._anchor.latLngHeight)},layerScenePointToLatLng:function(a){var b=this._anchor.scenePoint1,c=this._anchor.scenePoint2,d=this._anchor.latLng1,e=this._anchor.latLng2,f=(c.x-b.x)/(e.lng-d.lng),g=(a.x-b.x)/f+d.lng,h=(a.y-b.y)/f+d.lat,i=Z.Util.isNull(a.z)?NaN:Z.Util.isNull(b.z)?a.z:a.z-b.z,j=this.getLatLngHeight(i)+d.alt;return new Z.LatLng(h,g,j)},getLatLngHeight:function(a){return(a=a||0)/(this._anchor.sceneHeight/this._anchor.latLngHeight)},delegateGraphicEvent:function(a,b){if(a&&b){var c=this._scene.documentPointToContainer(new Z.Point(b.clientX,b.clientY)),d=this._scene.screenPointToScenePoint(c),e=this._scene.screenPointToLatLng(c),f={type:b.type,latlng:e,scenePoint:d,containerPoint:c,originalEvent:b,objects:[a]};this._onMouseEvent(f)}},_addEvents:function(a){this._applyEvents("on")},_removeEvents:function(){this._applyEvents("off")},_applyEvents:function(a){var b=this,a=a||"on";this._scene[a]("viewreset",b._onViewReset,b),this._scene[a]("moveend",b._onMoveEnd,b),this._scene[a]("zoomlevelschange",b._onZoomLevelsChange,b);var c=["dblclick","click","mousedown","mouseup","mouseover","mouseout","mousemove","contextmenu"];this._scene[a](c,b._onMouseEvent,b)},_onViewReset:function(){this._scene.refresh(),this._refreshGraphics()},_refreshGraphics:function(){for(var a=this._graphicLayer.getGraphics(),b=0;b<a.length;b++)a[b].refresh()},_onMoveEnd:function(){this._onZoomLevelsChange()},_onZoomLevelsChange:function(){var a=this._scene.latLngToScenePoint(this._anchor.latLng1),b=this._scene.latLngToScenePoint(this._anchor.latLng2),c=(b.x-a.x)/(this._anchor.scenePoint2.x-this._anchor.scenePoint1.x);this._graphicRoot.root.scale.set(c,c,c),this._graphicRoot.root.position.set(a.x,a.y,a.z),this._graphicRoot.root.updateMatrix(),this._graphicRoot.root.updateMatrixWorld(!0),this._scene.refresh(),this._refreshGraphics()},_onDragStart:function(a){this._dragStartPoint=this._graphicRoot.root.position.clone()},_onDrag:function(a){var b=this._scene;if(a.startPoint&&a.newPoint){var c=b.screenPointToScenePoint(a.startPoint),d=b.screenPointToScenePoint(a.newPoint);if(c&&d){var e=d.subtract(c),f=this._dragStartPoint.x+e.x,g=this._dragStartPoint.y+e.y,h=this._dragStartPoint.z+e.z;this._graphicRoot.root.position.set(f,g,h),this._graphicRoot.root.position.matrixWorldNeedsUpdate=!0,this._scene.refresh(),this._refreshGraphics()}}},_onDragEnd:function(a){this._dragStartPoint=null},_onMouseEvent:function(a){for(var b,c=a.objects||[],d=[],e={},f=0;f<c.length;f++)if(c[f]instanceof Z.Graphic&&c[f].eventCapturable&&c[f].isShowing()&&(b=Z.Util.stamp(c[f],"graphic"),this._graphicLayer.hasGraphic(c[f]))){if(e[b])continue;c[f].eventFirable&&(d[d.length]=c[f],e[b]=c[f]);break}this._fireGraphicLayerMouseEvent(a,d),this._fireGraphicsMouseEvent(a,e),this._intersectedObjects=e,"click"===a.type&&(this._nullClick(e)||(this._clickedObjects=e))},_fireGraphicLayerMouseEvent:function(a,b){this.fire(a.type,{latlng:a.latlng,scenePoint:a.scenePoint,containerPoint:a.containerPoint,originalEvent:a.originalEvent,objects:b})},_fireGraphicsMouseEvent:function(a,b){var c=[];for(var d in this._intersectedObjects)b[d]||(this._fireOneGraphicEvent("mouseout",a,this._intersectedObjects[d]),c.push(this._intersectedObjects[d]));if(c.length>0){var e={type:"mouseout",latlng:a.latlng,scenePoint:a.scenePoint,containerPoint:a.containerPoint,originalEvent:a.originalEvent};this._fireGraphicLayerMouseEvent(e,c)}var f=[];if("click"===a.type){if(!this._nullClick(b))for(var d in this._clickedObjects)b[d]||(this._fireOneGraphicEvent("unselect",a,this._clickedObjects[d]),f.push(this._clickedObjects[d]))}if(f.length>0){var g={type:"unselect",latlng:a.latlng,scenePoint:a.scenePoint,containerPoint:a.containerPoint,originalEvent:a.originalEvent};this._fireGraphicLayerMouseEvent(g,f)}var h=[],i=[];for(var d in b)this._intersectedObjects[d]||(this._fireOneGraphicEvent("mouseover",a,b[d]),i.push(b[d])),"click"===a.type&&(this._fireOneGraphicEvent("select",a,b[d]),h.push(b[d])),this._fireOneGraphicEvent(a.type,a,b[d]);if(i.length>0){var j={type:"mouseover",latlng:a.latlng,scenePoint:a.scenePoint,containerPoint:a.containerPoint,originalEvent:a.originalEvent};this._fireGraphicLayerMouseEvent(j,i)}if(h.length>0){var k={type:"select",latlng:a.latlng,scenePoint:a.scenePoint,containerPoint:a.containerPoint,originalEvent:a.originalEvent};this._fireGraphicLayerMouseEvent(k,h)}},_fireOneGraphicEvent:function(a,b,c){c&&c.fire(a,{latlng:b.latlng,scenePoint:b.scenePoint,containerPoint:b.containerPoint,originalEvent:b.originalEvent,object:c})},_nullClick:function(a){var b=!0,a=a||{};for(var c in a)if(c){b=!1;break}return b},_initAnchor:function(){var a=this._scene.getBounds(),b=10,c=this._scene.getSceneDistance(b);this._anchor={latLng1:a.getCenter(),latLng2:a.getNorthEast(),scenePoint1:new Z.Point(0,0,0),scenePoint2:this._scene.latLngToScenePoint(a.getNorthEast()),latLngHeight:b,sceneHeight:c}}}),Z.GraphicLayerRenderTerrain=Z.IGraphicLayerRender.extend({initialize:function(a){this._graphicRoot=new Z.SceneThreePaneItem,this._rootLatLng=null,this._containerPane=null,this._anchor={latLng1:null,latLng2:null,scenePoint1:null,scenePoint2:null},this._zIndex,this._graphicLayer,this._scene,this._intersectedObjects={},this._visibleGraphics=[],this._invisibleGraphics=[],this._renderId=Z.Util.stamp(this,"layerRender"),this._graphicObjects={}},onAdd:function(a,b,c,d,e){if(b instanceof Z.Scene3D&&d){this._graphicLayer=a;var f=c;return"number"!=typeof f&&(f=d.getMaxChildIndex()+1),this._scene=b,this._initAnchor(),this._addEvents(),Z.SingleTerrainPlane.getInstance().addSurfaceLayer(this._renderId,"graphic",null,f),this._refreshGraphics(),f}},onRemove:function(a){this._removeEvents(),this._containerPane&&(this._containerPane.removeChild(this._graphicRoot),this._containerPane=null),Z.SingleTerrainPlane.getInstance().removeSurfaceLayer(this._renderId),this._scene=void 0},show:function(){Z.SingleTerrainPlane.getInstance().addSurfaceLayer(this._renderId,"graphic")},hide:function(){Z.SingleTerrainPlane.getInstance().removeSurfaceLayer(this._renderId)},setOpacity:function(a){},setZIndex:function(a){"number"==typeof a&&(this._zIndex=a,Z.SingleTerrainPlane.getInstance().updateLayerIndex(this._renderId,a))},getZIndex:function(){return this._zIndex},refresh:function(a){throw new Error("refresh方法尚未实现")},addGraphic:function(a,b){if(b instanceof Z.Graphic||b instanceof Z.MultiGraphic){b.onAdd(a,this._graphicRoot,this._scene);var c=Z.Util.stamp(b,"graphic"),d=b.feature.shape.type;this._graphicObjects[c]={object:b.feature.shape.clone(),symbol:b.symbol.clone(),type:d,graphic:b},this._updateRenderContent(),this._applyGraphicUpdateEvent(b,"on"),this._refreshGraphics()}},removeGraphic:function(a,b){if(b instanceof Z.Graphic||b instanceof Z.MultiGraphic){b.onRemove(a,this._graphicRoot.root,this._scene);var c=Z.Util.stamp(b,"graphic");delete this._graphicObjects[c],this._updateRenderContent(),this._applyGraphicUpdateEvent(b,"off"),this._refreshGraphics()}},addGraphics:function(a,b){if(b=b||[],!(b.length<=0)){for(var c=0;c<b.length;c++){var d=b[c];if(d instanceof Z.Graphic||d instanceof Z.MultiGraphic){d.onAdd(a,this._graphicRoot,this._scene);var e=Z.Util.stamp(d,"graphic"),f=d.feature.shape.type;this._graphicObjects[e]={object:d.feature.shape.clone(),symbol:d.symbol.clone(),type:f,graphic:d},this._applyGraphicUpdateEvent(d,"on")}}this._updateRenderContent(),this._refreshGraphics()}},removeGraphics:function(a,b){if(b=b||[],!(b.length<=0)){for(var c=0;c<b.length;c++){var d=b[c];if(d instanceof Z.Graphic||d instanceof Z.MultiGraphic){d.onRemove(a,this._graphicRoot.root,this._scene);var e=Z.Util.stamp(d,"graphic");delete this._graphicObjects[e],this._applyGraphicUpdateEvent(d,"off")}}this._updateRenderContent(),this._refreshGraphics()}},clear:function(){this._graphicObjects={},this._updateRenderContent(),this._refreshGraphics()},latLngToLayerScenePoint:function(a){var b=this._anchor.scenePoint1,c=this._anchor.scenePoint2,d=this._anchor.latLng1,e=this._anchor.latLng2,f=(c.x-b.x)/(e.lng-d.lng),g=(a.lng-d.lng)*f,h=(a.lat-d.lat)*f,i=Z.Util.isNull(a.alt)?NaN:Z.Util.isNull(d.alt)?a.alt:a.alt-d.alt,j=this._scene.getSceneDistance(i);return new Z.Point(g,h,j)},_addEvents:function(a){this._applyEvents("on")},_removeEvents:function(){this._applyEvents("off")},_applyEvents:function(a){var b=this,a=a||"on";this._scene[a]("viewreset",b._onViewReset,b),this._scene[a]("moveend",b._onMoveEnd,b),this._scene[a]("zoomlevelschange",b._onZoomLevelsChange,b),this._scene[a]("drag",this._onDrag,b);var c,d,e=["dblclick","click","mousedown","mouseup","mouseover","mouseout","mousemove","contextmenu"];for(c=0,d=e.length;c<d;c++)this._scene[a](e[c],b._onMouseEvent,b)},_onViewReset:function(){this._refreshGraphics()},_refreshGraphics:function(){this._refreshVisibleStatus(),this._refreshVisibleGraphics(),this._refreshInvisibleGraphics()},_refreshVisibleStatus:function(){var a=this._graphicObjects,b=this._scene.getBounds();this._visibleGraphics=[],this._invisibleGraphics=[];for(var c in a){var d=a[c].graphic,e=d.feature.shape,f=e instanceof Z.Geometry?e.getBounds():e;b.intersects(f)?this._visibleGraphics.push(d):this._invisibleGraphics.push(d)}},_refreshVisibleGraphics:function(){for(var a=this._visibleGraphics,b=0;b<a.length;b++)a[b].refresh(),a[b].show()},_refreshInvisibleGraphics:function(){for(var a=this._invisibleGraphics,b=0;b<a.length;b++)a[b].hide()},_onMoveEnd:function(){this._onZoomLevelsChange()},_onZoomLevelsChange:function(){this._refreshAnchor(),this._scene.refresh(),this._refreshGraphics()},_onDrag:function(a){this._refreshVisibleGraphics()},_onMouseEvent:function(a){for(var b=a.objects||[],c=a.latlng,d=[],e={},f=0;f<b.length;f++)if(b[f]instanceof Z.SurfacePlane){var g=b[f],h=g.getGraphic(this._renderId,c);if(h){var i=Z.Util.stamp(h,"graphic");if(this._graphicLayer.hasGraphic(h)){if(e[i])continue;d[d.length]=h,e[i]=h;break}}}this._fireGraphicLayerMouseEvent(a,d),this._fireGraphicsMouseEvent(a,e),this._intersectedObjects=e,"click"===a.type&&(this._nullClick(e)||(this._clickedObjects=e))},_fireGraphicLayerMouseEvent:function(a,b){this.fire(a.type,{latlng:a.latlng,scenePoint:a.scenePoint,containerPoint:a.containerPoint,originalEvent:a.originalEvent,objects:b})},_fireGraphicsMouseEvent:function(a,b){for(var c in this._intersectedObjects)b[c]||this._fireOneGraphicEvent("mouseout",a,this._intersectedObjects[c]);if("click"===a.type){if(!this._nullClick(b))for(var c in this._clickedObjects)b[c]||this._fireOneGraphicEvent("unselect",a,this._clickedObjects[c])}for(var c in b)this._intersectedObjects[c]||this._fireOneGraphicEvent("mouseover",a,b[c]),"click"===a.type&&this._fireOneGraphicEvent("select",a,b[c]),this._fireOneGraphicEvent(a.type,a,b[c])},_fireOneGraphicEvent:function(a,b,c){c&&c.fire(a,{latlng:b.latlng,scenePoint:b.scenePoint,containerPoint:b.containerPoint,originalEvent:b.originalEvent,object:c})},_nullClick:function(a){var b=!0,a=a||{};for(var c in a)if(c){b=!1;break}return b},_initAnchor:function(){var a=this._scene.getBounds();this._anchor={latLng1:a.getCenter(),latLng2:a.getNorthEast(),scenePoint1:new Z.Point(0,0,0),scenePoint2:this._scene.latLngToScenePoint(a.getNorthEast())},this._initRootLatLng()},_refreshAnchor:function(){this._scene.getBounds();this._anchor.scenePoint1=this._scene.latLngToScenePoint(this._anchor.latLng1),this._anchor.scenePoint2=this._scene.latLngToScenePoint(this._anchor.latLng2)},_initRootLatLng:function(){var a=this._graphicRoot.root.position;this._rootLatLng=this._scene.scenePointToLatLng(new Z.Point(a.x,a.y,a.z))},_updateRenderContent:function(){var a=[],b=this._graphicObjects;for(var c in b)a.push(b[c]);Z.SingleTerrainPlane.getInstance().updateLayerContent(this._renderId,a)},_applyGraphicUpdateEvent:function(a,b){var c=this,b=b||"on";a[b]("featureupdated",c._onGraphicFeatureUpdate,c),a[b]("symbolupdated",c._onGraphicSymbolUpdate,c)},_onGraphicFeatureUpdate:function(a){var b=a.target,c=Z.Util.stamp(b,"graphic");this._graphicObjects[c].object=b.feature.shape,this._updateRenderContent()},_onGraphicSymbolUpdate:function(a){var b=a.target,c=Z.Util.stamp(b,"graphic");this._graphicObjects[c].symbol=b.symbol,this._updateRenderContent()}}),Z.GraphicLayerMergedRender3D=Z.GraphicLayerRender3D.extend({initialize:function(a){Z.GraphicLayerRender3D.prototype.initialize.apply(this,arguments),this._mergedRoot=new Z.MergedMesh3D1,this._graphicContainer=new Z.SceneThreePaneItem},onAdd:function(a,b,c,d,e){Z.GraphicLayerRender3D.prototype.onAdd.apply(this,arguments)},onRemove:function(a){Z.GraphicLayerRender3D.prototype.onRemove.apply(this,arguments),this._graphicRoot.root.remove(this._mergedRoot.root)},addGraphics:function(a,b){var c=b instanceof Array?b:b?[b]:[];if(!(c.length<=0)){for(var d=[],e=0;e<c.length;e++){var f=c[e];if((f instanceof Z.Graphic||f instanceof Z.ComposeGraphic1)&&(f.onAdd(a,this._graphicContainer,this._scene),console.info("graphicAdded:"+e),f instanceof Z.Graphic)){for(var g=this._getGraphicMesh(f._mainElement._render._renderedObject),h=0;h<g.length;h++){var i=this._recomputeVertices(g[h]);d.push(i)}this._applyGraphicChangeListener(f,"on")}}this._mergedRoot.addMeshes(d),console.info("graphicMerged:"),this._mergedRoot.root&&(this._mergedRoot.root.parent||this._graphicRoot.root.add(this._mergedRoot.root))}},removeGraphics:function(a,b){var c=b instanceof Array?b:b?[b]:[];if(!(c.length<=0))for(var d=0;d<c.length;d++){var e=c[d];if((e instanceof Z.Graphic||e instanceof Z.ComposeGraphic1)&&(e.onRemove(a,this._graphicContainer,this._scene),e instanceof Z.Graphic)){for(var f=this._getGraphicMesh(e._mainElement._render._renderedObject),g=0;g<f.length;g++)this._mergedRoot.deleteMesh(f[g].mesh);this._applyGraphicChangeListener(e,"off")}}},clear:function(){Z.GraphicLayerRender3D.prototype.clear.apply(this,arguments),this._mergedRoot.clear()},getSceneHeight:function(a){return a*(this._anchor.sceneHeight/this._anchor.latLngHeight)},_onViewReset:function(){Z.GraphicLayerRender3D.prototype._onViewReset.apply(this,arguments),this._mergedRoot.updateRasterIndex()},_refreshGraphics:function(){for(var a=this._graphicLayer.getGraphics(),b=0;b<a.length;b++)a[b].refresh()},_onZoomLevelsChange:function(){var a=this._scene.latLngToScenePoint(this._anchor.latLng1),b=this._scene.latLngToScenePoint(this._anchor.latLng2),c=(b.x-a.x)/(this._anchor.scenePoint2.x-this._anchor.scenePoint1.x);this._graphicRoot.root.scale.set(c,c,c),this._graphicRoot.root.position.set(a.x,a.y,a.z),this._scene.refresh(),this._mergedRoot.updateRasterIndex(),this._refreshGraphics()},_onMouseEvent:function(a){var b,c=a.objects||[],d=a.intersections||[],e=[],f={};console.info(a.type+":objects.length="+c.length);for(var g=0;g<d.length;g++)if(c[g]instanceof Z.Graphic&&c[g].eventCapturable&&c[g].isShowing()&&(b=Z.Util.stamp(c[g],"graphic"),this._graphicLayer.hasGraphic(c[g]))){if(f[b])continue;c[g].eventFirable&&(e[e.length]=c[g],f[b]=c[g]);break}this._fireGraphicLayerMouseEvent(a,e),this._fireGraphicsMouseEvent(a,f),this._intersectedObjects=f,"click"===a.type&&(this._nullClick(f)||(this._clickedObjects=f))},_getGraphicMesh:function(a){var b=[];if(a instanceof THREE.Mesh||a instanceof THREE.Line){var c=this._getWorldPosition(a);b.push({position:c,mesh:a})}else if(a&&a.children&&a.children.length>0)for(var d=0;d<a.children.length;d++)for(var e=this._getGraphicMesh(a.children[d]),f=0;f<e.length;f++)b.push(e[f]);return b},_getWorldPosition:function(a){var b=a.position.clone();if(a.parent){var c=this._getWorldPosition(a.parent);b=b.add(c)}return b},_recomputeVertices:function(a){var b=a.position,c=a.mesh;return c._z_posOffset=b,c},_applyGraphicChangeListener:function(a,b){if(a instanceof Z.Graphic)for(var c=["symbolupdated","featureupdated","show","hide"],d=0,e=c.length;d<e;d++)a[b](c[d],this._updateGraphic,this)},_updateGraphic:function(a){for(var b=a.target,c=this._getGraphicMesh(b._mainElement._render._renderedObject),d=0;d<c.length;d++){this._mergedRoot.deleteMesh(c[d].mesh);var e=this._recomputeVertices(c[d]);this._mergedRoot.addMeshes([e])}}}),Z.GraphicLayerTileRender3D=Z.GraphicLayerRender3D.extend({initialize:function(a,b){Z.GraphicLayerRender3D.prototype.initialize.apply(this,arguments),this._graphicContainer=new Z.SceneThreePaneItem,this._tileLoader=new Z.GraphicTileLoader(a),this._tileManager=new Z.GraphicTileManager(null,150,150),this._tileManager.tileLoader=this._tileLoader,this._tilesInit=!1},onAdd:function(a,b,c,d,e){Z.GraphicLayerRender3D.prototype.onAdd.apply(this,arguments),this._graphicRoot.root.add(this._tileManager.root),this._tileLoader.setContext({layer:a,container:this._graphicContainer,scene:b})},onRemove:function(a){Z.GraphicLayerRender3D.prototype.onRemove.apply(this,arguments),this._graphicRoot.root.remove(this._tileManager.root)},addGraphics:function(a,b){this._tilesInit||(this._refreshTiles(),this._tilesInit=!0);var c=b instanceof Array?b:b?[b]:[];c.length<=0||(this._tileLoader.addGraphics(c),this._refreshTiles())},removeGraphics:function(a,b){var c=b instanceof Array?b:b?[b]:[];if(!(c.length<=0)){for(var d=0;d<c.length;d++){var e=c[d];if((e instanceof Z.Graphic||e instanceof Z.ComposeGraphic1)&&(e.onRemove(a,this._graphicContainer,this._scene),e instanceof Z.Graphic)){var f=this._checkGraphics([e]);this._tileManager.removeGraphics(f)}}this._tileManager.refreshVisibleTiles()}},_onViewReset:function(){Z.GraphicLayerRender3D.prototype._onViewReset.apply(this,arguments),this._refreshTiles()},_onMoveEnd:function(){Z.GraphicLayerRender3D.prototype._onMoveEnd.apply(this,arguments),this._refreshTiles()},_onZoomLevelsChange:function(){Z.GraphicLayerRender3D.prototype._onZoomLevelsChange.apply(this,arguments),this._refreshTiles()},_refreshTiles:function(){var a=this._graphicLayer.getLayerSceneBounds();this._tileManager.updateVisibleBBox(a)},_refreshGraphics:function(){for(var a=this._graphicLayer.getGraphics(),b=0;b<a.length;b++)a[b].isAdded()&&a[b].refresh()}}),Z.VectorTileRender3D=Z.GraphicLayerTileRender3D.extend({initialize:function(a,b){Z.GraphicLayerTileRender3D.prototype.initialize.apply(this,arguments),this._tileLoader=new Z.VectorTileLoader(a);var c=b.pyramidModel,d=b.levelMapping;this._tileManager=new Z.VectorTileManager(c,d),this._tileManager.tileLoader=this._tileLoader},onAdd:function(a,b,c,d,e){Z.GraphicLayerTileRender3D.prototype.onAdd.apply(this,arguments),this._refreshTiles()},_refreshTiles:function(){var a=this._scene.getContentBounds(),b=this._scene.getBounds(),c=this._scene.getSize(),d=c.x*(a.getEast()-a.getWest())/(b.getEast()-b.getWest()),e=c.y*(a.getNorth()-a.getSouth())/(b.getNorth()-b.getSouth());this._tileManager.updateVisibleBBox(a,new Z.Point(d,e))},_applyEvents:function(a){Z.GraphicLayerTileRender3D.prototype._applyEvents.call(this,a),this._tileManager[a]("tileload",this._fireTileLoadEvent,this),this._tileManager[a]("tileupdate",this._fireTileUpdateEvent,this),this._tileManager[a]("tileremove",this._fireTileRemoveEvent,this)},_fireTileLoadEvent:function(a){this.fire("tileload",{row:a.row,col:a.col,graphics:a.graphics})},_fireTileUpdateEvent:function(a){this.fire("tileupdate",{row:a.row,col:a.col})},_fireTileRemoveEvent:function(a){this.fire("tileremove",{row:a.row,col:a.col,graphics:a.graphics})}}),Z.ScenePaneItem=Z.Class.extend({initialize:function(){this.root=this.createRootObject(),this._children=[],this.index=0},createRootObject:function(){},addChild:function(a,b){a instanceof this.constructor&&("number"==typeof b&&(a.index=b),a.parent,this.addElementToRoot(a.root,a.index),this._children.push(a))},addElementToRoot:function(a,b){},removeChild:function(a){a instanceof this.constructor&&(this.removeElementFromRoot(a.root),Z.Util.removeFromArray(this._children,a))},removeElementFromRoot:function(a){},setChildIndex:function(a,b){"number"==typeof b&&(a.index=b,this.setElementIndex(this.root,a.root,a.index))},setElementIndex:function(a,b,c){},show:function(){},hide:function(){},resetRoot:function(){this.root=this.createRootObject()},getMaxChildIndex:function(){for(var a=0,b=0;b<this._children.length;b++)a<this._children[b].index&&(a=this._children[b].index);return a},getPosition:function(){},setPosition:function(a){},setScale:function(a){},newInstance:function(){}}),Z.SceneDivPaneItem=Z.ScenePaneItem.extend({createRootObject:function(){var a=document.createElement("div");return a.className="zmap-view-pane",a},addElementToRoot:function(a,b){a&&(0==this.root.childNodes.length?(this.root.appendChild(a),b=b||0):(b=Z.Util.limitIndexToArray(this.root.childNodes,b),b>=this.root.childNodes.length?this.root.appendChild(a):this.root.insertBefore(a,this.root.childNodes[b])),a.style.zIndex=b)},removeElementFromRoot:function(a){if(a)try{this.root.removeChild(a)}catch(a){}},setElementIndex:function(a,b,c){!Z.Util.isNull(c)&&b&&(b.style.zIndex=c)},show:function(){this.root.style.display="block"},hide:function(){this.root.style.display="none"},getPosition:function(){return{x:this.root.offsetLeft,y:this.root.offsetTop,z:0}},setPosition:function(a){a=a||{},this.root.style.left=isNaN(parseInt(a.x))?this.root.style.left:parseInt(a.x),this.root.style.top=isNaN(parseInt(a.y))?this.root.style.top:parseInt(a.y)},setWidth:function(a){isNaN(a)||(this.root.style.width=a+"px")},setHeight:function(a){isNaN(a)||(this.root.style.height=a+"px")},setScale:function(a){},newInstance:function(){return new Z.SceneDivPaneItem}}),Z.SceneThreePaneItem=Z.ScenePaneItem.extend({initialize:function(){Z.ScenePaneItem.prototype.initialize.call(this,arguments),this._objects=[]},createRootObject:function(){return new THREE.Object3D},addElementToRoot:function(a,b){this._objects.push({element:a,index:b}),this._appendObjects([{element:a,index:b}])},removeElementFromRoot:function(a){this.root.remove(a);for(var b=this._objects.length-1;b>=0;b--)a===this._objects[b].element&&this._objects.splice(b,1)},setElementIndex:function(a,b,c){this.removeElementFromRoot(b),this.addElementToRoot(b,c)},show:function(){this.root.visible=!0},hide:function(){this.root.visible=!1},_appendObjects:function(a){for(var b=0;b<a.length;b++)this.root.add(a[b].element)},getPosition:function(){return{x:this.root.position.x,y:this.root.position.y,z:this.root.position.z}},setPosition:function(a){a=a||{};var b=isNaN(parseFloat(a.x))?this.root.position.x:parseFloat(a.x),c=isNaN(parseFloat(a.y))?this.root.position.y:parseFloat(a.y),d=isNaN(parseFloat(a.z))?this.root.position.z:parseFloat(a.z);this.root.position.set(b,c,d)},setScale:function(a){a=a||{};var b=isNaN(parseFloat(a.x))?1:parseFloat(a.x),c=isNaN(parseFloat(a.y))?1:parseFloat(a.y),d=isNaN(parseFloat(a.z))?1:parseFloat(a.z);this.root.scale.set(b,c,d)},newInstance:function(){return new Z.SceneThreePaneItem}}),Z.LayerGroup={},Z.LayerGroup.BaseBgLayer=1,Z.LayerGroup.BaseOverLayer=2,Z.LayerGroup.BusinessLayer=3,Z.SurfacePlane=Z.Class.extend({initialize:function(a,b){this._scene=a,this._container=b,this._tileMaterial=null,this._tilePlane=null,this._tileTexture=null,this._graphicHotAreaTexture=null,this._currentZoom=0,this._currentGridZoom=0,this._onAddDone=!1;var c=this;Object.defineProperties(this,{needsUpdate:{get:function(){return!!c._tileTexture&&c._tileTexture.needsUpdate}}}),this._initTileMaterial()},onAdd:function(a,b,c){this._onAddDone&&this.onRemove(),this._scene=a,this._container=c,this._pyramidModel=b,this._createTilePane(),this._createHotAreaPane(),this._appendTilePane(),this._updateTilePane(),this._applyEvents("on"),this._onAddDone=!0},onRemove:function(){this._scene=null,this._container=null,this._removeTilePane(),this._disposeTilePane(),this._disposeHotAreaPane(),this._applyEvents("off"),this._onAddDone=!1},addSurfaceLayer:function(a,b,c,d,e){if(this._tileTexture){var f=this._getLayerOptions(e);this._tileTexture.addSurfaceLayer(a,b,c,d,f)}this._graphicHotAreaTexture&&"graphic"===b&&this._graphicHotAreaTexture.addSurfaceLayer(a,b,c,d,f)},removeSurfaceLayer:function(a){this._tileTexture&&this._tileTexture.removeSurfaceLayer(a),this._graphicHotAreaTexture&&this._graphicHotAreaTexture.removeSurfaceLayer(a)},updateLayerIndex:function(a,b){this._tileTexture&&this._tileTexture.updateLayerIndex(a,b),this._graphicHotAreaTexture&&this._graphicHotAreaTexture.updateLayerIndex(a,b)},updateLayerContent:function(a,b,c){if(this._tileTexture){var d=this._getLayerOptions(c);this._tileTexture.updateLayerContent(a,b,d)}if(this._graphicHotAreaTexture){var d=this._getLayerOptions(c);this._graphicHotAreaTexture.updateLayerContent(a,b,d)}},draw:function(){this._tileTexture&&(this._tileTexture.clear(),this._tileTexture.draw(),this._tilePlane.material&&(this._tilePlane.material.map&&(this._tilePlane.material.map.needsUpdate=!0),console.info("Z.SurfacePlane.draw() done"),this._tilePlane.material.needsUpdate=!0)),this._graphicHotAreaTexture&&(this._graphicHotAreaTexture.clear(),this._graphicHotAreaTexture.draw())},refresh:function(){if(this._tileTexture){if(!this._tileTexture.needsUpdate)return;this.draw(),this._tileTexture.needsUpdate=!1}},getGraphic:function(a,b){return this._graphicHotAreaTexture?this._graphicHotAreaTexture.getGraphic(a,b):null},enablePolygonOffset:function(a,b){var c=this._tileMaterial;if(c.polygonOffset=!0,c.polygonOffsetFactor=a||(c.polygonOffsetFactor||1),c.polygonOffsetUnits=b||(c.polygonOffsetUnits||1),c.needsUpdate=!0,this._tilePlane){var d=this._tilePlane.material;d.polygonOffset=!0,d.polygonOffsetFactor=c.polygonOffsetFactor,d.polygonOffsetUnits=c.polygonOffsetUnits,d.needsUpdate=!0}},disablePolygonOffset:function(){this._tileMaterial.polygonOffset=!1,this._tileMaterial.needsUpdate=!0,this._tilePlane&&(this._tilePlane.material.polygonOffset=!1,this._tilePlane.material.needsUpdate=!0)},_initTileMaterial:function(){var a=new THREE.MeshBasicMaterial({transparent:!0,opacity:1,fog:!0});this._tileMaterial=a},_createTilePane:function(){var a=this._tileMaterial.clone();this._tilePlane=new THREE.Mesh(new THREE.PlaneGeometry(1,1),a),this._tileTexture=new Z.AggragatedSurfaceTexture;var b=this._tileTexture.getElement(),c=new THREE.Texture(b);c.minFilter=THREE.NearestFilter,c.magFilter=THREE.LinearFilter,c.anisotropy=256,a.map=c},_createHotAreaPane:function(){this._graphicHotAreaTexture=new Z.HotAreaTexture},_appendTilePane:function(){for(var a=!1,b=this._container,c=0;c<b.children.length;c++)if(b.children[c]===this._tilePlane){a=!0;break}a||(b.add(this._tilePlane),this._tilePlane._graphicObj=this)},_removeTilePane:function(){for(var a=!1,b=this._container,c=0;c<b.children.length;c++)if(b.children[c]===this._tilePlane){a=!0;break}a&&b.remove(this._tilePlane)},_disposeTilePane:function(){this._tilePlane&&(this._tilePlane.material&&(this._tilePlane.material.map&&this._tilePlane.material.map.dispose(),this._tilePlane.material.dispose()),this._tilePlane=null)},_applyEvents:function(a){var b=this;this._scene[a]("viewreset",b._onViewReset,b),this._scene[a]("zoomlevelschange",b._onZoomChange,b)},_onViewReset:function(a){this._updateTilePane()},_onZoomChange:function(a){this._renderTileSize=null,this._updateTilePane()},_onDragStart:function(a){this._dragStartPoint=this._tilePlane.position.clone()},_onDrag:function(a){var b=this._scene;if(a.startPoint&&a.newPoint){var c=b.screenPointToScenePoint(a.startPoint),d=b.screenPointToScenePoint(a.newPoint);if(c&&d){var e=d.subtract(c);this._tilePlane.position.x=this._dragStartPoint.x+e.x,this._tilePlane.position.y=this._dragStartPoint.y+e.y,this._tilePlane.position.z=this._dragStartPoint.z+e.z,this._scene.refresh()}}},_onDragEnd:function(a){this._tilePlane.position.x=this._dragStartPoint.x,this._tilePlane.position.y=this._dragStartPoint.y,this._tilePlane.position.z=this._dragStartPoint.z,this._dragStartPoint=null},_updateTilePane:function(){var a=this._scene.getContentBounds(),b=this._scene.getBounds(),c=this._scene.getSize(),d=this._pyramidModel.fitZoomLevel(b,c.x,c.y),e=d.level,f=null;d.outOfScaleBounds||(f=this._pyramidModel.getTileBounds(a,e),this._currentZoom=e,this._currentGridZoom=void 0===f.min.z?e:f.min.z,this._updateTilePaneGeometrySize(f,e),this._setTilePlaneGeometryPos(f,this._currentGridZoom),this._updateTileTexture(this._tileTexture,f,this._currentGridZoom),this._updateTileTexture(this._graphicHotAreaTexture,f,this._currentGridZoom))},_updateTilePaneGeometrySize:function(a,b){this._renderTileSize||(this._renderTileSize=this._getRenderTileSize(new Z.Point(a.min.x,a.min.y,b)));var c=a.getSize().x+1,d=a.getSize().y+1,e=new THREE.PlaneGeometry(this._renderTileSize.x*c,this._renderTileSize.y*d);this._tilePlane.geometry=e},_getRenderTileSize:function(a){var b=this._pyramidModel.getLatLngBounds(a,a.z),c=this._scene.latLngToScenePoint(b.getSouthWest()),d=this._scene.latLngToScenePoint(b.getNorthEast());return new Z.Point(Math.abs(c.x-d.x),Math.abs(c.y-d.y))},_setTilePlaneGeometryPos:function(a,b){if(this._tilePlane){var c=this._getTileBoundsCenter(a,b);this._tilePlane.position.set(c.x,c.y,c.z)}},_getTileBoundsCenter:function(a,b){var c=this._pyramidModel.getLatLngBounds(a.min,b),d=this._pyramidModel.getLatLngBounds(a.max,b),e=c.getNorth(),f=c.getWest(),g=d.getSouth(),h=d.getEast();return this._scene.latLngToScenePoint(new Z.LatLng((g+e)/2,(h+f)/2))},_updateTileTexture:function(a,b,c){var d=this._pyramidModel.getTopLeftPixelPointOfBounds(b);a.setTileAnchor(d.x,d.y);var e=this._getLatLngBounds(b,c);a.setLatLngBounds(e);var f=this._pyramidModel.getTileSize(),g=b.getSize().x+1,h=b.getSize().y+1,i=this._tileTexture.getSize(),j=g*f.x,k=h*f.y;i.x===j&&i.y===k||a.setTextureSize(j,k)},_getLatLngBounds:function(a,b){var c=this._pyramidModel.getLatLngBounds(a.min,b),d=this._pyramidModel.getLatLngBounds(a.max,b),e=new Z.LatLng(0,0),f=new Z.LatLng(0,0);return e.lat=d.getSouth(),e.lng=c.getWest(),f.lat=c.getNorth(),f.lng=d.getEast(),new Z.LatLngBounds(e,f)},_disposeHotAreaPane:function(){this._graphicHotAreaTexture&&(this._graphicHotAreaTexture.material&&(this._graphicHotAreaTexture.material.map&&this._graphicHotAreaTexture.material.map.dispose(),this._graphicHotAreaTexture.material.dispose()),this._graphicHotAreaTexture=null)},_getLayerOptions:function(a){if(a&&a.tileBounds&&a.pyramidModel){var b=a.pyramidModel.getTopLeftPixelPointOfBounds(a.tileBounds),c=new Z.LatLng(60,180),d=a.pyramidModel.getOrigin(),e=this._pyramidModel.latLngToPixelPoint(d,this._currentGridZoom),f=this._pyramidModel.latLngToPixelPoint(c,this._currentGridZoom),g=a.pyramidModel.latLngToPixelPoint(c,a.tileZoom),h=f.x/g.x,i=f.y/g.y,j=new Z.Point;j.x=e.x+b.x*h,j.y=e.y+b.y*i;return{width:a.width*h,height:a.height*i,tileBounds:a.tileBounds,topLeft:j,pyramidModel:a.pyramidModel}}}}),Z.SingleTerrainPlane=function(){var a=null;return{getInstance:function(){var b=null,c=null;try{getCurrentMapContext&&(b=getCurrentMapContext())}catch(a){}return b?(c=b.getSingleInstance("SingleTerrainPlane"),c||b.registerSingleInstance("SingleTerrainPlane",new Z.SurfacePlane),c=b.getSingleInstance("SingleTerrainPlane")):(a||(a=new Z.SurfacePlane),c=a),c}}}(),Z.MapContentFrame=function(a){this.basePane,this.layerPane,this.defaultGraphicPane,this.baseBgPane,this.baseOverPane,this.rootPane,this._container=a,this.initialize()},Z.MapContentFrame.prototype={initialize:function(){this.rootPane=new Z.SceneThreePaneItem,this.basePane=new Z.SceneThreePaneItem,this.layerPane=new Z.SceneThreePaneItem,this.defaultGraphicPane=new Z.SceneThreePaneItem,this.baseBgPane=new Z.SceneThreePaneItem,this.baseOverPane=new Z.SceneThreePaneItem,this._initLayout()},_initLayout:function(){this._container&&(this.rootPane.root=this._container),this.rootPane.addChild(this.basePane,1),this.rootPane.addChild(this.defaultGraphicPane,5),this.basePane.addChild(this.baseBgPane,2),this.basePane.addChild(this.baseOverPane,3),this.basePane.addChild(this.layerPane,4)}},Z.SceneViewFrame=function(a){this.controlPane,this.popupPane,this.labelPane,this.tipPane,this.mapPane,this.rootPane,this._container=a,this.initialize()},Z.SceneViewFrame.prototype={initialize:function(){this.rootPane=new Z.SceneDivPaneItem,this.controlPane=new Z.SceneDivPaneItem,this.popupPane=new Z.SceneDivPaneItem,this.labelPane=new Z.SceneDivPaneItem,this.tipPane=new Z.SceneDivPaneItem,this.mapPane=new Z.SceneDivPaneItem,this._initLayout(),this._applyResizeEvent("on")},resize:function(){this._resize()},_initLayout:function(){this._container&&(this._resize(),this.rootPane.root=this._container,this.rootPane.addChild(this.mapPane,0),this.rootPane.addChild(this.labelPane,1),this.rootPane.addChild(this.tipPane,2),this.rootPane.addChild(this.popupPane,3),this.rootPane.addChild(this.controlPane,4))},_applyResizeEvent:function(a){if(this._container){a=a||"on";var b=this;Z.DomEvent.addListener(this._container,"resize",function(){b._resize()},this)}},_resize:function(){var a=this._container.clientWidth,b=this._container.clientHeight;this._setPanelSize(this.mapPane,a,b),this._setPanelSize(this.labelPane,a,b)},_setPanelSize:function(a,b,c){a.root.style.width=b+"px",a.root.style.height=c+"px"}},Z.Postprocessing=function(a,b,c,d){this._scene=a,this._camera=b,this._renderer=c,this._effectComposer,this._ssaoPass,this._smaaPass,this.options={smaa:{enable:!0},ssao:{onlyAO:!1,radius:32,aoClamp:.25,lumInfluence:.7}},d=d||{},Z.Util.applyOptions(this.options.ssao,d.ssao||{},!1),Z.Util.applyOptions(this.options.smaa,d.smaa||{},!1),this.initialize()},Z.Postprocessing.prototype={initialize:function(){var a=new THREE.RenderPass(this._scene,this._camera);this._ssaoPass=new THREE.SSAOPass(this._scene,this._camera),this._ssaoPass.renderToScreen=!0;var b=this._renderer.getSize();this._smaaPass=new THREE.SMAAPass(b.width*this._renderer.getPixelRatio(),b.height*this._renderer.getPixelRatio()),this._smaaPass.renderToScreen=!0,this._effectComposer=new THREE.EffectComposer(this._renderer),this._effectComposer.addPass(a),this._effectComposer.addPass(this._smaaPass),this._effectComposer.addPass(this._ssaoPass)},render:function(){this._effectComposer&&this._effectComposer.render()}},Z.SceneRender3D=function(a,b){if(this._container=a,!a)throw new error("Z.SceneRender3D对象创建失败：container参数不能为空");this.needsUpdate=!0,this._initialized=!1,this._objects=[],this._cameraObject=null,this._rawCameraObject=null,this._radRotation=null,this._ambientLightObject=null,this._lightObject=null,this._reverseLightObject=null,this._sceneObject=null,this._renderObject=null,this._xyPlane=null,this._viewCenter=new THREE.Vector3(0,0,0),this._updateChecker=[],this._removedUpdateChecker=[],this._postprocessingObject=null,this._enablePostprocessing=!0,this.options={width:400,height:400,bgColor:"#000000",ambientColor:"#666666",lightColor:"#aaaaaa",lightIntensity:1,lightAngle:{h:30,v:45},fogColor:"#f2f7ff",cameraFov:45,cameraNear:1,cameraFar:150,cameraPosition:{x:0,y:0,z:50},cameraRotation:{x:0,y:0,z:0},showFrameRate:!1},Z.Util.applyOptions(this.options,b,!1),this.initialize()},Z.SceneRender3D.prototype={initialize:function(){this._cameraObject=new THREE.PerspectiveCamera(this.options.cameraFov,this.options.width/this.options.height,this.options.cameraNear,this.options.cameraFar),this._initCameraPosition(),this.rotateByEuler(this.options.cameraRotation),this._ambientLightObject=new THREE.AmbientLight(this.options.ambientColor),this._lightObject=new THREE.DirectionalLight(this.options.lightColor,this.options.lightIntensity),this._reverseLightObject=new THREE.DirectionalLight(this.options.ambientColor,this.options.lightIntensity),this.setLightPosition(this.options.lightAngle),this._sceneObject=new THREE.Scene,this._sceneObject.add(this._ambientLightObject),this._sceneObject.add(this._lightObject),this._sceneObject.add(this._reverseLightObject),this._xyPlane=this._createXYPlane(this.options.cameraFov,this.options.cameraFar,this.options.width/this.options.height),this._sceneObject.add(this._xyPlane),this._renderObject=new THREE.WebGLRenderer({antialias:!0,alpha:!0,precision:"highp"}),this._renderObject.sortObjects=!1,this._renderObject.setClearColor(this.options.bgColor),window.devicePixelRatio&&this._renderObject.setPixelRatio(window.devicePixelRatio),this._renderObject.setSize(this.options.width,this.options.height),this._container.appendChild(this._renderObject.domElement),this._enablePostprocessing&&(this._postprocessingObject=new Z.Postprocessing(this._sceneObject,this._cameraObject,this._renderObject)),this._initialized=!0},addUpdateChecker:function(a){a&&this._updateChecker.push(a)},removeUpdateChecker:function(a){if(a){for(var b=this._updateChecker,c=b.length,d=0;d<c;d++)if(b[d]===a){b.splice(d,1);break}this._removedUpdateChecker.push(a)}},render:function(){if(!this._renderLoopRunging){this._initialized||(this.initialize(),this._initialized=!0,console.info("initialize()")),this._renderObject.setClearColor(this.options.bgColor);try{this._runRenderLoop(),this._renderLoopRunging=!0}catch(a){console.error(a.message)}}},_runRenderLoop:function(){function a(){b.options.showFrameRate&&Z.RenderMonitor.update();var c=b.needsUpdate,d=Z.SingleTerrainPlane.getInstance();c||(c=d.needsUpdate),b._removedUpdateChecker.length>0&&(c=!0);var e=b._updateChecker,f=e.length,g=0;if(!c)for(g=0;g<f;g++)if(e[g].needsUpdate){c=!0;break}for(Z.TileManager.loadImages(),d.refresh(),Z.GraphicAnimation.run(),b._loopCount>=5?b._loopCount=0:c&&(b._renderObject.clear(),this._enablePostprocessing&&this._postprocessingObject?this._postprocessingObject.render():b._renderObject.render(b._sceneObject,b._cameraObject),b._loopCount++,b.needsUpdate=!1),g=0;g<f;g++)e[g].resetUpdateState&&e[g].resetUpdateState();this._removedUpdateChecker=[],requestAnimationFrame(a)}requestAnimationFrame(a);var b=this;void 0===this._loopCount&&(this._loopCount=0)},resize:function(a,b){a&&b||(a=this._container.clientWidth,b=this._container.clientHeight);var c=this.options.height;this.options.width=a,this.options.height=b,this._renderObject.setSize(a,b);var d=c/(2*Math.tan(this._cameraObject.fov/2*(Math.PI/180))),e=2*Math.atan(b/(2*d))*180/Math.PI;this._cameraObject.fov=e,this._cameraObject.aspect=this.options.width/this.options.height,this._cameraObject.updateProjectionMatrix()},getSize:function(){return Z.Point.create(this.options.width,this.options.height)},setViewCenter:function(a){if(a&&(a instanceof THREE.Vector3||a instanceof Z.Point)){var b=a;a instanceof Z.Point&&(b=new THREE.Vector3(a.x,a.y,a.z));var c=b.clone().sub(this._viewCenter);this._cameraObject.position.add(c),this._cameraObject.updateMatrix(),this._cameraObject.updateMatrixWorld(!0),console.info("Z.SceneRender3D.setViewCenter:camera position:("+this._cameraObject.position.x+", "+this._cameraObject.position.y+", "+this._cameraObject.position.z+")"),this._viewCenter.x=b.x,this._viewCenter.y=b.y,this._viewCenter.z=b.z}},resetCamera:function(){this._cameraObject=this._rawCameraObject.clone(),this._viewCenter.set(0,0,0),this._cameraObject.updateMatrixWorld()},rotateByRad:function(a){if(a&&"number"==typeof a.x&&"number"==typeof a.y&&"number"==typeof a.z){var b=this._getRotationMatrix(a,this.options.cameraRotation),c=new THREE.Vector3,d=new THREE.Quaternion,e=new THREE.Vector3;b.decompose(c,d,e),this._cameraObject.position.applyMatrix4(b),this._cameraObject.up.applyQuaternion(d),this._cameraObject.lookAt(this._viewCenter.clone()),this._cameraObject.updateMatrix(),this._cameraObject.updateMatrixWorld(),this._cameraObject.updateProjectionMatrix()}},getCameraDirection:function(){var a=this._cameraObject.getWorldDirection();return new Z.Point(a.x,a.y,a.z)},rotateByEuler:function(a){if(a&&"number"==typeof a.x&&"number"==typeof a.y&&"number"==typeof a.z){var b={};b.x=a.x*Math.PI/180,b.y=a.y*Math.PI/180,b.z=a.z*Math.PI/180,this.rotateByRad(b)}},rotateByVH:function(a,b){if(a=a||0,b=b||0,0!==a||0!==b){var c=this.webGLPointToScreen(new Z.Point(0,0,0)),d=new Z.Point(0,c.y),e=new Z.Point(this.options.width,c.y),f=this.screenPointToWebGL(d),g=this.screenPointToWebGL(e);if(f&&g){var h=new THREE.Vector3(g.x-f.x,g.y-f.y,g.z-f.z).normalize(),i=new THREE.Matrix4,j=new THREE.Matrix4;i.makeRotationAxis(h,-Math.PI*a/180),j.makeRotationZ(Math.PI*b/180),i.multiply(j);var k=new THREE.Vector3,l=new THREE.Quaternion,m=new THREE.Vector3;i.decompose(k,l,m),this.rotateByRad(l)}}},setLightPosition:function(a){if(a){var b=this._getLightDistance(),c=this._getLightPosition(a,b);this._lightObject.position.set(c.x,c.y,c.z),this._reverseLightObject.position.set(-c.x,-c.y,-c.z)}},setLightShadow:function(){var a=2*this._getLightDistance();this._lightObject.castShadow=!0,this._lightObject.shadow.camera.near=.1,this._lightObject.shadow.camera.far=a,this._lightObject.shadow.camera.left=-a,this._lightObject.shadow.camera.right=a,this._lightObject.shadow.camera.top=a,this._lightObject.shadow.camera.bottom=-a,this._lightObject.shadow.mapSize.width=5120,this._lightObject.shadow.mapSize.height=5120},setAmbientColor:function(a){this._ambientLightObject.color=new THREE.Color(a)},setLightColor:function(a){this._lightObject.color=new THREE.Color(a),this._reverseLightObject.color=new THREE.Color(a)},setBgColor:function(a){this.options.bgColor=a},addObject:function(a,b){this._addObject(a,b)},removeObject:function(a){this._removeObject(a)},reorderObject:function(a,b){this._removeObject(a),this._addObject(a,b)},screenPointToWebGL:function(a){if(!a||Z.Util.isNull(a.x)||Z.Util.isNull(a.y))return null;var b=this.options.width/2,c=this.options.height/2,d=new THREE.Raycaster,e=new THREE.Vector2((a.x-b)/b,(c-a.y)/c),f=this._getIntersectPoint(d,this._xyPlane,e,this._cameraObject);return f?Z.Point.create(f.x,f.y,f.z):null},webGLPointToScreen:function(a){if(!a||Z.Util.isNull(a.x)||Z.Util.isNull(a.y)||Z.Util.isNull(a.z))return null;var b=new THREE.Vector3(a.x,a.y,a.z),c=b.project(this._cameraObject),d=this.options.width/2,e=this.options.height/2;return{x:Math.round(c.x*d+d),y:Math.round(-c.y*e+e)}},getOrthoGLBounds:function(){var a=this._viewCenter,b=this._cameraObject.position.distanceTo(a),c=b*Math.tan(Math.PI*this._cameraObject.fov/360),d=c*this.options.width/this.options.height,e=new Z.Point(a.x-d,a.y+c),f=new Z.Point(a.x+d,a.y-c);return Z.GLBounds.create(e,f)},getVisibleGLBounds:function(){var a=new THREE.Raycaster;console.info("Z.SceneRender3D.getVisibleGLBounds:_cameraObject.position: x="+this._cameraObject.position.x+", y="+this._cameraObject.position.y+", z="+this._cameraObject.position.z);var b=this._getIntersectPoint(a,this._xyPlane,new THREE.Vector2(-1,1),this._cameraObject),c=this._getIntersectPoint(a,this._xyPlane,new THREE.Vector2(-1,-1),this._cameraObject),d=this._getIntersectPoint(a,this._xyPlane,new THREE.Vector2(1,1),this._cameraObject),e=this._getIntersectPoint(a,this._xyPlane,new THREE.Vector2(1,-1),this._cameraObject),f=[b,c,e,d];if(!(b&&c&&d&&e))for(var g=new ThreeBSP(this._xyPlane),h=new ThreeBSP(this._getCameraBox(this._cameraObject)),i=g.intersect(h).toGeometry(),j=i.vertices,k=0;k<j.length;k++)f.push(j[k]);return Z.Util.getVectorBounds(f)},getMaxAnisotropy:function(){return this._renderObject.getMaxAnisotropy()},getRotateByRad:function(){var a=this._cameraObject.quaternion.clone();return{x:a.x,y:a.y,z:a.z,w:a.w}},getVHRotateByRad:function(){var a=this.getRotateByRad(),b=new THREE.Vector3(0,0,1),c=this._cameraObject.position,d=b.project(this._cameraObject),e=Math.atan(Math.abs(c.z)/Math.sqrt(Math.pow(c.x,2)+Math.pow(c.y,2))),f=e,g=a.z;return d.y<0&&(f=Math.PI-f),c.z<0&&(f=-f),{v:f,h:g}},calculateVHRotation:function(a,b){if(!a||!b)return null;var c=this.screenPointToWebGL(a),d=this.screenPointToWebGL(new Z.Point(b.x,a.y,a.z)),e=0,f=0;if(c&&d){var g=new THREE.Vector3(c.x,c.y,0),h=new THREE.Vector3(d.x,d.y,0);e=(g.clone().cross(h).z>0?-1:1)*g.angleTo(h)*180/Math.PI}var i=new THREE.Raycaster,j=new THREE.Raycaster,k=this.options.width/2,l=this.options.height/2,m=new THREE.Vector3((a.x-k)/k,(l-a.y)/l,0),n=new THREE.Vector3((a.x-k)/k,(l-b.y)/l,0);i.setFromCamera(m,this._cameraObject),j.setFromCamera(n,this._cameraObject);var o=this._cameraObject.position,p=o.distanceTo(new THREE.Vector3(0,0,0)),q=new THREE.Plane(o,-(p-this._cameraObject.near)),r=i.ray.intersectPlane(q),s=j.ray.intersectPlane(q);if(r&&s){r.clone().cross(s);f=(b.y>a.y?-1:1)*r.angleTo(s)*180/Math.PI}return{h:e,v:f}},getIntersectObjects:function(a){var b=this.options.width/2,c=this.options.height/2,d=new THREE.Raycaster,e=new THREE.Vector3((a.x-b)/b,(c-a.y)/c,0);d.setFromCamera(e,this._cameraObject);var f=d.intersectObjects(this._sceneObject.children,!0),g=[],h=0;if(3===f.length);else if(4===f.length);for(var i=0;i<f.length;i++)if(f[i].object._graphicObj){for(var j=!1,k=0;k<g.length;k++)if(g[k].graphic===f[i].object._graphicObj){j=!0;break}j||(g[h]={graphic:f[i].object._graphicObj,rawIntersection:f[i]},h++)}return g},getFillScale:function(a){if(a){var b=new THREE.Vector3(a.max.x-a.min.x,a.max.y-a.min.y,a.max.z-a.min.z).length()/2,c=this._cameraObject.distanceTo(this._viewCenter),d=c*Math.sin(Math.PI*this._cameraObject.fov/360),e=this._cameraObject.aspect*c*Math.tan(Math.PI*this._cameraObject.fov/360),f=this._cameraObject.far-this._cameraObject.near,g=e*c/Math.sqrt(Math.pow(e,2)+Math.pow(c,2));return b/Math.min(f,d,g)}},_initCameraPosition:function(){this._cameraObject.position.x=this.options.cameraPosition.x,this._cameraObject.position.y=this.options.cameraPosition.y,this._cameraObject.position.z=this.options.cameraPosition.z,this._cameraObject.lookAt(this._viewCenter.clone()),this._cameraObject.updateMatrixWorld(),this._rawCameraObject=this._cameraObject.clone()},_getLightPosition:function(a,b){if(!a)return null;b=b||1;var c=b*Math.cos(a.v*Math.PI/180);return{x:c*Math.cos(a.h*Math.PI/180),y:c*Math.sin(a.h*Math.PI/180),z:b*Math.sin(a.v*Math.PI/180)}},_getLightDistance:function(){var a=this._cameraObject.far*Math.tan(Math.PI*this._cameraObject.fov/360),b=this._cameraObject.far/Math.cos(Math.PI*this._cameraObject.fov/360);return 1.1*Math.max(2*a,b)},_getRotationMatrix:function(a,b){var c=b?b.x*Math.PI/180+a.x:a.x,d=b?b.y*Math.PI/180+a.y:a.y,e=b?b.z*Math.PI/180+a.z:a.z,f=new THREE.Matrix4,g=new THREE.Matrix4,h=new THREE.Matrix4,i=new THREE.Matrix4;return g.makeRotationX(c),h.makeRotationY(d),i.makeRotationZ(e),f.multiplyMatrices(g,h),f.multiply(i),f},_createXYPlane:function(a,b,c){var d=b*Math.tan(Math.PI*a/360),e=b/Math.cos(Math.PI*a/360),f=1e8*Math.max(2*d,e),g=f*c*1e8,h=new THREE.PlaneGeometry(g,f),i=new THREE.MeshBasicMaterial({color:"#ffffff"});i.polygonOffset=!0,i.polygonOffsetFactor=-1,i.polygonOffsetUnits=-1,i.side=THREE.DoubleSide;var j=new THREE.Mesh(h,i);return j.visible=!1,j},_addObject:function(a,b){this._removeFromScene(this._objects),Z.Util.addToArray(this._objects,a,b),this._appendToScene(this._objects)},_removeFromScene:function(a){for(var b=a.length,c=0;c<b;c++)this._sceneObject.remove(a[c])},_appendToScene:function(a){for(var b=a.length,c=0;c<b;c++)this._sceneObject.add(a[c])},_removeObject:function(a){var b=a instanceof Array?a:[a];this._removeFromScene(b),Z.Util.removeFromArray(this._objects,a)},_getIntersectPoint:function(a,b,c,d){a.setFromCamera(c,d);var e=[];return b.raycast(a,e),e.length>0?e[0].point:null},_getCameraBox:function(a){for(var b,c=[[-1,1,-1],[-1,-1,-1],[1,-1,-1],[1,1,-1],[-1,1,1],[-1,-1,1],[1,-1,1],[1,1,1]],d=[],e=c.length,f=0;f<e;f++)b=new THREE.Vector3(c[f][0],c[f][1],c[f][2]),d[f]=b.unproject(a);return new THREE.ConvexGeometry(d)}},Z.Scene2D=Z.IScene.extend({initialize:function(a,b){this.options=b,this._containerLeft=a?a.offsetLeft:0,this._containerTop=a?a.offsetTop:0,this._viewFrame=new Z.SceneViewFrame(a),this._contentFrame=new Z.MapContentFrame,this._leafletMap=this._getLeafletMap(this._viewFrame.mapPane.root,b),this._currentLevel=this._leafletMap.getZoom(),this._applyEvents("on")},getBounds:function(){var a=this._leafletMap.getBounds();return Z.LeafletUtil.latLngBoundsFromLeaflet(a)},getPixelSceneRatio:function(){return new Z.Point.create(1,1)},getLatLngSceneRatio:function(){var a=this.getBounds(),b=this.getSize(),c=(a.getEast()-a.getWest())/b.x,d=(a.getNorth()-a.getSouth())/b.y;return new Z.Point.create(c,d)},setZoom:function(a){this._leafletMap.setZoom(a)},getZoom:function(){return this._leafletMap.getZoom()},getScale:function(a){throw new error("尚未实现")},getSize:function(){var a=this._leafletMap.getSize();return new Z.Point(a.x,a.y)},getTopLeftPos:function(){return new Z.Point(this._containerLeft,this._containerTop)},panTo:function(a,b){var c=Z.LeafletUtil.latLngToLeaflet(a);this._leafletMap.panTo(c,b)},panByPixel:function(a,b){var c=void 0===a?0:a,d=void 0===b?0:b;0===c&&0===d||this._offsetPixel(Z.Point.create(c,d))},panByLatLng:function(a,b){var c=void 0===b?0:b,d=void 0===a?0:a;0===c&&0===d||this._offsetLatLng(new Z.LatLng(d,c))},_offsetPixel:function(a){var b=L.point(a.x,a.y);this._leafletMap.panBy(b)},_offsetLatLng:function(a){var b=this.getBounds(),c=b.getEast()-b.getWest(),d=b.getNorth()-b.getSouth(),e=this._leafletMap.getSize(),f=e.x*a.lng/c,g=-e.y*a.lat/d;this._offsetPixel(Z.Point.create(f,g))},getContentBounds:function(){return this.getBounds()},latLngToScreenPoint:function(a){var b=this.getBounds(),c=b.getEast()-b.getWest(),d=b.getNorth()-b.getSouth(),e=this._leafletMap.getSize(),f=e.x*(a.lng-b.getWest())/c,g=e.y*(d-a.lat+b.getSouth())/d;return Z.Point.create(f,g)},screenPointToLatLng:function(a){var b=this.getBounds(),c=b.getEast()-b.getWest(),d=b.getNorth()-b.getSouth(),e=this._leafletMap.getSize(),f=b.getWest()+c*a.x/e.x,g=b.getSouth()+d*(e.y-a.y)/e.y;return Z.LatLng.create(g,f)},addLayer:function(a,b,c){if(a instanceof Z.ILayer){var d=null;d=c===Z.LayerGroup.BaseBgLayer?this._contentFrame.baseBgPane:c===Z.LayerGroup.BaseOverLayer?this._contentFrame.baseOverPane:this._contentFrame.layerPane,a.onAdd(this,b,d),this.fire("layeradd",{layer:a})}},removeLayer:function(a){a instanceof Z.ILayer&&(a.onRemove(this),this.fire("layerremove",{layer:a}))},openPopup:function(a,b,c){var d=Z.SinglePopup.getInstance(this,c);d.setContent(a),b&&d.setLatLng(b),d.open()},closePopup:function(){Z.SinglePopup.getInstance(this,options).close()},addControl:function(a){a.onAdd(this)},removeControl:function(a){a.onRemove(this)},refresh:function(){},resize:function(){},setSunLight:function(a){console.info("二维地图不支持设置太阳光照")},setAmbientLight:function(a){console.info("二维地图不支持设置环境光")},rotateByEuler:function(a){console.info("二维地图不支持旋转")},resetRotate:function(){console.info("二维地图不支持旋转")},getRotateByRad:function(){console.info("二维地图不支持旋转")},_getLeafletMap:function(a,b){var c=this._getLeafletOptions(b);c.crs=this._getLeafletCRS(b.crs,b);var d=null;b.sceneConfig.zoomSlider&&(d=b.sceneConfig.zoomSlider.toLowerCase(),c.zoomControl="small"===d);var e=L.map(a,c);return"slider"==d&&e.addControl(new L.Control.Zoomslider),e},_getLeafletOptions:function(a){return{center:a.center?L.latLng(a.center.lat,a.center.lng):L.latLng(118,32),zoom:a.initZoom?a.initZoom:void 0,layers:void 0,minZoom:a.minZoom?a.minZoom:void 0,maxZoom:a.maxZoom?a.maxZoom:maxZoom,maxBounds:a.maxBounds?L.latLngBounds(L.latLng(a.maxBounds.miny,a.maxBounds.minx),L.latLng(a.maxBounds.maxy,a.maxBounds.maxx)):void 0,crs:void 0}},_getLeafletCRS:function(a,b){return a=a?a.code?a.code.toLowerCase():(a+"").toLowerCase():"epsg3857","epsg3857"===a?a=L.CRS.EPSG3857:"epsg4326"===a?a=L.CRS.EPSG4326:"simple"===a?a=L.CRS.Simple:"perspective"===a?(a=L.CRS.Perspective.clone(),b.levelDefine&&(a.origin=new L.LatLng(90,-180),a.levelDefine=b.levelDefine)):(a=L.CRS.CustomLevel.clone(),b.levelDefine&&(a.origin=new L.LatLng(90,-180),a.levelDefine=b.levelDefine)),a},_applyEvents:function(a){Z.DomEvent&&(a=a||"on",this._applyMouseEvents(a),this._applyResizeEvents(a),this._applyMapControlEvents(a),Z.DomEvent[a](window,"scroll",this._onScroll,this))},_applyMouseEvents:function(a){this._leafletMap[a]("click",this._onMouseClick,this);var b,c,d=["dblclick","mousedown","mouseup","mouseover","mouseout","mousemove","contextmenu"];for(b=0,c=d.length;b<c;b++)this._leafletMap[a](d[b],this._fireMouseEvent,this)},_onMouseClick:function(a){this.fire("preclick"),this._fireMouseEvent(a)},_fireMouseEvent:function(a){var b=a.type;"contextmenu"===b&&Z.DomEvent.preventDefault(a),this.fire(b,{latlng:Z.LeafletUtil.latLngFromLeaflet(a.latlng),scenePoint:Z.LeafletUtil.pointFromLeaflet(a.layerPoint),containerPoint:Z.LeafletUtil.pointFromLeaflet(a.containerPoint),originalEvent:a.originalEvent,objects:[]})},_applyResizeEvents:function(a){this._leafletMap[a]("resize",this._fireResizeEvent,this)},_fireResizeEvent:function(a){this.fire(a.type,{oldSize:Z.LeafletUtil.pointFromLeaflet(a.oldSize),newSize:Z.LeafletUtil.pointFromLeaflet(a.newSize)})},_applyMapControlEvents:function(a){this._leafletMap[a]("zoomlevelschange",this._fireZoomLevelsChangeEvent,this);var b,c,d=["movestart","move","moveend","dragstart","drag","dragend","viewreset"];for(b=0,c=d.length;b<c;b++)this._leafletMap[a](d[b],this._fireMapControlEvent,this)},_fireZoomLevelsChangeEvent:function(a){this.fire(a.type,{oldLevel:this._currentLevel,newLevel:this._leafletMap.getZoom()}),this._currentLevel=this._leafletMap.getZoom()},_fireMapControlEvent:function(a){"dragend"===a.type?this.fire(a.type,{distance:a.distance}):this.fire(a.type),"move"===a.type&&this.fire("viewreset"),"moveend"===a.type&&this._currentLevel===this._leafletMap.getZoom()&&this.fire("viewreset")},_onScroll:function(a){var b=this._viewFrame.rootPane.root;this._containerLeft=b.offsetLeft,this._containerTop=b.offsetTop}}),Z.Scene3D=Z.IScene.extend({initialize:function(a,b){this._container=a,this._containerWidth=a?a.clientWidth:400,this._containerHeight=a?a.clientHeight:400;var c=Z.DomUtil.getOffsetPoint(a)||{};this._containerLeft=c.left||0,this._containerTop=c.top||0,this._rotation={x:0,y:0,z:0},this._bgColor="#ffffff",this._ambientLight="#ffffff",this._sunLight="#aaaaaa",this._sunIntensity=.8,this._sunHeight={h:30,v:45},this._sceneRender=null,this._viewFrame=null,this._contentFrame=null,this._level=null,this._dragger=null,this._touchZoom=null,this._vhRotationLimit={minV:0,maxV:90,minH:0,maxH:360},this._currentGraphics={select:[],mouseover:[]},this.options=b||{},this._latLngBounds=b.bounds.clone(),this._projBounds=this._latLngBounds2ProjBounds(this._latLngBounds,b.projModel),this._viewableLatLngBounds=b.bounds.clone(),this._viewableProjBounds=this._latLngBounds2ProjBounds(this._viewableLatLngBounds,b.projModel),this._latLngCenter=b.center.clone(),this._projCenter=b.projModel?b.projModel.forwardTransform(this._latLngCenter):this._latLngCenter,this._level=b.initZoom,this._viewFrame=new Z.SceneViewFrame(a),this._sceneRender=new Z.SceneRender3D(this._viewFrame.mapPane.root,this._getRenderOptions(a,b)),this._contentFrame=new Z.MapContentFrame,this._layerRoot=new Z.SceneThreePaneItem,this._sceneRender.addObject(this._layerRoot.root),this._sceneRender.render(),this._pyramidModel=b.pyramidModel,this._projModel=b.projModel,b.vhRotationLimit&&this.setVHRotationLimit(b.vhRotationLimit.minV,b.vhRotationLimit.maxV,b.vhRotationLimit.minH,b.vhRotationLimit.maxH),this._initEvents(),this._enableDrag(),this._orthoGLBounds=this._sceneRender.getOrthoGLBounds(),this._viewableGLBounds=this._sceneRender.getVisibleGLBounds(),this._terrainPlane=null,this._initSurfacePlane(),this._statusVersion=0,this.fire("load")},getCRS:function(){return this.options.crs},getBounds:function(){return this._latLngBounds.clone()},setZoom:function(a){if(!(this._level===a||Math.abs(this._level-a)<1e-6)){var b=this._pyramidModel.getScale(a),c=this._pyramidModel.getScale(this._level),d=this._projBounds.getEast()-this._projBounds.getWest(),e=this._projBounds.getNorth()-this._projBounds.getSouth(),f=d*b/c,g=e*b/c,h=Z.LatLngBounds.create([this._projCenter.lat-g/2,this._projCenter.lng-f/2,this._projBounds.getBottom()],[this._projCenter.lat+g/2,this._projCenter.lng+f/2,this._projBounds.getTop()]),i=this._projBounds2LatLngBounds(h,this._projModel);this._updateSceneStatus(this._latLngCenter,i);var j=this._level;this._level=a,this._sceneRender.needsUpdate=!0,this.fire("zoomlevelschange",{oldLevel:j,newLevel:a})}},zoomByScaling:function(a,b){var c=this._pyramidModel.scalingLevel(b||this._level,a);this.setZoom(c.level)},getZoom:function(){return this._level},getScale:function(a){return void 0===a&&(a=this._level),this._pyramidModel.getScale(a)},getSize:function(){return this._sceneRender.getSize()},getTopLeftPos:function(){return new Z.Point(this._containerLeft,this._containerTop)},panTo:function(a,b){a instanceof Z.LatLng&&(this.fire("movestart"),this._centerAt(a),this.fire("move"),this.fire("moveend"),this._level===b||Z.Util.isNull(b)||this.setZoom(b),this.fire("viewreset"))},panByPixel:function(a,b){var c=void 0===a||NaN===a?0:a,d=void 0===b||NaN===a?0:b;0===c&&0===d||(this.fire("movestart"),this._offsetPixel(Z.Point.create(c,d)),this.fire("move"),this.fire("moveend"),this.fire("viewreset"))},panByLatLng:function(a,b){var c=Z.LatLng.create(a,b),d=void 0===c.lng||NaN===c.lng?0:c.lng,e=void 0===c.lat||NaN===c.lat?0:c.lat;0===d&&0===e||(this.fire("movestart"),this._offsetLatLng(new Z.LatLng(e,d)),this.fire("move"),this.fire("moveend"),this.fire("viewreset"))},rotateByEuler:function(a){a&&(this._sceneRender.rotateByEuler(a),this._sceneRender.render(),this._rotation=a,this._updateSceneStatus(),this._sceneRender.needsUpdate=!0,this.fire("rotatestart"),this.fire("rotate"),this.fire("rotateend"),this.fire("viewreset"))},rotateByVH:function(a,b){if(a=a||0,b=b||0,0!==a||0!==b){var c=this.getVHRotationLimit(),d=this.getVHRotateByEuler(),e=(d.v+a)%180,f=((d.h+b)%360+360)%360;e=Math.min(Math.max(e,c.minV),c.maxV),f=Math.min(Math.max(f,c.minH),c.maxH),a=e-d.v,b=f-d.h,this._sceneRender.rotateByVH(a,b),this._sceneRender.render();var g=this._sceneRender.getRotateByRad();this._rotation={x:180*g.x/Math.PI||0,y:180*g.y/Math.PI||0,z:180*g.z/Math.PI||0},this._updateSceneStatus(),this._sceneRender.needsUpdate=!0,this.fire("rotatestart"),this.fire("rotate"),this.fire("rotateend"),this.fire("viewreset")}},calculateVHRotation:function(a,b){return this._sceneRender.calculateVHRotation(a,b)},resetRotate:function(){this._sceneRender.resetCamera(),this._rotation={x:0,y:0,z:0},this._updateSceneStatus(),this._sceneRender.needsUpdate=!0,this.fire("rotatestart"),this.fire("rotate"),this.fire("rotateend"),this.fire("viewreset")},getRotateByEuler:function(){return{x:this._rotation.x,y:this._rotation.y,z:this._rotation.z}},getVHRotateByEuler:function(){var a=this._sceneRender.getVHRotateByRad(),b=180/Math.PI;return{v:a.v*b,h:a.h*b}},getVHRotationLimit:function(){return Z.Util.objectClone(this._vhRotationLimit)},setVHRotationLimit:function(a,b,c,d){var e=this._vhRotationLimit;e.minV=Z.Util.isNumber(a)?a:e.minV,e.minH=Z.Util.isNumber(c)?c:e.minH,e.maxV=Z.Util.isNumber(b)?b:e.maxV,e.maxH=Z.Util.isNumber(d)?d:e.maxH},getRotateByRad:function(){var a=this.getRotateByEuler(),b=Math.PI/180;return{x:a.x*b,y:a.y*b,z:a.z*b}},getContentBounds:function(){return this._viewableLatLngBounds.clone()},getPixelSceneRatio:function(){var a=this._orthoGLBounds,b=this._containerWidth/a.getWidth(),c=this._containerHeight/a.getHeight();return new Z.Point.create(b,c)},getLatLngSceneRatio:function(){var a=this._latLngBounds,b=this._orthoGLBounds,c=(a.getEast()-a.getWest())/b.getWidth(),d=(a.getNorth()-a.getSouth())/b.getHeight();return new Z.Point.create(c,d)},latLngToScreenPoint:function(a){var b=this._latLngToGLPoint(a);return this._sceneRender.webGLPointToScreen(b)},latLngToScenePoint:function(a){return this._latLngToGLPoint(a)},scenePointToLatLng:function(a){return this._glPointToLatLng(a)},screenPointToLatLng:function(a){var b=this._sceneRender.screenPointToWebGL(a);return b?this._glPointToLatLng(b):null},screenPointToScenePoint:function(a){var b=this._sceneRender.screenPointToWebGL(a);return b?Z.Point.create(b.x,b.y,b.z):null},getProjBounds:function(a){this._sceneRender.getCameraDirection()},addLayer:function(a,b,c){if(a instanceof Z.ILayer){var d=null;d=c===Z.LayerGroup.BaseBgLayer?this._contentFrame.baseBgPane:c===Z.LayerGroup.BaseOverLayer?this._contentFrame.baseOverPane:this._contentFrame.layerPane,a.onAdd(this,b,this._layerRoot,d),this.options.selectionMutex&&this._applyLayerEvents(a,"on"),this._sceneRender.addUpdateChecker(a),this.fire("layeradd",{layer:a})}},removeLayer:function(a){a instanceof Z.ILayer&&(a.onRemove(this),this.options.selectionMutex&&this._applyLayerEvents(a,"off"),this._sceneRender.removeUpdateChecker(a),this.fire("layerremove",{layer:a}))},addControl:function(a){a.onAdd(this)},removeControl:function(a){a.onRemove(this)},setSunLightPosition:function(a){a&&(this._sceneRender.setLightPosition(a),this._sceneRender.render())},setSunLightColor:function(a){a&&(this._sceneRender.setLightColor(a),this._sceneRender.render(),this._sunLight=a)},getSunLightColor:function(){return this._sunLight},setAmbientLight:function(a){a&&(this._sceneRender.setAmbientColor(a),this._sceneRender.render(),this._ambientLight=a)},getAmbientLight:function(){return this._ambientLight},setBgColor:function(a){a&&(this._sceneRender.setBgColor(a),this._sceneRender.render())},refresh:function(){this.refreshPopup(),this._sceneRender.needsUpdate=!0,this._sceneRender.render()},resize:function(){var a=1e-6,b=this._containerWidth,c=this._containerHeight,d=this._container.clientWidth,e=this._container.clientHeight;if(!(d<a||e<a)){this._containerWidth=d,this._containerHeight=e;var f=Z.DomUtil.getOffsetPoint(this._container)||{};this._containerLeft=f.left||0,this._containerTop=f.top||0,this._viewFrame.resize(),this._sceneRender.render();var g=this._latLngBounds.getEast()-this._latLngBounds.getWest();Math.abs(b)>a&&(g*=this._containerWidth/b);var h=this._latLngBounds.getNorth()-this._latLngBounds.getSouth();Math.abs(c)>a&&(h*=this._containerHeight/c);var i=Z.LatLng.create(this._latLngCenter.lat-h/2,this._latLngCenter.lng-g/2),j=Z.LatLng.create(this._latLngCenter.lat+h/2,this._latLngCenter.lng+g/2),k=new Z.LatLngBounds(i,j);this._updateSceneStatus(this._latLngCenter,k),this._sceneRender.resize(),this._sceneRender.needsUpdate=!0,this.fire("viewreset")}},getMaxAnisotropy:function(){return this._sceneRender.getMaxAnisotropy()},getSceneDistance:function(a){return Math.abs(this._meterDistanceToScene(a))},openPopup:function(a,b,c,d){var e=Z.SinglePopup.getInstance(this,d);e.setTitle(a),e.setContent(b),c&&e.setLatLng(c),e.open()},closePopup:function(){Z.SinglePopup.getInstance(this).close()},refreshPopup:function(){var a=Z.SinglePopup.getInstance(this);a.isOpened()&&a.update()},getGeometryFillScale:function(a){var b=null;if(a instanceof Z.Geometry)b=a.getBounds();else{if(!(a instanceof Z.LatLngBounds))return;b=a}var c=b.getSouthWest(),d=b.getNorthEast(),e=this.latLngToScenePoint(c),f=this.latLngToScenePoint(d);return this._sceneRender.getFillScale({min:e,max:f})},documentPointToContainer:function(a){return Z.DomEvent.getMousePosition({clientX:a.x,clientY:a.y},this._container)},_getRenderOptions:function(a,b){return{width:a.clientWidth,height:a.clientHeight,bgColor:this._bgColor,ambientColor:this._ambientLight,lightColor:this._sunLight,lightIntensity:this._sunIntensity,lightAngle:this._sunHeight,rotation:{x:0,y:0,z:0},showFrameRate:b.showFrameRate}},_initSurfacePlane:function(){this._terrainPlane=Z.SingleTerrainPlane.getInstance(),this._terrainPlane.enablePolygonOffset(),this._terrainPlane.onAdd(this,this._pyramidModel,this._layerRoot.root)},_disposeSurfacePlane:function(){this._terrainPlane&&(this._terrainPlane.onRemove(),this._terrainPlane=null)},_initEvents:function(a){if(Z.DomEvent){a=a||"on";var b,c,d=["dblclick","mousedown","mouseup","mouseover","mouseout","mouseenter","mouseleave","mousemove","contextmenu"];for(b=0,c=d.length;b<c;b++)Z.DomEvent[a](this._container,d[b],this._fireMouseEvent,this);Z.DomEvent[a](this._container,"mousewheel",this._onMouseWheel,this),Z.DomEvent[a](this._container,"MozMousePixelScroll",Z.DomEvent.preventDefault),Z.DomEvent[a](window,"resize",this._onResize,this),Z.DomEvent[a](window,"scroll",this._onScroll,this),this._enableTouchZoom(),this._enableRightRotate()}},_onMouseWheel:function(a){var b=Z.DomEvent.getWheelDelta(a),c=this._level;b/=8;var d=this._pyramidModel.scalingLevel(c,Math.pow(2,b));this.setZoom(d.level),Z.DomEvent.preventDefault(a),Z.DomEvent.stopPropagation(a)},_onMouseClick:function(a){this.fire("preclick"),this._fireMouseEvent(a)},_onResize:function(a){this.resize(),this._fireMouseEvent(a)},_onScroll:function(a){var b=Z.DomUtil.getOffsetPoint(this._container)||{};this._containerLeft=b.left||0,this._containerTop=b.top||0,this._sceneRender.render()},_fireMouseEvent:function(a){var b=a.type;if(b="mouseenter"===b?"mouseover":"mouseleave"===b?"mouseout":b,"contextmenu"===b&&Z.DomEvent.preventDefault(a),!this._dragger||!this._dragger.isDraging()||"mousemove"===b)if("resize"===b)this.fire(b);else{var c=Z.DomEvent.getMousePosition(a,this._container);c?this._fireEventFromContainerPoint(a,b,c):this.fire(b)}},_fireEventFromContainerPoint:function(a,b,c){for(var d=this._sceneRender.screenPointToWebGL(c),e=this.screenPointToLatLng(c),f=this._sceneRender.getIntersectObjects(c),g=[],h=0;h<f.length;h++)g.push(f[h].graphic);this.fire(b,{latlng:e,scenePoint:d,containerPoint:c,originalEvent:a,objects:g,intersections:f})},_enableDrag:function(){this._dragger=this._dragger||new Z.Scene3D.Drag(this),this._dragger.enable(),this._dragger.on("click",this._checkClick,this)},_checkClick:function(a){var b=a.containerPoint,c=a.originalEvent;this._fireEventFromContainerPoint(c,"click",b)},_enableTouchZoom:function(){this._touchZoom||(this._touchZoom=new Z.Scene3D.TouchZoom(this,this._container)),this._touchZoom.enable()},_enableRightRotate:function(){this._rightRotate||(this._rightRotate=new Z.Scene3D.RightRotate(this)),this._rightRotate.enable()},_offsetPixel:function(a,b){b=b||new Z.Point(this._container.clientWidth/2,this._container.clientHeight/2);var c=b.add(a),d=this.screenPointToLatLng(b),e=this.screenPointToLatLng(c);if(d&&e){var f=e.subtract(d);this._offsetLatLng(f)}},_offsetLatLng:function(a){var b=this._latLngCenter.add(a);this._centerAt(b)},_centerAt:function(a){var b=a.subtract(this._latLngCenter),c=this._latLngBounds.translate(b.lat,b.lng,b.alt);this._updateSceneStatus(a,c),this._sceneRender.needsUpdate=!0},_latLngToGLPoint:function(a){var b=this._viewableGLBounds,c=this._viewableProjBounds,d=this._projModel?this._projModel.forwardTransform(a):a,e=b.getBottomLeft().x+b.getWidth()*(d.lng-c.getWest())/(c.getEast()-c.getWest()),f=b.getTopRight().y-b.getHeight()*(c.getNorth()-d.lat)/(c.getNorth()-c.getSouth()),g=this._meterDistanceToScene((a.alt||0)-(c.getCenter().alt||0));return new Z.Point(e,f,g)},_glPointToLatLng:function(a){var b=this._viewableGLBounds,c=this._viewableProjBounds,d=c.getWest()+(c.getEast()-c.getWest())*(a.x-b.getBottomLeft().x)/b.getWidth(),e=c.getSouth()+(c.getNorth()-c.getSouth())*(a.y-b.getBottomLeft().y)/b.getHeight(),f=this._sceneDistanceToMeter(a.z)+(c.getCenter().alt||0),g=new Z.LatLng(e,d,f);return this._projModel?this._projModel.reverseTransform(g):g},_updateSceneStatus:function(a,b){if(a!==this._latLngCenter&&a instanceof Z.LatLng){this._latLngCenter=a,this._projCenter=this._projModel?this._projModel.forwardTransform(this._latLngCenter):this._latLngCenter;var c=this._latLngToGLPoint(this._latLngCenter);this._sceneRender.setViewCenter(c)}b!==this._latLngBounds&&b instanceof Z.LatLngBounds&&(this._latLngBounds=b,this._projBounds=this._latLngBounds2ProjBounds(this._latLngBounds,this._projModel)),this._viewableLatLngBounds=this._getContentBounds(),this._orthoGLBounds=this._sceneRender.getOrthoGLBounds(),this._viewableGLBounds=this._sceneRender.getVisibleGLBounds(),this._viewableProjBounds=this._latLngBounds2ProjBounds(this._viewableLatLngBounds,this._projModel)},_latLngBounds2ProjBounds:function(a,b){var c=a;if(b){var d=a.getNorthEast(),e=a.getSouthWest(),f=b.forwardTransform(d),g=b.forwardTransform(e);c=new Z.LatLngBounds(f,g)}return c},_projBounds2LatLngBounds:function(a,b){var c=a;if(b){var d=a.getNorthEast(),e=a.getSouthWest(),f=b.reverseTransform(d),g=b.reverseTransform(e);c=new Z.LatLngBounds(f,g)}return c},_getContentBounds:function(){var a,b,c,d,e=this._sceneRender.getOrthoGLBounds(),f=this._sceneRender.getVisibleGLBounds(),g=1e-7;if(Math.abs(e.getWidth())>g){var h=(this._projBounds.getEast()-this._projBounds.getWest())/e.getWidth(),i=f.getWidth()*h;a=this._projCenter.lng-i*(e.getCenter().x-f.getBottomLeft().x)/f.getWidth(),b=a+i}else a=this._projCenter.lng,b=this._projCenter.lat;if(Math.abs(e.getHeight())>g){var j=(this._projBounds.getNorth()-this._projBounds.getSouth())/e.getHeight(),k=f.getHeight()*j;c=this._projCenter.lat+k*(f.getTopRight().y-e.getCenter().y)/f.getHeight(),d=c-k}else c=this._projCenter.lat,d=this._projCenter.lng;var l=Z.Util.isNumber(this._projBounds.getBottom())?this._projBounds.getBottom():this._projCenter.alt,m=Z.Util.isNumber(this._projBounds.getTop())?this._projBounds.getTop():this._projCenter.alt,n=new Z.LatLng(d,a,l),o=new Z.LatLng(c,b,m);return this._projModel&&(n=this._projModel.reverseTransform(n),o=this._projModel.reverseTransform(o)),new Z.LatLngBounds.create(n,o)},_meterDistanceToScene:function(a){if("number"!=typeof a||Z.Util.isZero(a)||isNaN(a))return 0;var b=this.options.projModel,c=b.unproject(new Z.Point(0,0)),d=b.unproject(new Z.Point(0,a)),e=this.getLatLngSceneRatio().y;return(d.lat-c.lat)/e},_sceneDistanceToMeter:function(a){if("number"!=typeof a||Z.Util.isZero(a)||isNaN(a))return 0;var b=this.options.projModel,c=this.getLatLngSceneRatio().y,d=a*c;return b.project(new Z.LatLng(d,0)).y},_applyLayerEvents:function(a,b){if(a){b=b||"on";var c=["select","mouseover"];for(var d in c);}},_onLayerGraphicEvent:function(a){for(var b=a.objects,c=this._currentGraphics[a.type],d=0;d<c.length;d++){for(var e=c[d],f=!1,g=0;g<b.length;g++)if(b[g]===e){f=!0;break}f||("select"==a.type?e.doUnselect():"mouseover"==a.type&&e.doMouseOut())}this._currentGraphics[a.type]=b}}),Z.CameraControl=function(a){this.options={whRatio:1,cameraFov:45,cameraNear:1,cameraFar:150,cameraPosition:{x:0,y:0,z:50},cameraRotation:{x:0,y:0,z:0},cameraTarget:{x:0,y:0,z:0}},Z.Util.applyOptions(this.options,a,!1),this._cameraObject=null,this._createCamera(),this._initCameraPosition()},Z.CameraControl.prototype.rotateByRad=function(a){if(a&&"number"==typeof a.x&&"number"==typeof a.y&&"number"==typeof a.z){var b=this._getRotationMatrix(a,this.options.cameraRotation),c=new THREE.Vector3,d=new THREE.Quaternion,e=new THREE.Vector3;b.decompose(c,d,e),this._cameraObject.position.applyMatrix4(b),this._cameraObject.up.applyQuaternion(d),this._cameraObject.lookAt(new THREE.Vector3(this.options.cameraTarget.x,this.options.cameraTarget.y,this.options.cameraTarget.z)),this._cameraObject.updateMatrix(),this._cameraObject.updateMatrixWorld(),this._cameraObject.updateProjectionMatrix()}},Z.CameraControl.prototype.scale=function(a){},Z.CameraControl.prototype._createCamera=function(){this._cameraObject=new THREE.PerspectiveCamera(this.options.cameraFov,this.options.width/this.options.height,this.options.cameraNear,this.options.cameraFar)},Z.CameraControl.prototype._initCameraPosition=function(){this._cameraObject.position.x=this.options.cameraPosition.x,this._cameraObject.position.y=this.options.cameraPosition.y,this._cameraObject.position.z=this.options.cameraPosition.z,this._cameraObject.lookAt(new THREE.Vector3(this.options.cameraTarget.x,this.options.cameraTarget.y,this.options.cameraTarget.z))},Z.CameraControl.prototype._getRotationMatrix=function(a,b){var c=b?b.x*Math.PI/180+a.x:a.x,d=b?b.y*Math.PI/180+a.y:a.y,e=b?b.z*Math.PI/180+a.z:a.z,f=new THREE.Matrix4,g=new THREE.Matrix4,h=new THREE.Matrix4,i=new THREE.Matrix4;return g.makeRotationX(c),h.makeRotationY(d),i.makeRotationZ(e),f.multiplyMatrices(g,h),f.multiply(i),f},Z.Scene3D.Drag=Z.Class.extend({includes:Z.EventManager,initialize:function(a){this._scene=a,this._draggable=null,this._enabled=!1,this._lastPoint=null,this._isDraging=!1},enable:function(){this._enabled||(this._enabled=!0,this.addHooks())},disable:function(){this._enabled&&(this._enabled=!1,this.removeHooks())},enabled:function(){return!!this._enabled},addHooks:function(){if(!this._draggable){var a=this._scene;this._draggable=new Z.Draggable(a._viewFrame.mapPane.root,a._container,!1),this._draggable.on({dragstart:this._onDragStart,drag:this._onDrag,dragend:this._onDragEnd,nodrag:this._onNoDrag},this)}this._draggable.enable()},removeHooks:function(){this._draggable.disable()},moved:function(){return this._draggable&&this._draggable._moved},isDraging:function(){return this._isDraging},_onDragStart:function(a){var b=this._scene;this._lastPoint=null,b.fire("movestart",a).fire("dragstart",a)},_onDrag:function(a){this._isDraging=!0,this._refreshMap(a),this._scene.fire("move",a).fire("drag",a)},_onDragEnd:function(a){var b=this._scene,c=b.options,d=+new Date-this._lastTime;!c.inertia||d>c.inertiaThreshold||this._positions[0];this._refreshMap(a),this._isDraging=!1,b.fire("dragend",a),b.fire("moveend",a),b.fire("viewreset",a),a.distance<=1&&this.fire("click",{containerPoint:a.newPoint,originalEvent:a})},_onNoDrag:function(a){this.fire("click",{containerPoint:a.newPoint,originalEvent:a.originalUpEvent})},_refreshMap:function(a){var b=this._scene;if(this._lastPoint||(this._lastPoint=a.startPoint),a.startPoint&&a.newPoint){var c=b.screenPointToLatLng(this._lastPoint),d=b.screenPointToLatLng(a.newPoint);if(c&&d){var e=c.subtract(d);b._offsetLatLng(e),this._lastPoint=a.newPoint}}}}),Z.Scene3D.ClickCheck=Z.Class.extend({includes:Z.EventManager,initialize:function(a){this._scene=a,this._draggable=null,this._enabled=!1,this._lastPoint=null,this._isDraging=!1},enable:function(){this._enabled||(this._enabled=!0,this.addHooks())},disable:function(){this._enabled&&(this._enabled=!1,this.removeHooks())},enabled:function(){return!!this._enabled},addHooks:function(){if(!this._draggable){var a=this._scene;this._draggable=new Z.Draggable(a._viewFrame.mapPane.root,a._container,!1),this._draggable.on({dragend:this._onDragEnd},this)}this._draggable.enable()},removeHooks:function(){this._draggable.disable()},moved:function(){return this._draggable&&this._draggable._moved},isDraging:function(){return this._isDraging},_onDragEnd:function(a){var b=this._scene,c=b.options,d=+new Date-this._lastTime;!c.inertia||d>c.inertiaThreshold||this._positions[0];this._screenEventToContainer(a),this._isDraging=!1,b.fire("dragend",a),b.fire("moveend",a),b.fire("viewreset",a)},_screenEventToContainer:function(a){var b=this._scene.getTopLeftPos();a.startPoint&&(a.startPoint=a.startPoint.subtract(b)),a.newPoint&&(a.newPoint=a.newPoint.subtract(b))}}),Z.Scene3D.TouchZoom=Z.Class.extend({includes:Z.EventManager,initialize:function(a,b){this._scene=a,this._container=b,this._enabled=!1,this._startCenter=null,this._startDist=null,this._moved=!1,this._zooming=!1},enable:function(){Z.DomEvent.on(this._container,"touchstart",this._onTouchStart,this)},disable:function(){Z.DomEvent.off(this._container,"touchstart",this._onTouchStart,this)},_onTouchStart:function(a){if(a.touches&&2===a.touches.length&&!this._zooming){var b=Z.DomEvent.getMousePosition(a.touches[0],this._container),c=Z.DomEvent.getMousePosition(a.touches[1],this._container);this._startCenter=b.add(c).divideBy(2),this._startDist=b.distanceTo(c),this._startZoom=this._scene.getZoom(),this._moved=!1,this._zooming=!0,Z.DomEvent.on(document,"touchmove",this._onTouchMove,this).on(document,"touchend",this._onTouchEnd,this),Z.DomEvent.preventDefault(a)}},_onTouchMove:function(a){if(a.touches&&2===a.touches.length&&this._zooming){var b=Z.DomEvent.getMousePosition(a.touches[0],this._container),c=Z.DomEvent.getMousePosition(a.touches[1],this._container);this._scale=this._startDist/b.distanceTo(c),this._delta=b.add(c).divideBy(2).subtract(this._startCenter),1!==this._scale&&(this._moved||(this._scene.fire("movestart").fire("zoomstart"),this._moved=!0),this._scene.zoomByScaling(this._scale,this._startZoom),Z.DomEvent.preventDefault(a))}},_onTouchEnd:function(){if(!this._moved||!this._zooming)return void(this._zooming=!1);this._zooming=!1,Z.DomEvent.off(document,"touchmove",this._onTouchMove).off(document,"touchend",this._onTouchEnd)}}),Z.Scene3D.RightRotate=Z.Class.extend({includes:Z.EventManager,initialize:function(a){this._scene=a,this._draggable=null,this._enabled=!1,this._lastPoint=null,this._isDraging=!1},enable:function(){this._enabled||(this._enabled=!0,this.addHooks())},disable:function(){this._enabled&&(this._enabled=!1,this.removeHooks())},enabled:function(){return!!this._enabled},addHooks:function(){if(!this._draggable){var a=this._scene;this._draggable=new Z.RightDraggable(a._viewFrame.mapPane.root,a._container,!1),this._draggable.on({rightdragstart:this._onDragStart,rightdrag:this._onDrag,rightdragend:this._onDragEnd,norightdrag:this._onNoDrag},this)}this._draggable.enable()},removeHooks:function(){this._draggable.disable()},moved:function(){return this._draggable&&this._draggable._moved},isDraging:function(){return this._isDraging},_onDragStart:function(a){var b=this._scene;this._lastPoint=null,b.fire("rotatestart",a)},_onDrag:function(a){this._isDraging=!0,this._screenEventToContainer(a),this._refreshMap(a),this._scene.fire("rotate",a)},_onDragEnd:function(a){var b=this._scene,c=b.options,d=+new Date-this._lastTime;!c.inertia||d>c.inertiaThreshold||this._positions[0];this._screenEventToContainer(a),this._refreshMap(a),this._isDraging=!1,b.fire("rotateend",a),b.fire("viewreset",a)},_onNoDrag:function(a){},_refreshMap:function(a){var b=this._scene;if(this._lastPoint||(this._lastPoint=a.startPoint),a.startPoint&&a.newPoint){var c=b.calculateVHRotation(this._lastPoint,a.newPoint);b.rotateByVH(c.v,c.h),this._lastPoint=a.newPoint}},_screenEventToContainer:function(a){var b=this._scene.getTopLeftPos();a.startPoint&&(a.startPoint=a.startPoint.subtract(b)),a.newPoint&&(a.newPoint=a.newPoint.subtract(b))}});var ZMap=Z.Class.extend({includes:Z.EventManager,initialize:function(a,b){this.options={},this._container=null,this._containerWidth=0,this._containerHeight=0,this._screenTopLeftCorner=null,this._pageOffset=null,this._defaultGraphicLayer=null,this._layers=[],this._popup=null,this._scene=null,this._currentSceneType=null,this._status={latLngBounds:{},center:{},zoomLevel:1},this._pyramidModel=null,this._initContainer(a),this._applyOptions(b),this._initPyramidModel(this.options),this._initMapStatus(),this._initScene(),this._initMapEvent(),this.fire("load")},addLayer:function(a,b,c){if(this._scene&&a instanceof Z.ILayer){if(b<0||b>=1e3)return void console.error("index的值必须在0到999之间");if(!this.hasLayer(a)){var d=this._scene.addLayer(a,b,c);this._layers.push({layer:a,index:d}),this.fire("layeradd",{layer:a})}}},removeLayer:function(a){this._scene.removeLayer(a);for(var b=this._layers.length-1;b>=0;b--)a===this._layers[b].layer&&this._layers.splice(b,1);this.fire("layerremove",{layer:a})},getLayers:function(){return Z.Util.ArrayClone(this._layers)},getLayer:function(a){var b="";if("string"==typeof a)b=a;else{if(!(a instanceof Z.ILayer))return;b=Z.Util.stamp(a)}for(var c=null,d="",e=this._layers.length-1;e>=0;e--)if(d=Z.Util.stamp(this._layers[e].layer),b===d){c=this._layers[e];break}return c},hasLayer:function(a){return!!this.getLayer(a)},panTo:function(a,b){this._scene&&(a=Z.LatLng.create(a),b="number"==typeof b?Math.floor(b):b,a&&(this._scene.panTo(a,b),this._updateMapStatus(null,a,b)))},panBy:function(a,b){var c=Z.Point.create(a,b),d=void 0===c.x||NaN===c.x?0:c.x,e=void 0===c.y||NaN===c.x?0:c.y;0===d&&0===e||this._scene&&this._scene.panByPixel(d,e)},getZoom:function(){return this._status.zoomLevel},setZoom:function(a){"number"==typeof a&&(a=this._limitZoom(a))!==this._status.zoomLevel&&(this._scene.setZoom(a),this._updateMapStatus(null,null,a))},zoomIn:function(){if(this._status.zoomLevel<this.options.maxZoom){var a=this._status.zoomLevel+1;this.setZoom(a)}},zoomOut:function(){if(this._status.zoomLevel>this.options.minZoom){var a=this._status.zoomLevel-1;this.setZoom(a)}},setView:function(a){if(a instanceof Z.LatLngBounds){var b=this._getFitableZoomLevel(a),c=a.getCenter();this._scene.panTo(c,b);var d=this._getFitableBounds(c,b);this._updateMapStatus(d,c,b)}},fitBounds:function(a){this.setView(a)},fitFeature:function(a){alert("fitFeature方法尚未实现")},fitFeatures:function(a){alert("fitFeatures方法尚未实现")},fullMap:function(){this.panTo(this.options.center,this.options.initZoom)},openPopup:function(a,b,c){this._scene.openPopup(a,b,c)},closePopup:function(a){this._scene.closePopup()},switchScene:function(a){a!==this._currentSceneType&&alert("switchScene方法尚未实现")},getBounds:function(){return this._status.latLngBounds.clone()},getCenter:function(){return this._status.center},getZoom:function(){return this._status.zoomLevel},getScale:function(){alert("getScale方法尚未实现")},getSize:function(){return Z.Point.create(this._containerWidth,this._containerHeight)},getContentBounds:function(){return this._scene.getContentBounds()},on:function(a,b,c){this._scene.on(a,b,c)},off:function(a,b,c){this._scene.off(a,b,c)},screenPointToLatLng:function(a){if(!(a instanceof Z.Point)){if(!a||"number"!=typeof a.x||"number"!=typeof a.y)return null;a=new Z.Point(a.x,a.y)}this.reposition();var b=a.add(this._pageOffset).subtract(this._screenTopLeftCorner);return this._scene.screenPointToLatLng(b)},latLngToScreenPoint:function(a){if(!((a=Z.LatLng.create(a))instanceof Z.LatLng))return null;var b=this._scene.latLngToScreenPoint(a);return this.reposition(),this._screenTopLeftCorner.add(b).subtract(this._pageOffset)},containerPointToLatLng:function(a){if(!(a instanceof Z.Point)){if(!a||"number"!=typeof a.x||"number"!=typeof a.y)return null;a=new Z.Point(a.x,a.y)}return this._scene.screenPointToLatLng(sceneScreenPoint)},latLngToContainerPoint:function(a){return a=Z.LatLng.create(a),a instanceof Z.LatLng?this._scene.latLngToScreenPoint(a):null},resize:function(){if(this._container){var a=this._container.offsetWidth||this._container.clientWidth,b=this._container.offsetHeight||this._container.clientHeight,c=1e-7;if(a<c||b<c)return;this._containerWidth=a,this._containerHeight=b}this._scene&&this._scene.resize()},reposition:function(){if(this._container){var a=this._container.offsetLeft||this._container.clientLeft,b=this._container.offsetTop||this._container.clientTop,c=window.pageXOffset||document.body.scrollLeft,d=window.pageYOffset||document.body.scrollTop;this._screenTopLeftCorner?(this._screenTopLeftCorner.x=a,this._screenTopLeftCorner.y=b,this._pageOffset.x=c,this._pageOffset.y=d):(this._screenTopLeftCorner=new Z.Point(a,b),this._pageOffset=new Z.Point(c,d))}},refresh:function(){this._scene&&this._scene.refresh()},setSunLight:function(a){this._scene&&this._scene.setSunLight(a)},setAmbientLight:function(a){this._scene&&this._scene.setAmbientLight(a)},rotateByEuler:function(a){this._scene&&this._scene.rotateByEuler(a)},rotateByVH:function(a,b){this._scene&&this._scene.rotateByVH(a,b)},getRotateByEuler:function(){if(this._scene)return this._scene.getRotateByEuler()},resetRotate:function(){this._scene&&this._scene.resetRotate()},_initContainer:function(a){var b=null;if(!(b=Z.DomUtil.isDom(a)?a:Z.DomUtil.get(a)))throw new Error("地图创建失败，未找到指定的地图容器：id＝"+a);if(b._zmap)throw new Error("地图容器已经初始化，请检查是否在同一地图容器中构造了多个地图对象");b._zmap=!0,Z.DomUtil.addClass(b,"zmap-container"),this._container=b,this.resize(),this.reposition()},_initScene:function(){var a=(this.options.sceneType||"mixed").toLowerCase();!this._supportWebGL()||"3d"!==a&&"mixed"!==a?(this.options.sceneType="2d",this._currentSceneType="2d"):this._scene=this._currentSceneType="3d"===a?"3d":"2d",this.options.pyramidModel=this._pyramidModel,this._scene="3d"===this._currentSceneType?new Z.Scene3D(this._container,this.options):new Z.Scene2D(this._container,this.options),this._updateMapStatus()},_initMapEvent:function(a){if(Z.DomEvent&&this._scene){a=a||"on",this._scene.on("viewreset",this._onSceneViewReset,this),this._scene.on("zoomlevelschange",this._onSceneZoomChange,this);var b,c,d=["preclick","click","dblclick","mousedown","mouseup","mouseover","mouseout","mousemove","contextmenu","resize","movestart","move","moveend","dragstart","drag","dragend"];for(b=0,c=d.length;b<c;b++)this._scene[a](d[b],this._fireMapEvent,this)}},_fireMapEvent:function(a){this.fire(a.type,a)},_onSceneViewReset:function(){this._updateMapStatus(),this.fire("viewreset")},_onSceneZoomChange:function(){this._updateMapStatus(),this.fire("zoomlevelschange")},_applyOptions:function(a){a=a||{},this.options=Z.Util.applyOptions(this.options,DefaultZMapConfig,!0,["sceneConfig"]),this.options.sceneConfig=Z.Util.applyOptions(this.options.sceneConfig,DefaultZMapConfig.sceneConfig,!0),this.options=Z.Util.applyOptions(this.options,a,!1,["sceneConfig"]),this.options.sceneConfig=Z.Util.applyOptions(this.options.sceneConfig,a.sceneConfig,!1),this.options.crs=this._getCRS(this.options.crs),this.options.center=new Z.LatLng(this.options.center.y,this.options.center.x)},_initMapStatus:function(){var a=this._getFitableBounds(this.options.center,this.options.initZoom);this.options.bounds=a,this.options.maxBounds=Z.LatLngBounds.create([this.options.maxBounds.miny,this.options.maxBounds.minx],[this.options.maxBounds.maxy,this.options.maxBounds.maxx]),this._updateMapStatus(a,this.options.center,this.options.initZoom)},_getCRS:function(a){return a=a||"",a=a.toUpperCase(),Z.CRS[a]||Z.CRS.EPSG4326},_updateMapStatus:function(a,b,c){this._status.latLngBounds=a||this._scene.getBounds(),this._status.center=b||this._scene.getBounds().getCenter(),this._status.zoomLevel=c||this._scene.getZoom()},_limitZoom:function(a){return Math.min(this.options.maxZoom,Math.max(this.options.minZoom,a))},_getFitableZoomLevel:function(a){var b=this._scene.getGeometryFillScale(a);return this._pyramidModel.scalingLevel(this._status.zoomLevel,1/b).level},_getFitableBounds:function(a,b){return this._pyramidModel.getFitableBounds(a,b,this._containerWidth,this._containerHeight)},_supportWebGL:function(){for(var a,b=document.createElement("canvas"),c=["webgl","experimental-webgl","moz-webgl","webkit-3d"],d=0;d<c.length;d++)try{if(a=b.getContext(c[d]))break}catch(a){}return!!a},_initPyramidModel:function(a){var b={pyramidId:a.pyramidId,pyramidDefine:a.pyramidDefine||{},projModel:a.projModel};this._pyramidModel=Z.PyramidModelFactory.create(b);var c=a.crs,d=this._pyramidModel.crs;this._pyramidModel.projModel=new Z.ProjModel(c,d),this.options.projModel=this._pyramidModel.projModel}});