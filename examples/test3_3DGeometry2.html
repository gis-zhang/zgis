<html>
<head>
	<title>地图api测试示例</title>
	<meta charset="utf-8" />

	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<link rel="stylesheet" href="../src/lib/leaflet-0.7.3/leaflet.css" />
	<link rel="stylesheet" href="../dist/zmap.css" />
	<!--<link rel="stylesheet" href="../src/lib/leaflet-extend/control/L.TextIcon.js" />-->

	<script src="../src/lib/leaflet-0.7.3/leaflet-src.js"></script>
	<!--<script src="../src/lib/threejs/three.js"></script>-->
	<script src="../src/lib/threejs_new/three.js"></script>
	<script src="../src/lib/threejs/ConvexGeometry.js"></script>
	<script src="../src/lib/threebsp/ThreeBSP.js"></script>
	<!--<script src="../src/lib/leaflet-extend/control/Util.js"></script>-->
	<!--<script src="../src/lib/leaflet-extend/layer/L.CustomTileLayer.js"></script>-->
	<!--<script src="../src/lib/leaflet-extend/layer/layer.wmts-src.js"></script>-->
	<!--<script src="../src/lib/leaflet-extend/layer/layer.tdt-src.js"></script>-->
	<!--<script src="../src/lib/leaflet-plugin/Leaflet.zoomslider-0.6.1/src/L.Control.Zoomslider.js"></script>-->
	<!--<script src="../src/lib/leaflet-extend/crs/L.CRS.CustomLevel.js"></script>-->
	<!--<script src="../src/lib/leaflet-extend/control/L.Control.Layers.Custom.js"></script>-->
	<!--<script src="../src/lib/leaflet-plugin/MiniMap/Control.MiniMap.min.js"></script>-->
	<!--<script src="../src/lib/leaflet-extend/MapConfig.js" charset="GBK"></script>-->
	<!--<script src="../src/lib/leaflet-extend/control/L.TextIcon.js"></script>-->
	<!--<script src="../src/lib/leaflet-extend/Map.js"></script>-->
	<script src="../dist/zmap-release.js"></script>
	<!--<script src="http://localhost/mapapi/example/testdata_wkt11.js"></script>-->
	<script src="data/testdata_wkt11.js"></script>
	<!--<script src="../src/zmap/fonts/gentilis_bold.typeface.js"></script>-->
	<!--<script src="../src/zmap/fonts/gentilis_regular.typeface.js"></script>-->
	<!--<script src="../src/zmap/fonts/optimer_bold.typeface.js"></script>-->
	<!--<script src="../src/zmap/fonts/optimer_regular.typeface.js"></script>-->
	<!--<script src="../src/zmap/fonts/helvetiker_bold.typeface.js"></script>-->
	<!--<script src="../src/zmap/fonts/helvetiker_regular.typeface.js"></script>-->
	<!--<script src="../src/zmap/fonts/droid/droid_sans_regular.typeface.js"></script>-->
	<!--<script src="../src/zmap/fonts/droid/droid_sans_bold.typeface.js"></script>-->
	<!--<script src="../src/zmap/fonts/droid/droid_serif_regular.typeface.js"></script>-->
	<!--<script src="../src/zmap/fonts/droid/droid_serif_bold.typeface.js"></script>-->
	<script src="../src/lib/stats.min.js"></script>
	<script>
		var rotateX = 0, rotateY = 0; rotateZ = 0, map = null, sunH = 30, sunV = 45;

		function load(){
			map = new ZMap('map', {sceneType: '3D', center:{x:120.293820214832, y:31.5801890000232}, initZoom: 16, maxZoom: 18});
			//map = new ZMap('map', {sceneType: '3D', center:{x:116.21, y:0.41}, initZoom: 16, maxZoom: 18});
		}

		function x_add(){
			rotateX = 2;
			rotateY = 0;
			rotateZ = 0;
			refresh();
		}

		function x_sub(){
			rotateX = -2;
			rotateY = 0;
			rotateZ = 0;
			refresh();
		}

		function y_add(){
			rotateY = 5;
			rotateX = 0;
			rotateZ = 0;
			refresh();
		}

		function y_sub(){
			rotateY = -5;
			rotateX = 0;
			rotateZ = 0;
			refresh();
		}

		function z_add(){
			rotateZ = 5;
			rotateY = 0;
			rotateX = 0;
			refresh();
		}

		function z_sub(){
			rotateZ = -5;
			rotateY = 0;
			rotateX = 0;
			refresh();
		}

		function sun_up(){
			sunV += 5;
			map.setSunLight({h: sunH, v:sunV});
		}

		function sun_down(){
			sunV -= 5;
			map.setSunLight({h: sunH, v:sunV});
		}

//		function clickMap(event){
//			var point = map.screenPointToLatLng(new Z.Point(event.clientX,event.clientY));
//			alert(point.lat + "," + point.lng);
//		}

		function refresh(){
			//map._scene.setRotationByEuler({x: rotateX, y:rotateY, z:rotateZ});
			map.rotateByEuler({x: rotateX, y:rotateY, z:rotateZ});
			//map._scene.render();
			map._scene.refresh();
		}

		function reset(){
			map.resetRotate();
		}

		function zoomIn(){
			map.zoomIn();
		}

		function zoomOut(){
			map.zoomOut();
		}

//		var added = false;
		var layer1 = new Z.TDTVectorLayer();
		var layer2 = new Z.TDTVectorAnnoLayer();
		var layer3 = new Z.TDTRasterLayer();
		var layer4 = new Z.TDTRasterAnnoLayer();

		function addVectorLayer(){
			map.addLayer(layer1, 0);
//			map.addLayer(layer1, 0, Z.LayerGroup.BaseBgLayer);
		}
		function addVectorAnnoLayer(){
			map.addLayer(layer2, 1);
		}
		function addRasterLayer(){
			//map.addLayer(layer3, 0, Z.LayerGroup.BaseOverLayer);
			map.addLayer(layer3, 2, Z.LayerGroup.BaseBgLayer);
		}
		function addRasterAnnoLayer(){
			map.addLayer(layer4, 3, Z.LayerGroup.BaseBgLayer);
			//map.addLayer(layer4, 1, Z.LayerGroup.BaseOverLayer);
			//map.addLayer(layer2, 3, Z.LayerGroup.BaseOverLayer);
		}
		function removeVectorLayer(){
			map.removeLayer(layer1);
		}
		function removeVectorAnnoLayer(){
			map.removeLayer(layer2);
		}
		function removeRasterLayer(){
			map.removeLayer(layer3);
		}
		function removeRasterAnnoLayer(){
			map.removeLayer(layer4);
		}

		var buildingLayer;
		function loadBuildings(){
			document.getElementById("state").style.display="block";

			var selectedSymbol = new Z.ExtrudeSymbol({
				topColor:'#0000ff',
				wallColor:'#dddddd'
			});

			var selectedGraphic = null, oldSymbol = null;

			//testWktData
			if(!buildingLayer){
				buildingLayer = new Z.BuildingLayer();
				map.addLayer(buildingLayer, 2);

				buildingLayer.on("mousemove", function(e){//console.info("layerEvent:" + e.type);
					if(e.objects.length > 0){
						if(e.objects[0].graphic !== selectedGraphic){//console.info(e.objects[0] !== selectedGraphic);
							if(!oldSymbol){
								//oldSymbol = e.objects[0].graphic.symbol;
								oldSymbol = e.objects[0].symbol;
							}

							//e.objects[0].graphic.updateSymbol(selectedSymbol);
							e.objects[0].updateSymbol(selectedSymbol);

							if(selectedGraphic){
								selectedGraphic.updateSymbol(oldSymbol);
								selectedGraphic.hideTitle();
							}

							//selectedGraphic = e.objects[0].graphic;
							selectedGraphic = e.objects[0];
							selectedGraphic.showTitle();
						}
					}else{
						if(selectedGraphic){
							if(oldSymbol){
								selectedGraphic.updateSymbol(oldSymbol);
							}

							selectedGraphic.hideTitle();
							selectedGraphic = null;
						}

						//selectedGraphic = null;
					}
					map.refresh();
				});
			}

//			var total = testWktData.length,
//					added = 0;
//			buildingLayer.on("graphicadd", function(e){
//				added++;
//				document.getElementById("loadingState").innerHTML=added + " / " + total;
//			});
			//document.getElementById("loadingState").innerHTML="数据正在加载......";
			buildingLayer.loadBuildingsByWKT(testWktData,{
//				root: 'data',
//				props: '#{building}',
				shape:'#{the_geom}',
				cw: true,
				title:'#{CODE}_#{FLOOR}_id',
//				spatialProp:'SHAPE',
//				title:{prop:'OBJECTID', symbol: new Z.TextSymbol({text:"百脑汇科技大厦",font: {size: 20}, color: '#222222', fillColor: '#999999', borderColor: '#0000ff'})},
//				height:{prop:'BUILDINGHEIGHT'},
//				baseHeight:{
//					fun: function(record){
//						return parseFloat(record['FLOORS_DOWN'] * 3);
//					}
//				},
//				height:{fun: function(record){
//						return parseFloat(record['FLOOR'] * 3);
//					}
//				},
				height:function(record){
					return parseFloat(record['FLOOR'] * 3);
				},
				baseHeight:{
					value:0
				},
				wire: false,
				//topColor:'#ff0000',
				//wallColor:'#ffff00'
				topColor:'#bbbbbb',
				wallColor:'#bbbbbb'
			});
		}
	</script>
</head>
<body onload="load()">
	<input type="button" value="重置相机位置" onclick="reset()">
	<input type="button" value="旋转x+" onclick="x_add()">
	<input type="button" value="旋转x-" onclick="x_sub()">
	<input type="button" value="旋转y+" onclick="y_add()">
	<input type="button" value="旋转y-" onclick="y_sub()">
	<input type="button" value="旋转z+" onclick="z_add()">
	<input type="button" value="旋转z-" onclick="z_sub()">
	<!--<input type="button" value="太阳上升" onclick="sun_up()">-->
	<!--<input type="button" value="太阳下落" onclick="sun_down()">-->
	<input type="button" value="放大" onclick="zoomIn()">
	<input type="button" value="缩小" onclick="zoomOut()">
	<br>
	<input type="button" value="添加天地图矢量底图" onclick="addVectorLayer()">
	<input type="button" value="添加天地图矢量注记" onclick="addVectorAnnoLayer()">
	<input type="button" value="添加天地图影像底图" onclick="addRasterLayer()">
	<input type="button" value="添加天地图影像注记" onclick="addRasterAnnoLayer()">
	<input type="button" value="移除天地图矢量底图" onclick="removeVectorLayer()">
	<input type="button" value="移除天地图矢量注记" onclick="removeVectorAnnoLayer()">
	<input type="button" value="移除天地图影像底图" onclick="removeRasterLayer()">
	<input type="button" value="移除天地图影像注记" onclick="removeRasterAnnoLayer()">
	<br>
	<br>
	<input type="button" value="添加建筑物" onclick="loadBuildings()">
	<div style="display: none" id="state"><span id="loadingState">正在加载......</span><span id="parseState"></span></div>
	<div id="map" style="width: 1200px; height: 800px"></div>
	<!--<div id="map" style="width: 500px; height: 500px"></div>-->


</body>
</html>