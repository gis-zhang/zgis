<html>
<head>
	<title>地图api测试示例-建筑物</title>
	<meta charset="utf-8" />

	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<link rel="stylesheet" href="../src/lib/leaflet-0.7.3/leaflet.css" />
	<link rel="stylesheet" href="../dist/zmap.css" />
	<!--<link rel="stylesheet" href="../src/lib/leaflet-extend/control/L.TextIcon.js" />-->

	<script src="../src/lib/leaflet-0.7.3/leaflet-src.js"></script>
	<!--<script src="../src/lib/threejs/three.js"></script>-->
	<script src="../src/lib/threejs_new/three.js"></script>
	<script src="../src/lib/threejs/ConvexGeometry.js"></script>
	<script src="../src/lib/threebsp/ThreeBSP.js"></script>
	<!--<script src="../src/lib/leaflet-extend/control/Util.js"></script>-->
	<!--<script src="../src/lib/leaflet-extend/layer/L.CustomTileLayer.js"></script>-->
	<!--<script src="../src/lib/leaflet-extend/layer/layer.wmts-src.js"></script>-->
	<!--<script src="../src/lib/leaflet-extend/layer/layer.tdt-src.js"></script>-->
	<!--<script src="../src/lib/leaflet-plugin/Leaflet.zoomslider-0.6.1/src/L.Control.Zoomslider.js"></script>-->
	<!--<script src="../src/lib/leaflet-extend/crs/L.CRS.CustomLevel.js"></script>-->
	<!--<script src="../src/lib/leaflet-extend/control/L.Control.Layers.Custom.js"></script>-->
	<!--<script src="../src/lib/leaflet-plugin/MiniMap/Control.MiniMap.min.js"></script>-->
	<!--<script src="../src/lib/leaflet-extend/MapConfig.js" charset="GBK"></script>-->
	<!--<script src="../src/lib/leaflet-extend/control/L.TextIcon.js"></script>-->
	<!--<script src="../src/lib/leaflet-extend/Map.js"></script>-->
	<script src="../src/lib/stats.min.js"></script>
	<script src="../dist/zmap-release.js"></script>
	<!--<script src="http://localhost/mapapi/example/testdata_wkt4.js"></script>-->
	<script src="data/indoordata_wkt1.json"></script>
	<script>
		var rotateX = 0, rotateY = 0; rotateZ = 0, map = null, sunH = 30, sunV = 45;

//		function mousemove(){alert("sdsfsfd");
//			console.log("map div: mousemove");
//		}

		function load(){
			//map = new ZMap('map', {sceneType: '3D', center:{x:120.293820214832, y:31.5801890000232}, initZoom: 18, maxZoom: 20});
			map = new ZMap('map', {sceneType: '3D', center:{x:118.7169, y:32.0094}, initZoom: 18, maxZoom: 20});
			map.rotateByEuler({x: 70, y:0, z:0});
		}

		function showPopup(){
			map.openPopup("popup测试popup测试popup测试popup测试popup测试popup测试popup测试popup测试popup测试popup测试popup测试", new Z.LatLng(31.5801890000232,120.294820214832));
		}

		function x_add(){
			//rotateX += 5;
			rotateX = 2;
			rotateY = 0;
			rotateZ = 0;
			refresh();
		}

		function x_sub(){
//			rotateX -= 5;
			rotateX = -2;
			rotateY = 0;
			rotateZ = 0;
			refresh();
		}

		function y_add(){
//			rotateY += 5;
			rotateY = 5;
			rotateX = 0;
			rotateZ = 0;
			refresh();
		}

		function y_sub(){
//			rotateY -= 5;
			rotateY = -5;
			rotateX = 0;
			rotateZ = 0;
			refresh();
		}

		function z_add(){
			//rotateZ += 5;
			rotateZ = 5;
			rotateY = 0;
			rotateX = 0;
			refresh();
		}

		function z_sub(){
			//rotateZ -= 5;
			rotateZ = -5;
			rotateY = 0;
			rotateX = 0;
			refresh();
		}

		function x_pan_add(){
			map.panBy(10);
			showBbox();
		}

		function x_pan_sub(){
			map.panBy(-10);
			showBbox();
		}

		function y_pan_add(){
			//map._scene.translateByGL({x: 0, y:1, z:0});
			map.panBy(0, 50);
			showBbox();
		}

		function y_pan_sub(){
			//map._scene.translateByGL({x: 0, y:-1, z:0});
			map.panBy(0, -50);
			showBbox();
		}

//		function z_pan_add(){
//			//map._scene.translateByGL({x: 0, y:0, z:1});
//			//map.panBy(0, -50);
//			showBbox();
//		}
//
//		function z_pan_sub(){
//			//map._scene.translateByGL({x: 0, y:0, z:-1});
//			//map.panBy(0, -50);
//			showBbox();
//		}

		function sun_up(){
			sunV += 5;
			map.setSunLight({h: sunH, v:sunV});
		}

		function sun_down(){
			sunV -= 5;
			map.setSunLight({h: sunH, v:sunV});
		}

		function clickMap(event){
			var point = map.screenPointToLatLng(new Z.Point(event.clientX,event.clientY));
			alert(point.lat + "," + point.lng);
		}

		var spriteContainer;
		var i = 1;
		function refreshSprite(){
//			var mapRotate = map._scene.getRotateByRad();
//			spriteContainer.setRotationFromQuaternion(new THREE.Quaternion(mapRotate.x, mapRotate.y, mapRotate.z, mapRotate.w));
		}

		function refresh(){
			//map._scene.setRotationByEuler({x: rotateX, y:rotateY, z:rotateZ});
			map.rotateByEuler({x: rotateX, y:rotateY, z:rotateZ});
			//map._scene.render();

			//refreshSprite();
			//map._scene.refresh();
			//showBbox();
		}

		function showBbox(){
			var visibleBounds = map._scene._sceneRender.getVisibleGLBounds();
			var visibleLatLngBounds = map.getContentBounds();
			document.getElementById("aaa").innerHTML = "Left:x=" + visibleBounds.getBottomLeft().x + ";y=" + visibleBounds.getBottomLeft().y + ";z=" + visibleBounds.getBottomLeft().z +
					"。Right:x=" + visibleBounds.getTopRight().x + ";y=" + visibleBounds.getTopRight().y + ";z=" + visibleBounds.getTopRight().z;
			document.getElementById("bbb").innerHTML = "Left:x=" + visibleLatLngBounds.getWest() + ";y=" + visibleLatLngBounds.getSouth() + ";z=" + visibleLatLngBounds.getBottom() +
					"。Right:x=" + visibleLatLngBounds.getEast() + ";y=" + visibleLatLngBounds.getNorth() + ";z=" + visibleLatLngBounds.getTop();
		}

		function reset(){
			map._scene._sceneRender.resetCamera();
			map._scene._sceneRender.render();
		}

		function zoomIn(){
			map.zoomIn();
		}

		function zoomOut(){
			map.zoomOut();
		}

		var added = false;
		var layer1 = new Z.TDTVectorLayer();
		var layer2 = new Z.TDTVectorAnnoLayer();
		var layer3 = new Z.TDTRasterLayer();
		var layer4 = new Z.TDTRasterAnnoLayer();
//		function addNewLayer(){
////			if(!added){
//				var layer = new Z.TDTVectorLayer();
//				map.addLayer(layer);
//				var layer1 = new Z.TDTVectorAnnoLayer();
//				map.addLayer(layer1,1);
//				added = true;
////			}
//		}

		function addVectorLayer(){
			map.addLayer(layer1, 0);
//			map.addLayer(layer1, 0, Z.LayerGroup.BaseBgLayer);
		}
		function addVectorAnnoLayer(){
			map.addLayer(layer2, 1);
		}
		function addRasterLayer(){
			//map.addLayer(layer3, 0, Z.LayerGroup.BaseOverLayer);
			map.addLayer(layer3, 2, Z.LayerGroup.BaseBgLayer);
		}
		function addRasterAnnoLayer(){
			map.addLayer(layer4, 3, Z.LayerGroup.BaseBgLayer);
			//map.addLayer(layer4, 1, Z.LayerGroup.BaseOverLayer);
			//map.addLayer(layer2, 3, Z.LayerGroup.BaseOverLayer);
		}
		function removeVectorLayer(){
			map.removeLayer(layer1);
		}
		function removeVectorAnnoLayer(){
			map.removeLayer(layer2);
		}
		function removeRasterLayer(){
			map.removeLayer(layer3);
		}
		function removeRasterAnnoLayer(){
			map.removeLayer(layer4);
		}

		var vectorLayer = null;

		var graphic1;
		function addExtrude(){
//			var geom = new Z.Extrude(null,
//					[[[33,95], [27,95], [27, 105], [33, 105], [33, 95]], [[31,100], [30,102], [29,100], [30, 98], [31,100]]],
//					20
//			);
			var geom = new Z.Extrude(null,
					[[[30.1,99], [30,99], [30, 99.1], [30.1, 99.1]]],
					2000
			);
			var shape = new Z.Feature({id:'id112', name: 'name1234'}, geom);
			var symbol = new Z.ExtrudeSymbol({
				topColor:'#ff0000',
				wallColor:'#ffff00'
			});
			var graphic = new Z.Graphic(shape, symbol);

			var geom1 = new Z.Extrude(null,
					[[[30.15,99.05], [30.05,99.05], [30.05, 99.15], [30.15, 99.15]]],
					2000,
					2000
			);
			var shape1 = new Z.Feature({id:'id112', name: 'name1234'}, geom1);
			var symbol1 = new Z.ExtrudeSymbol({
				topColor:'#000fff',
				wallColor:'#ffaa33'
			});

			var selectedSymbol = new Z.ExtrudeSymbol({
				topColor:'#666666',
				wallColor:'#ff0000'
			});
//			var
					graphic1 = new Z.ComposeGraphic(shape1, symbol1);
			var selectedGraphic = null;
			graphic1.addMember(graphic);

//			var multiGraphic = new Z.ComposeGraphic({}, [graphic, graphic1]);
//
			if(!vectorLayer){
				vectorLayer = new Z.GraphicLayer();
				map.addLayer(vectorLayer, 2);
//
//				vectorLayer.on("mousedown", function(e){console.info("layerEvent:" + e.type);
//					if(e.objects.length > 0){
//						if(e.objects[0] !== selectedGraphic){
//							e.objects[0].graphic.updateSymbol(selectedSymbol);
//
//							if(selectedGraphic){
//								selectedGraphic.graphic.updateSymbol(symbol1);
//							}
//
//							selectedGraphic = e.objects[0].graphic;
//							map.refresh();
//						}
//					}
//				});
			}

			vectorLayer.addGraphic(graphic1);
//			vectorLayer.addGraphic(multiGraphic);
			map.panTo(new Z.LatLng(30.1, 99.1));
		}

		function showSubExtrude(){
			if(graphic1){
				graphic1.showMembers();
			}
		}

		function hideSubExtrude(){
			if(graphic1){
				graphic1.hideMembers();
			}
		}

		var buildingLayer;
		function loadBuildings(){
			var selectedSymbol = new Z.ExtrudeSymbol({
				topColor:'#0000ff',
				wallColor:'#dddddd'
			});

			var selectedGraphic = null, oldSymbol = null;

			//testWktData
			if(!buildingLayer){
				buildingLayer = new Z.BuildingLayer({
					enableTip: true,
					//enableTitle: true,
					enableInfoWindow: true
				});
				map.addLayer(buildingLayer, 2);

				buildingLayer.on("buildingclick", function(e){//console.info("layerEvent:" + e.type);
//					buildingLayer.on("graphicmouseover", function(e){//console.info("layerEvent:" + e.type);
					if(e.objects.length > 0){
						//if(e.objects[0].graphic !== selectedGraphic){//console.info(e.objects[0] !== selectedGraphic);
						if(e.objects[0] !== selectedGraphic){//console.info(e.objects[0] !== selectedGraphic);
							if(!oldSymbol){
								oldSymbol = e.objects[0].symbol;
							}

//							e.objects[0].updateSymbol(selectedSymbol);

							if(selectedGraphic){
								selectedGraphic.updateSymbol(oldSymbol);
								selectedGraphic.hideTitle();
								selectedGraphic.showSurface();
							}

							selectedGraphic = e.objects[0];
							selectedGraphic.showTitle();
							selectedGraphic.showAllFloors();
						}
					}else{
						if(selectedGraphic){
							if(oldSymbol){
								selectedGraphic.updateSymbol(oldSymbol);
							}

							selectedGraphic.hideTitle();
							selectedGraphic = null;
						}
					}
					map.refresh();

					var controlContainer = document.getElementById("aaa");
					controlContainer.innerHTML = "";
					var controlContent = document.createDocumentFragment();
					var floors = selectedGraphic.getAllFloors();

					var _btn = document.createElement("input");
					_btn.type = "button";
					_btn.value = "showAllSurface";
					_btn.onclick = function(){
						selectedGraphic.showAllFloors();//Z.FloorModel
					};
					controlContent.appendChild(_btn);

					_btn = document.createElement("input");
					_btn.type = "button";
					_btn.value = "showAllCells";
					_btn.onclick = function(){
						selectedGraphic.showAllFloors(Z.FloorModel.Cells);//Z.FloorModel
					};
					controlContent.appendChild(_btn);

					for(var floorLoop = 0; floorLoop < floors.length; floorLoop++){
						_btn = document.createElement("input");
						_btn.type = "button";
						_btn.value = floors[floorLoop].name;
						_btn.floorId = floors[floorLoop].id;
						_btn.onclick = function(){
							selectedGraphic.showFloor(this.floorId);//Z.FloorModel
						};
						controlContent.appendChild(_btn);
					}

					controlContainer.appendChild(controlContent);
				});

//				var selectedFloor;
//				buildingLayer.on("floorclick", function(e){
//					var startTime = new Date();
//					if(e.objects.length > 0){
//						//if(e.objects[0].graphic !== selectedFloor){//console.info(e.objects[0] !== selectedGraphic);
//						if(e.objects[0] !== selectedFloor){//console.info(e.objects[0] !== selectedGraphic);
//							if(!oldSymbol){
//								oldSymbol = e.objects[0].symbol;
//							}
//
//							if(selectedFloor){
////								selectedFloor.updateSymbol(oldSymbol);
//								selectedFloor.hideTitle();
//								selectedFloor.showSurface();
//							}
//
//							selectedFloor = e.objects[0];
//							selectedFloor.showTitle();
//							selectedFloor.showCells();
//						}
//					}else{
//						if(selectedFloor){
////							if(oldSymbol){
////								selectedFloor.updateSymbol(oldSymbol);
////							}
//
//							selectedFloor.hideTitle();
//							selectedFloor = null;
//						}
//					}
//					var centerTime = new Date();
//					map.refresh();
//					var endTime = new Date();
//					console.info("centerTime:" + (centerTime.getMilliseconds() - startTime.getMilliseconds()));
//					console.info("endTime:" + (endTime.getMilliseconds() - startTime.getMilliseconds()));
//				});
			}

			var iconSymbol = new Z.PictureMarkerSymbol(
					{offset: new Z.Point(0, 0, 0), width:25, height:41,
						anchor:'bottomCenter',
						//url: "http://localhost:8080/zmap/src/zmap/image/marker-icon.png"})
						url: "http://localhost:8080/zmap/src/zmap/image/icon1.jpg"})

			buildingLayer.loadBuildingsByWKT(testWktData,{
				root: 'data',
				props: '#{building}',
				shape:'#{shape}',
				title:'#{floorsId}_#{defaultFloor}_id',
				//icon: 'http://localhost:8080/zmap/src/zmap/image/marker-icon.png',
				height:'#{high}',
				baseHeight:0,
				partsData:'#{floors}',
				partsOptions: {
					floorIndex: '#{id}',
					title:'#{name}',
					//icon: 'http://localhost:8080/zmap/src/zmap/image/marker-icon.png',
					//height: '#{high}',
					height: function(floorObj){
						return floorObj.high * 3;
					},
					shape:'#{shape}',
					partsData:'#{funcAreas}',
					wire: true,
					opacity: 0.5,
					partsOptions: {
						id: '#{id}',
						title:'#{name}',
						titleSymbol: null,
						//icon: 'http://localhost:8080/zmap/src/zmap/image/icon1.jpg',
						iconSymbol: iconSymbol,
						height: 1,
						shape:'#{shape}',
						selectSymbol: new Z.ExtrudeSymbol({topColor: "#aa0000", wallColor: "#aaaa00"}),
						mouseoverSymbol: new Z.ExtrudeSymbol({topColor: "#aa00aa", wallColor: "#00aaaa"}),
						wire: true,
						opacity: 0.5,
						topColor:'#ff00ff',
						wallColor:'#888888'
					}
				},
				wire: true,
				opacity: 0.5,
				topColor:'#ff0000',
				wallColor:'#ffff00'
			}, true);
		}
	</script>
</head>
<body onload="load()">
	<input type="button" value="addNewObject" onclick="addNewObject()">
	<input type="button" value="重置相机位置" onclick="reset()">
	<input type="button" value="旋转x+" onclick="x_add()">
	<input type="button" value="旋转x-" onclick="x_sub()">
	<input type="button" value="旋转y+" onclick="y_add()">
	<input type="button" value="旋转y-" onclick="y_sub()">
	<input type="button" value="旋转z+" onclick="z_add()">
	<input type="button" value="旋转z-" onclick="z_sub()">
	<input type="button" value="移动x+" onclick="x_pan_add()">
	<input type="button" value="移动x-" onclick="x_pan_sub()">
	<input type="button" value="移动y+" onclick="y_pan_add()">
	<input type="button" value="移动y-" onclick="y_pan_sub()">
	<!--<input type="button" value="移动z+" onclick="z_pan_add()">-->
	<!--<input type="button" value="移动z-" onclick="z_pan_sub()">-->
	<input type="button" value="太阳上升" onclick="sun_up()">
	<input type="button" value="太阳下落" onclick="sun_down()">
	<input type="button" value="放大" onclick="zoomIn()">
	<input type="button" value="缩小" onclick="zoomOut()">
	<br>
	<input type="button" value="添加天地图矢量底图" onclick="addVectorLayer()">
	<input type="button" value="添加天地图矢量注记" onclick="addVectorAnnoLayer()">
	<input type="button" value="添加天地图影像底图" onclick="addRasterLayer()">
	<input type="button" value="添加天地图影像注记" onclick="addRasterAnnoLayer()">
	<input type="button" value="移除天地图矢量底图" onclick="removeVectorLayer()">
	<input type="button" value="移除天地图矢量注记" onclick="removeVectorAnnoLayer()">
	<input type="button" value="移除天地图影像底图" onclick="removeRasterLayer()">
	<input type="button" value="移除天地图影像注记" onclick="removeRasterAnnoLayer()">
	<br>
	<input type="button" value="添加线" onclick="addPolyline()">
	<input type="button" value="添加面" onclick="addPolygon()">
	<input type="button" value="添加图片标注" onclick="addPictureMarker()">
	<input type="button" value="添加文字标注" onclick="addTextMarker()">
	<input type="button" value="添加圆形标注" onclick="addCircle()">
	<input type="button" value="添加环形标注" onclick="addRing()">
	<input type="button" value="添加Extrude" onclick="addExtrude()">
	<input type="button" value="显示子Extrude" onclick="showSubExtrude()">
	<input type="button" value="隐藏子Extrude" onclick="hideSubExtrude()">
	<input type="button" value="添加建筑物" onclick="loadBuildings()">
	<input type="button" value="popup" onclick="showPopup()">
	<div id="map" style="width: 1000px; height: 500px;"></div>
	<br><span id="aaa"></span>
	<!--<br><span id="bbb"></span><br>-->


</body>
</html>